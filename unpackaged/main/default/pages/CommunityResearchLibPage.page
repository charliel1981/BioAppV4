<apex:page controller="CommunityController" readOnly="true" sidebar="false" standardStylesheets="false" showheader="false">

  <script type="text/javascript" src="{!URLFOR($Resource.community_2,'js/promise-polyfill.js')}"></script>
  <apex:includeScript value="{!URLFOR($Resource.community_2,'js/vue.min.js')}" />
  <apex:includeScript value="{!URLFOR($Resource.community_2,'js/data.js')}" />
  <apex:stylesheet value="{!URLFOR($Resource.community_2,'css/style.css')}" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Biocomposites Distributor Hub</title>
  <script type="text/javascript">
    if ('{!$Profile.Name}' == 'Distributor Hub Profile') {
      window.location.href = '/apex/CommunitiesLogin'
    }
  </script>
  <style>
    .bc-bibliography {
      padding: 0 20px 0px 20px;
      width: calc(50% - 30px);
    }

    .bc-bibliography button {
      width: calc(100% - 138px);
      display: inline-block;
      padding: 0px 10px !important;
      height: 32px;
      text-decoration: none;
    }

    .bc-bibliography button:nth-child(1) {
      margin-bottom: 10px;
    }
    
    .bc-bibliography a {
      text-decoration: none;
    }
    
    .bc-search button, .bc-search input {
      vertical-align: top;
    }
    .bc-search button {
      height: 32px;
    }
    
    @media screen and (max-width: 800px) {
      .bc-bibliography {
        width: calc(100% - 40px);
      }
      .bc-bibliography button {
        display: block;
        width: 100%;
      }
    }
  </style>

  <!-- App -->
  <div id="vm">

    <!-- Header -->
    <div id="bc-header">
      <div v-on-click="navigation = !navigation" v-bind-class="{ 'shift' : width < 1360 && navigation == true }">
        <img src="{!URLFOR($Resource.community_2,'images/menu-grey.png')}" />
      </div>
      <a href="/apex/CommunityHomePage">
        <img src="{!URLFOR($Resource.community_2,'images/home_alt.png')}" />
      </a>
      <a v-if="navigation == true && width < 1360" href="/apex/CommunityHomePage">
        <img class="alt" src="{!URLFOR($Resource.community_2,'images/home.png')}" />
      </a>
      <img class="header" v-bind-src="image" />
      <div class="bc-search">
        <input v-on-keydown.enter="run_global_search()" v-on-blur="run_global_search()" v-model="globalsearch" type="text" placeholder="Search Hub..."/>    
        <button class="desktop" v-on-click="run_global_search()">
          <img src="{!URLFOR($Resource.community_2,'images/search-gray.png')}"/>
          <img src="{!URLFOR($Resource.community_2,'images/search-white.png')}"/>
        </button>
        <button class="mobile" v-on-click="mobile_search = ! mobile_search">
          <img src="{!URLFOR($Resource.community_2,'images/search-gray.png')}"/>
          <img src="{!URLFOR($Resource.community_2,'images/search-white.png')}"/>
        </button>
      </div>
      <div v-if="mobile_search == true" class="bc-global--search">
        <div>
          <input v-on-keydown.enter="run_global_search()" v-model="globalsearch" type="text" placeholder="Search Hub..."/>    
          <button v-on-click="run_global_search()">
            <img src="{!URLFOR($Resource.community_2,'images/search-gray.png')}"/>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Tab Bar -->
    <div id="bc-newnav">
      <ul>
        <a href="/apex/CommunityMarketingPage">
          <li>Marketing collateral</li>
        </a>
        <a href="/apex/CommunitySalesPage">
          <li>Sales tools</li>
        </a>
        <a href="/apex/CommunityELearningPage">
          <li>e-learning</li>
        </a>
        <a href="/apex/CommunityVideoLibPage">
          <li>Video library</li>
        </a>
        <a href="/apex/CommunityAccountMngPage">
          <li>Account management</li>
        </a>
      </ul>
    </div>

    <!-- Tabs -->
    <div id="bc-navigation" v-bind-style="{ 'height' : height + 'px', 'left' : shift }" v-bind-class="{ 'show' : navigation == true }">
      <div>
        <div v-if="navigation == true && width < 1360" v-on-click="navigation = !navigation" v-bind-class="{ 'shift' : width < 1360 && navigation == true }">
          <img src="{!URLFOR($Resource.community_2,'images/menu-white.png')}" />
        </div>
      </div>
      <ul>
        <a href="/apex/CommunityHomePage">
          <li><img src="{!URLFOR($Resource.community_2,'images/home.png')}" />Home</li>
        </a>
        <a href="/apex/CommunityTOIPage">
          <li><img src="{!URLFOR($Resource.community_2,'images/topics.png')}" />Topics of interest</li>
        </a>
        <a href="/apex/CommunityMarketingPage">
          <li><img src="{!URLFOR($Resource.community_2,'images/marketing-white.png')}" />Marketing collateral</li>
        </a>
        <a href="/apex/CommunitySalesPage">
          <li><img src="{!URLFOR($Resource.community_2,'images/sales-tools-icon.png')}" />Sales tools</li>
        </a>
        <a href="/apex/CommunityELearningPage">
          <li><img src="{!URLFOR($Resource.community_2,'images/learning-white.png')}" />e-learning</li>
        </a>
        <a href="/apex/CommunityVideoLibPage">
          <li><img src="{!URLFOR($Resource.community_2,'images/video-white.png')}" />Video library</li>
        </a>
        <a style="display: none" href="/apex/CommunityEducationPage" id="ce-linka">
          <li><img src="{!URLFOR($Resource.community_2,'images/continuing-education.png')}" />Continuing education</li>
        </a>
        <a href="/apex/CommunityAccountMngPage">
          <li><img src="{!URLFOR($Resource.community_2,'images/account-white.png')}" />Account management</li>
        </a>
        <a v-show="see_pub == true" href="/apex/CommunityResearchLibPage">
          <li><img src="{!URLFOR($Resource.community_2,'images/library.png')}" />Publication library</li>
        </a>
        <a v-show="see_internal == true" href="/apex/CommunityInternalPage">
          <li><img src="{!URLFOR($Resource.community_2,'images/internal.png')}" />Internal documentation</li>
        </a>
        <a v-if="profile.indexOf('COMMUNITY') != -1 && sforce == false" href="/secur/logout.jsp">
          <li><img src="{!URLFOR($Resource.community_2,'images/logout.png')}" />Log out</li>
        </a>
        <a v-if="profile.indexOf('COMMUNITY') == -1 && sforce == false" href="/servlet/networks/switch?networkid=00DD0000000Cl9q">
          <li><img src="{!URLFOR($Resource.community_2,'images/logout.png')}" />Back to CRM</li>
        </a>
      </ul>
    </div>

    <!-- Title -->
    <h3 style="margin: 20px">Publication library</h3>

    <!-- Content -->
    <table id="bc-content">
      <tr>
        <td width="100%" colspan="2">
          <p class="bc-info">The publication library is for internal education purposes only. Some of the papers may include the use of our products that go beyond the current clearance / approval granted by the relevant regulatory authority. The unsolicited / information request process must be strictly adhered to for any off label requests for information.</p>
          <div class="bc-bibliography">
            <a href="https://biocomposites.my.salesforce.com/sfc/p/U0000000Levb/a/4O0000004c4A/zuPi8TnFvOptOcFufNBUOM.B6uxhyKaxp.tAoFkO_zw" target="_blank">
              <button>STIMULAN bibliography</button>
            </a>
            <a href="https://biocomposites.my.salesforce.com/sfc/p/U0000000Levb/a/4O0000004c4F/jjmuSTHnyfddyHwBqwRXT0ls3eE4wgG6byw5F6azXP0" target="_blank">
              <button>genex bibliography</button>
            </a>
          </div>
          <div class="bc-search">
            <input placeholder="Enter your search here..." v-model="search" onkeyup="vm.check_enter(event)" style="font-size: 16px"/>
            <button class="bc-search-button" v-on-click="send_search" v-bind-disabled="search == ''">
              Search
              <img class="bc-search-icon" />
            </button>
            <button v-on-click="search = '', reset_search()">Clear</button>
            <p>Separate words with a comma to search on multiple keywords.</p>
            <span v-if="database.publishing.length == 0 && search == ''">Loading Results...</span>
            <span v-if="database.publishing.length == 0 && search != '' && loaded == false">Searching database...</span>
            <span v-if="database.publishing.length == 0 && search != '' && loaded == true">No Results Found</span>
          </div>
        </td>
      </tr>
      <tr>
        <td class="bc-left" width="50%" colspan="1">
          <div class="bc-paper" v-for="record in database.publishing">
            <h4>{{ stripper(record.title) }}</h4>
            <span>{{ stripper(record.authorPub) }}</span>
            <p>{{ stripper(record.publishers) }}</p>
            <button v-if="record.selected != true" v-on-click="select_abstract(record), click(record.recordId)">View abstract</button>
            <button class="bc-close" v-if="record.selected == true" v-on-click="select_abstract('none')">Close abstract</button>
            <div v-show="record.selected == true && show_abstract == true && width <= 800" class="bc-inline-abstract">
              <br/>
              <div class="bc-abstract">
                <div class="bc-paper">
                  <h4>{{ stripper(selected_paper.title) }}</h4>
                  <span>{{ stripper(selected_paper.authorPub) }}</span>
                  <p>{{ stripper(selected_paper.publishers) }}</p>
                  <div>{{ stripper(selected_paper.abstractPub) }}</div>
                </div>
              </div>
              <div class="bc-view">
                <h3 class="bc-abstract-title">Key Findings</h3> <pre style="white-space: pre-wrap; font-family: Flama">{{ stripper(selected_paper.ourView) }}</pre>
              </div>
            </div>
          </div>
          <div class="bc-paginator" v-show="database.publishing.length != 0">
            <span v-if="database.publishing.length >= 10">Showing 10 of {{ total }} results</span>
            <span v-if="database.publishing.length < 10">Showing {{ database.publishing.length }} of {{ total }} results</span>
            <div class="bc-blocker" v-bind-style="{ 'width' : 75 + (40 * pages.length) + 'px' }">
              <div class="bc-left" v-on-click="select_page('prev')" v-bind-disabled="selected_page == pages[0]">&lt;</div>
              <div class="bc-number" v-for="page in pages" v-on-click="select_page(page)" v-bind-class="{ 'selected' : page == selected_page }">
                {{ page }}
              </div>
              <div class="bc-right" v-on-click="select_page('next')" v-bind-disabled="selected_page == pages[pages.length - 1]">&gt;</div>
            </div>
          </div>
        </td>
        <td v-bind-class="{ 'hide' : show_abstract != true || width <= 800 }" class="bc-right" width="50%" colspan="1">
          <h3 class="bc-abstract-title">Abstract</h3>
          <div class="bc-abstract">
            <div class="bc-paper">
              <h4>{{ stripper(selected_paper.title) }}</h4>
              <span>{{ stripper(selected_paper.authorPub) }}</span>
              <p>{{ stripper(selected_paper.publishers) }}</p>
              <div>{{ stripper(selected_paper.abstractPub) }}</div>
            </div>
          </div>
          <div class="bc-view">
            <h3 class="bc-abstract-title">Key Findings</h3> <pre style="white-space: pre-wrap; font-family: Flama">{{ selected_paper.ourView }}</pre>
          </div>
        </td>
      </tr>
    </table>

    <!-- Footer -->
    <div class="bc-footer">
      <ul>
        <a href="/apex/CommunityHomePage">
          <li><img src="" />Home</li>
        </a>
        <a href="/apex/CommunityTOIPage">
          <li><img src="" />Topics of interest</li>
        </a>
        <a href="/apex/CommunityMarketingPage">
          <li><img src="" />Marketing collateral</li>
        </a>
        <a href="/apex/CommunitySalesPage">
          <li><img src="" />Sales tools</li>
        </a>
        <a href="/apex/CommunityELearningPage">
          <li><img src="" />e-learning</li>
        </a>
        <a href="/apex/CommunityVideoLibPage">
          <li><img src="" />Video library</li>
        </a>
        <a style="display: none" href="/apex/CommunityEducationPage" id="ce-linkb">
          <li><img src="" />Continuing education</li>
        </a>
        <a href="/apex/CommunityAccountMngPage">
          <li><img src="" />Account management</li>
        </a>
        <a v-show="see_pub == true" href="/apex/CommunityResearchLibPage">
          <li><img src="" />Publication library</li>
        </a>
        <a v-show="see_internal == true" href="/apex/CommunityInternalPage">
          <li><img src="" />Internal documentation</li>
        </a>
        <a v-if="profile.indexOf('COMMUNITY') != -1 && sforce == false" href="/secur/logout.jsp">
          <li><img src="" />Log out</li>
        </a>
        <a v-if="profile.indexOf('COMMUNITY') == -1 && sforce == false" href="/servlet/networks/switch?networkid=00DD0000000Cl9q">
          <li><img src="" />Back to CRM</li>
        </a>
      </ul>
      <p>© {!$Label.Community_Year} Biocomposites. All rights reserved</p>
    </div>

  </div>

  <!-- Interfacer -->
  <script type="text/javascript">
    var vi = {
      // handles apex function running
      runApex: function(action, value1, value2, value3) {
        return new Promise(function(success) {
          if (value1 && value2 && value3) {
            Visualforce.remoting.Manager.invokeAction(action, value1, value2, value3, function(res, event) {
              if (event.status) {
                success(res);
              } else {
                console.error(event);
              }
            });
          } else if (value1 && value2 && !value3) {
            Visualforce.remoting.Manager.invokeAction(action, value1, value2, function(res, event) {
              if (event.status) {
                success(res);
              } else {
                console.error(event);
              }
            });
          } else if (value1 && !value2 && !value3) {
            Visualforce.remoting.Manager.invokeAction(action, value1, function(res, event) {
              if (event.status) {
                success(res);
              } else {
                console.error(event);
              }
            });
          } else if (!value1 && !value2 && !value3) {
            Visualforce.remoting.Manager.invokeAction(action, function(res, event) {
              if (event.status) {
                success(res);
              } else {
                console.error(event);
              }
            });
          }
        })
      },
      getData: function() {
        return new Promise(function(success) {
        var education = 0;
        
          vi.runApex('{!$RemoteAction.CommunityController.getCommunityItemRecords}', 'Continuing Education', '1').then(function(ce) {
            education = ce.length;         
          });
          // get topics
          vi.runApex('{!$RemoteAction.CommunityController.getPublisherLibRecords}', 'Publication Library', 10, '0').then(function(publishing) {
            // get banner
            vi.runApex('{!$RemoteAction.CommunityController.getLogoURLForUser}').then(function(url) {
              // decode banner uri
              var decode = url.replace(/amp;/g, '').replace(/"/g, '');
              // get color codes
              vi.runApex('{!$RemoteAction.CommunityController.getColorCodes}').then(function(colors) {
                // check if we can see interna;
                var test1 = 'Internal only';
                vi.runApex('{!$RemoteAction.CommunityController.checkCommunityItemExists}', test1).then(function(test1res) {
                  vi.runApex('{!$RemoteAction.CommunityController.getPublisherTotalItems}').then(function(total) {
                  var test2 = 'Publication Library';
                        vi.runApex('{!$RemoteAction.CommunityController.checkCommunityItemExists}', test2).then(function(test2res) {
                    var results = {
                      publishing: publishing,
                      image: decode,
                      colors: colors,
                      internal: test1res,
                      pub: test2res,
                      total: total,
                      profile: "{!$Profile.Name}"
                    }
                    if (education > 0) {
                        document.getElementById('ce-linka').style.display = 'block';
                        document.getElementById('ce-linkb').style.display = 'block';
                      }
                    success(results);
                  })
                  })
                })
              })
            })
          });
        });
      },
      getSearch: function(keywords) {
        return new Promise(function(success) {
          vi.runApex('{!$RemoteAction.CommunityController.searchPublications}', keywords).then(function(results) {
            success(results);
          })
        })
      },
      getPapers: function(offset) {
        var calc = JSON.stringify((offset - 1) * 10);
        console.log(offset, calc);
        return new Promise(function(success) {
          vi.runApex('{!$RemoteAction.CommunityController.getPublisherLibRecords}', 'Publication Library', 10, calc).then(function(publishing) {
            success(publishing);
          });
        })
      },
      getTotal: function() {
        return new Promise(function(success) {
          vi.runApex('{!$RemoteAction.CommunityController.getPublisherTotalItems}').then(function(total) {
            console.log(total);
            success(total);
          });
        });
      },
      createStat: function(id) {
        vi.runApex('{!$RemoteAction.CommunityController.createCommunityStatRemote}', id).then(function(res) {
          console.log(res)
        });
      }
    }
  </script>

  <!-- JS Controller -->
  <script type="text/javascript" src="{!URLFOR($Resource.community_2,'js/controller.js')}"></script>

</apex:page>