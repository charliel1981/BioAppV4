/* mobilecaddy-utils - v1.4.2 - Bundle Time: 2017-11-30 16:07:32 */
/* git info: "2017-11-24 09:26:30 +0000": b5068f340ce0aa27fd458d562d1e8a0cf8b552f1 (develop) */
/* Copyright 2017 MobileCaddy Ltd */
var $j=jQuery.noConflict(),MC_TABLES=["Connection_Session__mc","Mobile_Log__mc","MC_Project__ap","MC_Time_Expense__ap","MC_Project_Location__ap"];!function(){var a,b;!function(){function c(b){var c=b.factory;return b.exports={},delete b.factory,c(a,b.exports,b),b.exports}var d={},e=[],f={};a=function(a){if(d[a]){if(a in f){e.slice(f[a]).join("->")+"->"+a}}else;if(d[a].factory)try{return f[a]=e.length,e.push(a),c(d[a])}finally{delete f[a],e.pop()}return d[a].exports},b=function(a,b){d[a],d[a]={id:a,factory:b}},b.remove=function(a){delete d[a]}}(),"object"==typeof module&&"function"==typeof a&&(module.exports.require=a,module.exports.define=b),b("mobileCaddy",function(a,c,d){var e={define:b,require:a,START_PAGE_CONTROLLER:"",QUERY_BUFFER_SIZE:50,INITIAL_APPCACHE_INFO:[]};d.exports=e}),b("mobileCaddy/mobileLogger",function(a,b,c){function d(){try{throw Error("")}catch(a){return a}}function e(a,b){var c=b.stack.split("\n")[4],d="";if("undefined"!=typeof c){var e=c.indexOf("at ");d=c.slice(e+2,c.length)}}function f(a,b){throw e(a,b),a}function g(a,b){for(var c in a)e("field:"+c+": has value :"+a[c]+":",b)}c.exports={logMessageAndThrow:function(a){f(a,d())},logMessage:function(a){e(a,d())},logObjectDetails:function(a){g(a,d())}}}),b("mobileCaddy/geolocation",function(a,b,c){function d(a){var b=[];b.Error="Location information is unavailable.",b.ErrorNumber=2,a(b)}c.exports={getLocation:function(a,b){d(a,b)}}}),b("mobileCaddy/startup",function(a,b,c){function d(){return new Promise(function(a,b){var c=[{path:"Mobile_Table_Name",type:"string"},{path:"SOUP_Record_Id",type:"string"},{path:"Id",type:"string"},{path:"LastModifiedDateTime",type:"integer"},{path:"CRUD_Operation",type:"string"},{path:"Current_Connection_Session",type:"string"}];l.registerSoup("recsToSync",c,function(){a()},function(a){b(a)})})}function e(a){mobileCaddy.INITIAL_APPCACHE_INFO=[],window.applicationCache.addEventListener("checking",function(a){f(a)},!1),window.applicationCache.addEventListener("downloading",function(a){f(a)},!1),window.applicationCache.addEventListener("progress",function(a){f(a)},!1),mobileCaddy.INITIAL_APPCACHE_INFO.push({Name:"AppCache: Initial Status",Description:window.applicationCache.status});var b={};switch(b.status=o,window.applicationCache.status){case window.applicationCache.CHECKING:case window.applicationCache.DOWNLOADING:throw window.applicationCache.addEventListener("updateready",function(b){f(b,a)},!1),window.applicationCache.addEventListener("cached",function(b){f(b,a)},!1),window.applicationCache.addEventListener("error",function(b){f(b,a)},!1),window.applicationCache.addEventListener("noupdate",function(b){f(b,a)},!1),new Error("MobileCaddy - Cache busy.  Will continue when check/load is complete");case window.applicationCache.UPDATEREADY:window.applicationCache.swapCache(),a(b);break;default:a(b)}}function f(a,b){mobileCaddy.INITIAL_APPCACHE_INFO.push("progress"==a.type?{Name:"Event ",Description:a.loaded+" of "+a.total}:{Name:"Event ",Description:a.type});var c={};c.status="udpateready"==a.type||(a.type="cached")?o:p,k.logObjectDetails(c),b&&"function"==typeof b&&b(c)}function g(a){$j(function(){e(function(b){h(a,b)})})}function h(a,b){var c=j("appSoupJson");if(""!==c){var d=$j.parseJSON(c),e=[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}];l.registerSoup("appSoup",e,function(){l.upsertSoupEntries("appSoup",d,function(){var c=[{path:"Name",type:"string"},{path:"Description",type:"string"}];l.registerSoup("cacheSoup",c,function(){i(a,b)},function(a){k.logMessage("Failed to create cache soup with error = "+a)})},function(a){k.logMessage("Failed to update app soup with error = "+a)})},function(a){k.logMessage("Failed to register app soup with error = "+a)})}else LOCAL_DEV?(cacheSoupStructure=[{path:"Name",type:"string"},{path:"Description",type:"string"}],l.registerSoup("cacheSoup",cacheSoupStructure,function(){i(a,b)})):navigator.appVersion.includes("Electron")?l.soupExists("appSoup",function(c){if(c)i(a,b);else{{var d=[],e=ipcRenderer.sendSync("request-creds","");j("access_token","?"+e)}if(d.push({Name:"accessToken",CurrentValue:j("access_token","?"+e),NewValue:null}),d.push({Name:"refreshToken",CurrentValue:j("refresh_token","?"+e),NewValue:null}),d.push({Name:"clientId",CurrentValue:j("client_id","?"+e),NewValue:null}),d.push({Name:"orgId",CurrentValue:j("org_id","?"+e),NewValue:null}),d.push({Name:"applicationName",CurrentValue:j("buildName","?"+e),NewValue:null}),d.push({Name:"buildName",CurrentValue:j("buildName","?"+e),NewValue:null}),window.location.pathname.startsWith("/apex/"))d.push({Name:"loginUrl",CurrentValue:window.location.protocol+"//"+window.location.host,NewValue:null});else{var f=window.location.pathname.split("/"),g=f[1];d.push({Name:"loginUrl",CurrentValue:window.location.protocol+"//"+window.location.host+"/"+g,NewValue:null})}var h=ipcRenderer.sendSync("request-device-info","");d.push({Name:"buildStatus",CurrentValue:"Initial"}),d.push({Name:"buildVersion",CurrentValue:h.buildVersion}),d.push({Name:"buildOS",CurrentValue:h.platform}),d.push({Name:"deviceUuid",CurrentValue:h.uuid});var m=[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}];l.registerSoup("appSoup",m,function(){l.upsertSoupEntries("appSoup",d,function(){var c=[{path:"Name",type:"string"},{path:"Description",type:"string"}];l.registerSoup("cacheSoup",c,function(){i(a,b)},function(a){k.logMessage("Failed to create cache soup with error = "+a)})},function(a){k.logMessage("Failed to update app soup with error = "+a)})},function(a){k.logMessage("Failed to register app soup with error = "+a)})}}):(document.addEventListener("deviceready",function(){i(a,b)},!1),document.addEventListener("backbutton",function(){},!0))}function i(b,c){a("mobileCaddy/logger");l.upsertSoupEntries("cacheSoup",mobileCaddy.INITIAL_APPCACHE_INFO,function(){n.querySoupRecsPromise("appSoup").then(function(e){var f={},g=[];if(e.forEach(function(a){if("undefined"!=typeof f[a.Name])throw"Should only be 1 "+a.Name+" entry in the app soup.  Found more";f[a.Name]=a}),f.userOverrideId||(f.userOverrideId=""),"Complete"==f.buildStatus.CurrentValue&&"Complete"==f.buildStatus.NewValue){if(null!==b){k.logMessage("build already complete - calling 3rd party callback function");var h={};if(h.status=r,h.mc_add_status=c.status,h.curVsn=f.dynVersionNumber.CurrentValue,"undefined"!=typeof f.dynVersionNumber.NewValue&&(h.newVsn=f.dynVersionNumber.NewValue),navigator.appVersion.includes("Electron")){var i=window.location.protocol+"//"+window.location.host+window.location.pathname;ipcRenderer.send("startPageUrl",i)}b(h)}}else{var j=function(a,e){if(e.status){k.logMessage("Parse json aud"+a),g=$j.parseJSON(a);var h=_.find(g,{Name:"audId"}).CurrentValue,i=_.find(g,{Name:"sysDataPlatSupVersion"}).CurrentValue;if(navigator.appVersion.includes("Electron")){var j=window.location.protocol+"//"+window.location.host+window.location.pathname;ipcRenderer.send("startPageUrl",j)}d().then(function(){m.createSystemDataSoup(function(){n.buildMobileTables(function(){var a=f.buildStatus;a.CurrentValue="Complete",a.NewValue="Complete",g.map(function(a){return f[a.Name]&&(a._soupEntryId=f[a.Name]._soupEntryId),a}),g.push(a),l.upsertSoupEntries("appSoup",g,function(){m.getRecordTypeDots(h,i).then(function(){if(null!==b){var a={};a.status=q,a.mc_add_status=c.status,k.logMessage("Calling 3rd party callback"),k.logObjectDetails(a),b(a)}}).catch(function(a){k.logMessage("From getRecordTypeDots "+a)})},function(a){k.logMessage("From upsert soup records "+a)})},function(a){k.logMessage("Error building mobile tables "+a)})},function(a){k.logMessage("create system data soup returned error"+a)},h,i),k.logMessage("Exiting startup")}).catch(function(a){k.logMessage("Error building recs to sync soup "+a)})}else"exception"===e.type&&alert(e.message)},o=a("mobileCaddy/syncRefresh");o.heartBeat(function(a){USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getAUDInfo001",contentType:"application/json",data:{buildVersion:f.buildVersion.CurrentValue,buildName:f.buildName.CurrentValue,buildOS:f.buildOS.CurrentValue,deviceUuid:f.deviceUuid.CurrentValue,overrideUserId:force.getUserId(),startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(a){var b={};b.status="200",j(a,b)},function(a){error()}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".getAudInfo",f.buildVersion.CurrentValue,f.buildName.CurrentValue,f.buildOS.CurrentValue,f.deviceUuid.CurrentValue,f.userOverrideId,j,{escape:!1,timeout:3e4})},function(a){error()})}}).catch(function(a){})},function(a){k.logMessage("Failed to update app soup with initial app cache info = "+a)})}function j(a,b){b||(b=window.location.search),a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var c="[\\?&]"+a+"=([^&#]*)",d=new RegExp(c),e=d.exec(b);return null===e?"":decodeURIComponent(e[1].replace(/\+/g," "))}var k=a("mobileCaddy/mobileLogger"),l=(a("mobileCaddy/logger"),cordova.require("com.salesforce.plugin.smartstore")),m=a("mobileCaddy/systemData"),n=a("mobileCaddy/smartStoreUtils"),o=(a("mobileCaddy/appDataUtils"),100900),p=100901,q=100800,r=100801;c.exports={startup:function(a){g(a)}}}),b("mobileCaddy/systemData",function(a,b,c){function d(a,b,c,d){i.logMessage("In populate system data row values");var e=function(a,b){if(b.status){i.logMessage("In remoting callback for getSysDataSoupVariables with record count = "+a.length);var e=$j.parseJSON(a);i.logMessage("Parse json soup field defns done"),k.upsertSoupEntries("syncLib_system_data",e,c,d)}else"exception"===b.type?(alert(b.message),i.logMessage("Exception return from getSystemDataRowValues = "+b.message)):i.logMessage("Unknown return from getSystemDataRowValues = "+b.message)};USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getSysDataSoupVariables001",contentType:"application/json",data:{audId:a,startPageControllerVersion:j.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:b}},function(a){var b={};b.status="200",e(a,b)},d):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+j.START_PAGE_CONTROLLER+".getSysDataSoupVariables",a,b,e,{escape:!1})}function e(a,b,c,d){i.logMessage("In createSystemDataSoup"),"undefined"!=typeof c&&"undefined"!=typeof d?f(c,d,a,b):l.getCurrentValueFromAppSoup("audId",function(c){l.getCurrentValueFromAppSoup("sysDataPlatSupVersion",function(d){i.logMessage("In success callback with aud id = "+c),f(c,d,a,b)},b)},b)}function f(a,b,c,e){i.logMessage("In getSystemDataSoupDefinition with audId = "+a+" and sysDataPlatSupVersion = "+b);var f=function(f,h){if(h.status){i.logMessage("In getSystemDataSoupDefinition callback -> "+f),i.logMessage("Parse json app defns"+f);var j=$j.parseJSON(f);i.logMessage("Parse json app defns done"),$j.each(j,function(a,b){i.logObjectDetails(b)}),k.registerSoup("syncLib_system_data",j,function(){d(a,b,function(){g(a,b,c,e)},e)},e)}else"exception"===h.type?(alert(h.message),i.logMessage("Exception return from getSystemDataSoupDefinition = "+h.message)):i.logMessage("Unknown return from getSystemDataSoupDefinition = "+h.message)};USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getSystemDataSoupDefinition001",contentType:"application/json",data:{audId:a,startPageControllerVersion:j.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:b}},function(a){var b={};b.status="200",f(a,b)},e):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+j.START_PAGE_CONTROLLER+".getSystemDataSoupDefinition",a,b,f,{escape:!1})}function g(a,b,c,d){i.logMessage(j.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables");var e=function(a,b){if(b.status){var e=$j.parseJSON(a);i.logMessage("Parse json table defns done"),k.upsertSoupEntries("syncLib_system_data",e,function(a){c(a)},function(a){d(a)})}else"exception"===b.type?(alert(b.message),i.logMessage("Exception return from getDefsForSObjectMobileTables = "+b.message)):i.logMessage("Unknown return from getDefsForSObjectMobileTables = "+b.message)};USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getDefsForSObjectMobileTables001",contentType:"application/json",data:{audId:a,startPageControllerVersion:j.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:b}},function(a){var b={};b.status="200",e(a,b)},d):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+j.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables",a,b,e,{escape:!1,timeout:12e4})}function h(a){return new Promise(function(b,c){var d=function(a,d){if(d.status){var e=[{path:"Table",type:"string"},{path:"Data",type:"string"}];k.registerSoup("dotsRecordTypes",e,function(){var d=JSON.parse(a).map(function(a){return{Table:a.mobileTableName,Data:JSON.stringify(a.recTypeInfoList)}});k.upsertSoupEntries("dotsRecordTypes",d,function(c){var d={};JSON.parse(a).forEach(function(a){var b={};a.recTypeInfoList.forEach(function(a){b[a.recTypeId]=a.recTypeName}),d[a.mobileTableName]=b}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(d)),b()},function(a){c(a)})},function(a){c(a)})}else"exception"===d.type?(i.logMessage("Exception return from p2mRefreshRecTypeDOTs = "+d.message),c(d.message)):(i.logMessage("Unknown return from p2mRefreshRecTypeDOTs = "+d.message),c(d.message))};USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshRecTypeDOTs001",contentType:"application/json",data:{audId:a,startPageControllerVersion:j.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:"002",connSessJson:"{}"}},function(a){var b={};b.status="200",d(a,b)},function(){d("[]",{status:"OK"})}):Visualforce.remoting.Manager.getAction("mobilecaddy1."+j.START_PAGE_CONTROLLER+".p2mRefreshRecTypeDOTs")?Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+j.START_PAGE_CONTROLLER+".p2mRefreshRecTypeDOTs",a,"002","{}",d,{escape:!1,timeout:12e4}):d("[]",{status:"OK"})})}var i=a("mobileCaddy/mobileLogger"),j=a("mobileCaddy"),k=(a("mobileCaddy/logger"),cordova.require("com.salesforce.plugin.smartstore")),l=(j.require("mobileCaddy/smartStoreUtils"),a("mobileCaddy/appDataUtils"));c.exports={createSystemDataSoup:function(a,b,c,d){e(a,b,c,d)},getRecordTypeDots:h}}),b("mobileCaddy/smartStoreUtils",function(a,b,c){function d(a,b,c){D.soupExists(a,function(d){d?D.soupExists("SnapShot_"+a,function(d){d?i("SnapShot_"+a,function(d){x(d,"SnapShot_"+a,function(){i(a,function(d){D.upsertSoupEntries("SnapShot_"+a,d,b,c)},c)},c)},c):C.logMessageAndThrow("SnapShot Table is missing: SnapShot_"+a)},c):C.logMessageAndThrow("Mobile Table is missing"+a)},c)}function e(a,b,c,d,e){if(0===b.length)d();else{var f=[];$j.each(b,function(a,b){f.push(b[c])}),i(a,function(b){var g=[];$j.each(b,function(a,b){-1!=f.indexOf(b[c])&&g.push(b._soupEntryId)}),0===g.length?d():D.removeFromSoup(a,g,d,e)},e)}}function f(a,b){function c(a){$j.each(a.currentPageOrderedEntries,function(a,b){e.push(b)}),a.currentPageIndex<a.totalPages-1?cordova.require("com.salesforce.plugin.smartstore").moveCursorToNextPage(a,c):cordova.require("com.salesforce.plugin.smartstore").closeCursor(a,d)}function d(){b(e)}var e=[];c(a)}function g(a,b,c){var d=D.buildExactQuerySpec("Name",a,mobileCaddy.QUERY_BUFFER_SIZE);k("syncLib_system_data",d,function(a){C.logMessage("soup definition rows success callback with rec count = "+a.length);var c=[];$j.each(a,function(a,b){C.logMessage("processing record = "),b.Type!=mobileCaddy.STANDING_DATA_OBJECT&&b.Type!=mobileCaddy.DYNAMIC_DATA_OBJECT?(C.logMessage("Record Match"),c.push(b)):C.logMessage("Record does not match")}),b(c)},c)}function h(a,b){C.logMessage("in getQueryAndSoupDefinition");var c=[],d="Select ";$j.each(a,function(a,b){C.logMessage("soup column defn = "),c.push({path:b.Column_Name,type:b.Column_Type}),0!==b.Column_Name.indexOf("_")&&(d+=b.Column_Name+",")}),d=d.substring(0,d.length-1),d+=" From "+a[0].Name,b(d,c)}function i(a,b,c){var d=D.buildAllQuerySpec("_soupEntryId",null,mobileCaddy.QUERY_BUFFER_SIZE);D.querySoup(a,d,function(a){f(a,function(a){b(a)},c)})}function j(a){return new Promise(function(b,c){i(a,function(a){b(a.filter(function(a){return"object"==typeof a}))},function(a){c(a)})})}function k(a,b,c,d){D.querySoup(a,b,function(b){f(b,function(b){C.logMessage("Passing records back to callback for soup = "+a+" and rec count = "+b.length),c(b)},d)},d)}function l(a,b,c){D.runSmartQuery(a,function(a){f(a,function(a){C.logMessage("Passing records back to callback for soup with rec count = "+a.length),b(a)},c)},c)}function m(a,b,c,d,e){if("undefined"==typeof d&&"undefined"==typeof e)return new Promise(function(d,e){var f=D.buildExactQuerySpec(b,c,mobileCaddy.QUERY_BUFFER_SIZE_SL);k(a,f,function(a){d(a)},function(a){e(a)})});var f=D.buildExactQuerySpec(b,c,mobileCaddy.QUERY_BUFFER_SIZE_SL);k(a,f,function(a){d(a)},e)}function n(a,b,c,d,e,f,g){var h=D.buildExactQuerySpec(b,c,mobileCaddy.QUERY_BUFFER_SIZE_SL);k(a,h,function(a){var b=[];$j.each(a,function(a,c){c[d]==e&&b.push(c)}),f(b)},g)}function o(a,b,c){r("Row Mapping PT","Mobile Table Name",function(d){n("syncLib_system_data","MC_Var_String_001","Platform Table Definition",d,a,function(c){1!=c.length&&C.logMessageAndThrow("Should be exactly 1 table defn row for table: "+a+", but we got "+c.length),b(c[0])},c)},c)}function p(a,b,c,d){o(a,function(a){r("Row Mapping PT",b,function(b){c(a[b])},d)},d)}function q(a,b,c,d,e){o(a,function(a){r("Row Mapping PT",b,function(b){a[b]=c,D.upsertSoupEntries("syncLib_system_data",[a],d,e)},e)},e)}function r(a,b,c,d){n("syncLib_system_data","MC_Var_String_001",a,"MC_Var_String_003",b,function(d){1!=d.length&&($j.each(d,function(a,b){C.logObjectDetails(b)}),C.logMessageAndThrow("Must be exactly 1 Row Mapping Record for Sys Data Row Type = "+a+" and Sys Data Row Value = "+b+" found count = "+d.length)),c(d[0].MC_Var_String_004)},d)}function s(a,b,c,d){var e=D.buildExactQuerySpec("MC_Var_String_001",a,mobileCaddy.QUERY_BUFFER_SIZE_SL);k("syncLib_system_data",e,function(d){var e=[];$j.each(b,function(b,c){var f=!1;if($j.each(d,function(a,b){return b.MC_Var_String_003==c?(e.push(b.MC_Var_String_004),void(f=!0)):void 0}),!f)throw"No mapping found for type = "+a+" and value = "+c}),c(e)},d)}function t(a,b,c){s("Row Mapping PT",["Mobile Table Name","Build Order"],function(d){var e=d[0],f=d[1];m("syncLib_system_data","MC_Var_String_001","Platform Table Definition",function(c){var d=[];a==G?(c.sort(function(a,b){var c=0,d=parseInt(a[f]),e=parseInt(b[f]);return isNaN(d)||isNaN(e)||(c=d-e),c}),$j.each(c,function(a,b){d.push(b[e])}),null!==b&&b(d)):($j.each(c,function(a,b){d.push(b[e])}),a==F&&d.sort(),null!==b&&b(d))},c)},c)}function u(a,b,c,d){s("Row Mapping TC",["Parent SOUP Name","Table Column Name","Mobile Column Type","Application Field CRUD","META isNillable","Platform Column Type","Device Value Type","Proxy Ref Field Name"],function(d){var e=d[0],f=d[1],g=d[2],h=d[3],i=d[4],j=d[5],k=d[6],l=d[7];n("syncLib_system_data","MC_Var_String_001","Platform Table Column",e,a,function(a){var d=[];$j.each(a,function(a,c){b==H?d.push(c[f]):b==J?d.push({path:c[f],type:c[g],crud:c[h],nillable:c[i],platColType:c[j],appColType:c[k],proxyRefField:c[l]}):(d.push({path:c[f],type:c[g]}),C.logMessage("path = "+c[f]+" and type = "+c[g]))}),c(d)},function(a){C.logMessage("Error retrieving column names = "+a)})},d)}function v(a,b){b.forEach(function(b){b.path.includes("MC_Proxy_ID")&&localStorage.setItem("proxyField-"+a,b.path)})}function w(a,b){t(G,function(c){var d=c.length;$j.each(c,function(c,e){u(e,I,function(c){D.registerSoup(e,c,function(){q(e,"SOUP Built Date/Time",(new Date).getTime(),function(){v(e,c),p(e,"Snapshot Data Required",function(f){"Yes"==f?D.registerSoup("SnapShot_"+e,c,function(){q(e,"Snapshot SOUP Built Date/Time",(new Date).getTime(),function(){d--,0===d&&a()},b)},function(a){b(a)}):(d--,0===d&&a())},b)},b)},function(a){b(a)})},b)})},b)}function x(a,b,c,d){if(C.logMessage("In delete recs from soup with rec count = "+a.length),0!==a.length){var e=[];$j.each(a,function(a,b){b&&b._soupEntryId&&e.push(b._soupEntryId)}),0!==e.length?D.removeFromSoup(b,e,function(a){C.logMessage("Deleted rec(s) - calling callback"),c(a)},d):c()}else c()}function y(b,c,d,e){var f=a("mobileCaddy/syncRefresh");D.upsertSoupEntries(b,c,function(a){var c=(new Date).getTime();f.addProxyIds(b,a,c,function(a){var f=[];$j.each(a,function(a,d){var e={Mobile_Table_Name:b,CRUD_Operation:"Insert",SOUP_Record_Id:d._soupEntryId,Id:d.Id,LastModifiedDateTime:c};f.push(e)}),D.upsertSoupEntriesWithExternalId("recsToSync",f,"Id",d,e)},e)},e)}function z(a,b,c){var d=b.length,e=0;return new Promise(function(f,g){B(a).then(function(h){$j.each(b,function(i,j){m(a,c,j[c]).then(function(k){if(k.length>0){var l=k[0];for(var n in j)l[n]=j[n];b[i]=l,e++,e>=d&&f(b)}else"Id"==c&&j.Id.length>18?m(a,h,j.Id).then(function(a){if(a.length>0){var c=a[0];for(var h in j)"Id"!=h&&(c[h]=j[h]);b[i]=c,e++,e>=d&&f(b)}else g({status:101107})}):g({status:101107})}).catch(function(a){g(a)})})}).catch(function(a){g(a)})})}function A(b,c,d,e,f){a("mobileCaddy/syncRefresh");z(b,c,d).then(function(a){D.upsertSoupEntriesWithExternalId(b,a,d,function(a){m("recsToSync","Mobile_Table_Name",b,function(c){var d=[];$j.each(a,function(a,e){var f;$j.each(c,function(a,b){return b.Id==e.Id?void(f=b):void 0});var g;if("undefined"!=typeof f)if(f.Current_Connection_Session&&"undefined"!=typeof f.Current_Connection_Session)switch(f.CRUD_Operation){case"Insert":case"InsertUpdate":g="InsertUpdate";break;default:g="UpdateUpdate"}else g=f.CRUD_Operation;else g="Update";var h={Mobile_Table_Name:b,SOUP_Record_Id:e._soupEntryId,Id:e.Id,CRUD_Operation:g,LastModifiedDateTime:e.SystemModstamp};("InsertUpdate"==g||"UpdateUpdate"==g)&&(h.Current_Connection_Session=f.Current_Connection_Session),d.push(h)}),D.upsertSoupEntriesWithExternalId("recsToSync",d,"Id",e,f)},f)},f)}).catch(function(a){f(a)})}function B(a){return new Promise(function(b){var c=localStorage.getItem("proxyField-"+a);c?b(c):u(a,H,function(c){var d=null;c.forEach(function(b){b.includes("MC_Proxy_ID")&&(d=b,localStorage.setItem("proxyField-"+a,b))}),b(d)},function(a){b(null)})})}var C=a("mobileCaddy/mobileLogger"),D=cordova.require("com.salesforce.plugin.smartstore"),E=0,F=1,G=2,H=0,I=1,J=2;c.exports={NONE:E,ALPHA:F,BUILD:G,listMobileTables:function(a,b,c){t(a,b,c)},LIST:H,BUILD_OBJECT:I,FULL:J,listMobileTableColumns:function(a,b,c,d){u(a,b,c,d)},queryMobileTable:function(a,b,c,d,e){return m(a,b,c,d,e)},buildMobileTables:function(a,b){w(a,b)},getProxyFieldName:function(a){return B(a)},getSysDataRowMapColHeading:function(a,b,c,d){r(a,b,c,d)},getSysDataRowMapColHeadings:function(a,b,c,d){s(a,b,c,d)},getTableDefnColumnValue:function(a,b,c,d){p(a,b,c,d)},setTableDefnColumnValue:function(a,b,c,d,e){q(a,b,c,d,e)},queryMobileTableWithAnd:function(a,b,c,d,e,f,g){n(a,b,c,d,e,f,g)},smartQuerySoupRecordsWithQuerySpec:function(a,b,c){l(a,b,c)},insertRecords:function(a,b,c,d){y(a,b,c,d)},updateRecordsWithExternalId:function(a,b,c,d,e){A(a,b,c,d,e)},markSoupToSync:function(a,b,c){var d=D.buildExactQuerySpec("Type",mobileCaddy.DYNAMIC_DATA_OBJECT,mobileCaddy.QUERY_BUFFER_SIZE_SL);k("syncLib_system_data",d,b,function(d){for(var e=0;e<d.length;e++)if(d[e].Name==a){d[e].Refresh_Indicator="Once",D.upsertSoupEntries("syncLib_system_data",[d[e]],b,c);break}},c)},emptySoup:function(a,b,c){var d=mobileCaddy.require("mobileCaddy/smartStoreUtils");D.removeSoup(a,function(){d.createSoup(a,b,c)},c)},emptySoupPromise:function(b){return new Promise(function(c,d){var e=mobileCaddy.require("mobileCaddy/smartStoreUtils"),f=a("mobileCaddy/logger");D.removeSoup(b,function(){e.createSoup(b,function(){c()},function(a){f.error("emptySoupPromise",a),d(a)})},function(a){f.error("emptySoupPromise",a),d(a)})})},deleteSoup:function(b){return new Promise(function(c,d){var e=(mobileCaddy.require("mobileCaddy/smartStoreUtils"),a("mobileCaddy/logger"));D.removeSoup(b,function(){e.log("deleteSoup",b),c()},function(a){e.error("deleteSoup",a),d(a)})})},createSoup:function(a,b,c){g(a,function(d){h(d,function(d,e){D.registerSoup(a,e,function(){b()},c)},c)},c)},querySoupRecords:function(a,b,c){i(a,b,c)},querySoupRecsPromise:function(a){return j(a)},querySoupRecordsWithQuerySpec:function(a,b,c,d){k(a,b,c,d)},compareVersions:function(a,b){var c=cordova.require("com.salesforce.plugin.smartstore").buildExactQuerySpec("Name",mobileCaddy.VERSION_ID,mobileCaddy.QUERY_BUFFER_SIZE);k("syncLib_system_data",c,function(c){simpleMessageSL("Version in soup = "+c[0].Value),getVersion(function(b){simpleMessageSL("Version in Salesforce = "+b),a()},b)},b)},deleteRecordsForExternalId:function(a,b,c,d,f){e(a,b,c,d,f)},deleteRecordsFromSoup:function(a,b,c,d){x(a,b,c,d)},refreshSnapshot:function(a,b,c){d(a,b,c)}}}),b("mobileCaddy/appDataUtils",function(a,b,c){function d(a,b,c){var d=localStorage.getItem("appSoup-"+a);return"undefined"==typeof b&&"undefined"==typeof c?new Promise(function(b){d?b(d):e(a).then(function(c){localStorage.setItem("appSoup-"+a,c),b(c)})}):void(d?b(d):e(a,function(c){localStorage.setItem("appSoup-"+a,c),b(c)},c))}function e(a,b,c){var d=g.buildExactQuerySpec("Name",a,mobileCaddy.QUERY_BUFFER_SIZE);return"undefined"==typeof b&&"undefined"==typeof c?new Promise(function(a,b){h.querySoupRecordsWithQuerySpec("appSoup",d,function(b){a(b[0]?b[0].CurrentValue:b[0])},function(a){b(a)})}):void h.querySoupRecordsWithQuerySpec("appSoup",d,function(a){"undefined"!=typeof a[0]?b(a[0].CurrentValue):c()},c)}function f(a,b,c){return new Promise(function(d,e){var f=g.buildExactQuerySpec("Name",a,mobileCaddy.QUERY_BUFFER_SIZE);h.querySoupRecordsWithQuerySpec("appSoup",f,function(a){a.length>0?(a[0][c]=b,g.upsertSoupEntries("appSoup",a,function(a){d(a)},function(a){e(a)})):d()},function(a){e(a)})})}var g=(a("mobileCaddy/mobileLogger"),cordova.require("com.salesforce.plugin.smartstore")),h=a("mobileCaddy/smartStoreUtils");c.exports={getCurrentValueFromAppSoup:function(a,b,c){return e(a,b,c)},getCachedCurrentValueFromAppSoup:function(a,b,c){return d(a,b,c)},updateNewValueInAppSoup:function(a,b){return f(a,b,"NewValue")},updateCurrentValueInAppSoup:function(a,b){return f(a,b,"CurrentValue")}}}),b("mobileCaddy/syncRefresh",function(a,b,c){function d(a,b,c){var d={};A.logMessage("Parse json date time");var f=new RegExp("\n","g");a=a.replace(f,"\\n"),f=new RegExp("\r","g"),a=a.replace(f,"");var g=$j.parseJSON(a);A.logMessage("Parse json date time done");var h={},i={},j=g.mt;null===j&&A.logMessageAndThrow("Mobile Table (tag 'mt') empty in p2mRefresh response: "+a);var k=C.buildExactQuerySpec("Mobile_Table_Name",j,mobileCaddy.QUERY_BUFFER_SIZE);z.querySoupRecordsWithQuerySpec("recsToSync",k,function(a){$j.each(a,function(a,b){if("Insert"==b.CRUD_Operation||"InsertUpdate"==b.CRUD_Operation)h[b.Id]=1;else{if("Update"!=b.CRUD_Operation&&"UpdateUpdate"!=b.CRUD_Operation)return void A.logMessageAndThrow("RTS contains record with non support CRUD Operation"+b);i[b.Id]=1}}),z.getProxyFieldName(j).then(function(f){var k=[],l=[];if($j.each(g.records,function(a,b){var c=!0;null!==b.recordData.MC_Proxy_ID__c&&h.hasOwnProperty(b.recordData[f])&&(c=!1),c&&i.hasOwnProperty(b.recordData.Id)&&(c=!1),c&&k.push(b.recordData)}),g.ds){var m=g.ds.oq.concat(g.ds.sd.concat(g.ds.hd.concat(g.ds.sh)));m.forEach(function(a){i.hasOwnProperty(a)||l.push({Id:a})})}var n=C.buildExactQuerySpec("Mobile_Table_Name",j,mobileCaddy.QUERY_BUFFER_SIZE);z.querySoupRecordsWithQuerySpec("recsToSync",n,function(f){f.length==a.length?z.deleteRecordsForExternalId(j,l,"Id",function(){C.upsertSoupEntriesWithExternalId(j,k,"Id",function(){C.soupExists("SnapShot_"+j,function(a){a?z.deleteRecordsForExternalId("SnapShot_"+j,l,"Id",function(){C.upsertSoupEntriesWithExternalId("SnapShot_"+j,k,"Id",function(){y.checkForMigrateToInfo(g),e(g.platAuthUrl),d.status=0,d.cs=g.cs,d.cp=g.cp,d.lastRefreshDatetime=g.lastRefreshDatetime,b(d)},c)},c):(y.checkForMigrateToInfo(g),e(g.platAuthUrl),d.status=0,d.lastRefreshDatetime=g.lastRefreshDatetime,d.cs=g.cs,d.cp=g.cp,b(d))},c)},c)},c):(d.status=0,d.mc_add_status=1,d.cs=g.cs,d.cp=g.cp,d.lastRefreshDatetime=g.lastRefreshDatetime,b(d))},c)})},c)}function e(a){a||(a=""),x.updateCurrentValueInAppSoup("platAuthUrl",a).catch(function(b){B.error("setPlatAuthUrl",a,b)})}function f(a,b,c,e,g,h,i,j){var k={},l="newBatch"==e?!0:!1;l&&(e=1),A.logMessage("Refreshing table = "+a),p("Sync - Refresh","P2M RE Process Called",e,g,h,function(g){if(!c){var h=JSON.parse(g.connSessJson);h.initialSync=!0,g.connSessJson=JSON.stringify(h)}if(l){var m=JSON.parse(g.connSessJson);m.firstBatch=!1,g.connSessJson=JSON.stringify(m)}x.getCachedCurrentValueFromAppSoup("audId",function(h){A.logMessage("Using app data aud id = "+h),x.getCachedCurrentValueFromAppSoup("syncRefreshVersion",function(m){A.logMessage("Using app data syncRefreshVersion = "+m),z.getTableDefnColumnValue(a,"Last Refresh Date/Time",function(n){n&&"null"!=n||(n=0),A.logMessage("Using lastRefreshDatetime = "+n);var o=new Date;if(o-b>n||e>1||l){var p="",q=function(e,h){h.status?d(e,function(d){z.setTableDefnColumnValue(a,"Last Refresh Date/Time",d.lastRefreshDatetime,function(){var h="P2M RE Records Processed";"Connection_Session__mc"==a&&(h="P2M Conn_Sess Records Processed"),1==d.mc_add_status&&(h="P2M RE Abandoned"),g.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=h,g.connSessionRec.Id=d.cs,D.postProcessConnectionSession(g.connSessionRec,function(){var d=JSON.parse(e);c?D.maybeSyncConnSess(g.connSessionRec,function(){d["Session Number"]&&d["Session Number"]<d["Total Sessions"]?f(a,b,c,d["Session Number"]+1,d["Total Sessions"],d.CsPId,i,j):d.moreBatches?f(a,b,c,"newBatch",1,null,i,j):(k.status=E,i(k))},j):d["Session Number"]&&d["Session Number"]<d["Total Sessions"]?f(a,b,c,d["Session Number"]+1,d["Total Sessions"],d.CsPId,i,j):d.moreBatches?f(a,b,c,"newBatch",1,null,i,j):(k.status=E,i(k))},j)},j)}):("exception"===h.type&&B.error("p2mRefresh",a,h.message,h.where),D.cleanConnectionSessionVFEvent(h,g,function(a){k.status=F,k.mc_add_status=a.mc_add_status,i(k)},j))};USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshTable001",contentType:"application/json",data:{audId:h,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:m,mobileTableName:a,deviceRefreshIds:[],lastRefreshDateTime:n,thirdPartyJson:p,connSessJson:g.connSessJson}},function(a,b){"undefined"==typeof b&&(b={},b.status="200"),q(a,b)},j):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".p2mRefreshTable",h,m,a,[],n,p,g.connSessJson,q,{buffer:!1,escape:!1,timeout:12e4})}else k.status=100402,k.status=100497,i(k)},j)},j)},j)},j)}function g(a,b,c,d,e){x.getCachedCurrentValueFromAppSoup("audId",function(e){var f="PROXY%"+a+"%"+c+"%"+b+"%"+e;d(f)},e)}function h(a,b,c,d,e){z.getProxyFieldName(a).then(function(f){x.getCachedCurrentValueFromAppSoup("audId",function(g){$j.each(b,function(b,d){var e="PROXY%"+a+"%"+c+"%"+d._soupEntryId+"%"+g;d.Id=e,d[f]=e}),C.upsertSoupEntries(a,b,function(a){d(a)},e)},e)}).catch(function(a){e(a)})}function i(a,b,c,d){var e;if("Throw Exception"==d)throw B.error("nullHandler - NULL value found",a,b,c.Id),"NULL value found for field "+b+" in Mobile Table "+a+" with Id = "+c.Id;return"Return NULL"==d?e=null:"Return Empty String"==d&&(e=""),e}function j(a,b,c,d,e,f,g,h,i,j,n){var o={MobileTable:a,connSessProxyId:j,records:[]};g.forEach(function(g){for(var j,n=0;n<h.length;++n)if(h[n].Id===g.Id){j=h[n];break}if(j){var p={RTSRowNum:g._soupEntryId,RecordCRUD:k(g.CRUD_Operation),fields:[]};switch(p.RecordCRUD){case"I":case"T":p=l(p,a,b,c,d,e,f,j),o.records.push(p);break;case"D":case"U":case"Q":for(var q,r=0;r<i.length;++r)if(i[r].Id===g.Id){q=i[r];break}q?(p=m(p,a,b,c,d,e,f,j,q),o.records.push(p)):B.error("createUpdateJson Missing snapShot",a,j.Id);break;default:B.error("createUpdateJson unknown CRUD",a,g.Id,g.CRUD_Operation)}}else B.error("createUpdateJson Missing primary",a,g.Id)
}),n(JSON.stringify(o))}function k(a){switch(a){case"Insert":return"I";case"InsertDelete":return"T";case"Update":return"U";case"UpdatetDelete":return"Q";case"Delete":return"D";default:return null}}function l(a,b,c,d,e,f,g,h){for(var j in h){var k={name:j};if("mobilecaddy1__Error_Text__c"==j)k.value=JSON.stringify(h[j]),a.fields.push(k);else if("_soupEntryId"!=j&&"_soupLastModifiedDate"!=j){var l,m={};m[d]=j;var n=_.findWhere(c,m);if(null===h[j])fieldNullHandler=n[f],l=i(b,j,h,fieldNullHandler);else if(l=h[j],n){var o=n[g];"M2P UP Unquoted"!=o||"true"!=l&&"false"!=l||(l="true"==l)}k.value=l,a.fields.push(k)}}return a}function m(a,b,c,d,e,f,g,h,j){var k=!1;for(var l in h)if("_soupEntryId"!=l&&"_soupLastModifiedDate"!=l){var m={name:l};if(h[l]!=j[l]||"SystemModstamp"==l){k=!0;var n,o,p={};p[d]=l;var q=_.findWhere(c,p);if(null===h[l])fieldNullHandler=q[f],n=i(b,l,h,fieldNullHandler),o=i(b,l,j,fieldNullHandler);else if(n=h[l],o=j[l],q){var r=q[g];"M2P UP Unquoted"!=r||"true"!=n&&"false"!=n||(n="true"==n),"M2P UP Unquoted"!=r||"true"!=o&&"false"!=o||(o="true"==o)}m.previousValue=o,m.value=n,a.fields.push(m)}}return k?(a.fields.push({name:"Id",previousValue:j.Id,value:j.Id}),a):[]}function n(a,b,c,d){$j.each(a,function(a,c){c.Current_Connection_Session=b}),C.upsertSoupEntriesWithExternalId("recsToSync",a,"Id",c,d)}function o(a,b,c,d,e){var f=[];$j.each(b,function(a,b){var d={};$j.each(c,function(a,c){if(b.Id==c.Id&&"Insert"==b.CRUD_Operation)for(var e in c)"_soupEntryId"!=e&&"_soupLastModifiedDate"!=e&&(d[e]=c[e])}),_.isEmpty(d)||f.push(d)}),0===f.length?d():z.getProxyFieldName(a).then(function(b){C.upsertSoupEntriesWithExternalId("SnapShot_"+a,f,b,d,e)})}function p(b,c,d,e,f,g,h){var i=a("mobileCaddy/geolocation"),j={};i.getLocation(function(a){var i={mobilecaddy1__Session_Type__c:b,mobilecaddy1__Mobile_Process_Status__c:c,SystemModstamp:(new Date).getTime()},k=a.ErrorNumber;0!==k?i.mobilecaddy1__Session_Created_Location_Error__c=a.Error:(i.Session_Created_Location__Longitude__s=a.Latitude,i.Session_Created_Location__Latitude__s=a.Longitude),s("Connection_Session__mc",i,function(b){var c=new Date,h={"Sync Session Proxy ID":null,"Total Sessions":e,"Session Number":d,"Device Call Date/Time":c.getTime(),"Connection Session Proxy ID":b.proxyId};f&&(h.CsPId=f),0!==k?h.ErrorNumber=k:(h["Location Long"]=a.Longitude,h["Location Lat"]=a.Latitude),j.status=0,j.connSessionRec=b.insertedRecord,j.connSessProxyId=b.proxyId;var i={version:"NULL"};window.device&&(i=window.device),x.getCurrentValueFromAppSoup("containerVersion").then(function(a){h.containerVsn=a,h.OSVsn=i.version,j.connSessJson=JSON.stringify(h),g(j)}).catch(function(a){B.error("buildConnectionSession - Could not get containerVsn",a),h.OSVsn=i.version,j.connSessJson=JSON.stringify(h),g(j)})},h)},h)}function q(a){return new Promise(function(b,c){var d=3e4,e={},f=function(a){b(a)},g=function(a){c(a)},h=C.buildExactQuerySpec("Mobile_Table_Name",a,mobileCaddy.QUERY_BUFFER_SIZE);z.querySoupRecordsWithQuerySpec("recsToSync",h,function(b){if(0!==b.length){var c=!1;"Connection_Session__mc"!=a&&b.length>d&&(c=!0);var h=[];c?(h=_.sortBy(b,"_soupLastModifiedDate"),h=h.slice(0,d)):h=b,z.querySoupRecords(a,function(b){z.querySoupRecords("SnapShot_"+a,function(c){z.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(d){var i=d[0],k=d[1],l=d[2],m=d[3],n=d[4];z.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",i,a,function(d){function i(a){return _.find(b,function(b){return b.Id==a})}var p=[];return _.each(h,function(a){i(a.Id,b)&&p.push(a)}),_.isEmpty(p)?void z.setTableDefnColumnValue(a,"Last Sync Date/Time",(new Date).getTime(),function(){e.status=G,e.mc_add_status=H,f(e)},g):void j(a,d,k,l,m,n,p,b,c,"",function(c){x.getCachedCurrentValueFromAppSoup("audId",function(d){x.getCachedCurrentValueFromAppSoup("syncRefreshVersion",function(i){o(a,h,b,function(){var b=function(a,b){e.result=a,e.event=b,f(e)};c=c.replace(/: undefined/g,': "undefined"'),USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:d,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:i,mobileTableName:a,jsonRecords:c}},function(a,c){"undefined"==typeof c&&(c={},c.status="200"),b(a,c)},g):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",d,i,a,c,JSON.stringify({"Session Number":1,"Location Long":10,"Location Lat":10,"Total Sessions":1,"Device Call Date/Time":(new Date).getTime(),"Connection Session Proxy ID":"1",ErrorNumber:2}),b,{buffer:!1,escape:!1,timeout:3e4})},g)},g)},g)},g)},g)},g)},g)},g)}else z.setTableDefnColumnValue(a,"Last Sync Date/Time",(new Date).getTime(),function(){e.status=G,e.mc_add_status=H,f(e)},g)},g)})}function r(a,b,c,d){var e={};p("Sync - Update","M2P Process Called",1,1,null,function(f){var g=C.buildExactQuerySpec("Mobile_Table_Name",a,mobileCaddy.QUERY_BUFFER_SIZE);z.querySoupRecordsWithQuerySpec("recsToSync",g,function(g){if(0!==g.length){var h=!1;"Connection_Session__mc"!=a&&g.length>b&&(h=!0);var i=[];h?(i=_.sortBy(g,"_soupLastModifiedDate"),i=i.slice(0,b)):i=g,n(i,f.connSessProxyId,function(b){z.querySoupRecords(a,function(g){z.querySoupRecords("SnapShot_"+a,function(i){z.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(k){var l=k[0],m=k[1],n=k[2],p=k[3],q=k[4];z.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",l,a,function(k){j(a,k,m,n,p,q,b,g,i,f.connSessProxyId,function(i){x.getCachedCurrentValueFromAppSoup("audId",function(j){x.getCachedCurrentValueFromAppSoup("syncRefreshVersion",function(k){o(a,b,g,function(){var b=function(b,g){g.status?D.processM2PUpdateResponse(b,i,function(b){f.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="Connection_Session__mc"==a?"M2P Conn_Sess Records Processed":"M2P Records Processed",f.connSessionRec.Id=b.csId,D.postProcessConnectionSession(f.connSessionRec,function(){h?(e.status=G,e.mc_add_status="more-to-sync",c(e)):D.maybeSyncConnSess(f.connSessionRec,function(){e.status=G,c(e)},d)},d)},d):"exception"===g.type?(e.status=G,e.mc_add_status=J,c(e),B.error("m2pUpdate",a,g.message,g.where)):(e.status=G,e.mc_add_status=K,c(e),B.error("m2pUpdate",a,g.message,g.where))};i=i.replace(/: undefined/g,': "undefined"'),USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:j,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:k,mobileTableName:a,jsonRecords:i,connSessJson:f.connSessJson}},function(a,c){"undefined"==typeof c&&(c={},c.status="200"),b(a,c)},d):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",j,k,a,i,f.connSessJson,b,{buffer:!1,escape:!1,timeout:3e4})},d)},d)},d)},d)},d)},d)},d)},d)},d)}else z.setTableDefnColumnValue(a,"Last Sync Date/Time",(new Date).getTime(),function(){e.status=G,e.mc_add_status=H,c(e)},d)},d)},d)}function s(a,b,c,d){var e={},f=new Date;z.getProxyFieldName(a).then(function(h){C.upsertSoupEntries(a,[b],function(b){var i=b[0];g(a,i._soupEntryId,f.getTime(),function(b){i.Id=b,i[h]=b,C.upsertSoupEntries(a,[i],function(a){e.status=0,e.proxyId=b,e.insertedRecord=a[0],c(e)},d)},d)},d)})}function t(a,b){var c={},d=navigator.appVersion.includes("Electron");if(d||navigator&&navigator.connection&&"undefined"!=typeof Connection)if(d||navigator.connection.type!=Connection.NONE)if("undefined"==typeof Visualforce){B.log("Visualforce not currently defined");var e=window.location.pathname;$j.get(e).done(function(d){B.log("Startpage re-fetched",e);var f='"(\\S+VFRemote.js)"',g=new RegExp(f),h=g.exec(d);if(h[0]){var i=h[1];$j.getScript(i).done(function(){B.log("remote script fetched",i);var c=new Function($j("script")[2].innerHTML);c(),B.log("set up Visualforce ref"),u(a,b)}).fail(function(b,d,e){B.error("vfRemote Load Error",h[0],e),c.status=K,a(c)})}else B.error("heartBeat Could not find VFRemote src",e),c.status=K,a(c)}).fail(function(b,d,f){B.error("Startpage Load Error",e,f),c.status=K,a(c)})}else u(a,b);else c.status=L,a(c);else c.status=localStorage.connection?localStorage.connection:M,a(c)}function u(a){var b={};Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".heartBeat",function(c,d){d.status?(b.status=I,a(b)):"exception"===d.type?v(function(){A.logMessage("refresh token refreshed in heartbeat"),b.status=N,a(b)},function(){b.status=J,a(b)}):(b.status=K,a(b))},{escape:!1,timeout:3e4})}function v(a,b){z.querySoupRecords("appSoup",function(c){var d={};c.forEach(function(a){d[a.Name]=a.CurrentValue}),w(d,a,b)},function(a){b(a)})}function w(b,c,d){var e=a("mobileCaddy/mobileLogger"),f=(cordova.require("com.salesforce.plugin.smartstore"),"https://mobilecaddy.secure.force.com/apex/ProxyToken"),g="grant_type=refresh_token&identity_url="+b.identityUrl+"&client_id="+b.clientId+"&refresh_token="+b.refreshToken+"&orgId="+b.orgId+"&audId="+b.audId+"&userId="+b.userId;e.logMessage("data: "+g),$j.ajax({type:"POST",url:f,cache:!1,processData:!1,data:g,success:function(a){e.logMessage("Changing vf access token from "+Visualforce.remoting.oauthAccessToken+" to "+a.access_token),Visualforce.remoting.oauthAccessToken=a.access_token,Visualforce.remoting.last.refresh(function(){x.updateCurrentValueInAppSoup("accessToken",a.access_token).then(function(){e.logMessage("Updated accessToken in appSoup"),c(a.access_token)}).catch(function(a){d(a)})},function(a){d(a)})},error:function(a){e.logMessage("failed to refresh access token "+JSON.stringify(a)),d(a)},dataType:"json",beforeSend:function(){}})}var x=a("mobileCaddy/appDataUtils"),y=a("mobileCaddy/vsnUtils"),z=a("mobileCaddy/smartStoreUtils"),A=a("mobileCaddy/mobileLogger"),B=a("mobileCaddy/logger"),C=cordova.require("com.salesforce.plugin.smartstore"),D=a("mobileCaddy/connSessUtils"),E=100500,F=100402,G=100300,H=100310,I=100100,J=100101,K=100102,L=100103,M=100104,N=100105;c.exports={refreshToken:function(a,b){v(a,b)},genProxyId:function(a,b,c,d,e){g(a,b,c,d,e)},addProxyIds:function(a,b,c,d,e){h(a,b,c,d,e)},P2M_REFRESH_OK:E,p2mRefreshTable:function(a,b,c,d,e,g,h,i){f(a,b,c,d,e,g,h,i)},buildConnectionSession:function(a,b,c,d,e,f,g){p(a,b,c,d,e,f,g)},M2P_UPDATE_OK:G,M2P_NO_RECS_TO_SYNC:H,m2pUpdateMobileTable:function(a,b,c,d){r(a,b,c,d)},m2pRecoveryUpdateMobileTable:function(a){return q(a)},HEARTBEAT_OK:I,HEARTBEAT_EXCEPTION:J,HEARTBEAT_FAILURE:K,HEARTBEAT_NO_CONNECTION:L,HEARTBEAT_NOT_DEVICE:M,HEARTBEAT_REFRESHED_OK:N,heartBeat:function(a,b){t(a,b)},handleRefreshResponse:function(a){return new Promise(function(b,c){d(a,function(){b()},function(a){c(a)})})},createUpdateJson:j}}),b("mobileCaddy/connSessUtils",function(a,b,c){function d(b,c){var d=a("mobileCaddy/smartStoreUtils"),e=100498;d.querySoupRecords("recsToSync",function(a){for(var d=null,f=null,g=0;g<a.length;g++)if(null!==a[g].Current_Connection_Session&&"undefined"!=typeof a[g].Current_Connection_Session){d=a[g].Current_Connection_Session,f=a[g];break}if(null!==d&&"undefined"!=typeof d){var h=(new Date).getTime(),i=f._soupLastModifiedDate+3e4;if(h>i)b(d);else{var j={};j.status=e,c(j)}}else b(d)},c)}function e(b,c,d){var e=a("mobileCaddy/syncRefresh"),i=a("mobileCaddy/appDataUtils"),j=a("mobileCaddy/connSessUtils"),k=a("mobileCaddy/smartStoreUtils"),l=a("mobileCaddy/logger");e.buildConnectionSession("Status Check","M2P SC Status Check Requested",1,1,null,function(a){e.heartBeat(function(m){m.status==e.HEARTBEAT_OK||m.status==e.HEARTBEAT_NOT_DEVICE||m.status==e.HEARTBEAT_REFRESHED_OK?i.getCachedCurrentValueFromAppSoup("audId",function(e){i.getCachedCurrentValueFromAppSoup("syncRefreshVersion",function(i){var j=function(e,i){if(i.status){var j=JSON.parse(e);"Received Processed"==j.cs_fc_sc?f(a,j,c,d):r(b,function(){k.queryMobileTable("Connection_Session__mc","mobilecaddy1__MC_Proxy_ID__c",b,function(b){if(b.length>0){var e=b[0];"Received Not Processed"==j.cs_fc_sc?g(e,a,j,c,d):h(e,a,j,c,d)}else c({status:w})},d)},d)}else l.error("csStatusCheck",i.message),c({status:x})},m=a.connSessJson,n=localStorage.getItem("lastErrorLog");n&&(localStorage.removeItem("lastErrorLog"),m=JSON.parse(m),m.lastErrorLog=n,m=JSON.stringify(m)),USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pCSStatusCheck001",contentType:"application/json",data:{audId:e,syncRefreshDataVersion:i,statusCheckCSProxyId:b,connSessJson:m,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(a,b){"undefined"==typeof b&&(b={},b.status="200"),j(a,b)},function(a){l.error("err -> "+JSON.stringify(a)),d(a)}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pCSStatusCheck",e,i,b,m,j,{buffer:!1,escape:!1,timeout:3e4})},d)},d):j.cleanConnectionSessionHeartBeat(m,a,function(a){c({status:w,mc_add_status:a.mc_add_status})},d)},d)},d)}function f(b,c,d,e){var f=a("mobileCaddy/connSessUtils"),g=a("mobileCaddy/logger");try{i(c.cs_fc_jr,function(){b.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P UP Received - Records Processed",b.connSessionRec.SystemModstamp=(new Date).getTime(),b.connSessionRec.mobilecaddy1__Status__c="Closed",b.connSessionRec.Id=c.cs_sc_sf,f.postProcessConnectionSession(b.connSessionRec,function(){d({status:w})},e)},e)}catch(h){g.error("processM2PUpdateResponse",h),e("processM2PUpdateResponse-error")}}function g(b,c,d,e,f){var g=a("mobileCaddy/connSessUtils");b.mobilecaddy1__Mobile_Process_Status__c="M2P UP Failed - RTS Cleared",b.mobilecaddy1__Session_Type__c="Sync Update",b.mobilecaddy1__Status__c="Closed",b.SystemModstamp=(new Date).getTime(),b.Id=d.cs_fc_sf,g.postProcessConnectionSession(b,function(){c.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",c.connSessionRec.SystemModstamp=(new Date).getTime(),c.connSessionRec.mobilecaddy1__Status__c="Closed",c.connSessionRec.Id=d.cs_sc_sf,g.postProcessConnectionSession(c.connSessionRec,function(){e({status:w})},f)},f)}function h(b,c,d,e,f){var g=a("mobileCaddy/connSessUtils"),h=a("mobileCaddy/smartStoreUtils");h.deleteRecordsFromSoup([b],"Connection_Session__mc",function(){c.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",c.connSessionRec.SystemModstamp=(new Date).getTime(),c.connSessionRec.mobilecaddy1__Status__c="Closed",c.connSessionRec.Id=d.cs_sc_sf,c.connSessionRec.mobilecaddy1__Session_Type__c="Status Check",g.postProcessConnectionSession(c.connSessionRec,function(){e({status:w})},f)},f)}function i(b,c,d,e){e||(e=d,d=c,c="{}");var f=a("mobileCaddy/smartStoreUtils"),g=(cordova.require("com.salesforce.plugin.smartstore"),a("mobileCaddy/logger")),h=a("mobileCaddy/vsnUtils"),i=1;b=b.replace(/,}/g,"}");var r=JSON.parse(b),s=r.mt,t=void 0!==r.is?r.is:[],u=void 0!==r.id?r.id:[],v=void 0!==r.us?r.us:[],w=void 0!==r.ifmf?r.ifmf:[],x=void 0!==r.ufmf?r.ufmf:[],y=[],z=[],A=[],B=[],C=[],D=[],E=[],F=[],G=[],H=[];if(t=t.concat(u),"undefined"==typeof r.if)G=[];else if("undefined"==typeof r.if.if)G=r.if;else{i=2;var I=r.if.if.map(function(a){var b=void 0!==r.ifbe?r.ifbe:"K";return{pd:a,fbe:b}}),J=r.if.ifv.map(function(a){var b=void 0!==r.ifvbe?r.ifvbe:"K";return{pd:a,fbe:b}}),K=r.if.icv.map(function(a){var b=void 0!==r.icvbe?r.icvbe:"K";return{pd:a,fbe:b}});G=I.concat(J.concat(K))}l(c,t,G,w).then(function(a){if(G=a,"undefined"==typeof r.uf)H=[];else if("undefined"==typeof r.uf.uf)H=r.uf;else{i=2;var b=r.uf.uf.map(function(a){var b=void 0!==r.ufbe?r.ufbe:"K";return{Id:a,fbe:b}}),c=r.uf.usv.map(function(a){var b=void 0!==r.usvbe?r.usvbe:"K";return{Id:a,fbe:b}}),d=r.uf.sdf.map(function(a){var b=void 0!==r.sdfbe?r.sdfbe:"K";return{Id:a,fbe:b}}),e=r.uf.hdf.map(function(a){var b=void 0!==r.hdfbe?r.hdfbe:"K";return{Id:a,fbe:b}}),f=r.uf.ufv.map(function(a){var b=void 0!==r.ufvbe?r.ufvbe:"K";return{Id:a,fbe:b}}),g=r.uf.ucv.map(function(a){var b=void 0!==r.ucvbe?r.ucvbe:"K";return{Id:a,fbe:b}});H=b.concat(c.concat(d.concat(e.concat(f.concat(g)))))}return m("SnapShot_"+s)}).then(function(a){return F=a,m(s)}).then(function(a){f.queryMobileTable("recsToSync","Mobile_Table_Name",s,function(b){for(var c in b)if(b[c].Current_Connection_Session==r.cp){var l=!1,m={},u={},I="";switch(b[c].CRUD_Operation){case"Insert":case"InsertUpdate":for(var J in t)if(b[c].Id==t[J].pd){if(t[J].crud=b[c].CRUD_Operation,u=j(t[J],a),"Insert"==b[c].CRUD_Operation){switch(r.stbe){case"D":E.push(u);break;default:if("U"==t[J].pc){if(u.Id=t[J].Id,"undefined"!=typeof t[J].an&&("undefined"!=typeof t[J].nf?u[t[J].nf]=t[J].an:u.Name=t[J].an),"undefined"!=typeof t[J].lu)for(var K in t[J].lu)t[J].lu.hasOwnProperty(K),u[K]=t[J].lu[K];B.push(u),D.push(u)}}z.push(b[c]._soupEntryId)}else{if(u.Id=t[J].Id,"undefined"!=typeof t[J].an&&("undefined"!=typeof t[J].nf?u[t[J].nf]=t[J].an:u.Name=t[J].an),"undefined"!=typeof t[J].lu)for(var L in t[J].lu)t[J].lu.hasOwnProperty(L),u[L]=t[J].lu[L];B.push(u);var M=j(t[J],F);M.Id=t[J].Id,D.push(M),m=b[c],m.Current_Connection_Session=null,m.CRUD_Operation="Update",m.Id=t[J].Id,y.push(m)}l=!0;break}if(!l)for(J in G)if(b[c].Id==G[J].pd){if(G[J].crud=b[c].CRUD_Operation,"Insert"==b[c].CRUD_Operation)switch(I="K",I=1==i?k(0,G[J].fl,r):G[J].fbe){case"K":m=b[c],m.Current_Connection_Session=null,y.push(m);break;case"R":break;default:u=j(G[J],a),E.push(u),z.push(b[c]._soupEntryId)}else"InsertUpdate"==b[c].CRUD_Operation&&(m=b[c],m.Current_Connection_Session=null,m.CRUD_Operation="Insert",y.push(m));l=!0;break}if(!l)for(J in w)if(b[c].Id==w[J].pd){if(w[J].crud=b[c].CRUD_Operation,"Insert"==b[c].CRUD_Operation)switch(w[J].fbe){case"K":m=b[c],m.Current_Connection_Session=null,y.push(m);break;case"R":break;default:u=j(w[J],a),E.push(u),z.push(b[c]._soupEntryId)}else"InsertUpdate"==b[c].CRUD_Operation&&(m=b[c],m.Current_Connection_Session=null,m.CRUD_Operation="Insert",y.push(m));l=!0;break}break;case"Update":case"UpdateUpdate":for(J in v)if(b[c].Id==v[J].Id){if(v[J].crud=b[c].CRUD_Operation,"Update"==b[c].CRUD_Operation){switch(u=j(v[J],a),r.stbe){case"D":E.push(u);break;default:if("M"==v[J].pc&&(u.SystemModstamp=new Date(v[J].sm)),"undefined"!=typeof v[J].lu)for(var N in v[J].lu)v[J].lu.hasOwnProperty(N)&&(u[N]=v[J].lu[N]);A.push(u),C.push(u)}z.push(b[c]._soupEntryId)}else"UpdateUpdate"==b[c].CRUD_Operation&&(m=b[c],m.Current_Connection_Session=null,m.CRUD_Operation="Update",y.push(m));l=!0;break}if(!l)for(J in H)if(b[c].Id==H[J].Id){if("Update"==b[c].CRUD_Operation)switch(I="K",I=1==i?k(1,H[J].fl,r):H[J].fbe){case"K":m=b[c],m.Current_Connection_Session=null,y.push(m);break;case"R":break;default:u=j(H[J],a),E.push(u),z.push(b[c]._soupEntryId)}else"UpdateUpdate"==b[c].CRUD_Operation&&(m=b[c],m.Current_Connection_Session=null,m.CRUD_Operation="Update",y.push(m));l=!0;break}if(!l)for(J in x)if(b[c].Id==x[J].pd){if(x[J].crud=b[c].CRUD_Operation,"Update"==b[c].CRUD_Operation)switch(x[J].fbe){case"K":m=b[c],m.Current_Connection_Session=null,y.push(m);break;case"R":break;default:u=j(x[J],a),E.push(u),z.push(b[c]._soupEntryId)}else"UpdateUpdate"==b[c].CRUD_Operation&&(m=b[c],m.Current_Connection_Session=null,m.CRUD_Operation="Update",y.push(m));l=!0;break}}}var O;f.getProxyFieldName(s).then(function(a){return O=a,n(s,"Id",A)}).then(function(a){return n(s,O,B)}).then(function(a){return n("SnapShot_"+s,"Id",C)}).then(function(a){return n("SnapShot_"+s,O,D)}).then(function(a){return q(s,E)}).then(function(a){return q("SnapShot_"+s,E)}).then(function(a){return p(y)}).then(function(a){return o(z)}).then(function(a){return h.checkForMigrateToInfo(r)}).then(function(){var a={};a.status=0,a.csId=r.csId,d(a)}).catch(function(a){g.error("m2pResp error for "+s+" -> "+JSON.stringify(a)),e(a)})},e)}).catch(function(a){g.error("Err reading table",s),e(a)})}function j(a,b){var c={};return c.Id="Insert"==a.crud||"InsertUpdate"==a.crud?a.pd:a.Id,_.findWhere(b,c)}function k(a,b,c){switch(a){case 0:switch(b){case"DF":return c.ifbe;case"CV":return c.icvbe;case"FV":return c.ifvbe}break;case 1:switch(b){case"DF":return c.ufbe;case"SV":return c.usvbe;case"CV":return c.ucvbe;case"FV":return c.ufvbe;case"SD":return c.sdfbe;case"HD":return c.hdfbe}}}function l(b,c,d,e){return new Promise(function(f){var g=a("mobileCaddy/smartStoreUtils");b=JSON.parse(b);var h=d.concat(e),i=d;if(b.records&&b.records.length>c.length+h.length){var j=[];g.getProxyFieldName(b.MobileTable).then(function(a){b.records.forEach(function(b){if("I"==b.RecordCRUD){var d=b.fields.find(function(b){return b.name==a?!0:!1}).value;_.findWhere(c,{pd:d})||_.findWhere(h,{pd:d})||j.push({pd:d,fbe:"K"})}}),j.length>0&&(i=d.concat(j)),f(i)})}else f(i)})}function m(b){var c=a("mobileCaddy/smartStoreUtils");return new Promise(function(a,d){c.querySoupRecords(b,function(b){a(b)},function(a){d(a)})})}function n(a,b,c){var d=cordova.require("com.salesforce.plugin.smartstore");return new Promise(function(e,f){c.length>0?d.upsertSoupEntriesWithExternalId(a,c,b,function(a){e(a)},function(a){f(a)}):e("OK")})}function o(a){var b=cordova.require("com.salesforce.plugin.smartstore");return new Promise(function(c,d){a.length>0?b.removeFromSoup("recsToSync",a,function(a){c(a)},function(a){d(a)}):c("OK")})}function p(a){var b=cordova.require("com.salesforce.plugin.smartstore");return new Promise(function(c,d){a.length>0?b.upsertSoupEntries("recsToSync",a,function(a){c(a)},function(a){d(a)}):c("OK")})}function q(b,c){var d=a("mobileCaddy/smartStoreUtils");return new Promise(function(a,e){c.length>0?-1==b.indexOf("SnapShot")?d.deleteRecordsFromSoup(c,b,function(b){a(b)},function(a){e(a)}):d.deleteRecordsForExternalId(b,c,"Id",function(b){a(b)},function(a){logger.error(a),e(a)}):a("OK")})}function r(b,c,d){var e=a("mobileCaddy/smartStoreUtils"),f=cordova.require("com.salesforce.plugin.smartstore");e.queryMobileTable("recsToSync","Current_Connection_Session",b,function(a){if(0!==a.length){for(var b=0;b<a.length;b++)a[b].Current_Connection_Session=null,"InsertUpdate"==a[b].CRUD_Operation?a[b].CRUD_Operation="Insert":"UpdateUpdate"==a[b].CRUD_Operation&&(a[b].CRUD_Operation="Update");f.upsertSoupEntries("recsToSync",a,c,d)}else c()},d)}function s(b,c,d,e){var f=a("mobileCaddy/syncRefresh"),g={bogus:!0};g.status="exception"===b.type?f.HEARTBEAT_EXCEPTION:f.HEARTBEAT_FAILURE,t(g,c,d,e)}function t(b,c,d,e){var f=(a("mobileCaddy/smartStoreUtils"),a("mobileCaddy/syncRefresh")),g=cordova.require("com.salesforce.plugin.smartstore"),h=a("mobileCaddy/logger"),i={},j=null;b.status==f.HEARTBEAT_NO_CONNECTION?"Sync - Refresh"==c.connSessionRec.mobilecaddy1__Session_Type__c?j="P2M RE Heartbeat No Connection":"Status Check"==c.connSessionRec.mobilecaddy1__Session_Type__c&&(j="M2P SC Heartbeat No Connection"):b.status==f.HEARTBEAT_EXCEPTION?"Sync - Refresh"==c.connSessionRec.mobilecaddy1__Session_Type__c?j=b.bogus?"P2M RE Exception/Timeout":"P2M RE Heartbeat Exception/Timeout":"Status Check"==c.connSessionRec.mobilecaddy1__Session_Type__c&&(j=b.bogus?"M2P SC Exception/Timeout":"M2P SC Heartbeat Exception/Timeout"):b.status==f.HEARTBEAT_FAILURE&&("Sync - Refresh"==c.connSessionRec.mobilecaddy1__Session_Type__c?j=b.bogus?"P2M RE Failure":"P2M RE Hearbeat Failure":"Status Check"==c.connSessionRec.mobilecaddy1__Session_Type__c&&(j=b.bogus?"M2P SC Failure":"M2P SC Heartbeat Failure")),null!==j?(c.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=j,c.connSessionRec.SystemModstamp=(new Date).getTime(),c.connSessionRec.mobilecaddy1__Status__c="Closed",g.upsertSoupEntries("Connection_Session__mc",[c.connSessionRec],function(){i.status=y,i.mc_add_status=b.status,d(i)},e)):(h.error("Unknown heartBeatObject.status. ",b.status),e())}function u(b,c,d){var e=mobileCaddy.require("mobileCaddy/devUtils"),f=a("mobileCaddy/smartStoreUtils"),g=a("mobileCaddy/logger"),h={};f.querySoupRecsPromise("recsToSync").then(function(a){var f=_.filter(a,function(a){return"undefined"!=typeof a.currentConnectionSession});f.length>1||"M2P Conn_Sess Records Processed"!=b.mobilecaddy1__Mobile_Process_Status__c?e.syncMobileTable("Connection_Session__mc").then(function(a){h.status=0,c(h)}).catch(function(a){g.warn("syncMobileTable ERROR -> ",a),d(a)}):(h.status=0,c(h))}).catch(function(a){g.error("querySoupRecsPromise ERROR -> ",a),d(a)})}function v(b,c,d){var e=cordova.require("com.salesforce.plugin.smartstore"),f=a("mobileCaddy/mobileLogger");f.logObjectDetails(b);var g={};e.upsertSoupEntries("Connection_Session__mc",[b],function(a){f.logObjectDetails(a[0]);var h={Id:b.Id,SystemModstamp:b.SystemModstamp-1};for(var i in b)"_soupEntryId"!=i&&"_soupLastModifiedDate"!=i&&"Id"!=i&&"SystemModstamp"!=i&&(h[i]=null);e.upsertSoupEntries("SnapShot_Connection_Session__mc",[h],function(a){var b={Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Update",SOUP_Record_Id:a[0]._soupEntryId,Id:a[0].Id,LastModifiedDateTime:a[0].SystemModstamp};e.upsertSoupEntries("recsToSync",[b],function(){g.status=0,c(g)},d)},d)},d)}var w=100200,x=100201,y=100600;c.exports={getRTSPendingconnSess:function(a,b){d(a,b)},CLEAN_CS_OK:y,cleanConnectionSessionHeartBeat:function(a,b,c,d){t(a,b,c,d)},cleanConnectionSessionVFEvent:function(a,b,c,d){s(a,b,c,d)},CONN_SESS_OK:w,csStatusCheck:function(a,b,c){e(a,b,c)},maybeSyncConnSess:function(a,b,c){u(a,b,c)},processM2PUpdateResponse:function(a,b,c,d){i(a,b,c,d)},postProcessConnectionSession:function(a,b,c){v(a,b,c)}}}),b("mobileCaddy/vsnUtils",function(a,b,c){function d(a){return new Promise(function(b,c){null===a?n.listMobileTables(n.ALPHA,function(a){var c=r;_.each(a,function(a){c.push(a),c.push("SnapShot_"+a),localStorage.removeItem("meta-tableDEF-"+a),localStorage.removeItem("meta-tableCRUD-"+a)}),b(c)},function(a){c(a)}):b([])})}function e(a,b){return new Promise(function(c,e){d(a,b).then(function(a){return Promise.all(a.map(n.deleteSoup))}).then(function(){c()}).catch(function(a){q.error(a),e(a)})})}function f(b){return new Promise(function(c,d){{var f={},i=b?"Version Upgrade":"HardReset",k="";a("mobileCaddy/syncRefresh")}h().then(function(){m.readRecords("appSoup").then(function(a){return a.records.forEach(function(a){f[a.Name]=a.CurrentValue}),e(null,["appSoup"])}).then(function(){k=g(f);var a,b,e="",h=j();if("codeflow"==h&&(a=localStorage.getItem("forceOAuth"),b=localStorage.getItem("appSoup")),localStorage.clear(),"codeflow"==h)localStorage.setItem("forceOAuth",a),localStorage.setItem("appSoup",b),e=window.location.protocol+"//"+window.location.host+"/www",c("ok");else if("platform"==h)e=window.location.href.substr(0,window.location.href.indexOf("#"));else{var l="";navigator&&navigator.connection&&(l=navigator.connection.type);var m;if(window.device&&(m=window.device),navigator.appVersion.includes("Electron")){m=ipcRenderer.sendSync("request-device-info",""),l="wifi";var o="landscape"}e=k+"?deviceUuid="+m.uuid+"&deviceName="+m.name+"&deviceCordova="+m.cordova+"&deviceVersion="+m.version+"&deviceModel="+m.model+"&buildName="+f.buildName+"&buildVersion="+f.buildVersion+"&buildOS="+f.buildOS+"&knownAud="+f.audId+"&currentDv="+f.dynVersionNumber+"&orientation="+o+"&viewportWidth="+$j(window).width()+"&viewportHeight="+$j(window).height()+"&sessionType="+i+"&connType="+l+"&loginUrl="+f.loginUrl+"&millsFromEpoch="+(new Date).getTime()}p.updateNewValueInAppSoup("buildStatus","Resetting").then(function(){n.deleteSoup("syncLib_system_data").then(function(){try{window.location.href=e}catch(a){q.error("error on redirect",a),d(a)}c()}).catch(function(a){q.error(a)}),c()}).catch(function(a){q.error(a),d(a)})}).catch(function(a){q.error(a),d(a)})}).catch(function(a){window.history.go(-(history.length-1)),navigator.appVersion.includes("Electron")||cordova.require("com.salesforce.plugin.sfaccountmanager").logout(),d(a)})})}function g(a){var b="/apex/mobilecaddy1__MobileCaddyBootstrap001_mc";switch(a.platAuthUrl){case"i":case"I":resetURL=a.instanceUrl+b;break;case"l":case"L":resetURL=a.loginUrl+b;break;case"":resetURL=void 0;break;default:resetURL=a.platAuthUrl}return resetURL||(a.authURLType||(a.authURLType="login"),resetURL="login"==a.authURLType?a.loginUrl+b:a.instanceUrl+b),resetURL}function h(){return new Promise(function(b,c){var d=a("mobileCaddy/syncRefresh");d.refreshToken(function(){b("ok")},function(a){c(a)})})}function i(b){var c=a("mobileCaddy/appDataUtils");return new Promise(function(a,d){null!==b.migrateTo&&"undefined"!=typeof b.migrateTo?c.updateNewValueInAppSoup("dynVersionNumber",b.migrateTo).then(function(){a()}).catch(function(a){q.error(a),d(a)}):a()})}function j(){return"localhost:3030"==window.location.host?"codeflow":"undefined"!=typeof mockStore?navigator.appVersion.includes("Electron")?"desktop":"platform":"device"}function k(){return new Promise(function(a,b){var c=mobileCaddy.require("mobileCaddy/smartStoreUtils");c.queryMobileTable("appSoup","Name","dynVersionNumber").then(function(b){a("undefined"!=typeof b[0].NewValue&&b[0].NewValue!=b[0].CurrentValue?!0:!1)}).catch(function(a){q.error(a),b(a)})})}function l(){return new Promise(function(a,b){k().then(function(b){b?o.getRTSPendingconnSess(function(b){return null===b||"undefined"==typeof b?f(!0):void a(!1)},function(){a(!1)}):a(!1)}).catch(function(a){q.error(a),b(a)})})}var m=mobileCaddy.require("mobileCaddy/devUtils"),n=(cordova.require("com.salesforce.plugin.smartstore"),mobileCaddy.require("mobileCaddy/smartStoreUtils")),o=a("mobileCaddy/connSessUtils"),p=a("mobileCaddy/appDataUtils"),q=a("mobileCaddy/logger"),r=["recsToSync"];c.exports={checkForMigrateToInfo:function(a){return i(a)},clearSoups:function(a,b){return e(a,b)},getSoupsToClear:function(a,b){return d(a,b)},hardReset:function(){return f()},upgradeAvailable:function(){return k()},upgradeIfAvailable:function(){return l()},_getBootstrapUrl:function(a){return g(a)}}}),b("mobileCaddy/logger",function(a,b,c){function d(){return new Promise(function(a,b){localStorage.hasLogType?a(localStorage.hasLogType):h.listMobileTableColumns("Mobile_Log__mc",h.FULL,function(b){var c=_.find(b,{path:"mobilecaddy1__Log_Type__c"});"undefined"==typeof c?(localStorage.setItem("hasLogType","false"),a("false")):(localStorage.setItem("hasLogType","true"),a("true"))},function(a){b(a)})})}function e(a,b){return new Promise(function(c,e){if(1==b.length&&(b=b[0]),"object"==typeof b&&(b=JSON.stringify(b)),"string"==typeof b){a==j&&localStorage.setItem("lastErrorLog",b.substring(0,1024));var f={mobilecaddy1__Error_Text__c:b.substring(0,1024),SystemModstamp:(new Date).getTime()};i.getCachedCurrentValueFromAppSoup("audId").then(function(a){return f.mobilecaddy1__Application_User_Device__c=a,d()}).then(function(b){"true"==b&&(f.mobilecaddy1__Log_Type__c="D"+a.toString()),h.insertRecords("Mobile_Log__mc",[f],function(){c()},function(a){e(a)})}).catch(function(a){e(a)})}else logger.error("Trying to log unsupported type",typeof b),e("Trying to log unsupported type"+typeof b)})}function f(a,b,c){var d=localStorage.getItem("logLevel");if(d="undefined"==typeof d?0:d,d>=a){var f="";if(a>0){var g=c.stack.split("\n")[4];if("undefined"!=typeof g){var h=g.indexOf("at ");f=g.slice(h+2,g.length)}}switch(a){case j:e(a,b),console.error.apply(console,b);break;case k:d>=k&&(e(a,b),console.log.apply(console,b));break;default:d>=l&&(e(a,b),console.log.apply(console,b))}}}function g(){try{throw Error("")}catch(a){return a}}var h=(cordova.require("com.salesforce.plugin.smartstore"),a("mobileCaddy/smartStoreUtils")),i=a("mobileCaddy/appDataUtils"),j=0,k=1,l=2,m=3,n=4;c.exports={debug:function(){return f(n,arguments,g())},error:function(){return f(j,arguments)},info:function(){return f(m,arguments,g())},log:function(){return f(l,arguments,g())},warn:function(){return f(k,arguments,g())},hasLogType:function(){return d()}}}),b("mobileCaddy/devUtils",function(a,b,c){function d(a){var b="Analytics";
return new Promise(function(c,d){var g=new Date,h=new Date(g.getFullYear(),g.getMonth(),g.getDate(),0,0,0,0).valueOf();e().then(function(){return f(h)}).then(function(d){var e={};if(0===d.length){e[a]=1;var f={Name:h,Data:JSON.stringify(e)};c(e[a]),M.upsertSoupEntries(b,[f],function(){},function(a){L.error("Unable to insert analytic recs",a)})}else{var g=d[0];e=JSON.parse(g.Data),e[a]="undefined"==typeof e[a]?1:e[a]+1,c(e[a]),g.Data=JSON.stringify(e),M.upsertSoupEntriesWithExternalId(b,[g],"Name",function(){},function(a){L.error(a)})}}).catch(function(a){L.error("Error in analInc",a),d(a)})})}function e(){return new Promise(function(a,b){M.soupExists("Analytics",function(c){if(c)a();else{var d=[{path:"Name",type:"integer"},{path:"Data",type:"string"}];M.registerSoup("Analytics",d,function(){a()},function(a){b(a)})}},function(a){L.error(a),b(a)})})}function f(b){return new Promise(function(c,d){var e=a("mobileCaddy/appDataUtils"),f="";e.getCurrentValueFromAppSoup("audId").then(function(a){return f=a,K.querySoupRecsPromise("Analytics")}).then(function(a){var e=[],g=[],h=[];a.forEach(function(a){if(a.Name==b)e.push(a);else{var c={Name:a.Name.toString(),SystemModstamp:a.Name,mobilecaddy1__Error_Text__c:JSON.parse(a.Data),mobilecaddy1__Application_User_Device__c:f};L.hasLogType()&&(c.mobilecaddy1__Log_Type__c="analytic"),g.push(c),h.push(a._soupEntryId)}}),0!==g.length&&K.insertRecords("Mobile_Log__mc",g,function(){M.removeFromSoup("Analytics",h,function(){c(e)},function(a){L.error("Unable to insert analytic recs",a),d(a)})},function(a){L.error("Unable to insert analytic recs",a),d(a)}),c(e)}).catch(function(a){L.error("Error housekeeping Analytics",a),d(a)})})}function g(a,b,c){return new Promise(function(d,e){var f=function(b,f){var g=0;switch(b){case $:g=1;break;case ab:g=4;break;case bb:g=7;break;case cb:g=10;break;default:g=0}if("Y"==f.charAt(g))d(c);else{var h={};h.status=b+P,h.mc_add_status=a,e(h)}};-1==eb.indexOf(a)?localStorage["meta-tableCRUD-"+a]?f(b,localStorage["meta-tableCRUD-"+a]):K.getTableDefnColumnValue(a,"Application Record CRUD",function(c){localStorage["meta-tableCRUD-"+a]=c,f(b,c)},function(a){e(a)}):d(c)})}function h(){return new Promise(function(a,b){if(USE_FORCETK===!0){var c=force.getUserId();a("undefined"!=typeof c?c:c)}else j("userId").then(function(b){a(b)}).catch(function(a){L.error("getCurrentUserId",a),b(a)})})}function i(){var a="";return new Promise(function(b,c){j("userFirstName").then(function(b){return a=b,j("userLastName")}).then(function(c){b(a+" "+c)}).catch(function(a){L.error("getCurrentUserName",a),c(a)})})}function j(b){return new Promise(function(c,d){var e=a("mobileCaddy/appDataUtils");e.getCachedCurrentValueFromAppSoup(b).then(function(a){c(a)}).catch(function(a){L.error("getCachedAppSoupValue",a),d(a)})})}function k(a){if(0===a.length)return!0;var b=a.indexOf("@"),c=a.lastIndexOf(".");return 1>b||b+2>c||c+2>=a.length?!1:!0}function l(a,b,c,d){if("_soupLastModifiedDate"==a)return d;var e=_.findWhere(c,{path:a}),f={};if("undefined"==typeof e)return f.status=b+O,f.mc_add_status=a,f;var g=0;switch(b){case $:g=1;break;case ab:g=4;break;case bb:g=7;break;default:g=0}if("Y"!=e.crud.charAt(g))return f.status=b+P,f;try{return f.value=p(d,e.appColType,e.platColType),f}catch(h){return f.status=b+R,f.mc_add_status=h+"->"+a,f}}function n(a){return new Promise(function(b,c){localStorage["meta-tableDEF-"+a]?b(JSON.parse(localStorage["meta-tableDEF-"+a])):K.listMobileTableColumns(a,K.FULL,function(c){localStorage["meta-tableDEF-"+a]=JSON.stringify(c),b(c)},function(a){c(a)})})}function o(a,b,c){switch(c){case"checkbox":case"Deleted":return"true"===String(a);case"CreatedDate":case"date":case"datetime":case"LastActivtyDate":case"LastModifiedDate":case"LastReferencedDate":case"LastViewedDate":case"SystemModstamp":if(null!==a){var d=new Date(a);return d}return a;default:return a}}function p(a,b,c){switch(c){case"autonumber":throw"invalid_autonumber";case"checkbox":case"Deleted":if("boolean"==typeof a||"true"===a||"false"===a)return String(a);throw"invalid_boolean";case"date":if(a instanceof Date)return a.setUTCHours(0),a.setUTCMinutes(0),a.setUTCSeconds(0),a.setUTCMilliseconds(0),a.valueOf();if(null===a)return null;throw"invalid_date";case"datetime":if(a instanceof Date)return a.valueOf();throw"invalid_datetime";case"email":if(k(a))return a;throw"invalid_email";default:switch(b){case"jsString":if("string"==typeof a)return a;if("number"==typeof a)return a.toString();throw"invalid_string";case"jsNumber":if("number"==typeof a||null===a)return a;throw"invalid_number";default:return a}}}function q(a,b){return new Promise(function(c,d){var e={};localStorage["meta-tableCRUD-"+a]?c():K.listMobileTables(K.ALPHA,function(f){var g=f.concat(eb);g.indexOf(a)>=0?c():(e.status=b+N,e.mc_add_status=a,d(e))},function(a){e.status=b+W,e.mc_add_status="Unkonwn error "+a,d(e)})})}function r(a,b,c,d,e){return new Promise(function(f){var g={},i={};g.status=c,t().then(function(b){return b[a]&&(i=_.invert(b[a])),h()}).then(function(a){$j.each(d,function(d,h){if(delete h._soupEntryId,delete h.$$HashKey,h.RecordTypeName){if(h.RecordTypeId=i[h.RecordTypeName],_.isEmpty(i))return g.status=c+O,g.mc_add_status=h.RecordTypeName,f(g);if(!h.RecordTypeId)return g.status=c+U,g.mc_add_status=h.RecordTypeName,f(g);delete h.RecordTypeName}for(var j in h)if(h.hasOwnProperty(j)&&j!=b){if(isValidFieldRes=l(j,c,e,h[j]),isValidFieldRes.status==c+O){g.status=isValidFieldRes.status,g.mc_add_status=j;break}if(isValidFieldRes.status==c+R){g.status=isValidFieldRes.status,g.mc_add_status=j;break}if(isValidFieldRes.status==c+P){g.status=isValidFieldRes.status,g.mc_add_status=j;break}if(c==$&&fb.indexOf(j)>=0){g.status=c+S,g.mc_add_status=j;break}h[j]=isValidFieldRes.value}if(g.status!=c+O&&g.status!=c+R&&g.status!=c+S){var k=(new Date).getTime();c==$&&(h.CreatedById=a,h.CreatedDate=k),h.SystemModstamp=k,h.LastModifiedDate=k,h.LastModifiedById=a,h.IsDeleted="false",$j.each(e,function(a,b){if(c==$){var d=b.crud.charAt(1);fb.indexOf(b.path)<0&&"false"==b.nillable&&"Y"==d?_.has(h,b.path)||(g.status=c+Q,g.mc_add_status=b.path):("IsClosed"==b.path&&(h.IsClosed="false"),"IsWon"==b.path&&(h.IsWon="false"))}""!==b.proxyRefField&&"undefined"!=typeof h[b.path]&&h[b.path].length>18&&(h[b.proxyRefField]=h[b.path])})}}),g.records=d,f(g)},function(a){L.error("validateRecords",a)})})}function s(a){return new Promise(function(b,c){q(a,db).then(function(){return t()}).then(function(c){b(c[a])}).catch(function(a){c(a)})})}function t(){return new Promise(function(a,b){var c=localStorage.getItem("lsDotsRecordTypes");c?a(JSON.parse(localStorage.getItem("lsDotsRecordTypes"))):K.querySoupRecords("dotsRecordTypes",function(b){var c={};b.forEach(function(a){var b={},d=JSON.parse(a.Data);d.forEach(function(a){b[a.recTypeId]=a.recTypeName}),c[a.Table]=b}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(c)),a(c)},function(a){b(a)})})}function u(a,b,c){var d,e={};return new Promise(function(f,h){b.length>0?q(a,cb).then(function(){return n(a)}).then(function(b){return g(a,cb,b)}).then(function(d){var e=new Promise(function(e,f){var g=l(c,cb,d);g.status!=cb+O?r(a,c,cb,b,d).then(function(a){a.status==cb?e(a.records):(f(a),L.error(a))}):(f(g),L.error(g))});return e}).then(function(){return K.queryMobileTable(a,c,b[0][c])}).then(function(b){if(0===b.length)e.status=cb+Q,L.warn("deleteRecord no record found",a),e.mc_add_status="no record found",h(e);else{if(!(b[0].Id.length<19))return d=b,K.querySoupRecsPromise("recsToSync");e.status=cb+P,L.warn("deleteRecord Cannot delete synced records"),e.mc_add_status="Cannot delete synced records",h(e)}}).then(function(b){var c=b.reduce(function(b,c){return c.Mobile_Table_Name==a&&_.findWhere(d,{_soupEntryId:c.SOUP_Record_Id})&&b.push({_soupEntryId:c._soupEntryId}),b},[]);K.deleteRecordsFromSoup(d,a,function(){K.deleteRecordsFromSoup(c,"recsToSync",function(){e.status=cb,e.records=d,f(e)},function(a){h(a)})},function(a){h(a)})}).catch(function(a){h(a)}):(e.status=cb,L.warn("deleteRecord No records supplied"),e.mc_add_status="No records supplied",e.records=[],f(e))})}function v(){return new Promise(function(a,b){z("recsToSync").then(function(b){var c=[],d=[];b.records.forEach(function(a){"Connection_Session__mc"!=a.Mobile_Table_Name&&"undefined"==typeof c[a.Mobile_Table_Name]&&(c[a.Mobile_Table_Name]=!0,d.push(a.Mobile_Table_Name))}),a(d)}).catch(function(a){L.error(a),b(a)})})}function w(a,b){return new Promise(function(c,d){a.length>0&&-1==eb.indexOf(b)?t().then(function(d){if(d[b]){var e=d[b],f=a.map(function(a){return a.RecordTypeName=e[a.RecordTypeId],a.RecordTypeName||L.warn("enrichWithRecordTypeNames",a.RecordTypeId),a});c(f)}else c(a)}).catch(function(a){d(a)}):c(a)})}function x(a,b){var c={};return new Promise(function(d,e){q(a,$).then(function(){return n(a)}).then(function(b){return g(a,$,b)}).then(function(c){var d=new Promise(function(d,e){r(a,null,$,b,c).then(function(a){a.status==$?d(a.records):e(a)})});return d}).then(function(b){K.insertRecords(a,b,function(a){c.status=$,c.records=a;var b=mobileCaddy.require("mobileCaddy/vsnUtils");b.upgradeAvailable().then(function(a){c.upgradeAvailable=a,d(c)}).catch(function(a){d(c),L.error(a)})},function(a){e(a),L.error(a)})}).catch(function(a){e(a),L.error(a)})})}function y(){navigator.appVersion.includes("Electron")?ipcRenderer.sendSync("logout",""):cordova.require("com.salesforce.plugin.sfaccountmanager").logout()}function z(a){var b={};return new Promise(function(c,d){q(a,ab).then(function(){return g(a,ab)}).then(function(){return n(a)}).then(function(e){K.querySoupRecords(a,function(d){if(b.status=ab,d.length>0)-1==eb.indexOf(a)?K.getTableDefnColumnValue(a,"Last Refresh Date/Time",function(f){A(a,d,e,f,b).then(function(a){c(a)})}):A(a,d,e,null,b).then(function(a){c(a)});else{b.records=[];var f=mobileCaddy.require("mobileCaddy/vsnUtils");f.upgradeAvailable().then(function(a){b.upgradeAvailable=a,c(b)}).catch(function(a){c(b),L.error(a)})}},function(a){d(a),L.error(a)})},function(a){d(a),L.error(a)})})}function A(a,b,c,d,e){return new Promise(function(f){$j.each(b,function(a,b){for(var e in b){var f=_.findWhere(c,{path:e});"undefined"!=typeof f&&(b[e]=o(b[e],f.appColType,f.platColType),"LastModifiedDate"==e&&(b.dirtyFlag=E(b[e],d)))}}),e.records=b.filter(function(a){return"object"==typeof a}),w(e.records,a).then(function(a){e.records=a;var b=mobileCaddy.require("mobileCaddy/vsnUtils");return b.upgradeAvailable()}).then(function(a){e.upgradeAvailable=a,f(e)}).catch(function(a){f(e),L.error(a)})})}function B(a){return new Promise(function(b,c){var d,e,f=cordova.require("com.salesforce.plugin.smartstore"),h={},i=/\{(\S*)\}/g,j=i.exec(a);tableName=j[1],D(tableName,a).then(function(a){return d=f.buildSmartQuerySpec(a),e="MC-TIMING smartRead "+tableName,q(tableName,ab)}).then(function(){return g(tableName,ab)}).then(function(){return n(tableName)}).then(function(a){K.smartQuerySoupRecordsWithQuerySpec(d,function(c){if(h.status=ab,c.length>0)-1==eb.indexOf(tableName)?K.getTableDefnColumnValue(tableName,"Last Refresh Date/Time",function(d){C(tableName,c,a,d,h).then(function(a){b(a)})}):C(tableName,c,a,null,h).then(function(a){b(a)});else{h.records=[];var d=mobileCaddy.require("mobileCaddy/vsnUtils");d.upgradeAvailable().then(function(a){h.upgradeAvailable=a,b(h)}).catch(function(a){b(h),L.error(a)})}},function(){c()})},function(a){c(a),L.error(a)})})}function C(a,b,c,d,e){return new Promise(function(f){var g=[];$j.each(b,function(a,b){var e=b[1];for(var f in e){var h=_.findWhere(c,{path:f});"undefined"!=typeof h&&(e[f]=o(e[f],h.appColType,h.platColType),"LastModifiedDate"==f&&(b[1].dirtyFlag=E(b[1][f],d)))}g.push(e)}),e.records=g.filter(function(a){return"object"==typeof a}),w(e.records,a).then(function(a){e.records=a;var b=mobileCaddy.require("mobileCaddy/vsnUtils");return b.upgradeAvailable()}).then(function(a){e.upgradeAvailable=a,f(e)}).catch(function(a){f(e),L.error(a)})})}function D(a,b){return new Promise(function(c){if(m=b.match(/.* WHERE (.* = .*)/i),null!==m&&null!==m[1]){var d=m[1].split("AND"),e={},f="";d.forEach(function(a){mWhere=a.match(/{(.*):(.*)} = (.*)/i),whereField=mWhere[2],f=mWhere[3].split("'")[1],e[whereField]=f}),"undefined"!=typeof e.Id&&e.Id.length>18?K.getProxyFieldName(a).then(function(a){parsedSmartSql=b.replace("Id} =",a+"} ="),c(parsedSmartSql)}):c(b)}else c(b)})}function E(a,b){return b&&"null"!=b||(b=0),a.valueOf()>b?!0:!1}function F(b){return new Promise(function(c,d){var e=a("mobileCaddy/syncRefresh"),f=function(a){c(a)},g=function(a){L.error("innerProcessRefreshTablePromise error",a),d(a)},h={table:b};e.p2mRefreshTable(b,0,!1,1,1,null,function(a){a.status==e.P2M_REFRESH_OK?(h.status=Y,f(h)):(h.status=a.status,h.mc_add_status=a.mc_add_status,f(h))},g)})}function G(b){return new Promise(function(c,d){if(0===b.length)c({status:X+Q});else{var e={},f=a("mobileCaddy/syncRefresh");f.heartBeat(function(g){if(g.status==f.HEARTBEAT_OK||g.status==f.HEARTBEAT_NOT_DEVICE||g.status==f.HEARTBEAT_REFRESHED_OK){var h=[];v().then(function(a){return a.forEach(function(a){dirtyIndex=b.indexOf(a),dirtyIndex>-1&&(h.push({table:a,status:Z,mc_add_status:"Dirty records"}),b.splice(dirtyIndex,1))}),H(b)}).then(function(b){var e=h.concat(b);c(e);var f=a("mobileCaddy/connSessUtils"),g={mobilecaddy1__Mobile_Process_Status__c:""};f.maybeSyncConnSess(g,function(){},function(a){d(a),L.error(a)})}).catch(function(a){d(a),L.error(a)})}else e.status=Z,e.mc_add_status=g.status,c(e),100101==e.mc_add_status||100102==e.mc_add_status?L.error(e):L.log(e)},function(a){L.error(a),e.status=Z,c(e)})}})}function H(a){var b=(Promise.resolve(),[]);return a.reduce(function(a,c){return a.then(function(){return F(c)}).then(function(a){return b.push(a),b}).catch(function(a){L.error(a),reject(a)})},Promise.resolve())}function I(b,c,d,e){c="undefined"!=typeof c?c:!0;var f=a("mobileCaddy/connSessUtils"),g=a("mobileCaddy/syncRefresh"),h=a("mobileCaddy/smartStoreUtils"),i=(a("mobileCaddy/mobileLogger"),50);d||(d=0),e||(e=i);var j=function(a,b,c){var e={};g.p2mRefreshTable(a,d,!0,1,1,null,function(a){a.status==g.P2M_REFRESH_OK?(e.status=Y,b(e)):(e.status=a.status,e.mc_add_status=a.mc_add_status,b(e))},c)},k=function(a,b,c){var f={};h.queryMobileTable("recsToSync","Mobile_Table_Name",a,function(h){h.length>0?g.m2pUpdateMobileTable(a,e,function(e){e.status==g.M2P_UPDATE_OK&&"undefined"==typeof e.mc_add_status?(d=0,f.status=0,b(f)):e.status==g.M2P_UPDATE_OK&&"more-to-sync"===e.mc_add_status?k(a,b,c):(f.status=e.status,f.mc_add_status=e.mc_add_status,b(f))},c):(f.status=2,f.mc_add_status="no-sync-no-updates",b(f))},c)},l=function(a,b,c,d,e){var f={};"Dynamic (Submit First/Retain)"==b||"Dynamic (Submit First/Clear)"==b?k(a,function(b){0===b.status||c&&2==b.status?j(a,d,e):2==b.status?(f.status=Y,f.mc_add_status=b.mc_add_status,d(f)):(f.status=Z,f.mc_add_status=b.mc_add_status,d(f))},e):"Submit Only"==b||"Submit & Clear"==b||"Submit & Destroy"==b?k(a,function(a){0===a.status?(f.status=Y,d(f)):(f.status=Z,f.mc_add_status=a.mc_add_status,d(f))},e):L.error("Unknown sync type",b)};return new Promise(function(a,d){var e={},i=function(b){localStorage.removeItem("syncInProgressTime"),a(b)},k=function(a){localStorage.removeItem("syncInProgressTime"),d(a)},m="syncTime"+b,n=localStorage.getItem(m),o=(new Date).valueOf(),p=n?parseInt(n)+5e3:0;"Connection_Session__mc"!=b&&p>o?(e.status=Y,e.mc_add_status="sync-too-soon",a(e)):(localStorage.setItem(m,o),q(b,X).then(function(){g.heartBeat(function(m){if(m.status==g.HEARTBEAT_OK||m.status==g.HEARTBEAT_NOT_DEVICE||m.status==g.HEARTBEAT_REFRESHED_OK){var n=localStorage.getItem("syncInProgressTime"),o=(new Date).valueOf();"Connection_Session__mc"!=b&&n&&n>o-12e4?(e.status=100498,k(e)):(localStorage.setItem("syncInProgressTime",o),h.getTableDefnColumnValue(b,"Sync Type",function(g){f.getRTSPendingconnSess(function(h){"Mobile_Log__mc"!=b?null!==h&&"undefined"!=typeof h?f.csStatusCheck(h,function(d){d.status==f.CONN_SESS_OK?"Refresh Only"==g||"Refresh & Clear"==g?j(b,i,k):l(b,g,c,i,k):(e.status=Y,e.mc_add_status=d.status,a(e))},function(a){L.error(a),d(a)}):"Refresh Only"==g||"Refresh & Clear"==g?j(b,i,k):l(b,g,c,i,k):l(b,g,!1,i,k)},k)},k))}else e.status=Z,e.mc_add_status=m.status,a(e),100101==e.mc_add_status||100102==e.mc_add_status?L.error(e):L.log(e)},k)}).catch(k))})}function J(a,b,c){var d={};return new Promise(function(e,f){b.length>0?q(a,bb).then(function(){return n(a)}).then(function(b){return g(a,bb,b)}).then(function(d){var e=new Promise(function(e,f){var g=l(c,bb,d);g.status!=bb+O?r(a,c,bb,b,d).then(function(a){a.status==bb?e(a.records):f(a)}):f(g)});return e}).then(function(b){K.updateRecordsWithExternalId(a,b,c,function(a){d.status=bb,d.records=a;var b=mobileCaddy.require("mobileCaddy/vsnUtils");b.upgradeAvailable().then(function(a){d.upgradeAvailable=a,e(d)}).catch(function(){e(d)})},function(a){f(a),L.error(a)})},function(a){f(a),L.error(a)}):(d.status=bb,d.mc_add_status="No records supplied",d.records=[],e(d),L.warn(d))})}var K=a("mobileCaddy/smartStoreUtils"),L=(a("mobileCaddy/mobileLogger"),a("mobileCaddy/logger")),M=cordova.require("com.salesforce.plugin.smartstore"),N=1,O=2,P=3,Q=4,R=5,S=6,T=7,U=8,V=98,W=99,X=100400,Y=X,Z=100402,$=100700,ab=101e3,bb=101100,cb=101200,db=101300,eb=["syncLib_system_data","appSoup","cacheSoup","recsToSync","SnapShot_Connection_Session__mc"],fb=["autonumber","CreatedById","CreatedDate","IsDeleted","IsClosed","IsWon","LastModifiedById","LastModifiedDate","LastReferencedDate","mobilecaddy1__MC_Proxy_ID","MC_Proxy_ID","OwnerId","SystemModstamp","Id","dirtyFlag"];c.exports={SYNC_OK:Y,SYNC_NOK:Z,SYNC_ALREADY_IN_PROGRESS:X+V,SYNC_UNKONWN_TABLE:X+N,SYNC_MANDATORY_MISSING:X+Q,DELETE_RECS_OK:cb,DELETE_RECS_UNKONWN_TABLE:cb+N,DELETE_RECS_UNKONWN_FIELD:cb+O,DELETE_RECS_ACCESS_DENIED:cb+P,DELETE_RECS_MANDATORY_MISSING:cb+Q,INSERT_RECS_OK:$,INSERT_RECS_UNKONWN_TABLE:$+N,INSERT_RECS_UNKONWN_FIELD:$+O,INSERT_RECS_ACCESS_DENIED:$+P,INSERT_RECS_MANDATORY_MISSING:$+Q,INSERT_RECS_DATATYPE_MISMATCH:$+R,INSERT_RECS_PROTECTED_FIELD:$+S,INSERT_RECS_UNKNOWN_RECORD_TYPE:$+U,READ_RECS_OK:ab,READ_RECS_UNKONWN_TABLE:ab+N,READ_RECS_ACCESS_DENIED:ab+P,UPDATE_RECS_OK:bb,UPDATE_RECS_UNKONWN_TABLE:bb+N,UPDATE_RECS_UNKONWN_FIELD:bb+O,UPDATE_RECS_ACCESS_DENIED:bb+P,UPDATE_RECS_DATATYPE_MISMATCH:bb+R,UPDATE_RECS_UNKNOWN_ID:bb+T,UPDATE_RECS_UNKNOWN_RECORD_TYPE:bb+U,GET_REC_TYPES_UNKONWN_TABLE:db+N,analInc:function(a){return d(a)},deleteRecord:function(a,b,c){return u(a,[b],c)},dirtyTables:function(){return v()},syncMobileTable:function(a,b,c,d){return I(a,b,c,d)},initialSync:function(a){return G(a)},getCurrentUserId:function(){return h()},getCurrentUserName:function(){return i()},getUserLocale:function(){return j("userLocale")},getCachedAppSoupValue:function(a){return j(a)},getRecordTypes:function(a){return s(a)},insertRecord:function(a,b){return x(a,[b])},insertRecords:function(a,b){return x(a,b)},logout:function(){return y()},readRecords:function(a,b){return z(a,b)},smartSql:function(a){return B(a)},updateRecord:function(a,b,c){return J(a,[b],c)},updateRecords:function(a,b,c){return J(a,b,c)},maybeReadTransformType:function(a,b,c){return o(a,b,c)},maybeWriteTransformType:function(a,b,c){return p(a,b,c)}}}),window.mobileCaddy=a("mobileCaddy")}();