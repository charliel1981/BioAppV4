/*! BioHub - v3.3.8 - 2019-12-03 10:22:04*/
/* Copyright 2019 MobileCaddy Ltd */
!function(){"use strict";angular.module("starter.controllers",["ionic","ngCordova"]).filter("dateYYYYMMDD",["$filter",function($filter){return function(x){if("undefined"!=typeof x&&null!==typeof x){var myDate=new Date(x);if(1970==myDate.getUTCFullYear()&&0===myDate.getUTCHours()&&0===myDate.getUTCMinutes())return"-";if(2099==myDate.getUTCFullYear())return"No date set";var day=myDate.getUTCDate();day=10>day?"0"+day:day;var monthNum=myDate.getUTCMonth()+1;monthNum=10>monthNum?"0"+monthNum:monthNum;var year=myDate.getUTCFullYear();return year+" - "+monthNum+" - "+day}return""}}]).filter("dateDDMMMYYYY",["$filter",function($filter){return function(x){var monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];if("undefined"!=typeof x&&null!==typeof x){if(null===x)return"";var myDate=new Date(x),day=myDate.getUTCDate();day=10>day?"0"+day:day;var monthIdx=myDate.getUTCMonth(),year=myDate.getUTCFullYear();return day+" "+monthNames[monthIdx]+" "+year}return""}}]).filter("dateDDMMMYYYYHHMM",["$filter",function($filter){return function(x){if("undefined"!=typeof x&&null!==typeof x){if(null===x)return"";var myDate=new Date(x);return $filter("date")(myDate,"dd MMM yyyy HH:mm")}return""}}]).filter("trusted",["$sce",function($sce){return function(val){return val?$sce.trustAsHtml(val.replace(/\n/g,"<br/>").replace("<ul>",'<ul class="bio-custom-bullet bio-green-tick">')):void 0}}])}(),function(){"use strict";function ContentItemCtrl($rootScope,$scope,$stateParams,$ionicLoading,$window,$timeout,$ionicModal,$location,$ionicScrollDelegate,$ionicPopup,$ionicHistory,$state,logger,ContentItemService,NetworkService,AnalyticsService){function activate(refreshAfterSync){vm.title=decodeURIComponent($stateParams.menuName),refreshAfterSync||$ionicLoading.show({duration:1e4,template:"Loading...",animation:"fade-in",showBackdrop:!0}),ContentItemService.getContentItems($stateParams.menuItem).then(function(records){records.length>0&&($ionicLoading.hide(),vm.contentItemTemplate=getTemplateName(records[0].Record_Type_Name__c),"Portrait_Image.html"==vm.contentItemTemplate||"Portrait_Image_Fixed_Heading.html"==vm.contentItemTemplate?populatePortraitImageSlider(records,refreshAfterSync):"Menu_List.html"==vm.contentItemTemplate?populateMenuList(records,refreshAfterSync):"Twin_Images.html"==vm.contentItemTemplate?populateTwinImagesSlider(records,refreshAfterSync):"Landscape_Image.html"==vm.contentItemTemplate?populateLandscapeImageSlider(records,refreshAfterSync):"Image_and_Copy.html"==vm.contentItemTemplate?populateImageAndCopySlider(records,refreshAfterSync):"Image_or_Copy.html"==vm.contentItemTemplate&&populateImageOrCopySlider(records,refreshAfterSync))})}function getTemplateName(recordTypeName){return"Portrait_Image"==recordTypeName?"apps"==vm.menuItem?"Portrait_Image.html":"Portrait_Image_Fixed_Heading.html":"Menu_List"==recordTypeName?"Menu_List.html":"Twin_Images"==recordTypeName?"Twin_Images.html":"Landscape_Image"==recordTypeName?"Landscape_Image.html":"Image_and_Copy"==recordTypeName?"Image_and_Copy.html":"Copy"==recordTypeName?"Image_or_Copy.html":void 0}function populatePortraitImageSlider(records,refreshAfterSync){if(vm.slider&&!refreshAfterSync)refreshSliderAndImageText();else{vm.slides=[],vm.slideHeadings=[],vm.slideFooters=[];for(var i=0;i<records.length;i++)vm.slideHeadings.push(records[i].Text2__c),vm.slideFooters.push(records[i].Text3__c),"Copy"==records[i].Display_Type__c?vm.slides.push({text:records[i].Image1__c}):vm.slides.push({image:records[i].Image1__c,caption:records[i].Text1__c});vm.slides.length<=1?hideSwiperPagination(vm.slidesId):showSwiperPagination(vm.slidesId),refreshAfterSync&&refreshSliderAndImageText()}}function populateMenuList(records,refreshAfterSync){vm.menuItems&&!refreshAfterSync||(vm.menuItems=records)}function populateTwinImagesSlider(records,refreshAfterSync){if(vm.slider&&!refreshAfterSync)refreshSliderAndImageText();else{vm.slides=[],vm.slideHeadings=[],vm.slideFooters=[];for(var slideFooter=null,i=0;i<records.length;i++)"Left Side Image"==records[i].Display_Type__c&&(slideFooter=records[i].Text3__c),"Right Side Image"==records[i].Display_Type__c&&(slideFooter=records[i].Text3__c),records[i].Image1__c&&(vm.slides.push({image:records[i].Image1__c,caption:records[i].Text1__c,heading:""}),vm.slideHeadings.push(records[i].Text2__c),vm.slideFooters.push(slideFooter));refreshAfterSync&&refreshSliderAndImageText()}}function populateLandscapeImageSlider(records,refreshAfterSync){if(vm.slider&&!refreshAfterSync)refreshSliderAndImageText();else{vm.slides=[],vm.slideHeadings=[],vm.slideFooters=[];for(var i=0;i<records.length;i++)records[i].Image1__c&&(vm.slides.push({image:records[i].Image1__c,caption:records[i].Text1__c}),vm.slideHeadings.push(records[i].Text2__c),vm.slideFooters.push(records[i].Text3__c));vm.slides.length<=1&&hideSwiperPagination(vm.slidesId),refreshAfterSync&&refreshSliderAndImageText()}}function populateImageAndCopySlider(records,refreshAfterSync){if(vm.slider&&!refreshAfterSync)refreshSliderAndImageText();else{vm.slides=[],vm.slideHeadings=[],vm.slideFooters=[],vm.modalSlides=[];for(var copyText=null,image=null,image2=null,slideHeading=null,slideFooter=null,i=0;i<records.length;i++)"Left Side Copy"==records[i].Display_Type__c&&(slideHeading=records[i].Text2__c,slideFooter=records[i].Text3__c,records[i].Image1__c&&(copyText=records[i].Image1__c)),"Left Side Image"==records[i].Display_Type__c&&(slideHeading=records[i].Text2__c,slideFooter=records[i].Text3__c,records[i].Image1__c&&(image=records[i].Image1__c,vm.modalSlides.push({image:records[i].Image1__c}))),"Right Side Image"==records[i].Display_Type__c&&records[i].Image1__c&&(image?image2=records[i].Image1__c:image=records[i].Image1__c,vm.modalSlides.push({image:records[i].Image1__c}),vm.slides.push({image:image,image2:image2,text:copyText}),vm.slideHeadings.push(slideHeading),vm.slideFooters.push(slideFooter),copyText=null,image=null,image2=null,slideHeading=null,slideFooter=null);vm.slides.length<=1&&hideSwiperPagination(vm.slidesId),refreshAfterSync&&refreshSliderAndImageText()}}function populateImageOrCopySlider(records,refreshAfterSync){if(vm.slider&&!refreshAfterSync)refreshSliderAndImageText();else{vm.slides=[];for(var i=0;i<records.length;i++){var image=null,copy=null,footerText=null,headerText=null,externalURL=null;"Copy"==records[i].Display_Type__c&&(headerText=records[i].Text1__c,copy=records[i].Image1__c,footerText=records[i].Text2__c,externalURL=records[i].Text3__c),"Image"==records[i].Display_Type__c&&(records[i].Image1__c&&(image=records[i].Image1__c),headerText=records[i].Text1__c,footerText=records[i].Text2__c,externalURL=records[i].Text3__c),vm.slides.push({image:image,text:copy,headerText:headerText,footerText:footerText,externalURL:externalURL})}vm.slides.length<=1&&hideSwiperPagination(vm.slidesId),refreshAfterSync&&refreshSliderAndImageText()}}function refreshSliderAndImageText(){resetSliderTimeout=$timeout(function(){vm.slider&&vm.slider.update(),adjustImageCaptionPosition(vm.imageCSSClass,vm.imageCaptionCSSClass,vm.slidesId),showingModal&&(vm.modalSlider.update(),adjustImageCaptionPosition(vm.imageCSSClassModal,vm.imageCaptionCSSClassModal,vm.modalSlidesId))},0)}function windowResizeHandler(){showingModal?adjustImageCaptionPosition(vm.imageCSSClassModal,vm.imageCaptionCSSClassModal,vm.modalSlidesId):(adjustImageCaptionPosition(vm.imageCSSClass,vm.imageCaptionCSSClass,vm.slidesId),$ionicScrollDelegate.scrollTop())}function showImageModal(index,templateName){$ionicModal.fromTemplateUrl($window.RESOURCE_ROOT+"templates/"+templateName+".html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){showingModal=!0,vm.imageModal=modal,vm.slides.length<=1?hideSwiperPagination(vm.modalSlidesId):showSwiperPagination(vm.modalSlidesId),vm.imageModal.show(),resetModalSliderTimeout=$timeout(function(){vm.modalSlider.slideTo(index,0)},0)})}function closeImageModal(){showingModal=!1,vm.slider.update(),vm.slider.slideTo(vm.modalSlider.activeIndex,0),adjustImageCaptionPosition(vm.imageCSSClass,vm.imageCaptionCSSClass,vm.slidesId),vm.imageModal&&(vm.imageModal.hide(),vm.imageModal.remove(),delete vm.imageModal)}function adjustImageCaptionPosition(imageClass,imageCaptionClass,slidesId){adjustImageTextTimeout=$timeout(function(){var slidesEl=$window.document.getElementById(slidesId),wrappedSlidesEl=angular.element(slidesEl),slidesHeight=null;wrappedSlidesEl&&wrappedSlidesEl.length>0&&(slidesHeight=wrappedSlidesEl[0].offsetHeight);var images=$window.document.getElementsByClassName(imageClass);if(images.length>0&&images[0].offsetWidth>0){for(var imageCaptions=$window.document.getElementsByClassName(imageCaptionClass),j=imageCaptions.length-1;j>=0;--j){var bottomAttr="";if(slidesHeight){var bottom=wrappedSlidesEl[0].offsetHeight-images[j].offsetHeight-images[j].offsetTop;bottomAttr=0>bottom?"bottom:0;":"bottom:"+bottom+"px;"}imageCaptions[j].setAttribute("style","width:"+images[j].offsetWidth+"px;left:"+images[j].offsetLeft+"px;display:block;"+bottomAttr)}imageCaptions=null}images=slidesEl=wrappedSlidesEl=null},0)}function hideSwiperPagination(slidesId){hideSwiperPaginationTimeout=$timeout(function(){var slidesEl=$window.document.getElementById(slidesId);if(slidesEl){var swiperPagination=slidesEl.querySelector("#"+slidesId+" > .swiper-container > .swiper-pagination"),wrappedSwiperPagination=angular.element(swiperPagination);wrappedSwiperPagination.css("display","none"),slidesEl=swiperPagination=wrappedSwiperPagination=null}},50)}function showSwiperPagination(slidesId){showSwiperPaginationTimeout=$timeout(function(){var slidesEl=$window.document.getElementById(slidesId);if(slidesEl){var swiperPagination=slidesEl.querySelector("#"+slidesId+" > .swiper-container > .swiper-pagination"),wrappedSwiperPagination=angular.element(swiperPagination);wrappedSwiperPagination.removeClass("ng-hide"),slidesEl=swiperPagination=wrappedSwiperPagination=null}},500)}function gotoPage(menuItem,menuName){$location.path("/app/contentitem/"+menuItem+"/"+encodeURIComponent(menuName))}function openWindow(url){"online"===NetworkService.getNetworkStatus()?openWindowTimeout=$timeout(function(){cordova.InAppBrowser?cordova.InAppBrowser.open(url,"_system","location=yes"):$window.open(url,"_system","location=yes")},0):alertOffline()}function alertOffline(){var alertPopup=$ionicPopup.alert({title:"No connection",template:"You need to be online to view",cssClass:"bio-popup"});alertPopup.then(function(res){})}function goBack(){$ionicHistory.backView()?$ionicHistory.goBack():"toi"===vm.menuItem||"e-learn"===vm.menuItem||"bio"===vm.menuItem||"contact-us"===vm.menuItem?$rootScope.$emit("showSideMenu"):"terms"===vm.menuItem?$rootScope.$emit("showSettingsMenu"):vm.menuItem.includes("genex-")?$rootScope.$emit("showGenexMenu"):$rootScope.$emit("showStimulanMenu")}function goHome(){$state.go("app.home")}var resetSliderTimeout,resetModalSliderTimeout,adjustImageTextTimeout,openWindowTimeout,hideSwiperPaginationTimeout,showSwiperPaginationTimeout,slideNextStartTimeout,slidePrevStartTimeout,updateTimeout,showingModal,vm=this;vm.menuItem=$stateParams.menuItem,vm.imageCSSClass="slide-image-"+$stateParams.menuItem,vm.imageCaptionCSSClass="slide-caption-text-"+$stateParams.menuItem,vm.imageCSSClassModal="modal-slide-image-"+$stateParams.menuItem,vm.imageCaptionCSSClassModal="modal-slide-caption-text-"+$stateParams.menuItem,vm.slidesId="slides-"+$stateParams.menuItem,vm.modalSlidesId="modal-slides-"+$stateParams.menuItem,vm.twinImagesSliderOptions={slidesPerView:2,breakpoints:{768:{slidesPerView:1}}},vm.showImageModal=showImageModal,vm.closeImageModal=closeImageModal,vm.gotoPage=gotoPage,vm.openWindow=openWindow,vm.goBack=goBack,vm.goHome=goHome,activate(!1);var deregisterIonicViewEnter=$scope.$on("$ionicView.enter",function(scopes,states){refreshSliderAndImageText(),angular.element($window).on("resize",windowResizeHandler),AnalyticsService.incrementKey(vm.menuItem).then(function(result){})["catch"](function(e){logger.error("ContentItemCtrl AnalyticsService.incrementKey error: "+JSON.stringify(e))})}),deregisterIonicViewLeave=($scope.$on("$ionicView.afterEnter",function(scopes,states){updateTimeout=$timeout(function(){vm.title=decodeURIComponent($stateParams.menuName)},0)}),$scope.$on("$ionicView.leave",function(scopes,states){angular.element($window).off("resize",windowResizeHandler),vm.slider&&vm.slider.slideTo(0,0),"Menu_List.html"==vm.contentItemTemplate&&$ionicScrollDelegate.scrollTop()}));$scope.$watch("vm.slider",function(slider){slider&&(adjustImageCaptionPosition(vm.imageCSSClass,vm.imageCaptionCSSClass,vm.slidesId),vm.slider.on("slideNextStart",function(){slideNextStartTimeout=$timeout(function(){$scope.$apply()},0)}),vm.slider.on("slidePrevStart",function(){slidePrevStartTimeout=$timeout(function(){$scope.$apply()},0)}))}),$scope.$watch("vm.modalSlider",function(slider){slider&&adjustImageCaptionPosition(vm.imageCSSClassModal,vm.imageCaptionCSSClassModal,vm.modalSlidesId)});var deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){if(args.result.toString().indexOf("TableComplete")>=0){var syncedTable=args.result.replace("TableComplete ","");"Surgeon_in_Hospital__ap"==syncedTable&&activate(!0)}});$scope.$on("$destroy",function(){deregisterIonicViewEnter(),deregisterIonicViewLeave(),deregisterHandleSyncTables(),$timeout.cancel(resetSliderTimeout),$timeout.cancel(resetModalSliderTimeout),$timeout.cancel(adjustImageTextTimeout),$timeout.cancel(openWindowTimeout),$timeout.cancel(hideSwiperPaginationTimeout),$timeout.cancel(showSwiperPaginationTimeout),$timeout.cancel(slideNextStartTimeout),$timeout.cancel(slidePrevStartTimeout),$timeout.cancel(updateTimeout),vm.slider&&(vm.slider.off("slideNextStart"),vm.slider.off("slidePrevStart"))})}angular.module("starter.controllers").controller("ContentItemCtrl",ContentItemCtrl),ContentItemCtrl.$inject=["$rootScope","$scope","$stateParams","$ionicLoading","$window","$timeout","$ionicModal","$location","$ionicScrollDelegate","$ionicPopup","$ionicHistory","$state","logger","ContentItemService","NetworkService","AnalyticsService"]}(),function(){"use strict";function DeployCtrl($scope,DeployService){function iconForErr(errType){switch(errType){case"info":return"ion-information-circled";default:return"ion-close-round"}}var messages=[{message:"Uploading bundle...",type:""}],appConfig={};$scope.messages=messages,DeployService.getDetails().then(function(data){return console.log("data",data),appConfig=data,DeployService.deployBunlde(appConfig)}).then(function(res){console.dir(res);var msg={message:res,type:"ok",icon:"ion-checkmark-round"};return $scope.$apply(function(){$scope.messages.push(msg),msg={message:"Uploading cache manifest...",type:""},$scope.messages.push(msg)}),DeployService.uploadCachePage(appConfig)}).then(function(res){console.dir(res);var msg={message:res,type:"ok",icon:"ion-checkmark-round"};return $scope.$apply(function(){$scope.messages.push(msg),msg={message:"Uploading start page...",type:""},$scope.messages.push(msg)}),DeployService.uploadStartPage(appConfig)}).then(function(res){console.dir(res);var msg={message:res,type:"ok",icon:"ion-checkmark-round"};$scope.$apply(function(){$scope.messages.push(msg),msg={message:"Deploy Completed successfully.",type:"final"},$scope.messages.push(msg)})})["catch"](function(err){var msg={message:err.message,type:err.type,icon:iconForErr(err.type)};$scope.$apply(function(){$scope.messages.push(msg),"error"!=err.type&&(msg={message:"Deploy Completed successfully.",type:"final"},$scope.messages.push(msg))}),console.debug(err)})}angular.module("starter.controllers").controller("DeployCtrl",DeployCtrl),DeployCtrl.$inject=["$scope","DeployService"]}(),function(){"use strict";function DiagnosticsCtrl($scope,AppRunStatusService,DiagnosticService,logger,NetworkService){function activate(){DiagnosticService.getCachedFlag().then(function(cachedFlag){vm.cachedFlag=cachedFlag})["catch"](function(e){logger.error(e)}),vm.networkStatus=NetworkService.getNetworkStatus(),DiagnosticService.getRecentLogs(5).then(function(latestLogs){vm.latestMobileLogs=latestLogs})["catch"](function(e){logger.error(e)})}function testHeartbeat(){console.debug("testHeartbeat"),vm.testTitle="Heartbeat in progress...",DiagnosticService.testVfRemote().then(function(res){vm.testTitle="Heartbeat result",vm.testResults={result:JSON.stringify(res.result),event:JSON.stringify(res.event)},$scope.$apply()})["catch"](function(e){var err=errToObj(e);vm.testTitle="Heartbeat Errored",vm.testResults={result:"-",event:"-",error:JSON.stringify(err)},$scope.$apply(),logger.error("testHeartbeat",err)})}function errToObj(e){var err={};return e instanceof Error?Object.getOwnPropertyNames(e).forEach(function(key){err[key]=e[key]}):err=e,err}var vm=this;vm.testHeartbeat=testHeartbeat,activate()}angular.module("starter.controllers").controller("DiagnosticsCtrl",DiagnosticsCtrl),DiagnosticsCtrl.$inject=["$scope","AppRunStatusService","DiagnosticService","logger","NetworkService"]}(),function(){"use strict";function SettingsHBCtrl($scope,NetworkService){localStorage.connection?$scope.heartbeatStatus=localStorage.connection:$scope.heartbeatStatus=100100,$scope.hbUpdate=function(){localStorage.connection=$scope.heartbeatStatus,100100==$scope.heartbeatStatus&&NetworkService.networkEvent("online"),100103==$scope.heartbeatStatus&&NetworkService.networkEvent("offline")}}angular.module("starter.controllers").controller("SettingsHBCtrl",SettingsHBCtrl),SettingsHBCtrl.$inject=["$scope","NetworkService"]}(),function(){"use strict";function HomeCtrl($rootScope,$scope,$ionicLoading,$window,$timeout,$location,logger,UserService,OutboxService,AnalyticsService){function activate(){UserService.getUserFirstName().then(function(result){vm.userFirstName="Hello "+result}),UserService.hasDoneProcess("initialDataLoaded").then(function(result){result||$ionicLoading.show({template:'<p id="app-progress-msg" class="item-icon-left"><h3>Loading Data...</h3><p>Please do not close the app until complete…</p><ion-spinner></ion-spinner></p>',animation:"fade-in",showBackdrop:!0,maxWidth:600,duration:0})})}function showStimulanSideMenu(){$rootScope.$emit("showStimulanMenu"),AnalyticsService.incrementKey("home-stimulan").then(function(result){})["catch"](function(e){logger.error("HomeCtrl showStimulanSideMenu AnalyticsService.incrementKey error: "+JSON.stringify(e))})}function checkOutbox(){OutboxService.getDirtyRecordsCount().then(function(result){result>0?vm.showOutboxAlert=!0:vm.showOutboxAlert=!1,refreshTimeout=$timeout(function(){$scope.$apply()},0)})}function gotoPage(path,key){AnalyticsService.incrementKey(key).then(function(result){})["catch"](function(e){logger.error("HomeCtrl gotoPage AnalyticsService.incrementKey error: "+JSON.stringify(e))}),gotoPageTimeout=$timeout(function(){$location.path(path)},0)}var slideInTimeout,gotoPageTimeout,refreshTimeout,vm=this;vm.titleImage=$window.RESOURCE_ROOT+"images/Biocomposites-header-logo.SVG",vm.homeImage=$window.RESOURCE_ROOT+"images/home.jpg",vm.orderFormSVG=$window.RESOURCE_ROOT+"images/order-form-home-icon.SVG",vm.unsolicitedSVG=$window.RESOURCE_ROOT+"images/unsolicited-request-home-icon.SVG",vm.stimulanSVG=$window.RESOURCE_ROOT+"images/stimulan-home-icon.SVG",vm.topicSVG=$window.RESOURCE_ROOT+"images/topics-of-interest-home-icon.SVG",vm.elearnSVG=$window.RESOURCE_ROOT+"images/elearn-home-icon.SVG",vm.outboxSVG=$window.RESOURCE_ROOT+"images/outbox-home-icon.SVG",vm.outboxAlertGIF=$window.RESOURCE_ROOT+"images/outbox-alert.GIF",vm.slideInHomePage=!0,vm.showOutboxAlert=!1,vm.showStimulanSideMenu=showStimulanSideMenu,vm.gotoPage=gotoPage,activate(),slideInTimeout=$timeout(function(){vm.slideInHomePage=!1},1e3);var deregisterHandleCheckOutbox=$rootScope.$on("home:checkOutbox",function(event,args){checkOutbox()}),deregisterIonicViewEnter=$scope.$on("$ionicView.enter",function(scopes,states){AnalyticsService.incrementKey("home").then(function(result){})["catch"](function(e){logger.error("HomeCtrl deregisterIonicViewEnter AnalyticsService.incrementKey error: "+JSON.stringify(e))})});$scope.$on("$destroy",function(){$timeout.cancel(slideInTimeout),$timeout.cancel(gotoPageTimeout),$timeout.cancel(refreshTimeout),deregisterHandleCheckOutbox(),deregisterIonicViewEnter()})}angular.module("starter.controllers").controller("HomeCtrl",HomeCtrl),HomeCtrl.$inject=["$rootScope","$scope","$ionicLoading","$window","$timeout","$location","logger","UserService","OutboxService","AnalyticsService"]}(),function(){"use strict";function LeadCaptureCtrl($rootScope,$scope,$ionicPopup,$state,$ionicLoading,$timeout,$ionicScrollDelegate,$ionicHistory,logger,SyncService,NetworkService,RecordTypeService,MobileDynamicService,LocalNotificationService,CameraService,AnalyticsService){function activate(){angular.copy(initialLead,vm.lead),vm.showBackButton=!0,RecordTypeService.getRecordTypeId("Mobile_Lead","Mobile_Dynamic__c").then(function(id){recordTypeId=id})}function gotoStep(step){if("eventinfo"==step)vm.showCancel=!0,$rootScope.$emit("disableSideMenu",{showSideMenu:!1}),SyncService.setSyncLock("true"),vm.newLeadTitle="- new lead",""!==vm.lead.eventName.trim()&&(vm.showBackButton=!1),"eventinfo"==step&&AnalyticsService.incrementKey("lead-new").then(function(result){})["catch"](function(e){logger.error("LeadCaptureCtrl gotoStep AnalyticsService.incrementKey error: "+JSON.stringify(e))});else if("capture-photo"==step){AnalyticsService.incrementKey("lead-new-photo").then(function(result){})["catch"](function(e){logger.error("LeadCaptureCtrl gotoStep AnalyticsService.incrementKey error: "+JSON.stringify(e))}),step=null;try{navigator.camera.getPicture(function(result){result.length<=13e4?(vm.lead.leadPhotoBase64=result,gotoStep("eventinfo")):(cameraQuality-=10,showAlert("Error","Unfortunately, the photo size is too large. Please try again."))},function(err){logger.error("CameraService.getPicture "+JSON.stringify(err))},{quality:cameraQuality,targetWidth:480,targetHeight:480,encodingType:navigator.camera.EncodingType.JPEG,destinationType:navigator.camera.DestinationType.DATA_URL})}catch(e){logger.error("CameraService.getPicture try error "+JSON.stringify(e))}}else"default"==step&&(vm.newLeadTitle="",vm.showCancel=!1,activate(),$rootScope.$emit("disableSideMenu",{showSideMenu:!0}),SyncService.setSyncLock("false"));step&&(vm.step=step,scrollTimeout=$timeout(function(){$ionicScrollDelegate.scrollTop()},50))}function stepBack(currentStep){"topic"==currentStep&&gotoStep(vm.lead.leadPhotoBase64?"eventinfo":"contactinfo")}function inputValidation(nextStepIfValid){return"leadinfo"===nextStepIfValid&&""===vm.lead.eventName.trim()?void showAlert("Error","Please enter an event name."):"contactinfo"===nextStepIfValid&&""===vm.lead.nameTitleInstitution.trim()?void showAlert("Error","Please enter a name/title/institution."):"topic"===nextStepIfValid&&""===vm.lead.contactInformation.trim()?void showAlert("Error","Please enter an e-mail/telephone/address."):"submit"===nextStepIfValid?"Select product"===vm.lead.product?void showAlert("Error","Please select a product."):""===vm.lead.notes.trim()?void showAlert("Error","Please enter your notes."):void submitLeadCapture():("leadinfo"===nextStepIfValid&&vm.lead.leadPhotoBase64&&(nextStepIfValid="topic"),void gotoStep(nextStepIfValid))}function submitLeadCapture(){$ionicLoading.show({duration:5e3,template:"Saving lead...",animation:"fade-in",showBackdrop:!0}),MobileDynamicService.insertRecord(buildLeadRecord()).then(function(resObject){$ionicLoading.hide(),"online"===NetworkService.getNetworkStatus()?(SyncService.setSyncLock("false"),SyncService.syncTables(["Mobile_Dynamic__ap","Mobile_Log__mc"]),submitSuccessful=!0,exitLeadCapture("lead-capture-submit")):($rootScope.$emit("updateOutboxCount"),$rootScope.$emit("home:checkOutbox"),LocalNotificationService.setLocalNotification(),alertOffline())})["catch"](function(e){logger.error("submitLeadCapture "+JSON.stringify(e)+" "+JSON.stringify(orderForm)),$ionicLoading.hide()})}function buildLeadRecord(){var lead={};return lead.Name="TMP-"+(new Date).valueOf(),lead.Event_Name__c=vm.lead.eventName,lead.Name_Title_Institution__c=vm.lead.nameTitleInstitution,lead.Contact_Information__c=vm.lead.contactInformation,lead.Product__c=vm.lead.product,lead.Notes__c=vm.lead.notes,vm.lead.leadPhotoBase64&&(lead.Lead_Photo_Base64__c=vm.lead.leadPhotoBase64),""!==recordTypeId&&(lead.RecordTypeId=recordTypeId),lead.Date_Entered__c=new Date,lead.Alternate_Billing_Address__c=!1,lead.STIMULAN_Bullet__c=!1,lead.STIMULAN_Kit_10cc__c=!1,lead.STIMULAN_Kit_5cc__c=!1,lead.STIMULAN_Rapid_Cure_10cc__c=!1,lead.STIMULAN_Rapid_Cure_20cc__c=!1,lead.STIMULAN_Rapid_Cure_5cc__c=!1,lead.Other_Product__c=!1,lead}function cancelLeadCapture(){var confirmPopup=$ionicPopup.confirm({title:"Cancel",template:"Are you sure?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res&&exitLeadCapture("lead-capture-cancel")})}function exitLeadCapture(analyticPoint){AnalyticsService.incrementKey(analyticPoint).then(function(result){})["catch"](function(e){logger.error("LeadCaptureCtrl exitLeadCapture AnalyticsService.incrementKey error: "+JSON.stringify(e))}),$rootScope.$emit("disableSideMenu",{showSideMenu:!0}),SyncService.setSyncLock("false"),submitSuccessful?alertSuccess():$state.go("app.home")}function alertSuccess(){var alertPopup=$ionicPopup.alert({title:"New lead",template:"Submission successful. Please allow sync to complete before closing app",cssClass:"bio-popup"});alertPopup.then(function(res){res&&$state.go("app.home")})}function alertOffline(){var alertPopup=$ionicPopup.alert({title:"You are currently offline",template:"Synchronisation will take place when you are next online",cssClass:"bio-popup"});alertPopup.then(function(res){res&&exitLeadCapture("lead-capture-submit")})}function showAlert(title,template){var alertPopup=$ionicPopup.alert({title:title,template:template,cssClass:"bio-popup"});alertPopup.then(function(res){})}var recordTypeId,scrollTimeout,vm=this,initialLead={eventName:"",nameTitleInstitution:"",contactInformation:"",product:"STIMULAN",notes:"",leadPhotoBase64:""},submitSuccessful=!1,cameraQuality=90;vm.showCancel=!1,vm.today=new Date,vm.newLeadTitle="",vm.lead={},vm.gotoStep=gotoStep,vm.stepBack=stepBack,vm.inputValidation=inputValidation,vm.cancelLeadCapture=cancelLeadCapture,activate();var deregisterIonicViewEnter=$scope.$on("$ionicView.enter",function(scopes,states){var forwardView=$ionicHistory.viewHistory().forwardView;forwardView||AnalyticsService.incrementKey("lead").then(function(result){})["catch"](function(e){logger.error("LeadCaptureCtrl deregisterIonicViewEnter AnalyticsService.incrementKey error: "+JSON.stringify(e))})});$scope.$on("$destroy",function(){$timeout.cancel(scrollTimeout),deregisterIonicViewEnter()})}angular.module("starter.controllers").controller("LeadCaptureCtrl",LeadCaptureCtrl),LeadCaptureCtrl.$inject=["$rootScope","$scope","$ionicPopup","$state","$ionicLoading","$timeout","$ionicScrollDelegate","$ionicHistory","logger","SyncService","NetworkService","RecordTypeService","MobileDynamicService","LocalNotificationService","CameraService","AnalyticsService"]}(),function(){"use strict";function LeadHistoryCtrl($rootScope,$scope,$window,$ionicLoading,$ionicModal,$state,logger,RecordTypeService,MobileDynamicService,AnalyticsService){function activate(){$ionicLoading.show({duration:5e3,template:"Loading...",animation:"fade-in",showBackdrop:!0}),vm.leads=[],RecordTypeService.getRecordTypeId("Mobile_Lead","Mobile_Dynamic__c").then(function(recordTypeId){return MobileDynamicService.getRecords(recordTypeId)}).then(function(records){for(var i=0;i<records.length;i++)-1==records[i].Id.indexOf("PROXY")&&vm.leads.push(records[i]);$ionicLoading.hide(),AnalyticsService.incrementKey("lead-history").then(function(result){})["catch"](function(e){logger.error("LeadHistoryCtrl activate AnalyticsService.incrementKey error: "+JSON.stringify(e))})})}function showModal(record){$ionicModal.fromTemplateUrl($window.RESOURCE_ROOT+"templates/leadDetail.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){vm.modal=modal,vm.modal.lead=record,vm.modal.show()})}function closeModal(){vm.modal&&(vm.modal.hide(),vm.modal.remove(),delete vm.modal)}function goHome(){$state.go("app.home")}var vm=this;vm.showModal=showModal,vm.closeModal=closeModal,vm.goHome=goHome,activate();var deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){if(args.result.toString().indexOf("TableComplete")>=0){var syncedTable=args.result.replace("TableComplete ","");"Mobile_Dynamic__ap"==syncedTable&&activate()}});$scope.$on("$destroy",function(){deregisterHandleSyncTables(),vm.modal&&(vm.modal.remove(),delete vm.modal)})}angular.module("starter.controllers").controller("LeadHistoryCtrl",LeadHistoryCtrl),LeadHistoryCtrl.$inject=["$rootScope","$scope","$window","$ionicLoading","$ionicModal","$state","logger","RecordTypeService","MobileDynamicService","AnalyticsService"]}(),function(){"use strict";function MenuCtrl($rootScope,$scope,$timeout,$ionicLoading,$ionicSideMenuDelegate,$location,$state,$ionicScrollDelegate,$ionicPopup,$window,logger,MenuService,SyncService,UserService,RecordTypeService,OutboxService,LocalNotificationService,NetworkService,AppSoupService,AnalyticsService){function activate(){MenuService.getSideMenuJson().then(function(sidemenu){sidemenu&&sidemenu[0].length>0?(vm.allSideMenuOptions=sidemenu[0],vm.stimulanMenuOption=sidemenu[1],vm.settingsMenuOption=sidemenu[2],vm.genexMenuOption=sidemenu[3],vm.menuOptions=vm.allSideMenuOptions,setRecordTypes(),updateOutboxCount(),menuRefreshTimeout=$timeout(function(){$scope.$apply(),UserService.hasDoneProcess("initialDataLoaded").then(function(result){result&&$ionicLoading.hide()})},0),"syncing"==SyncService.getSyncState()&&displayFeedbackMsg("Syncing...")):MenuService.buildAndSetSideMenuJson().then(function(result){vm.allSideMenuOptions=result[0],vm.stimulanMenuOption=result[1],vm.settingsMenuOption=result[2],vm.genexMenuOption=result[3],vm.menuOptions=vm.allSideMenuOptions,vm.allSideMenuOptions.length>0&&(setRecordTypes(),updateOutboxCount(),menuRefreshTimeout=$timeout(function(){$scope.$apply(),UserService.hasDoneProcess("initialDataLoaded").then(function(result){result&&$ionicLoading.hide()})},5e3))})})}function showSubmenu(item){vm.menuOptions=item.submenu,vm.selectedItem=item,$ionicScrollDelegate.scrollTop(),AnalyticsService.incrementKey(vm.selectedItem.name).then(function(result){})["catch"](function(e){logger.error("MenuCtrl showSubmenu AnalyticsService.incrementKey error: "+JSON.stringify(e))})}function goBack(){if(vm.selectedItem)if(0===vm.selectedItem.parentid)vm.menuOptions=vm.allSideMenuOptions,vm.selectedItem=null;else{var parentItem=findItemById(vm.allSideMenuOptions,vm.selectedItem.parentid);showSubmenu(parentItem)}}function findItemById(obj,id){if(obj.id==id)return obj;for(var i in obj)if(null!==obj[i]&&"object"==typeof obj[i]){var result=findItemById(obj[i],id);if(result)return result}return null}function doRefreshAndSync(){AnalyticsService.incrementKey("sync").then(function(result){"complete"==SyncService.getSyncState()&&SyncService.syncTables(["Mobile_Refresh__ap","Content_Item__ap","DOF__ap","DOF_Item__ap","Mobile_Dynamic__ap","Surgeon_in_Hospital__ap","Mobile_Log__mc"])})["catch"](function(e){logger.error("MenuCtrl doRefreshAndSync AnalyticsService.incrementKey error: "+JSON.stringify(e))}),$state.go("app.home")}function gotoPage(path){gotoPageTimeout=$timeout(function(){goBack(),$location.path(path)},0)}function setRecordTypes(){RecordTypeService.readAndSetRecordTypes()}function checkForMenuChanges(){MenuService.buildAndSetSideMenuJson().then(function(result){var reloadMenu=!1,newAllSideMenuOptions=result[0],newStimulanMenuOption=result[1],newGenexMenuOption=result[3],currentMainMenuOptionNames=_.pluck(vm.allSideMenuOptions,"name"),newMainMenuOptionNames=_.pluck(newAllSideMenuOptions,"name");
if(newMainMenuOptionNames.join()!==currentMainMenuOptionNames.join()&&(reloadMenu=!0),vm.stimulanMenuOption&&newStimulanMenuOption){var currentStimulanMenuOptionNames=_.pluck(vm.stimulanMenuOption.submenu,"name"),newStimulanMenuOptionNames=_.pluck(newStimulanMenuOption.submenu,"name");newStimulanMenuOptionNames.join()!==currentStimulanMenuOptionNames.join()&&(reloadMenu=!0)}if(vm.stimulanMenuOption&&!newStimulanMenuOption&&(reloadMenu=!0),!vm.stimulanMenuOption&&newStimulanMenuOption&&(reloadMenu=!0),vm.genexMenuOption&&newGenexMenuOption){var currentGenexMenuOptionNames=_.pluck(vm.genexMenuOption.submenu,"name"),newGenexMenuOptionNames=_.pluck(newGenexMenuOption.submenu,"name");newGenexMenuOptionNames.join()!==currentGenexMenuOptionNames.join()&&(reloadMenu=!0)}vm.genexMenuOption&&!newGenexMenuOption&&(reloadMenu=!0),!vm.genexMenuOption&&newGenexMenuOption&&(reloadMenu=!0),reloadMenu&&(vm.allSideMenuOptions=newAllSideMenuOptions,vm.stimulanMenuOption=newStimulanMenuOption,vm.genexMenuOption=newGenexMenuOption,vm.menuOptions=vm.allSideMenuOptions,vm.selectedItem&&goBack())})}function displayFeedbackMsg(msg){displayFeedbackMsgTimeout=$timeout(function(){vm.feedbackMsgText=msg,vm.showFeedbackMsg=!0,$scope.$apply()},0)}function delayHidingOfFeedbackMsg(delay){delayHidingOfFeedbackMsgTimeout=$timeout(function(){vm.showFeedbackMsg=!1,$scope.$apply()},delay)}function displaySyncingMessageAgain(){displaySyncingMessageAgainTimeout=$timeout(function(){vm.feedbackMsgText="Syncing...",vm.showFeedbackMsg=!0,$scope.$apply()},3e3)}function updateOutboxCount(){OutboxService.getDirtyRecords().then(function(records){for(var count=0,i=0;i<records.length;i++)("DOF__ap"===records[i].Mobile_Table_Name||"Mobile_Dynamic__ap"===records[i].Mobile_Table_Name)&&count++;count>0?vm.outboxCount=" ("+count+")":vm.outboxCount=""})}function openDistHub(){var url;"online"===NetworkService.getNetworkStatus()?(url="https://biocomposites.force.com",inAppBrowserTimeout=$timeout(function(){cordova.InAppBrowser?cordova.InAppBrowser.open(url,"_system","location=yes"):$window.open(url,"_system","location=yes")},0)):alertOffline(),AnalyticsService.incrementKey("dist-hub").then(function(result){})["catch"](function(e){logger.error("MenuCtrl openDistHub AnalyticsService.incrementKey error: "+JSON.stringify(e))}),$state.go("app.home")}function alertOffline(){var alertPopup=$ionicPopup.alert({title:"No connection",template:"You need to be online to view",cssClass:"bio-popup"});alertPopup.then(function(res){})}var displayFeedbackMsgTimeout,delayHidingOfFeedbackMsgTimeout,displaySyncingMessageAgainTimeout,gotoPageTimeout,menuRefreshTimeout,inAppBrowserTimeout,vm=this;vm.allSideMenuOptions=[],vm.stimulanMenuOption={},vm.settingsMenuOption={},vm.genexMenuOption={},vm.menuOptions=[],vm.selectedItem=null,vm.feedbackMsgText="",vm.showFeedbackMsg=!1,vm.showSideMenu=!0,vm.currentYear=(new Date).getFullYear(),vm.showSubmenu=showSubmenu,vm.goBack=goBack,vm.doRefreshAndSync=doRefreshAndSync,vm.gotoPage=gotoPage,vm.openDistHub=openDistHub,activate();var deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){if(args&&args.result)switch(args.result.toString()){case"StartSync":displayFeedbackMsg("Syncing...");break;case"Complete":delayHidingOfFeedbackMsg(0),$rootScope.$emit("home:checkOutbox"),LocalNotificationService.cancelNotification();break;case"InitialLoadComplete":activate(),UserService.setProcessDone("initialDataLoaded");break;case"100497":displayFeedbackMsg("Sync too soon, please try again in a minute"),delayHidingOfFeedbackMsg(3e3);break;case"100498":displayFeedbackMsg("Sync already in progress"),displaySyncingMessageAgain();break;case"100402":displayFeedbackMsg("Please connect before syncing"),delayHidingOfFeedbackMsg(3e3),$rootScope.$emit("home:checkOutbox"),LocalNotificationService.setLocalNotification();break;default:if(args.result.toString().indexOf("Error")>=0)displayFeedbackMsg(args.result.toString()),delayHidingOfFeedbackMsg(3e3);else if(args.result.toString().indexOf("TableComplete")>=0){var syncedTable=args.result.replace("TableComplete ","");("DOF__ap"==syncedTable||"Mobile_Dynamic__ap"==syncedTable)&&updateOutboxCount(),("DOF_Item__ap"==syncedTable||"Mobile_Dynamic__ap"==syncedTable)&&$rootScope.$emit("home:checkOutbox"),"Mobile_Refresh__ap"==syncedTable&&(checkForMenuChanges(),setRecordTypes())}}}),deregisterHandleSetSideMenuVisibility=$rootScope.$on("disableSideMenu",function(event,args){vm.showSideMenu=args.showSideMenu,$ionicSideMenuDelegate.canDragContent(args.showSideMenu)}),deregisterHandleShowStimulan=$rootScope.$on("showStimulanMenu",function(event,args){showSubmenu(vm.stimulanMenuOption),$ionicSideMenuDelegate.toggleLeft()}),deregisterHandleShowGenex=$rootScope.$on("showGenexMenu",function(event,args){showSubmenu(vm.genexMenuOption),$ionicSideMenuDelegate.toggleLeft()}),deregisterHandleShowSettings=$rootScope.$on("showSettingsMenu",function(event,args){showSubmenu(vm.settingsMenuOption),$ionicSideMenuDelegate.toggleLeft()}),deregisterHandleShowSideMenu=$rootScope.$on("showSideMenu",function(event,args){$ionicSideMenuDelegate.toggleLeft()}),deregisterHandleUpdateOutboxCount=$rootScope.$on("updateOutboxCount",function(event,args){updateOutboxCount()}),deregisterHandleOpenDistHub=$rootScope.$on("menu:openDistHub",function(event,args){openDistHub()});$scope.$on("$destroy",function(){deregisterHandleSyncTables(),deregisterHandleSetSideMenuVisibility(),deregisterHandleShowStimulan(),deregisterHandleShowGenex(),deregisterHandleShowSettings(),deregisterHandleUpdateOutboxCount(),deregisterHandleShowSideMenu(),deregisterHandleOpenDistHub(),$timeout.cancel(displayFeedbackMsgTimeout),$timeout.cancel(delayHidingOfFeedbackMsgTimeout),$timeout.cancel(displaySyncingMessageAgainTimeout),$timeout.cancel(gotoPageTimeout),$timeout.cancel(menuRefreshTimeout),$timeout.cancel(inAppBrowserTimeout)})}angular.module("starter.controllers").controller("MenuCtrl",MenuCtrl),MenuCtrl.$inject=["$rootScope","$scope","$timeout","$ionicLoading","$ionicSideMenuDelegate","$location","$state","$ionicScrollDelegate","$ionicPopup","$window","logger","MenuService","SyncService","UserService","RecordTypeService","OutboxService","LocalNotificationService","NetworkService","AppSoupService","AnalyticsService"]}(),function(){"use strict";function MTICtrl($stateParams,$scope,$rootScope,$location,$ionicPopup,$ionicLoading,DevService,devUtils,logger,syncRefresh){$stateParams.recovery&&($scope.recovery=!0);var adminTimeout=3e5;if($rootScope.adminLoggedIn>Date.now()-adminTimeout);else{$location.url("app/settings");var alertPopup=$ionicPopup.alert({title:"Access Denied"});alertPopup.then(function(res){$scope.$apply()})}DevService.allTables().then(function(tables){$scope.tables=tables},function(reason){console.error("Angular: promise returned reason -> "+reason)}),$scope.showTable=function(tableName){$location.path(decodeURIComponent("/app/settings/mti/"+tableName))},$scope.syncTable=function(tableName){var confirmPopup=$ionicPopup.confirm({title:"Sync Table",template:"<div style='text-align:center;'>Are you sure you want to sync "+tableName+"?</div>",cancelText:"No",okText:"Yes"});confirmPopup.then(function(res){res&&($ionicLoading.show({duration:1e4,template:"Syncing "+tableName+" ..."}),$scope.recovery?syncRefresh.m2pRecoveryUpdateMobileTable(tableName).then(function(resObject){var resJson=JSON.parse(resObject.result),resMsg="";console.log("resJson.is",resJson.is),resJson.is&&(resMsg+="<p>Insert Success: "+resJson.is.length+"</p>"),resObject.us&&(resMsg+="<p>Update Success: "+resJson.us.length+"</p>");$ionicPopup.alert({title:"ForceSync Success!",template:resMsg,buttons:[{text:"Done"},{text:"<b>Show Full Resp</b>",type:"button-positive",onTap:function(e){$ionicPopup.alert({title:"Full Response",template:"<p>Returned with:</p><p><pre>"+JSON.stringify(resObject)+"</pre></p>"})}}]});$ionicLoading.hide()})["catch"](function(e){logger.error("syncRefresh.m2pRecoveryUpdateMobileTable from settings "+tableName+" "+JSON.stringify(e)),$ionicLoading.hide();$ionicPopup.alert({title:"Operation failed!",template:'<p>Sorry, something went wrong.</p><p class="error_details">Error: '+e.status+" - "+e.mc_add_status+"</p>"})}):devUtils.syncMobileTable(tableName).then(function(resObject){$ionicLoading.hide()})["catch"](function(e){logger.error("syncTable from settings "+tableName+" "+JSON.stringify(e)),$ionicLoading.hide();$ionicPopup.alert({title:"Operation failed!",template:'<p>Sorry, something went wrong.</p><p class="error_details">Error: '+e.status+" - "+e.mc_add_status+"</p>"})}))})},$scope.saveTableToML=function(tableName){var confirmPopup=$ionicPopup.confirm({title:"Save Table To Mobile Log",template:"<div style='text-align:center;'>Are you sure you want to save "+tableName+"?</div>",cancelText:"No",okText:"Yes"});confirmPopup.then(function(res){res&&($ionicLoading.show({duration:1e4,template:"Saving "+tableName+" ..."}),DevService.allRecords(tableName,!1).then(function(tableRecs){return DevService.insertMobileLog(tableRecs)}).then(function(resObject){$ionicLoading.hide()})["catch"](function(e){logger.error("saveTableToML "+tableName+" "+JSON.stringify(e)),$ionicLoading.hide();$ionicPopup.alert({title:"Operation failed!",template:'<p>Sorry, something went wrong.</p><p class="error_details">Error: '+e.status+" - "+e.mc_add_status+"</p>"})}))})}}angular.module("starter.controllers").controller("MTICtrl",MTICtrl),MTICtrl.$inject=["$stateParams","$scope","$rootScope","$location","$ionicPopup","$ionicLoading","DevService","devUtils","logger","syncRefresh"]}(),function(){"use strict";function MTIDetailCtrl($scope,$stateParams,$ionicLoading,$ionicModal,DevService){$ionicLoading.show({duration:3e4,noBackdrop:!0,template:'<p id="app-progress-msg" class="item-icon-left"><i class="icon ion-loading-c"></i>Fetching records...</p>'}),$scope.table={Name:$stateParams.tableName},DevService.allRecords($stateParams.tableName,!1).then(function(tableRecs){$scope.tableRecs=tableRecs,$ionicLoading.hide()},function(reason){console.error("Angular: promise returned error -> "+reason)}),$scope.getItemHeight=function(item,index){return"undefined"!=typeof item?100+55*item.length:0},$scope.search={},$scope.clearSearch=function(){$scope.search.query=""},$scope.showRecord=function(tableRec,soupRecordId){$ionicLoading.show({duration:1e4,template:"Loading..."});for(var tableName,i=0,len=tableRec.length;len>i;i++)"Mobile_Table_Name"==tableRec[i].Name&&(tableName=tableRec[i].Value);console.log("tableName",tableName,soupRecordId),DevService.getRecordForSoupEntryId(tableName,soupRecordId).then(function(record){console.log("record",record),$scope.showTableRecord(tableName,record,soupRecordId),$ionicLoading.hide()},function(reason){$ionicLoading.hide(),console.error("getRecordForSoupEntryId "+reason)})},$scope.showTableRecord=function(tableName,record,soupRecordId){$ionicModal.fromTemplateUrl("settingDevMTITableRecord.html",function(modal){$scope.tableRecordModal=modal,$scope.tableRecordModal.tableName=tableName,$scope.tableRecordModal.record=record,$scope.tableRecordModal.soupRecordId=soupRecordId,$scope.tableRecordModal.show()},{scope:$scope,animation:"slide-in-up",backdropClickToClose:!1})},$scope.closeShowTableRecord=function(){$scope.tableRecordModal.hide(),$scope.tableRecordModal.remove(),delete $scope.tableRecordModal},$scope.reorder=function(){$scope.tableRecs=$scope.tableRecs.reverse()}}angular.module("starter.controllers").controller("MTIDetailCtrl",MTIDetailCtrl),MTIDetailCtrl.$inject=["$scope","$stateParams","$ionicLoading","$ionicModal","DevService"]}(),function(){"use strict";function MyAccountsCtrl($rootScope,$scope,$ionicLoading,$location,$timeout,$ionicScrollDelegate,$ionicModal,$ionicHistory,$window,$stateParams,logger,SyncService,OrderFormService,UserService){function showList(showLoading){showLoading&&$ionicLoading.show({duration:6e4,template:"Loading...",animation:"fade-in",showBackdrop:!0}),adjustListHeight(),UserService.hasDoneProcess("initialDataLoaded").then(function(initialInstallFinished){initialInstallFinished&&OrderFormService.getHospitals().then(function(res){res.length>0&&(vm.accounts=res),refreshTimeout=$timeout(function(){$ionicLoading.hide(),$scope.$apply()},0)})["catch"](function(resObject){logger.error("MyAccountsCtrl "+JSON.stringify(resObject)),$ionicLoading.hide()})})}function clearSearch(){vm.searchQuery=""}function scrollTop(){$ionicScrollDelegate.scrollTop()}function showModal(record){$ionicModal.fromTemplateUrl($window.RESOURCE_ROOT+"templates/accountDetail.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){vm.modal=modal,vm.modal.account=record,vm.modal.show()})}function closeModal(){vm.modal&&(vm.modal.hide(),vm.modal.remove(),delete vm.modal)}function adjustListHeight(){var winHeight=$window.innerHeight-175,accountsList=$window.document.getElementById("accounts-list");accountsList&&accountsList.setAttribute("style","height:"+winHeight+"px")}function windowResizeHandler(){adjustListHeight()}var refreshTimeout,vm=this;vm.accounts=[],vm.searchQuery="",vm.scrollTop=scrollTop,vm.clearSearch=clearSearch,vm.showModal=showModal,vm.closeModal=closeModal;var deregisterHandleViewLoaded=$scope.$on("$ionicView.loaded",function(viewInfo,state){angular.element($window).on("resize",windowResizeHandler)}),deregisterHandleViewLeave=$scope.$on("$ionicView.leave",function(scopes,states){angular.element($window).off("resize",windowResizeHandler)}),deregisterHandleViewAfterLeave=$scope.$on("$ionicView.afterLeave",function(){$ionicHistory.clearCache()}),deregisterIonicViewBeforeEnter=$scope.$on("$ionicView.beforeEnter",function(scopes,states){showList(!0)}),deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){if(console.info("bio MyAccountsCtrl syncTables: "+JSON.stringify(args)),args&&args.result){var syncResult=args.result.toString();switch(syncResult){case"InitialLoadComplete":0===vm.accounts.length?showList(!0):$ionicLoading.hide(),UserService.setProcessDone("initialDataLoaded");break;default:if(args.table){var syncedTable=args.table.toString();"Surgeon_in_Hospital__ap"==syncedTable&&showList(!1)}}}});$scope.$on("$destroy",function(){deregisterHandleSyncTables(),deregisterIonicViewBeforeEnter(),deregisterHandleViewLoaded(),deregisterHandleViewLeave(),deregisterHandleViewAfterLeave(),$timeout.cancel(refreshTimeout)})}angular.module("starter.controllers").controller("MyAccountsCtrl",MyAccountsCtrl),MyAccountsCtrl.$inject=["$rootScope","$scope","$ionicLoading","$location","$timeout","$ionicScrollDelegate","$ionicModal","$ionicHistory","$window","$stateParams","logger","SyncService","OrderFormService","UserService"]}(),function(){"use strict";function NewAccountCtrl($rootScope,$scope,$ionicPopup,$state,$ionicLoading,$timeout,$ionicScrollDelegate,$ionicHistory,logger,SyncService,NetworkService,RecordTypeService,MobileDynamicService,LocalNotificationService,UserService,AnalyticsService){function activate(){angular.copy(initialAccount,vm.account),vm.billingAddress={},vm.billingAddress.isSameAsMainAddress=!0,vm.billingAddress.isAlternativeAddress=!1,vm.showBackButton=!0,RecordTypeService.getRecordTypeId("New_Account","Mobile_Dynamic__c").then(function(id){recordTypeId=id,UserService.getUserCurrencySymbol().then(function(result){vm.currencySymbol=result})})}function gotoStep(step){"hosp-details"==step?(vm.showCancel=!0,$rootScope.$emit("disableSideMenu",{showSideMenu:!1}),SyncService.setSyncLock("true"),""!==vm.account.hospitalName.trim()&&(vm.showBackButton=!1),AnalyticsService.incrementKey("new-account-start").then(function(result){})["catch"](function(e){logger.error("NewAccountCtrl gotoStep AnalyticsService.incrementKey error: "+JSON.stringify(e))})):"default"==step&&(vm.showCancel=!1,activate(),$rootScope.$emit("disableSideMenu",{showSideMenu:!0}),SyncService.setSyncLock("false")),step&&(vm.step=step,scrollTimeout=$timeout(function(){$ionicScrollDelegate.scrollTop()},50))}function inputValidation(nextStepIfValid){if("bill-address"===nextStepIfValid){if(""===vm.account.hospitalName.trim())return void showAlert("Error","Please enter a hospital name.");if(""===vm.account.address.trim())return void showAlert("Error","Please enter a hospital address.")}if("products"===nextStepIfValid&&(vm.billingAddress.isAlternativeAddress&&""===vm.account.alternateBillingAddressDetails.trim()||!vm.billingAddress.isAlternativeAddress&&""!==vm.account.alternateBillingAddressDetails.trim()))return void showAlert("Error","Please enter an alternative billing address and tick the option.");if("add-info"===nextStepIfValid){var errorMsg=validateProducts();if(""!==errorMsg)return void showAlert("Error",errorMsg)}return"submit"===nextStepIfValid?void submitNewAccount():void gotoStep(nextStepIfValid)}function validateProducts(){var errorMsg="";return vm.account.STIMULANRapidCure5cc||vm.account.STIMULANRapidCure10cc||vm.account.STIMULANRapidCure20cc||vm.account.STIMULANKit5cc||vm.account.STIMULANKit10cc||vm.account.STIMULANBullet||""!==vm.account.otherProductDetails||(errorMsg="Please select at least one product."),("undefined"==typeof vm.account.STIMULANRapidCure5ccPrice||vm.account.STIMULANRapidCure5ccPrice&&!isValidPrice(vm.account.STIMULANRapidCure5ccPrice))&&(errorMsg="Please enter a valid STIMULAN Rapid Cure 5cc price."),("undefined"==typeof vm.account.STIMULANRapidCure10ccPrice||vm.account.STIMULANRapidCure10ccPrice&&!isValidPrice(vm.account.STIMULANRapidCure10ccPrice))&&(errorMsg="Please enter a valid STIMULAN Rapid Cure 10cc price."),("undefined"==typeof vm.account.STIMULANRapidCure20ccPrice||vm.account.STIMULANRapidCure20ccPrice&&!isValidPrice(vm.account.STIMULANRapidCure20ccPrice))&&(errorMsg="Please enter a valid STIMULAN Rapid Cure 20cc price."),("undefined"==typeof vm.account.STIMULANKit5ccPrice||vm.account.STIMULANKit5ccPrice&&!isValidPrice(vm.account.STIMULANKit5ccPrice))&&(errorMsg="Please enter a valid STIMULAN Kit 5cc price."),("undefined"==typeof vm.account.STIMULANKit10ccPrice||vm.account.STIMULANKit10ccPrice&&!isValidPrice(vm.account.STIMULANKit10ccPrice))&&(errorMsg="Please enter a valid STIMULAN Kit 10cc price."),("undefined"==typeof vm.account.STIMULANBulletPrice||vm.account.STIMULANBulletPrice&&!isValidPrice(vm.account.STIMULANBulletPrice))&&(errorMsg="Please enter a valid STIMULAN Bullet Mat and Introducer price."),!vm.account.STIMULANRapidCure5cc&&vm.account.STIMULANRapidCure5ccPrice&&(errorMsg="Please select the STIMULAN Rapid Cure 5cc product."),!vm.account.STIMULANRapidCure10cc&&vm.account.STIMULANRapidCure10ccPrice&&(errorMsg="Please select the STIMULAN Rapid Cure 10cc product."),!vm.account.STIMULANRapidCure20cc&&vm.account.STIMULANRapidCure20ccPrice&&(errorMsg="Please select the STIMULAN Rapid Cure 20cc product."),!vm.account.STIMULANKit5cc&&vm.account.STIMULANKit5ccPrice&&(errorMsg="Please select the STIMULAN Kit 5cc product."),!vm.account.STIMULANKit10cc&&vm.account.STIMULANKit10ccPrice&&(errorMsg="Please select the STIMULAN Kit 10cc product."),!vm.account.STIMULANBullet&&vm.account.STIMULANBulletPrice&&(errorMsg="Please select the STIMULAN Bullet Mat and Introducer product."),errorMsg}function submitNewAccount(){$ionicLoading.show({duration:5e3,template:"Saving account...",animation:"fade-in",showBackdrop:!0}),MobileDynamicService.insertRecord(buildAccountRecord()).then(function(resObject){$ionicLoading.hide(),"online"===NetworkService.getNetworkStatus()?(SyncService.setSyncLock("false"),SyncService.syncTables(["Mobile_Dynamic__ap","Mobile_Log__mc"]),submitSuccessful=!0,exitNewAccount("new-account-submit")):($rootScope.$emit("updateOutboxCount"),$rootScope.$emit("home:checkOutbox"),LocalNotificationService.setLocalNotification(),alertOffline())})["catch"](function(e){logger.error("submitNewAccount "+JSON.stringify(e)+" "+JSON.stringify(orderForm)),$ionicLoading.hide()})}function buildAccountRecord(){var account={};return account.Name="TMP-"+(new Date).valueOf(),account.Hospital_Name__c=vm.account.hospitalName.trim(),account.Address__c=vm.account.address.trim(),account.Alternate_Billing_Address__c=vm.billingAddress.isAlternativeAddress,vm.billingAddress.isAlternativeAddress&&(account.Alternate_Billing_Address_Details__c=vm.account.alternateBillingAddressDetails.trim()),account.STIMULAN_Rapid_Cure_5cc__c=vm.account.STIMULANRapidCure5cc,vm.account.STIMULANRapidCure5cc&&(account.STIMULAN_Rapid_Cure_5cc_Price__c=vm.account.STIMULANRapidCure5ccPrice),account.STIMULAN_Rapid_Cure_10cc__c=vm.account.STIMULANRapidCure10cc,vm.account.STIMULANRapidCure10cc&&(account.STIMULAN_Rapid_Cure_10cc_Price__c=vm.account.STIMULANRapidCure10ccPrice),account.STIMULAN_Rapid_Cure_20cc__c=vm.account.STIMULANRapidCure20cc,vm.account.STIMULANRapidCure20cc&&(account.STIMULAN_Rapid_Cure_20cc_Price__c=vm.account.STIMULANRapidCure20ccPrice),account.STIMULAN_Kit_5cc__c=vm.account.STIMULANKit5cc,vm.account.STIMULANKit5cc&&(account.STIMULAN_Kit_5cc_Price__c=vm.account.STIMULANKit5ccPrice),account.STIMULAN_Kit_10cc__c=vm.account.STIMULANKit10cc,vm.account.STIMULANKit10cc&&(account.STIMULAN_Kit_10cc_Price__c=vm.account.STIMULANKit10ccPrice),account.STIMULAN_Bullet__c=vm.account.STIMULANBullet,vm.account.STIMULANBullet&&(account.STIMULAN_Bullet_Price__c=vm.account.STIMULANBulletPrice),vm.account.otherProductDetails&&""!==vm.account.otherProductDetails.trim()?(account.Other_Product_Details__c=vm.account.otherProductDetails.trim(),account.Other_Product__c=!0):account.Other_Product__c=!1,vm.account.hospitalContactInfo&&(account.Hospital_Contact_Info__c=vm.account.hospitalContactInfo.trim()),vm.account.additionalComments&&(account.Additional_Comments__c=vm.account.additionalComments.trim()),""!==recordTypeId&&(account.RecordTypeId=recordTypeId),account.Date_Entered__c=new Date,account}function billAddressCheckboxChange(checkbox){"isSameAsMainAddress"==checkbox?(vm.billingAddress.isSameAsMainAddress=!0,vm.billingAddress.isAlternativeAddress=!1):(vm.billingAddress.isSameAsMainAddress=!1,vm.billingAddress.isAlternativeAddress=!0)}function cancelNewAccount(){var confirmPopup=$ionicPopup.confirm({title:"Cancel",template:"Are you sure?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res&&exitNewAccount("new-account-cancel")})}function exitNewAccount(analyticPoint){AnalyticsService.incrementKey(analyticPoint).then(function(result){})["catch"](function(e){logger.error("NewAccountCtrl exitNewAccount AnalyticsService.incrementKey error: "+JSON.stringify(e))}),$rootScope.$emit("disableSideMenu",{showSideMenu:!0}),SyncService.setSyncLock("false"),submitSuccessful?alertSuccess():$state.go("app.home")}function alertSuccess(){var alertPopup=$ionicPopup.alert({title:"New account",template:"Submission successful. Please allow sync to complete before closing app",cssClass:"bio-popup"});alertPopup.then(function(res){res&&$state.go("app.home")})}function alertOffline(){var alertPopup=$ionicPopup.alert({title:"You are currently offline",template:"Synchronisation will take place when you are next online",cssClass:"bio-popup"});alertPopup.then(function(res){res&&exitNewAccount("new-account-submit")})}function showAlert(title,template){var alertPopup=$ionicPopup.alert({title:title,template:template,cssClass:"bio-popup"});alertPopup.then(function(res){})}function isValidPrice(n){return/^\d*\.?\d{0,2}$/.test(n)}var recordTypeId,scrollTimeout,vm=this,initialAccount={hospitalName:"",address:"",alternateBillingAddressDetails:"",STIMULANRapidCure5cc:!1,STIMULANRapidCure5ccPrice:null,STIMULANRapidCure10cc:!1,STIMULANRapidCure10ccPrice:null,STIMULANRapidCure20cc:!1,STIMULANRapidCure20ccPrice:null,STIMULANKit5cc:!1,STIMULANKit5ccPrice:null,STIMULANKit10cc:!1,STIMULANKit10ccPrice:null,STIMULANBullet:!1,STIMULANBulletPrice:null,otherProduct:!1,otherProductDetails:"",hospitalContactInfo:"",additionalComments:""},submitSuccessful=!1;vm.showCancel=!1,vm.today=new Date,vm.account={},vm.gotoStep=gotoStep,vm.inputValidation=inputValidation,vm.cancelNewAccount=cancelNewAccount,vm.billAddressCheckboxChange=billAddressCheckboxChange,activate();var deregisterIonicViewEnter=$scope.$on("$ionicView.enter",function(scopes,states){var forwardView=$ionicHistory.viewHistory().forwardView;forwardView||AnalyticsService.incrementKey("new-account").then(function(result){})["catch"](function(e){logger.error("NewAccountCtrl deregisterIonicViewEnter AnalyticsService.incrementKey error: "+JSON.stringify(e))})});$scope.$on("$destroy",function(){$timeout.cancel(scrollTimeout),deregisterIonicViewEnter()})}angular.module("starter.controllers").controller("NewAccountCtrl",NewAccountCtrl),NewAccountCtrl.$inject=["$rootScope","$scope","$ionicPopup","$state","$ionicLoading","$timeout","$ionicScrollDelegate","$ionicHistory","logger","SyncService","NetworkService","RecordTypeService","MobileDynamicService","LocalNotificationService","UserService","AnalyticsService"]}(),function(){"use strict";function NewAccountHistoryCtrl($rootScope,$scope,$window,$ionicLoading,$ionicModal,$state,logger,RecordTypeService,MobileDynamicService,UserService,AnalyticsService){function activate(){$ionicLoading.show({duration:5e3,template:"Loading...",animation:"fade-in",showBackdrop:!0}),vm.accounts=[],RecordTypeService.getRecordTypeId("New_Account","Mobile_Dynamic__c").then(function(recordTypeId){return MobileDynamicService.getRecords(recordTypeId)}).then(function(records){for(var i=0;i<records.length;i++)-1==records[i].Id.indexOf("PROXY")&&vm.accounts.push(records[i]);UserService.getUserCurrencySymbol().then(function(result){vm.currencySymbol=result}),$ionicLoading.hide(),AnalyticsService.incrementKey("new-account-history").then(function(result){})["catch"](function(e){logger.error("NewAccountHistoryCtrl activate AnalyticsService.incrementKey error: "+JSON.stringify(e))})})}function showModal(record){$ionicModal.fromTemplateUrl($window.RESOURCE_ROOT+"templates/newAccountDetail.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){vm.modal=modal,vm.modal.account=record,vm.modal.show()})}function closeModal(){vm.modal&&(vm.modal.hide(),vm.modal.remove(),delete vm.modal)}function goHome(){$state.go("app.home")}var vm=this;vm.showModal=showModal,vm.closeModal=closeModal,vm.goHome=goHome,activate();var deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){if(args.result.toString().indexOf("TableComplete")>=0){var syncedTable=args.result.replace("TableComplete ","");"Mobile_Dynamic__ap"==syncedTable&&activate()}});$scope.$on("$destroy",function(){deregisterHandleSyncTables(),vm.modal&&(vm.modal.remove(),delete vm.modal)})}angular.module("starter.controllers").controller("NewAccountHistoryCtrl",NewAccountHistoryCtrl),NewAccountHistoryCtrl.$inject=["$rootScope","$scope","$window","$ionicLoading","$ionicModal","$state","logger","RecordTypeService","MobileDynamicService","UserService","AnalyticsService"]}(),function(){"use strict";function OrderHistoryCtrl($rootScope,$scope,$ionicLoading,$window,$ionicModal,$state,logger,OrderFormService,UserService,AnalyticsService){function activate(){$ionicLoading.show({duration:5e3,template:"Loading...",animation:"fade-in",showBackdrop:!0}),UserService.getUserCurrencySymbol().then(function(result){vm.currencySymbol=result}),vm.orders=[],vm.orderItems=[],OrderFormService.getOrders().then(function(records){for(var i=0;i<records.length;i++)if(-1==records[i].Id.indexOf("PROXY")){var hospitalNotification;hospitalNotification="Do not send"==records[i].Send_Confirmation__c?records[i].Send_Confirmation__c:"Send to alternative address"==records[i].Send_Confirmation__c?"alternative e-mail address - "+records[i].Alternative_Email__c:"e-mail address on file - "+records[i].Hospital_Email__c,vm.orders.push({record:records[i],items:[],hospitalNotification:hospitalNotification})}return OrderFormService.getOrderItems()}).then(function(records){for(var j=0;j<records.length;j++)for(var k=0;k<vm.orders.length;k++)vm.orders[k].record.Id==records[j].DOF__c&&(records[j].Product_Name__c?vm.orders[k].items.push({productName:records[j].Product_Name__c,lotNumber:records[j].Lot_Number__c,price:records[j].Entered_Price__c,priceEntered:records[j].Price_Entered__c,expiryDate:records[j].Expiry_Date__c}):records[j].Product_Name_from_Lot_Number__c?vm.orders[k].items.push({productName:records[j].Product_Name_from_Lot_Number__c,lotNumber:records[j].Lot_Number__c,price:records[j].Entered_Price__c,priceEntered:records[j].Price_Entered__c,expiryDate:records[j].Expiry_Date__c}):vm.orders[k].items.push({lotNumber:records[j].Lot_Number__c,price:records[j].Entered_Price__c,priceEntered:records[j].Price_Entered__c}));$ionicLoading.hide(),AnalyticsService.incrementKey("order-form-history").then(function(result){})["catch"](function(e){logger.error("OrderHistoryCtrl activate AnalyticsService.incrementKey error: "+JSON.stringify(e))})})}function showModal(order){$ionicModal.fromTemplateUrl($window.RESOURCE_ROOT+"templates/orderDetail.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){vm.modal=modal,vm.modal.order=order,vm.modal.show()})}function closeModal(){vm.modal&&(vm.modal.hide(),vm.modal.remove(),delete vm.modal)}function goHome(){$state.go("app.home")}var vm=this;vm.showModal=showModal,vm.closeModal=closeModal,vm.goHome=goHome,activate();var deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){if(args.result.toString().indexOf("TableComplete")>=0){var syncedTable=args.result.replace("TableComplete ","");"DOF_Item__ap"==syncedTable&&activate()}});$scope.$on("$destroy",function(){deregisterHandleSyncTables(),vm.modal&&(vm.modal.remove(),delete vm.modal)})}angular.module("starter.controllers").controller("OrderHistoryCtrl",OrderHistoryCtrl),OrderHistoryCtrl.$inject=["$rootScope","$scope","$ionicLoading","$window","$ionicModal","$state","logger","OrderFormService","UserService","AnalyticsService"]}(),function(){"use strict";function OrderFormCtrl($rootScope,$scope,$window,$ionicPopup,$state,$ionicLoading,$timeout,$cordovaBarcodeScanner,$ionicScrollDelegate,$ionicHistory,logger,OrderFormService,SyncService,RecentItemsService,NetworkService,LocalNotificationService,UserService,AnalyticsService){function activate(){OrderFormService.getProducts().then(function(records){return vm.allProducts=records,OrderFormService.getLotNumbers()}).then(function(records){vm.allLotNumbers=records}),vm.hospitals=[],OrderFormService.getHospitals().then(function(records){return vm.hospitals=records.map(function(el){return{id:el.Hospital__c,name:el.Hospital_Name__c,email:el.Hospital_Email__c}}),RecentItemsService.getRecentHospitals(vm.hospitals)}).then(function(recentHospitals){vm.recentHospitals=recentHospitals}),vm.allSurgeons=[],OrderFormService.getSurgeons().then(function(records){return vm.allSurgeons=records.map(function(el){return{id:el.Surgeon__c,name:el.Salutation__c+" "+el.First_Name__c+" "+el.Last_Name__c,hospitalId:el.Hospital__c}}),RecentItemsService.getRecentSurgeons(vm.allSurgeons)}).then(function(recentSurgeons){vm.allRecentSurgeons=recentSurgeons}),vm.showManualInputBackButton=!0,UserService.getUserCurrencySymbol().then(function(result){vm.currencySymbol=result})}function gotoStep(step){("manual"==step||"scangood"==step||"scanbad"==step)&&(vm.showCancel=!0,$rootScope.$emit("disableSideMenu",{showSideMenu:!1}),SyncService.setSyncLock("true")),"confirmation"==step&&(vm.isFirstTimeThru=!1,createSignaturePad()),"default"==step&&(vm.showCancel=!1,$rootScope.$emit("disableSideMenu",{showSideMenu:!0}),SyncService.setSyncLock("false")),"manualinputgood"==step&&(vm.showManualInputBackButton=!1),vm.step=step,scrollTimeout=$timeout(function(){$ionicScrollDelegate.scrollTop()},50)}function createSignaturePad(){signaturePadTimeout=$timeout(function(){var canvas=angular.element(document.getElementById("signatureCanvas"))[0];resizeCanvas(canvas),signaturePad=new SignaturePad(canvas,{backgroundColor:"#FFFFFF",minWidth:1,maxWidth:1.5,onBegin:onBeginSignature,onEnd:onEndSignature
}),signatureDataURL&&signaturePad.fromDataURL(signatureDataURL),canvas=null},0)}function onBeginSignature(){onBeginSignatureTimeout=$timeout(function(){$ionicScrollDelegate.freezeAllScrolls(!0)},0)}function onEndSignature(){onEndSignatureTimeout=$timeout(function(){$ionicScrollDelegate.freezeAllScrolls(!1),signatureDataURL=signaturePad.toDataURL()},0)}function displayNewManualInput(step){vm.manualInput={},vm.manualInput.lotNumber={part1:null,part2:null,part3:"",part4:""},vm.manualInput.price=null,vm.manualInput.isCharge=!0,vm.manualInput.isNoCharge=!1,vm.product=null,AnalyticsService.incrementKey("order-form-manual").then(function(result){})["catch"](function(e){logger.error("OrderFormCtrl displayNewManualInput AnalyticsService.incrementKey error: "+JSON.stringify(e))}),gotoStep(step)}function lotNumberPart1Change(){vm.manualInput.lotNumber.part1.length<2&&(vm.manualInputMessage=ENTER_FIRST_DIGITS_MSG,vm.manualInputValid=!0),0===vm.manualInput.lotNumber.part1.length?vm.isLegacyLotNumber=!1:isNaN(vm.manualInput.lotNumber.part1)?(console.log("Is new number"),2==vm.manualInput.lotNumber.part1.length&&(vm.isLegacyLotNumber=!1,hasNumbers(vm.manualInput.lotNumber.part1)?(vm.manualInputMessage=ENTRY_INVALID,vm.manualInputValid=!1):(vm.manualInputValid=!0,vm.manualInputMessage=ENTER_REMAINING))):(console.log("Is legacy"),vm.isLegacyLotNumber||(vm.manualInput.lotNumber.newPart2=""),vm.isLegacyLotNumber=!0,2==vm.manualInput.lotNumber.part1.length&&(vm.manualInputMessage=ENTER_REMAINING_LEGACY))}function lotNumberPart2NewChange(){vm.manualInput.lotNumber.newPart2&&vm.manualInput.lotNumber.newPart2.toString().length>6&&(vm.manualInput.lotNumber.newPart2=parseInt(vm.manualInput.lotNumber.newPart2.toString().substring(0,6)))}function hasNumbers(t){return/\d/.test(t)}function manualInputLotNumberMatch(nextStepIfValid){0===vm.allLotNumbers.length?($ionicLoading.show({duration:5e3,template:"Loading lot numbers...",animation:"fade-in",showBackdrop:!0}),OrderFormService.getLotNumbers().then(function(records){vm.allLotNumbers=records,matchLotNumber(nextStepIfValid),$ionicLoading.hide()})):matchLotNumber(nextStepIfValid)}function matchLotNumber(nextStepIfValid){if(vm.isLegacyLotNumber&&!vm.manualInput.lotNumber.part1&&!vm.manualInput.lotNumber.part2||!vm.isLegacyLotNumber&&!vm.manualInput.lotNumber.part1&&!vm.manualInput.lotNumber.newPart2)return void showAlert("Error","Please enter all parts of the lot number.");vm.manualInput.lotNumberCombined="",vm.isLegacyLotNumber?(vm.manualInput.lotNumber.part1&&(vm.manualInput.lotNumberCombined+=("00"+vm.manualInput.lotNumber.part1).slice(-2)+"/"),vm.manualInput.lotNumber.part2&&(vm.manualInput.lotNumberCombined+=("00"+vm.manualInput.lotNumber.part2).slice(-2)+"-"),vm.manualInput.lotNumber.part3&&(vm.manualInput.lotNumberCombined+=vm.manualInput.lotNumber.part3),vm.manualInput.lotNumber.part4&&(vm.manualInput.lotNumberCombined+="/"+vm.manualInput.lotNumber.part4)):vm.manualInput.lotNumberCombined=vm.manualInput.lotNumber.part1+vm.manualInput.lotNumber.newPart2,vm.manualInput.lotNumberCombined=vm.manualInput.lotNumberCombined.toUpperCase();for(var matchedLotNumber=null,i=0;i<vm.allLotNumbers.length;i++)vm.allLotNumbers[i].Lot_Number__c.toUpperCase()==vm.manualInput.lotNumberCombined&&(matchedLotNumber=vm.allLotNumbers[i]);matchedLotNumber?(vm.manualInput.name=matchedLotNumber.Product_Name__c,vm.manualInput.expiryDate=matchedLotNumber.Expiry_Date__c,gotoStep(nextStepIfValid)):confirmManualInputLotNumberNotMatched(nextStepIfValid)}function confirmManualInputLotNumberNotMatched(nextStepIfValid){var confirmPopup=$ionicPopup.confirm({title:"Lot Number Not Matched",template:vm.manualInput.lotNumberCombined+"<br/><br/>Would you like to continue or re-enter lot number?",cssClass:"bio-popup",cancelText:"Re-enter",cancelType:"button-dark",okText:"Continue",okType:"button-positive"});confirmPopup.then(function(res){res&&manualInputValidation(nextStepIfValid)})}function manualInputValidation(nextStepIfValid){vm.isLegacyLotNumber?null===vm.manualInput.lotNumber.part1||null===vm.manualInput.lotNumber.part2||""===vm.manualInput.lotNumber.part1||""===vm.manualInput.lotNumber.part2?showAlert("Error","Please enter all parts of the lot number."):vm.manualInput.lotNumber.part1<0||vm.manualInput.lotNumber.part1>99?showAlert("Error","The first part of the lot number can only be a maximum of two digits."):vm.manualInput.lotNumber.part2<0||vm.manualInput.lotNumber.part2>99?showAlert("Error","The second part of the lot number can only be a maximum of two digits."):""===vm.manualInput.lotNumber.part3.trim()?showAlert("Error","Please enter all parts of the lot number."):gotoStep(nextStepIfValid):vm.manualInput.lotNumber.newPart2.toString().length<6?showAlert("Error","The second part of the lot number must be 6 digits."):gotoStep(nextStepIfValid)}function manualInputPriceValidation(nextStepIfValid){!vm.manualInput.isCharge||null!==vm.manualInput.price&&0!==vm.manualInput.price?manualInputPriceValidationContinued(nextStepIfValid):confirmManualInputNoPrice(nextStepIfValid)}function confirmManualInputNoPrice(nextStepIfValid){var confirmPopup=$ionicPopup.confirm({title:"No Price Entered",template:"Would you like to enter a price?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res||(vm.manualInput.price=0,manualInputPriceValidationContinued(nextStepIfValid))})}function manualInputPriceValidationContinued(nextStepIfValid){if(vm.manualInput.isNoCharge&&null!==vm.manualInput.price)return void showAlert("Error","You have entered a price, but selected no charge.");if(vm.manualInput.isCharge&&!isValidPrice(vm.manualInput.price))showAlert("Error","Please enter a valid price.");else{vm.manualInput.isNoCharge&&(vm.manualInput.price=0);var product={id:"MANUAL-"+(new Date).valueOf(),lotNumber:vm.manualInput.lotNumberCombined,price:vm.manualInput.price,isCharge:vm.manualInput.isCharge,isNoCharge:vm.manualInput.isNoCharge};vm.manualInput.name&&(product.name=vm.manualInput.name),vm.manualInput.expiryDate&&(product.expiryDate=vm.manualInput.expiryDate),vm.selectedProducts.push(product),"selecthospital"==nextStepIfValid?displayHospitalSelection(nextStepIfValid):gotoStep(nextStepIfValid)}}function scannedProductDetailsValidation(nextStepIfValid){!vm.product.isCharge||null!==vm.product.price&&0!==vm.product.price?scannedProductDetailsValidationContinued(nextStepIfValid):confirmScannedInputNoPrice(nextStepIfValid)}function confirmScannedInputNoPrice(nextStepIfValid){var confirmPopup=$ionicPopup.confirm({title:"No Price Entered",template:"Would you like to enter a price?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res||(vm.product.price=0,scannedProductDetailsValidationContinued(nextStepIfValid))})}function scannedProductDetailsValidationContinued(nextStepIfValid){return vm.product.isNoCharge&&null!==vm.product.price?void showAlert("Error","You have entered a price, but selected no charge."):void(vm.product.isCharge&&!isValidPrice(vm.product.price)?showAlert("Error","Please enter a valid price."):(vm.product.isNoCharge&&(vm.product.price=0),vm.selectedProducts.push(vm.product),"selecthospital"==nextStepIfValid?displayHospitalSelection(nextStepIfValid):gotoStep(nextStepIfValid)))}function hospitalDetailsValidation(nextStepIfValid){vm.selectedHospital.replaceStockYes&&""===vm.selectedHospital.replaceStockComments.trim()?showAlert("Error","Please enter stock replacement details if you've selected 'Replace stock to'."):vm.selectedHospital.replaceStockNo&&""!==vm.selectedHospital.replaceStockComments.trim()?showAlert("Error","You have entered stock details but selected 'Don't replace stock'."):(vm.selectedHospital.stockInstruction=vm.selectedHospital.replaceStockYes?"Replace stock":"Don't replace stock",RecentItemsService.getRecentItems("recentStockNotification").then(function(recentItems){var canAddItem=!0;if(recentItems.length>0&&(vm.selectedHospital.replaceStockNo&&recentItems[0].replaceStockNo&&(canAddItem=!1),vm.selectedHospital.replaceStockYes&&recentItems[0].replaceStockYes&&vm.selectedHospital.replaceStockComments.trim()==recentItems[0].replaceStockComments&&(canAddItem=!1)),canAddItem){var recentItemToSave={replaceStockYes:vm.selectedHospital.replaceStockYes,replaceStockNo:vm.selectedHospital.replaceStockNo,replaceStockComments:vm.selectedHospital.replaceStockComments.trim()};RecentItemsService.addRecentItem("recentStockNotification",recentItemToSave).then(function(recentItems){vm.recentStockNotifications=recentItems})}}),"selectsurgeon"==nextStepIfValid||"confirmsurgeon"==nextStepIfValid?displaySurgeonSelection(nextStepIfValid):gotoStep(nextStepIfValid))}function newHospitalValidation(nextStepIfValid){""===vm.newHospital.name.trim()&&""===vm.newHospital.address.trim()?showAlert("Error","Please enter a name and address of the hospital - or select one from the Recent/All tabs."):""===vm.newHospital.name.trim()&&""!==vm.newHospital.address.trim()||""!==vm.newHospital.name.trim()&&""===vm.newHospital.address.trim()?showAlert("Error","Please enter both the name and address of the hospital."):displayHospitalDetails(vm.newHospital,nextStepIfValid)}function newSurgeonValidation(nextStepIfValid){""===vm.newSurgeon.firstName.trim()&&""===vm.newSurgeon.lastName.trim()?showAlert("Error","Please enter a first and last name for the surgeon - or select one from the Recent/All tabs."):""===vm.newSurgeon.firstName.trim()&&""!==vm.newSurgeon.lastName.trim()||""!==vm.newSurgeon.firstName.trim()&&""===vm.newSurgeon.lastName.trim()?showAlert("Error","Please enter both the first and last names."):(vm.newSurgeon.name=vm.newSurgeon.firstName.trim()+" "+vm.newSurgeon.lastName.trim(),displaySurgeonDetails(vm.newSurgeon,nextStepIfValid))}function surgeonDetailsValidation(nextStepIfValid){if(vm.procedureType&&"Please select"!==vm.procedureType)if(vm.procedureDate){if(vm.selectedProducts&&vm.selectedProducts.length>0){for(var isNoChargeCount=0,zeroPriceCount=0,i=0,len=vm.selectedProducts.length;len>i;i++)vm.selectedProducts[i].isNoCharge&&(isNoChargeCount+=1),0===vm.selectedProducts[i].price&&(zeroPriceCount+=1);if(0!==isNoChargeCount&&""===vm.procedureComments.trim())return void showAlert("Error","You selected no charge. Please add your reason in the comment section.");if(0!==zeroPriceCount&&""===vm.procedureComments.trim())return void showAlert("Error","You entered "+vm.currencySymbol+"0.00. Please add your reason in the comment section.")}gotoStep(nextStepIfValid)}else showAlert("Error","Please enter a valid procedure date.");else showAlert("Error","Please select type of procedure.")}function hospitalRepValidation(nextStepIfValid){vm.notification.email=vm.selectedHospital.email,vm.isFirstTimeThru&&(vm.notification.isEmail=!1,vm.notification.isAlternativeEmail=!1,vm.notification.dontSend=!0),gotoStep(nextStepIfValid)}function notificationValidation(nextStepIfValid){vm.notification.isAlternativeEmail&&!vm.notification.alternativeEmail?showAlert("Error","Please enter a valid alternative e-mail address."):!vm.notification.isAlternativeEmail&&vm.notification.alternativeEmail?showAlert("Error","You have entered an alternative e-mail address but not tapped the checkedbox."):vm.notification.isAlternativeEmail&&vm.notification.alternativeEmail&&!validateEmail(vm.notification.alternativeEmail)?showAlert("Error","Please enter a valid e-mail address."):vm.notification.isEmail&&""===vm.notification.email?showAlert("Error","e-mail address on file is blank. Please enter an altenative e-mail, or tap don't send."):(vm.notification.dontSend?vm.confirmationEmail="No email will be sent":vm.notification.isAlternativeEmail?vm.confirmationEmail=vm.notification.alternativeEmail:vm.confirmationEmail=vm.notification.email,gotoStep(nextStepIfValid))}function resizeCanvas(canvas){var ratio=Math.max($window.devicePixelRatio||1,1);canvas.width=canvas.offsetWidth*ratio,canvas.height=canvas.offsetHeight*ratio,canvas.getContext("2d").scale(ratio,ratio)}function clearCanvas(){signaturePad.clear()}function displayHospitalSelection(step){vm.hospitalTab="hospitalrecent",gotoStep(step)}function displayHospitalDetails(hospital,step){vm.selectedHospital?(vm.selectedHospital.id=hospital.id?hospital.id:null,vm.selectedHospital.name=hospital.name,vm.selectedHospital.email=hospital.id?hospital.email:null):(vm.selectedHospital={},vm.selectedHospital.id=hospital.id?hospital.id:null,vm.selectedHospital.name=hospital.name,vm.selectedHospital.email=hospital.id?hospital.email:null,RecentItemsService.getRecentItems("recentStockNotification").then(function(recentItems){recentItems.length>0?(vm.selectedHospital.replaceStockNo=recentItems[0].replaceStockNo,vm.selectedHospital.replaceStockYes=recentItems[0].replaceStockYes,vm.selectedHospital.replaceStockComments=recentItems[0].replaceStockComments):(vm.selectedHospital.replaceStockNo=!0,vm.selectedHospital.replaceStockYes=!1,vm.selectedHospital.replaceStockComments=""),vm.recentStockNotifications=recentItems})),hospital.id&&RecentItemsService.addRecentHospital(hospital).then(function(recentItems){vm.recentHospitals=recentItems}),gotoStep(step)}function displaySurgeonSelection(step){if(vm.surgeonTab="surgeonrecent",vm.selectedHospital.id){vm.surgeons=[],vm.recentSurgeons=[];for(var a=0;a<vm.allSurgeons.length;a++)vm.allSurgeons[a].hospitalId==vm.selectedHospital.id&&vm.surgeons.push(vm.allSurgeons[a]);if(vm.allRecentSurgeons)for(var r=0;r<vm.allRecentSurgeons.length;r++)vm.allRecentSurgeons[r].hospitalId==vm.selectedHospital.id&&vm.recentSurgeons.push(vm.allRecentSurgeons[r])}else vm.surgeons=vm.allSurgeons,vm.recentSurgeons=vm.allRecentSurgeons;gotoStep(step)}function displaySurgeonDetails(surgeon,step){vm.selectedSurgeon={},vm.selectedSurgeon.id=surgeon.id?surgeon.id:null,vm.selectedSurgeon.name=surgeon.name,vm.selectedSurgeon.hospitalId=surgeon.hospitalId,vm.isFirstTimeThru&&(vm.procedureDate=vm.today,vm.procedureType="",vm.procedureComments=""),surgeon.id&&RecentItemsService.addRecentSurgeon(surgeon).then(function(recentItems){vm.allRecentSurgeons=recentItems}),gotoStep(step)}function displayHospitalTab(tab){vm.hospitalTab=tab}function displaySurgeonTab(tab){vm.surgeonTab=tab}function clearHospitalSearch(){vm.hospitalSearch=""}function editProduct(startEditAtStep){gotoStep(startEditAtStep)}function removeProduct(index){var confirmPopup=$ionicPopup.confirm({title:"Remove Product",template:"Are you sure you want to remove product?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res&&vm.selectedProducts.splice(index,1)})}function scanBarcode(){if(cordova&&cordova.plugins&&cordova.plugins.barcodeScanner)scannerTimeout=$timeout(function(){$cordovaBarcodeScanner.scan().then(function(imageData){AnalyticsService.incrementKey("order-form-scan").then(function(result){})["catch"](function(e){logger.error("OrderFormCtrl scanBarcode AnalyticsService.incrementKey error: "+JSON.stringify(e))}),imageData.cancelled||processScannedProduct(imageData)},function(err){showAlert("Information","The camera cannot be accessed.<br/><br/>Please check that the Biocomposites app has permission to use the camara."),logger.error("scanBarcode: err = "+JSON.stringify(err)),AnalyticsService.incrementKey("order-form-scan").then(function(result){})["catch"](function(e){logger.error("OrderFormCtrl scanBarcode AnalyticsService.incrementKey error: "+JSON.stringify(e))})})},0);else{AnalyticsService.incrementKey("order-form-scan").then(function(result){})["catch"](function(e){logger.error("OrderFormCtrl scanBarcode AnalyticsService.incrementKey error: "+JSON.stringify(e))});var imageData={text:"0150601557110348171810311010/15-R123/456",format:"CODE_128"};processScannedProduct(imageData)}}function cancelOrder(){var confirmPopup=$ionicPopup.confirm({title:"Cancel",template:"Are you sure?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res&&exitOrderForm("order-form-cancel")})}function submitOrder(){return 0===vm.selectedProducts.length?void showAlert("Error","Please add a product before submitting."):void(signaturePad.isEmpty()?confirmNoSignature():saveOrder())}function confirmNoSignature(){var confirmPopup=$ionicPopup.confirm({title:"No signature",template:"Add signature?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res||saveOrder()})}function saveOrder(){$ionicLoading.show({duration:5e3,template:"Saving Order form...",animation:"fade-in",showBackdrop:!0}),OrderFormService.insertOrderForm(buildOrderFormRecord()).then(function(resObject){return OrderFormService.insertOrderFormItems(buidOrderFormItemRecords(resObject.records[0].Id))}).then(function(resObject){$ionicLoading.hide(),"online"===NetworkService.getNetworkStatus()?(SyncService.setSyncLock("false"),SyncService.syncTables(["DOF__ap","DOF_Item__ap","Mobile_Log__mc"]),submitSuccessful=!0,exitOrderForm("order-form-submit")):($rootScope.$emit("updateOutboxCount"),$rootScope.$emit("home:checkOutbox"),LocalNotificationService.setLocalNotification(),alertOffline())})["catch"](function(e){logger.error("saveOrder "+JSON.stringify(e)+" "+JSON.stringify(orderForm)),$ionicLoading.hide()})}function buildOrderFormRecord(){var orderForm={};return orderForm.Name="TMP-"+(new Date).valueOf(),orderForm.DOF_Item_Count__c=vm.selectedProducts.length,vm.selectedHospital.id?orderForm.Hospital__c=vm.selectedHospital.id:(orderForm.Hospital_Name__c=vm.newHospital.name,orderForm.Hospital_Street__c=vm.newHospital.address),vm.selectedHospital.poNumber&&(orderForm.PO_Number__c=vm.selectedHospital.poNumber),vm.selectedHospital.replaceStockNo?orderForm.Stock_Instructions__c="Don't replace stock":(orderForm.Stock_Instructions__c="Replace stock to",orderForm.Replace_Stock_Details__c=vm.selectedHospital.replaceStockComments),vm.selectedSurgeon.id?orderForm.Surgeon__c=vm.selectedSurgeon.id:(orderForm.Surgeon_First_Name__c=vm.newSurgeon.firstName,orderForm.Surgeon_Last_Name__c=vm.newSurgeon.lastName),orderForm.Procedure_Date__c=vm.procedureDate,orderForm.Type_of_Procedure__c=vm.procedureType,""!==vm.procedureComments&&(orderForm.Procedure_Comments__c=vm.procedureComments),""!==vm.hospitalRep.firstName&&(orderForm.First_Name__c=vm.hospitalRep.firstName),""!==vm.hospitalRep.lastName&&(orderForm.Last_Name__c=vm.hospitalRep.lastName),vm.notification.isEmail?orderForm.Send_Confirmation__c="Send to address on file":vm.notification.dontSend?orderForm.Send_Confirmation__c="Do not send":(orderForm.Send_Confirmation__c="Send to alternative address",orderForm.Alternative_Email__c=vm.notification.alternativeEmail),signaturePad.isEmpty()||(orderForm.Signature_Capture__c=signaturePad.toDataURL()),orderForm.Date_Entered__c=new Date,orderForm}function buidOrderFormItemRecords(orderFormId){for(var orderFormItems=[],i=0,len=vm.selectedProducts.length;len>i;i++){var record={};record.Name="TMP-"+(new Date).valueOf(),record.DOF__c=orderFormId,vm.selectedProducts[i].name?(vm.selectedProducts[i].id.includes("MANUAL")?record.Product_Name_from_Lot_Number__c=vm.selectedProducts[i].name:record.Product__c=vm.selectedProducts[i].id,record.Lot_Number__c=vm.selectedProducts[i].lotNumber,record.Entered_Price__c=parseFloat(vm.selectedProducts[i].price),vm.selectedProducts[i].isCharge?record.Price_Entered__c="Price Entered":record.Price_Entered__c="No Charge",record.Expiry_Date__c=vm.selectedProducts[i].expiryDate):(record.Lot_Number__c=vm.selectedProducts[i].lotNumber,record.Entered_Price__c=parseFloat(vm.selectedProducts[i].price),vm.selectedProducts[i].isCharge?record.Price_Entered__c="Price Entered":record.Price_Entered__c="No Charge"),orderFormItems.push(record)}return orderFormItems}function exitOrderForm(analyticPoint){AnalyticsService.incrementKey(analyticPoint).then(function(result){})["catch"](function(e){logger.error("OrderFormCtrl exitOrderForm AnalyticsService.incrementKey error: "+JSON.stringify(e))}),$rootScope.$emit("disableSideMenu",{showSideMenu:!0}),SyncService.setSyncLock("false"),submitSuccessful?alertSuccess():$state.go("app.home")}function alertSuccess(){var alertPopup=$ionicPopup.alert({title:"Order form",template:"Submission successful. Please allow sync to complete before closing app",cssClass:"bio-popup"});alertPopup.then(function(res){res&&$state.go("app.home")})}function alertOffline(){var alertPopup=$ionicPopup.alert({title:"You are currently offline",template:"Synchronisation will take place when you are next online",cssClass:"bio-popup"});alertPopup.then(function(res){res&&exitOrderForm("order-form-submit")})}function processScannedProduct(imageData){0===vm.allProducts.length?($ionicLoading.show({duration:5e3,template:"Loading products...",animation:"fade-in",showBackdrop:!0}),OrderFormService.getProducts().then(function(records){vm.allProducts=records,matchProduct(imageData),$ionicLoading.hide()})):matchProduct(imageData)}function matchProduct(imageData){if("CODE_128"==imageData.format||"QR_CODE"==imageData.format||"DATA_MATRIX"==imageData.format){for(var data="QR_CODE"==imageData.format||"DATA_MATRIX"==imageData.format?imageData.text.substring(1):imageData.text,scannedProductGTIN=data.substring(2,16),matchedProduct=null,i=0;i<vm.allProducts.length;i++)vm.allProducts[i].GTIN__c==scannedProductGTIN&&(matchedProduct=vm.allProducts[i]);matchedProduct?(vm.product={},vm.product.id=matchedProduct.Id,vm.product.name=matchedProduct.Name__c+" "+matchedProduct.Size__c,vm.product.expiryDate=new Date("20"+data.substring(18,20)+"-"+data.substring(20,22)+"-"+data.substring(22,24)),vm.product.lotNumber=data.substring(26),vm.product.price=null,vm.product.isCharge=!0,vm.product.isNoCharge=!1,gotoStep("scangood")):gotoStep("scanbad")}else gotoStep("scanbad")}function chargeCheckboxChange(inputType,checkbox){"manual"==inputType?vm.manualInput[checkbox]=!vm.manualInput[checkbox]:vm.product[checkbox]=!vm.product[checkbox]}function stockCheckboxChange(checkbox){if("replaceStockYes"==checkbox)vm.selectedHospital.replaceStockYes=!1,vm.selectedHospital.replaceStockNo=!0;else if(vm.selectedHospital.replaceStockYes=!0,vm.selectedHospital.replaceStockNo=!1,vm.recentStockNotifications)for(var i=0;i<vm.recentStockNotifications.length;i++)if(vm.recentStockNotifications[i].replaceStockYes){vm.selectedHospital.replaceStockComments=vm.recentStockNotifications[i].replaceStockComments;break}}function notificationEmailCheckboxChange(checkbox){vm.notification.isEmail=!1,vm.notification.isAlternativeEmail=!1,vm.notification.dontSend=!1,"isEmail"==checkbox?vm.notification.isEmail=!0:"isAlternativeEmail"==checkbox?vm.notification.isAlternativeEmail=!0:vm.notification.dontSend=!0}function showAlert(title,template){var alertPopup=$ionicPopup.alert({title:title,template:template,cssClass:"bio-popup"});alertPopup.then(function(res){})}function windowResizeHandler(){var canvas=angular.element(document.getElementById("signatureCanvas"))[0];canvas&&signaturePad&&!signaturePad.isEmpty()&&(signatureDataURL=signaturePad.toDataURL(),$timeout(function(){resizeCanvas(canvas),signaturePad.isEmpty()||signaturePad.fromDataURL(signatureDataURL),canvas=null},500))}function isValidPrice(n){return/^\d*\.?\d{0,2}$/.test(n)}function validateEmail(email){var re=/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(email)}var signaturePad,signatureDataURL,signaturePadTimeout,scannerTimeout,scrollTimeout,onBeginSignatureTimeout,onEndSignatureTimeout,vm=this,submitSuccessful=!1;vm.allProducts=[],vm.allLotNumbers=[],vm.selectedProducts=[],vm.showCancel=!1,vm.isFirstTimeThru=!0,vm.newHospital={name:"",address:""},vm.newSurgeon={firstName:"",lastName:""},vm.hospitalRep={firstName:"",lastName:""},vm.notification={email:"",alternativeEmail:"",dontSend:!1,isEmail:!1,isAlternativeEmail:!1},vm.today=new Date,vm.hospitalTab="hospitalrecent",vm.isLegacyLotNumber=!1,vm.manualInput={},vm.manualInput.lotNumber={};var ENTER_FIRST_DIGITS_MSG="Enter first two letters/numbers of lot number",ENTER_REMAINING_LEGACY="Enter remaining letters/numbers of lot number",ENTER_REMAINING="Enter remaining numbers of lot number",ENTRY_INVALID="First two digits must be two letters or two numbers";vm.manualInputMessage=ENTER_FIRST_DIGITS_MSG,vm.gotoStep=gotoStep,vm.displayNewManualInput=displayNewManualInput,vm.lotNumberPart1Change=lotNumberPart1Change,vm.lotNumberPart2NewChange=lotNumberPart2NewChange,vm.manualInputLotNumberMatch=manualInputLotNumberMatch,vm.manualInputPriceValidation=manualInputPriceValidation,vm.scannedProductDetailsValidation=scannedProductDetailsValidation,vm.newHospitalValidation=newHospitalValidation,vm.hospitalDetailsValidation=hospitalDetailsValidation,vm.newSurgeonValidation=newSurgeonValidation,vm.surgeonDetailsValidation=surgeonDetailsValidation,vm.hospitalRepValidation=hospitalRepValidation,vm.notificationValidation=notificationValidation,vm.chargeCheckboxChange=chargeCheckboxChange,vm.stockCheckboxChange=stockCheckboxChange,vm.notificationEmailCheckboxChange=notificationEmailCheckboxChange,vm.displayHospitalDetails=displayHospitalDetails,vm.displaySurgeonDetails=displaySurgeonDetails,vm.displayHospitalTab=displayHospitalTab,vm.displaySurgeonTab=displaySurgeonTab,vm.clearHospitalSearch=clearHospitalSearch,vm.editProduct=editProduct,vm.removeProduct=removeProduct,vm.scanBarcode=scanBarcode,vm.cancelOrder=cancelOrder,vm.submitOrder=submitOrder,vm.clearCanvas=clearCanvas,activate(),angular.element($window).on("resize",windowResizeHandler);var deregisterIonicViewEnter=$scope.$on("$ionicView.enter",function(scopes,states){var forwardView=$ionicHistory.viewHistory().forwardView;forwardView||AnalyticsService.incrementKey("order-form").then(function(result){})["catch"](function(e){logger.error("OrderFormCtrl deregisterIonicViewEnter AnalyticsService.incrementKey error: "+JSON.stringify(e))})});$scope.$on("$destroy",function(){$timeout.cancel(signaturePadTimeout),$timeout.cancel(scannerTimeout),$timeout.cancel(scrollTimeout),$timeout.cancel(onBeginSignatureTimeout),$timeout.cancel(onEndSignatureTimeout),deregisterIonicViewEnter(),angular.element($window).off("resize",windowResizeHandler)})}angular.module("starter.controllers").controller("OrderFormCtrl",OrderFormCtrl),OrderFormCtrl.$inject=["$rootScope","$scope","$window","$ionicPopup","$state","$ionicLoading","$timeout","$cordovaBarcodeScanner","$ionicScrollDelegate","$ionicHistory","logger","OrderFormService","SyncService","RecentItemsService","NetworkService","LocalNotificationService","UserService","AnalyticsService"]}(),function(){"use strict";function OutboxCtrl($rootScope,$scope,$ionicLoading,$timeout,logger,OutboxService,RecordTypeService,SyncService,NetworkService,UserService,OrderFormService,AnalyticsService){function activate(){$ionicLoading.show({duration:5e3,template:"Loading...",animation:"fade-in",showBackdrop:!0,delay:400}),UserService.getUserCurrencySymbol().then(function(result){vm.currencySymbol=result}),vm.orders=[],vm.leads=[],vm.requests=[],vm.accounts=[],RecordTypeService.getRecordTypeId("Mobile_Lead","Mobile_Dynamic__c").then(function(recordTypeId){return leadRecordTypeId=recordTypeId,RecordTypeService.getRecordTypeId("New_Account","Mobile_Dynamic__c")}).then(function(recordTypeId){return newAccountRecordTypeId=recordTypeId,OutboxService.getDirtyRecords()}).then(function(records){if(dirtyRecordsCount=records.length,0===dirtyRecordsCount)vm.showMsg=!0,vm.showSyncButton=!1,vm.syncing=!1,$ionicLoading.hide();else{getDOFDirtyCount(records);for(var i=0;i<records.length;i++)pushRecordToArray(records[i].Mobile_Table_Name,records[i].SOUP_Record_Id)}updateOutboxCountTimeout=$timeout(function(){$rootScope.$emit("updateOutboxCount")},0),AnalyticsService.incrementKey("outbox").then(function(result){})["catch"](function(e){logger.error("OutboxCtrl activate AnalyticsService.incrementKey error: "+JSON.stringify(e))})})}function pushRecordToArray(tableName,soupRecordId){OutboxService.getRecordForSoupEntryId(tableName,soupRecordId).then(function(record){record&&("DOF__ap"==tableName?getAdditionalDOFDetails(record):"DOF_Item__ap"==tableName?0===dofDirtyCount?buildDOFCardFromItem(record):$scope.$emit("checkIfAllRecordsProcessed"):record.RecordTypeId==leadRecordTypeId?(vm.leads.push(record),$scope.$emit("checkIfAllRecordsProcessed")):record.RecordTypeId==newAccountRecordTypeId?(vm.accounts.push(record),$scope.$emit("checkIfAllRecordsProcessed")):(vm.requests.push(record),$scope.$emit("checkIfAllRecordsProcessed")))})}function getAdditionalDOFDetails(record){var surgeonInHospitalRecord,items;OrderFormService.getSurgeonInHospital(record.Surgeon__c).then(function(surgeonInHospital){return surgeonInHospitalRecord=surgeonInHospital,OrderFormService.getOrderItemsWithOrderId(record.Id)}).then(function(orderItems){return orderItems&&orderItems.length>0?orderItems:OrderFormService.getOrderItemsWithOrderId(record.MC_Proxy_ID__c)}).then(function(orderItems){return items=orderItems,OrderFormService.getProductsForOrderItems(orderItems)}).then(function(products){for(var productName,displayProducts=[],j=0;j<items.length;j++){if(productName=null,items[j].Product__c)for(var k=0;k<products.length;k++)if(items[j].Product__c==products[k].Id){productName=products[k].Name__c+" "+products[k].Size__c;break}productName?displayProducts.push({productName:productName,lotNumber:items[j].Lot_Number__c,price:items[j].Entered_Price__c,expiryDate:items[j].Expiry_Date__c}):displayProducts.push({lotNumber:items[j].Lot_Number__c,price:items[j].Entered_Price__c})}vm.orders.push({record:record,surgeonInHospitalRecord:surgeonInHospitalRecord,products:displayProducts}),$scope.$apply(),$scope.$emit("checkIfAllRecordsProcessed")})}function getDOFDirtyCount(dirtyRecords){dofDirtyCount=0;for(var i=0;i<dirtyRecords.length;i++)"DOF__ap"==dirtyRecords[i].Mobile_Table_Name&&(dofDirtyCount+=1)}function buildDOFCardFromItem(orderItem){OrderFormService.getOrderById(orderItem.DOF__c).then(function(order){order&&order.length>0?getAdditionalDOFDetails(order[0]):$scope.$emit("checkIfAllRecordsProcessed")})}function sync(){SyncService.syncTables(["DOF__ap","DOF_Item__ap","Mobile_Dynamic__ap","Mobile_Log__mc"])}var leadRecordTypeId,newAccountRecordTypeId,updateOutboxCountTimeout,dirtyRecordsCount,dofDirtyCount,vm=this,recordsProcessed=0;vm.showMsg=!1,vm.showSyncButton=!1,vm.syncing=!1,vm.sync=sync,activate();var deregisterHandleCheckRecordProcessed=$scope.$on("checkIfAllRecordsProcessed",function(event,args){recordsProcessed+=1,recordsProcessed===dirtyRecordsCount&&($ionicLoading.hide(),vm.showSyncButton=!0)}),deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){if(args&&args.result)switch(args.result.toString()){case"StartSync":vm.syncing=!0;break;case"Complete":case"100497":case"100498":case"100402":vm.syncing=!1;break;default:if(args.result.toString().indexOf("Error")>=0)vm.syncing=!1;else if(args.result.toString().indexOf("TableComplete")>=0){var syncedTable=args.result.replace("TableComplete ","");"Mobile_Dynamic__ap"==syncedTable&&activate()}}});$scope.$on("$destroy",function(){deregisterHandleSyncTables(),deregisterHandleCheckRecordProcessed(),$timeout.cancel(updateOutboxCountTimeout)})}angular.module("starter.controllers").controller("OutboxCtrl",OutboxCtrl),OutboxCtrl.$inject=["$rootScope","$scope","$ionicLoading","$timeout","logger","OutboxService","RecordTypeService","SyncService","NetworkService","UserService","OrderFormService","AnalyticsService"];
}(),function(){"use strict";function RawViewCtrl($scope,$stateParams,$ionicLoading,$ionicModal,RecoveryService){function activate(){switch(console.log(">>> Raw Data View activated. Loading: "+$scope.type),$stateParams.type){case"tables":loadTableData();break;case"localStorage":loadLocalStorageData();break;case"soups":loadSoupsData()}}function loadTableData(){RecoveryService.returnAllTableData().then(function(data){$scope.viewContent=data,$ionicLoading.hide()})}function loadSoupsData(){RecoveryService.returnAllSoupsData().then(function(data){$scope.viewContent=JSON.stringify(data),$ionicLoading.hide()})}function loadLocalStorageData(){console.log(">>> loading local storage"),RecoveryService.returnAllLocalStorageData().then(function(data){console.log(">>> done"),$scope.viewContent=data,$ionicLoading.hide()})}$ionicLoading.show({duration:3e4,noBackdrop:!0,template:'<p id="app-progress-msg" class="item-icon-left"><h3>Loading Data</h3><p>Please wait...</p><ion-spinner></ion-spinner></p>'}),$scope.type=$stateParams.type,$scope.viewContent="",setTimeout(function(){activate()},1e3)}angular.module("starter.controllers").controller("RawViewCtrl",RawViewCtrl),RawViewCtrl.$inject=["$scope","$stateParams","$ionicLoading","$ionicModal","RecoveryService"]}(),function(){"use strict";function RequestCtrl($rootScope,$scope,$ionicPopup,$state,$ionicLoading,$timeout,$ionicScrollDelegate,$ionicHistory,logger,SyncService,NetworkService,RecordTypeService,MobileDynamicService,LocalNotificationService,AnalyticsService){function activate(){angular.copy(initialRequest,vm.request),vm.showBackButton=!0,RecordTypeService.getRecordTypeId("Unsolicited_Request","Mobile_Dynamic__c").then(function(id){recordTypeId=id})}function gotoStep(step){("standardstart"==step||"urgentstart"==step)&&(vm.showCancel=!0,$rootScope.$emit("disableSideMenu",{showSideMenu:!1}),SyncService.setSyncLock("true"),"standardstart"==step?vm.requestTypeTitle="- standard":vm.requestTypeTitle="- urgent",AnalyticsService.incrementKey("request-"+step).then(function(result){})["catch"](function(e){logger.error("RequestCtrl gotoStep AnalyticsService.incrementKey error: "+JSON.stringify(e))})),("standardinfo"==step||"urgentinfo"==step)&&""!==vm.request.info.trim()&&(vm.showBackButton=!1),"default"==step&&(vm.requestTypeTitle="",vm.showCancel=!1,activate(),$rootScope.$emit("disableSideMenu",{showSideMenu:!0}),SyncService.setSyncLock("false")),vm.step=step,scrollTimeout=$timeout(function(){$ionicScrollDelegate.scrollTop()},50)}function inputValidation(nextStepIfValid){if(("standardproduct"===nextStepIfValid||"urgentproduct"===nextStepIfValid)&&""===vm.request.info.trim())return void showAlert("Error","Please enter information.");if("standarddeadline"===nextStepIfValid){if(""===vm.request.requestorName.trim()||""===vm.request.requestorInstitution.trim())return void showAlert("Error","Please enter the requestor's details.");if(!vm.request.requestorEmail||!validateEmail(vm.request.requestorEmail))return void showAlert("Error","Please enter a valid e-mail address.")}if("urgentdeadline"===nextStepIfValid){if(""===vm.request.requestorName.trim()||""===vm.request.requestorInstitution.trim())return void showAlert("Error","Please enter the requestor's details.");if(!vm.request.requestorEmail||!validateEmail(vm.request.requestorEmail))return void showAlert("Error","Please enter a valid e-mail address.")}return"submitstandard"===nextStepIfValid||"submiturgent"===nextStepIfValid?vm.request.responseDate?void submitRequest(nextStepIfValid):void showAlert("Error","Please enter a date."):void gotoStep(nextStepIfValid)}function submitRequest(requestType){$ionicLoading.show({duration:5e3,template:"Saving request...",animation:"fade-in",showBackdrop:!0}),MobileDynamicService.insertRecord(buildRequestRecord(requestType)).then(function(resObject){$ionicLoading.hide(),"online"===NetworkService.getNetworkStatus()?(SyncService.setSyncLock("false"),SyncService.syncTables(["Mobile_Dynamic__ap","Mobile_Log__mc"]),submitSuccessful=!0,exitRequest("new-request-submit")):($rootScope.$emit("updateOutboxCount"),$rootScope.$emit("home:checkOutbox"),LocalNotificationService.setLocalNotification(),alertOffline())})["catch"](function(e){logger.error("submitRequest",requestType,e),$ionicLoading.hide()})}function buildRequestRecord(requestType){var request={};return request.Name="TMP-"+(new Date).valueOf(),"submitstandard"==requestType?request.Request_Type__c="Standard":request.Request_Type__c="Urgent",request.Requested_Information__c=vm.request.info,request.Product__c=vm.request.product,request.Requestors_Name__c=vm.request.requestorName,vm.request.requestorEmail?request.Email__c=vm.request.requestorEmail:request.Email__c="",request.Hospital_Institution__c=vm.request.requestorInstitution,request.Request_Target_Response_Date__c=vm.request.responseDate,""!==recordTypeId&&(request.RecordTypeId=recordTypeId),request.Date_Entered__c=new Date,request.Alternate_Billing_Address__c=!1,request.STIMULAN_Bullet__c=!1,request.STIMULAN_Kit_10cc__c=!1,request.STIMULAN_Kit_5cc__c=!1,request.STIMULAN_Rapid_Cure_10cc__c=!1,request.STIMULAN_Rapid_Cure_20cc__c=!1,request.STIMULAN_Rapid_Cure_5cc__c=!1,request.Other_Product__c=!1,request}function cancelRequest(){var confirmPopup=$ionicPopup.confirm({title:"Cancel",template:"Are you sure?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res&&exitRequest("new-request-cancel")})}function exitRequest(analyticPoint){AnalyticsService.incrementKey(analyticPoint).then(function(result){})["catch"](function(e){logger.error("RequestCtrl exitRequest AnalyticsService.incrementKey error: "+JSON.stringify(e))}),$rootScope.$emit("disableSideMenu",{showSideMenu:!0}),SyncService.setSyncLock("false"),submitSuccessful?alertSuccess():$state.go("app.home")}function alertSuccess(){var alertPopup=$ionicPopup.alert({title:"Unsolicited request",template:"Submission successful. Please allow sync to complete before closing app",cssClass:"bio-popup"});alertPopup.then(function(res){res&&$state.go("app.home")})}function alertOffline(){var alertPopup=$ionicPopup.alert({title:"You are currently offline",template:"Synchronisation will take place when you are next online",cssClass:"bio-popup"});alertPopup.then(function(res){res&&exitRequest("new-request-submit")})}function showAlert(title,template){var alertPopup=$ionicPopup.alert({title:title,template:template,cssClass:"bio-popup"});alertPopup.then(function(res){})}function validateEmail(email){var re=/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(email)}var recordTypeId,scrollTimeout,vm=this,initialRequest={info:"",product:"STIMULAN",requestorName:"",requestorEmail:"",requestorInstitution:"",responseDate:new Date((new Date).getTime()+12096e5)},submitSuccessful=!1;vm.showCancel=!1,vm.today=new Date,vm.requestTypeTitle="",vm.request={},vm.gotoStep=gotoStep,vm.inputValidation=inputValidation,vm.submitRequest=submitRequest,vm.cancelRequest=cancelRequest,activate();var deregisterIonicViewEnter=$scope.$on("$ionicView.enter",function(scopes,states){var forwardView=$ionicHistory.viewHistory().forwardView;forwardView||AnalyticsService.incrementKey("request").then(function(result){})["catch"](function(e){logger.error("RequestCtrl deregisterIonicViewEnter AnalyticsService.incrementKey error: "+JSON.stringify(e))})});$scope.$on("$destroy",function(){deregisterIonicViewEnter(),$timeout.cancel(scrollTimeout)})}angular.module("starter.controllers").controller("RequestCtrl",RequestCtrl),RequestCtrl.$inject=["$rootScope","$scope","$ionicPopup","$state","$ionicLoading","$timeout","$ionicScrollDelegate","$ionicHistory","logger","SyncService","NetworkService","RecordTypeService","MobileDynamicService","LocalNotificationService","AnalyticsService"]}(),function(){"use strict";function RequestHistoryCtrl($rootScope,$scope,$window,$ionicLoading,$ionicModal,$state,logger,RecordTypeService,MobileDynamicService,AnalyticsService){function activate(){$ionicLoading.show({duration:5e3,template:"Loading...",animation:"fade-in",showBackdrop:!0}),vm.requests=[],RecordTypeService.getRecordTypeId("Unsolicited_Request","Mobile_Dynamic__c").then(function(recordTypeId){return MobileDynamicService.getRecords(recordTypeId)}).then(function(records){for(var i=0;i<records.length;i++)-1==records[i].Id.indexOf("PROXY")&&vm.requests.push(records[i]);$ionicLoading.hide(),AnalyticsService.incrementKey("request-history").then(function(result){})["catch"](function(e){logger.error("RequestHistoryCtrl activate AnalyticsService.incrementKey error: "+JSON.stringify(e))})})}function showModal(record){$ionicModal.fromTemplateUrl($window.RESOURCE_ROOT+"templates/requestDetail.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){vm.modal=modal,vm.modal.request=record,vm.modal.show()})}function closeModal(){vm.modal&&(vm.modal.hide(),vm.modal.remove(),delete vm.modal)}function goHome(){$state.go("app.home")}var vm=this;vm.showModal=showModal,vm.closeModal=closeModal,vm.goHome=goHome,activate();var deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){if(args.result.toString().indexOf("TableComplete")>=0){var syncedTable=args.result.replace("TableComplete ","");"Mobile_Dynamic__ap"==syncedTable&&activate()}});$scope.$on("$destroy",function(){deregisterHandleSyncTables(),vm.modal&&(vm.modal.remove(),delete vm.modal)})}angular.module("starter.controllers").controller("RequestHistoryCtrl",RequestHistoryCtrl),RequestHistoryCtrl.$inject=["$rootScope","$scope","$window","$ionicLoading","$ionicModal","$state","logger","RecordTypeService","MobileDynamicService","AnalyticsService"]}(),function(){"use strict";function SettingsCtrl($scope,$rootScope,$ionicPopup,$ionicLoading,$location,$state,devUtils,vsnUtils,DevService,logger,RecoveryService,SyncService,NetworkService,$timeout,OutboxService,AnalyticsService){function extractSettingsValues(appSoupRecs){var settingRecs={};return $j.each(appSoupRecs,function(i,records){var tableRec={};$j.each(records,function(i,record){switch(record.Name){case"Name":tableRec.Name=record.Value;break;case"CurrentValue":tableRec.Value=record.Value}}),settingRecs[tableRec.Name]=tableRec.Value}),settingRecs}function showAlert(title,message){var alert=$ionicPopup.alert({title:title,template:message,cssClass:"bio-popup"});alert.then(function(){})}AnalyticsService.incrementKey("app-settings").then(function(result){})["catch"](function(e){logger.error("SettingsCtrl AnalyticsService.incrementKey error: "+JSON.stringify(e))});var e=document.getElementById("my-nav-bar");angular.element(e).removeClass("mc-hide"),$scope.logoutAllowedClass="disabled",$scope.recsToSyncCount=0,$scope.codeflow=LOCAL_DEV,$scope.upgradeAvailable=!1,vsnUtils.upgradeAvailable().then(function(res){return res?devUtils.dirtyTables():void 0}).then(function(tables){var tables2;tables&&(tables2=tables.filter(function(table){return"Mobile_Log__mc"!=table})),tables2&&0===tables2.length&&($scope.upgradeAvailable=!0,$timeout(function(){$scope.$apply()},0))}),DevService.allRecords("recsToSync",!1).then(function(recsToSyncRecs){$scope.recsToSyncCount=recsToSyncRecs.length,0===$scope.recsToSyncCount?$scope.logoutAllowedClass="":$scope.recsToSyncCount=0},function(reason){console.error("Angular: promise returned reason -> "+reason)}),$scope.networkStatusLS=NetworkService.getNetworkStatus(),DevService.allRecords("appSoup",!1).then(function(appSoupRecs){$scope.settingsRecs=extractSettingsValues(appSoupRecs)},function(reason){console.error("Angular: promise returned reason -> "+reason)}),$scope.upgradeIfAvailable=function(){devUtils.dirtyTables().then(function(tables){if(logger.log("upgrade: dirtyTables check"),tables&&0===tables.length){logger.log("upgrade: no dirtyTables");var confirmPopup=$ionicPopup.confirm({title:"Upgrade",template:"Are you sure you want to upgrade now?"});confirmPopup.then(function(res){res&&($ionicLoading.show({duration:3e4,delay:400,maxWidth:600,noBackdrop:!0,template:'<h1>Upgrade app...</h1><p id="app-upgrade-msg" class="item-icon-left">Upgrading...<ion-spinner/></p>'}),logger.log("upgrade: calling upgradeIfAvailable"),vsnUtils.upgradeIfAvailable().then(function(res){logger.log("upgrade: upgradeIfAvailable? "+res),res||($ionicLoading.hide(),$scope.data={},$ionicPopup.show({title:"Upgrade",subTitle:"The upgrade could not take place due to sync in progress. Please try again later.",scope:$scope,buttons:[{text:"OK",type:"button-positive",onTap:function(e){return!0}}]}))})["catch"](function(e){logger.error("upgrade: "+JSON.stringify(e)),$ionicLoading.hide()}))})}else logger.log("upgrade: dirtyTables found"),$scope.data={},$ionicPopup.show({title:"Upgrade",subTitle:"Unable to upgrade. A sync is required - please try later.",scope:$scope,buttons:[{text:"OK",type:"button-positive",onTap:function(e){return!0}}]})})},$scope.recoverAllData=function(){$ionicLoading.show({duration:6e4,noBackdrop:!0,template:'<p id="app-progress-msg" class="item-icon-left"><h3>Recovering Data</h3><p>Please do not close the app until complete…</p><ion-spinner></ion-spinner></p>'}),RecoveryService.recoverAllData().then(function(){$ionicLoading.hide(),showAlert("Success","Recovery Completed. Please transfer recovered data from device.")})["catch"](function(error){$ionicLoading.hide(),showAlert("Error","Error recovering data.")})},$scope.showAdminPasswordPopup=function(){if(LOCAL_DEV)$location.path("app/settings/devtools"),$rootScope.adminLoggedIn=Date.now();else{var supportPin=DevService.generateSupportPin(),adminTimeout=18e5;if($rootScope.adminLoggedIn>Date.now()-adminTimeout)$location.path("app/settings/devtools"),$rootScope.adminLoggedIn=Date.now(),$scope.$apply();else{$scope.data={};$ionicPopup.show({template:"<p>Pass this support PIN to your admin: <em>"+supportPin+'</em></p><p>They will provide you with an access PIN, to enter here:</p><input type="password" ng-model="data.admin">',title:"Enter Access PIN",scope:$scope,buttons:[{text:"Cancel"},{text:"<b>Continue</b>",type:"button-positive",onTap:function(e){DevService.authenticate(supportPin,$scope.data.admin).then(function(result){result?($location.path("app/settings/devtools"),$rootScope.adminLoggedIn=Date.now(),$scope.$apply()):console.log("Password incorrect")})["catch"](function(e){logger.error(e)})}}]})}}},$scope.showConfirmLogout=function(){var confirmPopup=$ionicPopup.confirm({title:"Logout",template:"Are you sure you want to logout?"});confirmPopup.then(function(res){res&&($rootScope.adminLoggedIn=null,devUtils.logout())})},$scope.showConfirmReset=function(){var confirmPopup=$ionicPopup.confirm({title:"Reset App Data",template:"Are you sure you want to reset ALL application data?"});confirmPopup.then(function(res){if(res){console.debug("Resetting app");$ionicLoading.show({duration:3e4,delay:400,maxWidth:600,noBackdrop:!0,template:'<h1>Resetting app...</h1><p id="app-progress-msg" class="item-icon-left">Clearing data...<ion-spinner/></p>'}),vsnUtils.hardReset().then(function(res){})["catch"](function(e){console.error(e),$ionicLoading.hide()})}})},$scope.setLogLevel=function(){"Off"==$scope.log.level?localStorage.removeItem("logLevel"):localStorage.setItem("logLevel",$scope.log.level),$scope.log.levelChange=!1},$scope.getLogLevel=function(){var logLevel=localStorage.getItem("logLevel");return null===logLevel&&(logLevel="Off"),logLevel},$scope.log={},$scope.log.level=$scope.getLogLevel(),$scope.log.levelChange=!1,$scope.logLevelChange=function(){$scope.log.levelChange=!0},$scope.goBack=function(){$rootScope.$emit("showSettingsMenu")},$scope.goHome=function(){$state.go("app.home")}}angular.module("starter.controllers").controller("SettingsCtrl",SettingsCtrl),SettingsCtrl.$inject=["$scope","$rootScope","$ionicPopup","$ionicLoading","$location","$state","devUtils","vsnUtils","DevService","logger","RecoveryService","SyncService","NetworkService","$timeout","OutboxService","AnalyticsService"]}(),function(){"use strict";function TestingCtrl($scope,$cordovaLocalNotification,AppRunStatusService,logger,LocalNotificationService,DiagnosticService){$scope.resumeEvent=function(){console.debug("resumeEvent"),AppRunStatusService.statusEvent("resume")},$scope.testHeartbeat=function(){console.debug("testHeartbeat"),$scope.testTitle="Heartbeat in progress...",DiagnosticService.testVfRemote().then(function(res){$scope.testTitle="Heartbeat result",$scope.testResults={result:JSON.stringify(res.result),event:JSON.stringify(res.event)},$scope.$apply()})["catch"](function(e){var err={};e instanceof Error?Object.getOwnPropertyNames(e).forEach(function(key){err[key]=e[key]}):err=e,$scope.testTitle="Heartbeat Errored",$scope.testResults={result:"-",event:"-",error:JSON.stringify(err)},$scope.$apply(),logger.error("testHeartbeat",err)})},$scope.localNotification=function(id){var alarmTime=new Date;alarmTime.setSeconds(alarmTime.getSeconds()+15);var args={id:100100,at:alarmTime,text:"Unsynced records",sound:null};"Android"==device.platform&&(args.ongoing=!0,args.smallIcon="res://icon"),$cordovaLocalNotification.schedule(args).then(function(result){console.log("localNotification result = "+result),logger.log("localNotification result = "+result)})},$scope.localNotificationTrigger=function(id){LocalNotificationService.handleLocalNotification(id,"foreground")},$scope.toggleNotificationState=function(){var notificationState=LocalNotificationService.getLocalNotificationState();"enabled"==notificationState?(LocalNotificationService.setLocalNotificationState("disabled"),$scope.notificationButtonText="Enable"):(LocalNotificationService.setLocalNotificationState("enabled"),$scope.notificationButtonText="Disable")};var notificationState=LocalNotificationService.getLocalNotificationState();"enabled"==notificationState?$scope.notificationButtonText="Disable":$scope.notificationButtonText="Enable"}angular.module("starter.controllers").controller("TestingCtrl",TestingCtrl),TestingCtrl.$inject=["$scope","$cordovaLocalNotification","AppRunStatusService","logger","LocalNotificationService","DiagnosticService"]}(),function(){"use strict";function TutorialCtrl($rootScope,$scope,$state,$window,$timeout,logger,UserService,AnalyticsService){function leftButtonClick(){0===vm.slider.activeIndex?startApp():previous()}function rightButtonClick(){vm.slider.activeIndex===vm.maxSlideIndex?startApp():next()}function startApp(){var tutorialDone=localStorage.getItem("tutorial");null===tutorialDone?(localStorage.setItem("tutorial","done"),$state.go("app.home")):($state.go("app.home"),showSettingsMenuTimeout=$timeout(function(){$rootScope.$emit("showSettingsMenu")},0))}function startAppFromImageTap(index){index==vm.maxSlideIndex&&startApp()}function next(){vm.slider.slideNext(!1),setButtonText()}function previous(){vm.slider.slidePrev(!1),setButtonText()}function setButtonText(){0===vm.slider.activeIndex?vm.leftButtonText="Skip welcome":vm.leftButtonText="<",vm.slider.activeIndex===vm.maxSlideIndex?vm.rightButtonText="Start App":vm.rightButtonText=">"}function setMaxSlideIndex(slidesPerView){vm.slides.length%slidesPerView===0?vm.maxSlideIndex=vm.slides.length/slidesPerView-1:vm.maxSlideIndex=Math.ceil(vm.slides.length/slidesPerView)-1}function windowResizeHandler(){updateButtonTextOnResizeTimeout=$timeout(function(){setMaxSlideIndex(vm.slider.params.slidesPerView),setButtonText()},0)}var showButtonsTimeout,showSettingsMenuTimeout,updateButtonTextOnResizeTimeout,vm=this;vm.startAppFromImageTap=startAppFromImageTap,vm.slides=[],vm.slides.push({image:$window.RESOURCE_ROOT+"images/tutorial1.jpg",heading:"Welcome to the Biocomposites' <span class='bio-line-break-on-small-device'>Distributor Hub.</span>"}),vm.slides.push({image:$window.RESOURCE_ROOT+"images/tutorial2.jpg",heading:"Providing easy, offline access to <span class='bio-line-break-on-small-device'>the tools you need.</span>"}),vm.slides.push({image:$window.RESOURCE_ROOT+"images/tutorial3.jpg",heading:"Applications and cases at your <span class='bio-line-break-on-small-device'>fingertips.</span>"}),vm.slides.push({image:$window.RESOURCE_ROOT+"images/tutorial4.jpg",heading:"On-label answers to your <span class='bio-line-break-on-small-device'>surgeons' questions.</span>"}),vm.slides.push({image:$window.RESOURCE_ROOT+"images/tutorial5.jpg",heading:"e-learning modules to grow your <span class='bio-line-break-on-small-device'>knowledge.</span>"}),vm.slides.push({image:$window.RESOURCE_ROOT+"images/tutorial6.jpg",heading:"…and regular news updates to <span class='bio-line-break-on-small-device'>keep you informed.</span>"}),vm.slides.push({image:$window.RESOURCE_ROOT+"images/tutorial7.jpg",heading:"Let's get started."}),vm.showButtons=!1,vm.leftButtonClick=leftButtonClick,vm.rightButtonClick=rightButtonClick;var deregisterIonicViewAfterEnter=$scope.$on("$ionicView.afterEnter",function(scopes,states){showButtonsTimeout=$timeout(function(){setButtonText(),vm.showButtons=!0},0),angular.element($window).on("resize",windowResizeHandler),AnalyticsService.incrementKey("tutorial").then(function(result){})["catch"](function(e){logger.error("TutorialCtrl deregisterIonicViewAfterEnter AnalyticsService.incrementKey error: "+JSON.stringify(e))})}),deregisterIonicViewLeave=$scope.$on("$ionicView.leave",function(scopes,states){angular.element($window).off("resize",windowResizeHandler)});$scope.$watch("vm.slider",function(slider){slider&&(setMaxSlideIndex(slider.params.slidesPerView),vm.slider.on("slideNextStart",function(){setButtonText(),$scope.$apply()}),vm.slider.on("slidePrevStart",function(){setButtonText(),$scope.$apply()}))});var deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){"InitialLoadComplete"==args.result.toString()&&(UserService.setProcessDone("initialDataLoaded"),UserService.setUserFirstName())});$scope.$on("$destroy",function(){deregisterHandleSyncTables(),deregisterIonicViewAfterEnter(),deregisterIonicViewLeave(),$timeout.cancel(showButtonsTimeout),$timeout.cancel(updateButtonTextOnResizeTimeout),$timeout.cancel(showSettingsMenuTimeout),vm.slider.off("slideNextStart"),vm.slider.off("slidePrevStart")})}angular.module("starter.controllers").controller("TutorialCtrl",TutorialCtrl),TutorialCtrl.$inject=["$rootScope","$scope","$state","$window","$timeout","logger","UserService","AnalyticsService"]}();