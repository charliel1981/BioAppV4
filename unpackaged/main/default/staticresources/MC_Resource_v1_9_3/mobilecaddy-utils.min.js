/* mobilecaddy-utils - v1.9.3 - Bundle Time: 2018-08-30 10:24:07 */
/* git info: "2018-08-30 10:23:52 +0100": 87e981516ccb65d48af53fa6899da35ba96ebd4b (develop) */
/* Copyright 2018 MobileCaddy Ltd */

String.prototype.includes||(String.prototype.includes=function(e,t){"use strict";return"number"!=typeof t&&(t=0),!(t+e.length>this.length)&&-1!==this.indexOf(e,t)}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var o=arguments[1],r=0;r<n;){var a=t[r];if(e.call(o,a,r,t))return a;r++}},configurable:!0,writable:!0});var $j=jQuery.noConflict(),MC_TABLES=["Connection_Session__mc","Mobile_Log__mc","MC_Project__ap","MC_Time_Expense__ap","MC_Project_Location__ap"];!function(){var o,r,a,i,s;a={},i=[],s={},o=function(e){if(a[e]&&e in s&&i.slice(s[e]).join("->"),a[e].factory)try{return s[e]=i.length,i.push(e),t=a[e],n=t.factory,t.exports={},delete t.factory,n(o,t.exports,t),t.exports}finally{delete s[e],i.pop()}var t,n;return a[e].exports},(r=function(e,t){a[e],a[e]={id:e,factory:t}}).remove=function(e){delete a[e]},"object"==typeof module&&"function"==typeof o&&(module.exports.require=o,module.exports.define=r),r("mobileCaddy",function(e,t,n){var o={define:r,require:e,START_PAGE_CONTROLLER:"",QUERY_BUFFER_SIZE:1e3,QUERY_BUFFER_SIZE_SL:1e3,INITIAL_APPCACHE_INFO:[]};n.exports=o}),r("mobileCaddy/mobileLogger",function(e,t,n){function o(){try{throw Error("")}catch(e){return e}}function r(e,t){var n=t.stack.split("\n")[4];if(void 0!==n){var o=n.indexOf("at ");n.slice(o+2,n.length)}}n.exports={logMessageAndThrow:function(e){!function(e,t){throw r(0,t),e}(e,o())},logMessage:function(e){r(0,o())},logObjectDetails:function(e){!function(e,t){for(var n in e)r(e[n],t)}(e,o())}}}),r("mobileCaddy/geolocation",function(e,t,n){n.exports={getLocation:function(e,t){var n,o;n=e,(o=[]).Error="Location information is unavailable.",o.ErrorNumber=2,n(o)}}}),r("mobileCaddy/startup",function(r,e,t){var u=r("mobileCaddy/mobileLogger"),d=(r("mobileCaddy/logger"),cordova.require("com.salesforce.plugin.smartstore")),l=r("mobileCaddy/systemData"),f=r("mobileCaddy/smartStoreUtils");r("mobileCaddy/appDataUtils");window.addEventListener("error",function(e){var t=e.error?e.error.stack:null;e.error.toString()});var o=100900,a=100901;function n(e,t){"progress"==e.type?mobileCaddy.INITIAL_APPCACHE_INFO.push({Name:"Event ",Description:e.loaded+" of "+e.total}):mobileCaddy.INITIAL_APPCACHE_INFO.push({Name:"Event ",Description:e.type});var n={};"udpateready"==e.type||(e.type="cached")?n.status=o:n.status=a,u.logObjectDetails(n),t&&"function"==typeof t&&t(n)}function i(t){$j(function(){!function(t){mobileCaddy.INITIAL_APPCACHE_INFO=[],window.applicationCache.addEventListener("checking",function(e){n(e)},!1),window.applicationCache.addEventListener("downloading",function(e){n(e)},!1),window.applicationCache.addEventListener("progress",function(e){n(e)},!1),mobileCaddy.INITIAL_APPCACHE_INFO.push({Name:"AppCache: Initial Status",Description:window.applicationCache.status});var e={};switch(e.status=o,window.applicationCache.status){case window.applicationCache.CHECKING:case window.applicationCache.DOWNLOADING:throw window.applicationCache.addEventListener("updateready",function(e){n(e,t)},!1),window.applicationCache.addEventListener("cached",function(e){n(e,t)},!1),window.applicationCache.addEventListener("error",function(e){n(e,t)},!1),window.applicationCache.addEventListener("noupdate",function(e){n(e,t)},!1),new Error("MobileCaddy - Cache busy.  Will continue when check/load is complete");case window.applicationCache.UPDATEREADY:window.applicationCache.swapCache(),t(e);break;default:t(e)}}(function(e){!function(i,s){var e=S("appSoupJson");if(""!==e){var t=$j.parseJSON(e);d.registerSoup("appSoup",[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}],function(){d.upsertSoupEntries("appSoup",t,function(e){d.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){c(i,s)},function(e){u.logMessage("Failed to create cache soup with error = "+e)})},function(e){u.logMessage("Failed to update app soup with error = "+e)})},function(e){u.logMessage("Failed to register app soup with error = "+e)})}else LOCAL_DEV?(cacheSoupStructure=[{path:"Name",type:"string"},{path:"Description",type:"string"}],d.registerSoup("cacheSoup",cacheSoupStructure,function(){c(i,s)})):navigator.appVersion.includes("Electron")?d.soupExists("appSoup",function(e){if(e)c(i,s);else{var t=[],n=ipcRenderer.sendSync("request-creds","");S("access_token","?"+n);if(t.push({Name:"accessToken",CurrentValue:S("access_token","?"+n),NewValue:null}),t.push({Name:"refreshToken",CurrentValue:S("refresh_token","?"+n),NewValue:null}),t.push({Name:"clientId",CurrentValue:S("client_id","?"+n),NewValue:null}),t.push({Name:"orgId",CurrentValue:S("org_id","?"+n),NewValue:null}),t.push({Name:"applicationName",CurrentValue:S("buildName","?"+n),NewValue:null}),t.push({Name:"buildName",CurrentValue:S("buildName","?"+n),NewValue:null}),window.location.pathname.startsWith("/apex/"))t.push({Name:"loginUrl",CurrentValue:window.location.protocol+"//"+window.location.host,NewValue:null});else{var o=window.location.pathname.split("/"),r=o[1];t.push({Name:"loginUrl",CurrentValue:window.location.protocol+"//"+window.location.host+"/"+r,NewValue:null})}var a=ipcRenderer.sendSync("request-device-info","");t.push({Name:"buildStatus",CurrentValue:"Initial"}),t.push({Name:"buildVersion",CurrentValue:a.buildVersion}),t.push({Name:"buildOS",CurrentValue:a.platform}),t.push({Name:"deviceUuid",CurrentValue:a.uuid});d.registerSoup("appSoup",[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}],function(){d.upsertSoupEntries("appSoup",t,function(e){d.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){c(i,s)},function(e){u.logMessage("Failed to create cache soup with error = "+e)})},function(e){u.logMessage("Failed to update app soup with error = "+e)})},function(e){u.logMessage("Failed to register app soup with error = "+e)})}}):(document.addEventListener("deviceready",function(){c(i,s)},!1),document.addEventListener("backbutton",function(){},!0))}(t,e)})})}var p=100800,m=100801;function c(s,c){r("mobileCaddy/logger");d.upsertSoupEntries("cacheSoup",mobileCaddy.INITIAL_APPCACHE_INFO,function(){f.querySoupRecsPromise("appSoup").then(function(e){var a={},i=[];if(e.forEach(function(e){if(void 0!==a[e.Name])throw"Should only be 1 "+e.Name+" entry in the app soup.  Found more";a[e.Name]=e}),a.userOverrideId||(a.userOverrideId=""),"Complete"==a.buildStatus.CurrentValue&&"Complete"==a.buildStatus.NewValue){if(null!==s){u.logMessage("build already complete - calling 3rd party callback function");var t={};if(t.status=m,t.mc_add_status=c.status,t.curVsn=a.dynVersionNumber.CurrentValue,void 0!==a.dynVersionNumber.NewValue&&(t.newVsn=a.dynVersionNumber.NewValue),navigator.appVersion.includes("Electron")){var n=window.location.protocol+"//"+window.location.host+window.location.pathname;ipcRenderer.send("startPageUrl",n)}s(t)}}else{var o=function(e,t){if(t.status){u.logMessage("Parse json aud"+e),i=$j.parseJSON(e);var n=_.find(i,{Name:"audId"}).CurrentValue,o=_.find(i,{Name:"sysDataPlatSupVersion"}).CurrentValue;if(navigator.appVersion.includes("Electron")){var r=window.location.protocol+"//"+window.location.host+window.location.pathname;ipcRenderer.send("startPageUrl",r)}new Promise(function(e,t){d.registerSoup("recsToSync",[{path:"Mobile_Table_Name",type:"string"},{path:"SOUP_Record_Id",type:"string"},{path:"Id",type:"string"},{path:"LastModifiedDateTime",type:"integer"},{path:"CRUD_Operation",type:"string"},{path:"Current_Connection_Session",type:"string"}],function(){e()},function(e){t(e)})}).then(function(){l.createSystemDataSoup(function(){f.buildMobileTables(function(){var e=a.buildStatus;e.CurrentValue="Complete",e.NewValue="Complete",i.map(function(e){return a[e.Name]&&(e._soupEntryId=a[e.Name]._soupEntryId),e}),i.push(e),d.upsertSoupEntries("appSoup",i,function(){l.getRecordTypeDots(n,o).then(function(){if(null!==s){var e={};e.status=p,e.mc_add_status=c.status,u.logMessage("Calling 3rd party callback"),u.logObjectDetails(e),s(e)}}).catch(function(e){u.logMessage("From getRecordTypeDots "+e)})},function(e){u.logMessage("From upsert soup records "+e)})},function(e){u.logMessage("Error building mobile tables "+e)})},function(e){u.logMessage("create system data soup returned error"+e)},n,o),u.logMessage("Exiting startup")}).catch(function(e){u.logMessage("Error building recs to sync soup "+e)})}else"exception"===t.type&&alert(t.message)};r("mobileCaddy/syncRefresh").heartBeat(function(e){!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getAUDInfo001",contentType:"application/json",data:{buildVersion:a.buildVersion.CurrentValue,buildName:a.buildName.CurrentValue,buildOS:a.buildOS.CurrentValue,deviceUuid:a.deviceUuid.CurrentValue,overrideUserId:force.getUserId(),startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(e){var t={status:"200"};o(e,t)},function(e){error()}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".getAudInfo",a.buildVersion.CurrentValue,a.buildName.CurrentValue,a.buildOS.CurrentValue,a.deviceUuid.CurrentValue,a.userOverrideId,o,{escape:!1,timeout:3e4})},function(e){error()})}}).catch(function(e){})},function(e){u.logMessage("Failed to update app soup with initial app cache info = "+e)})}function S(e,t){t||(t=window.location.search),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var n=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(t);return null===n?"":decodeURIComponent(n[1].replace(/\+/g," "))}t.exports={startup:function(e){i(e)}}}),r("mobileCaddy/systemData",function(e,t,n){var o=e("mobileCaddy/mobileLogger"),u=e("mobileCaddy"),d=e("mobileCaddy/logger"),l=cordova.require("com.salesforce.plugin.smartstore"),c=(u.require("mobileCaddy/smartStoreUtils"),e("mobileCaddy/appDataUtils"));function f(a,i,s,c){var n=function(e,t){if(t.status){var n=$j.parseJSON(e);$j.each(n,function(e,t){o.logObjectDetails(t)}),l.registerSoup("syncLib_system_data",n,function(){var e,t,o,r,n;e=a,t=i,o=function(){var e,t,o,r,n;e=a,t=i,o=s,r=c,n=function(e,t){if(t.status){var n=$j.parseJSON(e);l.upsertSoupEntries("syncLib_system_data",n,function(e){o(e)},function(e){d.error("Error returned from upsert, message =  "+e),r(e)})}else"exception"===t.type?(alert(t.message),d.error("Exception return from getDefsForSObjectMobileTables = "+t.message)):d.error("Unknown return from getDefsForSObjectMobileTables = "+t.message)},!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getDefsForSObjectMobileTables001",contentType:"application/json",data:{audId:e,startPageControllerVersion:u.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:t}},function(e){var t={status:"200"};n(e,t)},r):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+u.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables",e,t,n,{escape:!1,timeout:12e4})},r=c,n=function(e,t){if(t.status){var n=$j.parseJSON(e);l.upsertSoupEntries("syncLib_system_data",n,o,r)}else"exception"===t.type?(alert(t.message),d.error("Exception return from getSystemDataRowValues = "+t.message)):d.error("Unknown return from getSystemDataRowValues = "+t.message)},!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getSysDataSoupVariables001",contentType:"application/json",data:{audId:e,startPageControllerVersion:u.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:t}},function(e){var t={status:"200"};n(e,t)},r):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+u.START_PAGE_CONTROLLER+".getSysDataSoupVariables",e,t,n,{escape:!1})},c)}else"exception"===t.type?(alert(t.message),d.error("Exception return from getSystemDataSoupDefinition = "+t.message)):d.error("Unknown return from getSystemDataSoupDefinition = "+t.message)};!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getSystemDataSoupDefinition001",contentType:"application/json",data:{audId:a,startPageControllerVersion:u.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:i}},function(e){var t={status:"200"};n(e,t)},c):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+u.START_PAGE_CONTROLLER+".getSystemDataSoupDefinition",a,i,n,{escape:!1})}n.exports={createSystemDataSoup:function(e,t,n,o){var r,a,i,s;r=e,a=t,s=o,void 0!==(i=n)&&void 0!==s?f(i,s,r,a):c.getCurrentValueFromAppSoup("audId").then(function(e){return i=e,c.getCurrentValueFromAppSoup("sysDataPlatSupVersion")}).then(function(e){f(i,e,r,a)}).catch(function(e){a(e)})},getRecordTypeDots:function(a){return new Promise(function(r,n){var t,o=function(o,e){e.status?l.registerSoup("dotsRecordTypes",[{path:"Table",type:"string"},{path:"Data",type:"string"}],function(e){var t=JSON.parse(o).map(function(e){return{Table:e.mobileTableName,Data:JSON.stringify(e.recTypeInfoList)}});l.upsertSoupEntries("dotsRecordTypes",t,function(e){var n={};JSON.parse(o).forEach(function(e){var t={};e.recTypeInfoList.forEach(function(e){e.recTypeDevName?(t[e.recTypeId]={recTypeName:e.recTypeName,recTypeDevName:e.recTypeDevName},t[e.recTypeName]=e.recTypeId,t[e.recTypeDevName]=e.recTypeId):(t[e.recTypeId]=e.recTypeName,t[e.recTypeName]=e.recTypeId)}),n[e.mobileTableName]=t}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(n)),r()},function(e){d.error("Error returned from upsert, message =  "+e),n(e)})},function(e){n(e)}):("exception"===e.type?d.error("Exception return from p2mRefreshRecTypeDOTs = "+e.message):d.error("Unknown return from p2mRefreshRecTypeDOTs = "+e.message),n(e.message))};c.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){t=e,!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshRecTypeDOTs001",contentType:"application/json",data:{audId:a,startPageControllerVersion:u.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:t,connSessJson:"{}"}},function(e){var t={status:"200"};o(e,t)},function(e){o("[]",{status:"OK"})}):Visualforce.remoting.Manager.getAction("mobilecaddy1."+u.START_PAGE_CONTROLLER+".p2mRefreshRecTypeDOTs")?Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+u.START_PAGE_CONTROLLER+".p2mRefreshRecTypeDOTs",a,t,"{}",o,{escape:!1,timeout:12e4}):o("[]",{status:"OK"})})})}}}),r("mobileCaddy/smartStoreUtils",function(p,e,t){var f=p("mobileCaddy/mobileLogger"),m=cordova.require("com.salesforce.plugin.smartstore");function r(e,t,n){var o=[];function r(e){t(o)}function a(e){if(!n)throw e;n(e)}!function e(t){$j.each(t.currentPageOrderedEntries,function(e,t){o.push(t)}),t.currentPageIndex<t.totalPages-1?cordova.require("com.salesforce.plugin.smartstore").moveCursorToNextPage(t,e):cordova.require("com.salesforce.plugin.smartstore").closeCursor(t,r,a)}(e)}function n(e,t,n){s("syncLib_system_data",m.buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE),function(e){var n=[];$j.each(e,function(e,t){t.Type!=mobileCaddy.STANDING_DATA_OBJECT&&t.Type!=mobileCaddy.DYNAMIC_DATA_OBJECT&&n.push(t)}),t(n)},n)}function i(e,t,n){var o=m.buildAllQuerySpec("_soupEntryId",null,mobileCaddy.QUERY_BUFFER_SIZE);m.querySoup(e,o,function(e){r(e,function(e){t(e)},n)})}function s(e,t,n,o){m.querySoup(e,t,function(e){r(e,function(e){n(e)},o)},o)}function c(e,t,n){m.runSmartQuery(e,function(e){r(e,function(e){t(e)},n)},n)}function _(o,r,a,t,e){if(void 0===t&&void 0===e)return new Promise(function(t,n){var e=m.buildExactQuerySpec(r,a,mobileCaddy.QUERY_BUFFER_SIZE_SL);s(o,e,function(e){t(e)},function(e){n(e)})});var n=m.buildExactQuerySpec(r,a,mobileCaddy.QUERY_BUFFER_SIZE_SL);s(o,n,function(e){t(e)},e)}function S(e,t,n,o,r,a,i){s(e,m.buildExactQuerySpec(t,n,mobileCaddy.QUERY_BUFFER_SIZE_SL),function(e){var n=[];$j.each(e,function(e,t){t[o]==r&&n.push(t)}),a(n)},i)}function u(t,n,o){h("Row Mapping PT","Mobile Table Name",function(e){S("syncLib_system_data","MC_Var_String_001","Platform Table Definition",e,t,function(e){1!=e.length&&f.logMessageAndThrow("Should be exactly 1 table defn row for table: "+t+", but we got "+e.length),n(e[0])},o)},o)}function d(e,r){return new Promise(function(n,o){u(e,function(t){h("Row Mapping PT",r,function(e){n(t[e])},function(e){o(e)})},function(e){o(e)})})}function l(e,r,a){return new Promise(function(n,o){u(e,function(t){h("Row Mapping PT",r,function(e){t[e]=a,m.upsertSoupEntries("syncLib_system_data",[t],function(){n()},function(e){o(e)})},function(e){o(e)})},function(e){o(e)})})}function h(t,n,o,e){var r=t+"_"+n,a=localStorage.getItem(r);a?o(a):S("syncLib_system_data","MC_Var_String_001",t,"MC_Var_String_003",n,function(e){1!=e.length&&($j.each(e,function(e,t){f.logObjectDetails(t)}),f.logMessageAndThrow("Must be exactly 1 Row Mapping Record for Sys Data Row Type = "+t+" and Sys Data Row Value = "+n+" found count = "+e.length)),localStorage.setItem(r,e[0].MC_Var_String_004),o(e[0].MC_Var_String_004)},e)}function a(a,e,n,t){s("syncLib_system_data",m.buildExactQuerySpec("MC_Var_String_001",a,mobileCaddy.QUERY_BUFFER_SIZE_SL),function(t){var r=[];$j.each(e,function(e,n){var o=!1;if($j.each(t,function(e,t){if(t.MC_Var_String_003==n)return r.push(t.MC_Var_String_004),void(o=!0)}),!o)throw"No mapping found for type = "+a+" and value = "+n}),n(r)},t)}var y=1,b=2;function o(t,r,n){a("Row Mapping PT",["Mobile Table Name","Build Order"],function(e){var o=e[0],a=e[1];_("syncLib_system_data","MC_Var_String_001","Platform Table Definition",function(e){var n=[];t==b?(e.sort(function(e,t){var n=0,o=parseInt(e[a]),r=parseInt(t[a]);return isNaN(o)||isNaN(r)||(n=o-r),n}),$j.each(e,function(e,t){n.push(t[o])})):($j.each(e,function(e,t){n.push(t[o])}),t==y&&n.sort()),null!==r&&r(n)},n)},n)}var g=0,C=1,v=2;function R(n,d,l,e){a("Row Mapping TC",["Parent SOUP Name","Table Column Name","Mobile Column Type","Application Field CRUD","META isNillable","Platform Column Type","Device Value Type","Proxy Ref Field Name"],function(e){var t=e[0],o=e[1],r=e[2],a=e[3],i=e[4],s=e[5],c=e[6],u=e[7];S("syncLib_system_data","MC_Var_String_001","Platform Table Column",t,n,function(e){var n=[];$j.each(e,function(e,t){d==g?n.push(t[o]):d==v?n.push({path:t[o],type:t[r],crud:t[a],nillable:t[i],platColType:t[s],appColType:t[c],proxyRefField:t[u]}):n.push({path:t[o],type:t[r]})}),l(n)},function(e){f.logMessage("Error retrieving column names = "+e)})},e)}function T(r,a){o(b,function(e){var t=e.length;$j.each(e,function(e,o){R(o,C,function(n){m.registerSoup(o,n,function(){l(o,"SOUP Built Date/Time",(new Date).getTime()).then(function(){var t;return t=o,n.forEach(function(e){e.path.includes("MC_Proxy_ID")&&localStorage.setItem("proxyField-"+t,e.path)}),d(o,"Snapshot Data Required")}).then(function(e){"Yes"==e?m.registerSoup("SnapShot_"+o,n,function(){l(o,"Snapshot SOUP Built Date/Time",(new Date).getTime()),0===--t&&r()},function(e){a(e)}):0===--t&&r()}).catch(function(e){a(e)})},a)},function(e){a(e)})})},a)}function E(e,t,n,o){if(0!==e.length){var r=[];$j.each(e,function(e,t){t&&t._soupEntryId&&r.push(t._soupEntryId)}),0!==r.length?m.removeFromSoup(t,r,function(e){n(e)},o):n()}else n()}function I(s,e,t,n,o){var c,u,d,l,f;p("mobileCaddy/syncRefresh");(c=s,u=e,d=t,l=u.length,f=0,new Promise(function(i,s){N(c).then(function(a){$j.each(u,function(o,r){_(c,d,r[d]).then(function(e){if(0<e.length){var t=e[0];for(var n in r)t[n]=r[n];u[o]=t,l<=++f&&i(u)}else"Id"==d&&18<r.Id.length?_(c,a,r.Id).then(function(e){if(0<e.length){var t=e[0];for(var n in r)"Id"!=n&&(t[n]=r[n]);u[o]=t,l<=++f&&i(u)}else s({status:101107})}):s({status:101107})}).catch(function(e){s(e)})})}).catch(function(e){s(e)})})).then(function(e){m.upsertSoupEntriesWithExternalId(s,e,t,function(e){_("recsToSync","Mobile_Table_Name",s,function(a){var i=[];$j.each(e,function(e,n){var o,t;if($j.each(a,function(e,t){t.Id!=n.Id||(o=t)}),void 0!==o)if(o.Current_Connection_Session&&void 0!==o.Current_Connection_Session)switch(o.CRUD_Operation){case"Insert":case"InsertUpdate":t="InsertUpdate";break;default:t="UpdateUpdate"}else t=o.CRUD_Operation;else t="Update";var r={Mobile_Table_Name:s,SOUP_Record_Id:n._soupEntryId,Id:n.Id,CRUD_Operation:t,LastModifiedDateTime:n.SystemModstamp};"InsertUpdate"!=t&&"UpdateUpdate"!=t||(r.Current_Connection_Session=o.Current_Connection_Session),i.push(r)}),m.upsertSoupEntriesWithExternalId("recsToSync",i,"Id",n,o)},o)},o)}).catch(function(e){o(e)})}function N(o){return new Promise(function(n,e){var t=localStorage.getItem("proxyField-"+o);t?n(t):R(o,g,function(e){var t=null;e.forEach(function(e){e.includes("MC_Proxy_ID")&&(t=e,localStorage.setItem("proxyField-"+o,e))}),n(t)},function(e){n(null)})})}t.exports={NONE:0,ALPHA:y,BUILD:b,listMobileTables:function(e,t,n){o(e,t,n)},LIST:g,BUILD_OBJECT:C,FULL:v,listMobileTableColumns:function(e,t,n,o){R(e,t,n,o)},queryMobileTable:function(e,t,n,o,r){return _(e,t,n,o,r)},buildMobileTables:function(e,t){T(e,t)},getProxyFieldName:function(e){return N(e)},getSysDataRowMapColHeading:function(e,t,n,o){h(e,t,n,o)},getSysDataRowMapColHeadings:function(e,t,n,o){a(e,t,n,o)},getTableDefnColumnValue:function(e,t){return d(e,t)},setTableDefnColumnValue:function(e,t,n,o,r){return l(e,t,n)},queryMobileTableWithAnd:function(e,t,n,o,r,a,i){S(e,t,n,o,r,a,i)},smartQuerySoupRecordsWithQuerySpec:function(e,t,n){c(e,t,n)},insertRecords:function(e,t,n,o){var a,r,i,s,c;a=e,r=t,i=n,s=o,c=p("mobileCaddy/syncRefresh"),m.upsertSoupEntries(a,r,function(e){var r=(new Date).getTime();c.addProxyIds(a,e,r,function(e){var o=[];$j.each(e,function(e,t){var n={Mobile_Table_Name:a,CRUD_Operation:"Insert",SOUP_Record_Id:t._soupEntryId,Id:t.Id,LastModifiedDateTime:r};o.push(n)}),m.upsertSoupEntriesWithExternalId("recsToSync",o,"Id",i,s)},s)},s)},updateRecordsWithExternalId:function(e,t,n,o,r){I(e,t,n,o,r)},markSoupToSync:function(n,o,r){s("syncLib_system_data",m.buildExactQuerySpec("Type",mobileCaddy.DYNAMIC_DATA_OBJECT,mobileCaddy.QUERY_BUFFER_SIZE_SL),o,function(e){for(var t=0;t<e.length;t++)if(e[t].Name==n){e[t].Refresh_Indicator="Once",m.upsertSoupEntries("syncLib_system_data",[e[t]],o,r);break}})},emptySoup:function(e,t,n){var o=mobileCaddy.require("mobileCaddy/smartStoreUtils");m.removeSoup(e,function(){o.createSoup(e,t,n)},n)},emptySoupPromise:function(o){return new Promise(function(e,t){var n=mobileCaddy.require("mobileCaddy/smartStoreUtils");m.removeSoup(o,function(){n.createSoup(o,function(){e()},function(e){t(e)})},function(e){t(e)})})},deleteSoup:function(o){return new Promise(function(e,t){mobileCaddy.require("mobileCaddy/smartStoreUtils");var n=p("mobileCaddy/logger");m.removeSoup(o,function(){n.log("deleteSoup",o),e()},function(e){n.errorAndDispatch("deleteSoup",e),t(e)})})},createSoup:function(a,i,s){n(a,function(e){var t,n,o,r;t=e,n=function(e,t){m.registerSoup(a,t,function(e){i()},s)},o=[],r="Select ",$j.each(t,function(e,t){o.push({path:t.Column_Name,type:t.Column_Type}),0!==t.Column_Name.indexOf("_")&&(r+=t.Column_Name+",")}),r=r.substring(0,r.length-1),n(r+=" From "+t[0].Name,o)},s)},querySoupRecords:function(e,t,n){i(e,t,n)},querySoupRecsPromise:function(e){return o=e,new Promise(function(t,n){i(o,function(e){t(e.filter(function(e){return"object"==typeof e}))},function(e){n(e)})});var o},querySoupRecordsWithQuerySpec:function(e,t,n,o){s(e,t,n,o)},compareVersions:function(t,n){s("syncLib_system_data",cordova.require("com.salesforce.plugin.smartstore").buildExactQuerySpec("Name",mobileCaddy.VERSION_ID,mobileCaddy.QUERY_BUFFER_SIZE),function(e){simpleMessageSL("Version in soup = "+e[0].Value),getVersion(function(e){simpleMessageSL("Version in Salesforce = "+e),t()},n)},n)},deleteRecordsForExternalId:function(e,t,n,o,r){return function(a,t,i,n,o){if(!n&&!o)return new Promise(function(n,o){if(0===t.length)n();else{var r="";"object"==typeof t[0]?t.forEach(function(e,t){r+=0===t?"'"+e[i]+"'":",'"+e[i]+"'"}):t.forEach(function(e,t){r+=0===t?"'"+e+"'":", '"+e+"'"});var e="SELECT {"+a+":_soupEntryId} FROM {"+a+"} WHERE {"+a+":"+i+"} IN ("+r+")";querySpec=m.buildSmartQuerySpec(e,1e4),c(querySpec,function(e){var t=e.map(function(e){return e[0]});m.removeFromSoup(a,t,function(e){n(e)},function(e){o(e)})},function(e){o(e)})}});if(0===t.length)n();else{var r=[];$j.each(t,function(e,t){r.push(t[i])});var s="";t.forEach(function(e,t){s+=0===t?"'"+e[i]+"'":",'"+e[i]+"'"});var e="SELECT {"+a+":_soupEntryId} FROM {"+a+"} WHERE {"+a+":"+i+"} IN ("+s+")";querySpec=m.buildSmartQuerySpec(e,1e4),c(querySpec,function(e){var t=e.map(function(e){return e[0]});m.removeFromSoup(a,t,function(e){n()},function(e){o(e)})},function(e){o(e)})}}(e,t,n,o,r)},deleteRecordsFromSoup:function(e,t,n,o){E(e,t,n,o)},refreshSnapshot:function(e,t,n){var o,r,a;o=e,r=t,a=n,m.soupExists(o,function(e){e?m.soupExists("SnapShot_"+o,function(e){e?i("SnapShot_"+o,function(e){E(e,"SnapShot_"+o,function(){i(o,function(e){m.upsertSoupEntries("SnapShot_"+o,e,r,a)},a)},a)},a):f.logMessageAndThrow("SnapShot Table is missing: SnapShot_"+o)},a):f.logMessageAndThrow("Mobile Table is missing"+o)},a)}}}),r("mobileCaddy/appDataUtils",function(e,t,n){e("mobileCaddy/mobileLogger");var i=cordova.require("com.salesforce.plugin.smartstore"),s=e("mobileCaddy/smartStoreUtils");function r(o){return new Promise(function(t,n){var e=i.buildExactQuerySpec("Name",o,mobileCaddy.QUERY_BUFFER_SIZE);s.querySoupRecordsWithQuerySpec("appSoup",e,function(e){e[0]?t(e[0].CurrentValue):t(e[0])},function(e){n(e)})})}function o(o,r,a){return new Promise(function(t,n){var e=i.buildExactQuerySpec("Name",o,mobileCaddy.QUERY_BUFFER_SIZE);s.querySoupRecordsWithQuerySpec("appSoup",e,function(e){0<e.length?(e[0][a]=r,i.upsertSoupEntries("appSoup",e,function(e){t(e)},function(e){n(e)})):t()},function(e){n(e)})})}n.exports={getCurrentValueFromAppSoup:function(e){return r(e)},getCachedCurrentValueFromAppSoup:function(e){return n=e,o=localStorage.getItem("appSoup-"+n),new Promise(function(t,e){o?t(o):r(n).then(function(e){localStorage.setItem("appSoup-"+n,e),t(e)})});var n,o},updateNewValueInAppSoup:function(e,t){return o(e,t,"NewValue")},updateCurrentValueInAppSoup:function(e,t){return o(e,t,"CurrentValue")}}}),r("mobileCaddy/syncRefresh",function(r,e,t){var y=r("mobileCaddy/appDataUtils"),f=r("mobileCaddy/vsnUtils"),b=r("mobileCaddy/smartStoreUtils"),g=(r("mobileCaddy/mobileLogger"),r("mobileCaddy/logger")),C=cordova.require("com.salesforce.plugin.smartstore"),v=r("mobileCaddy/connSessUtils"),R="006";function h(l){return new Promise(function(a,t){var i=function(e){t(e)},s={},c={},u={},d=l.mt,e=C.buildExactQuerySpec("Mobile_Table_Name",d,mobileCaddy.QUERY_BUFFER_SIZE);b.querySoupRecordsWithQuerySpec("recsToSync",e,function(n){$j.each(n,function(e,t){if("Insert"==t.CRUD_Operation||"InsertUpdate"==t.CRUD_Operation)c[t.Id]=1;else{if("Update"!=t.CRUD_Operation&&"UpdateUpdate"!=t.CRUD_Operation)return void g.error("RTS contains record with non support CRUD Operation"+t);u[t.Id]=1}}),b.getProxyFieldName(d).then(function(o){var r=[],t=[];($j.each(l.records,function(e,t){var n=!0;null!==t.recordData.MC_Proxy_ID__c&&c.hasOwnProperty(t.recordData[o])&&(n=!1),n&&u.hasOwnProperty(t.recordData.Id)&&(n=!1),n&&r.push(t.recordData)}),l.ds)&&l.ds.oq.concat(l.ds.sd.concat(l.ds.hd.concat(l.ds.sh))).forEach(function(e){u.hasOwnProperty(e)||t.push({Id:e})});var e=C.buildExactQuerySpec("Mobile_Table_Name",d,mobileCaddy.QUERY_BUFFER_SIZE);b.querySoupRecordsWithQuerySpec("recsToSync",e,function(e){e.length==n.length?b.deleteRecordsForExternalId(d,t,"Id",function(){C.upsertSoupEntriesWithExternalId(d,r,"Id",function(){C.soupExists("SnapShot_"+d,function(e){e?b.deleteRecordsForExternalId("SnapShot_"+d,t,"Id",function(){C.upsertSoupEntriesWithExternalId("SnapShot_"+d,r,"Id",function(){f.checkForMigrateToInfo(l),p(l.platAuthUrl),s.status=0,s.cs=l.cs,s.cp=l.cp,s.lastRefreshDatetime=l.lastRefreshDatetime,a(s)},i)},i):(f.checkForMigrateToInfo(l),p(l.platAuthUrl),s.status=0,s.lastRefreshDatetime=l.lastRefreshDatetime,s.cs=l.cs,s.cp=l.cp,a(s))},i)},i)},i):(s.status=0,s.mc_add_status=1,s.cs=l.cs,s.cp=l.cp,s.lastRefreshDatetime=l.lastRefreshDatetime,resolves(s))},i)})},i)})}function p(t){t||(t=""),y.updateCurrentValueInAppSoup("platAuthUrl",t).catch(function(e){g.error("setPlatAuthUrl",t,e)})}var T=100500,E=100402;function I(o,r,a){return new Promise(function(t,n){y.getCachedCurrentValueFromAppSoup("audId").then(function(e){t("PROXY%"+o+"%"+a+"%"+r+"%"+e)}).catch(function(e){n(e)})})}function N(e,t,n,o){var r;if("Throw Exception"==o)throw g.errorAndDispatch("nullHandler - NULL value found",e,t,n.Id),"NULL value found for field "+t+" in Mobile Table "+e+" with Id = "+n.Id;return"Return NULL"==o?r=null:"Return Empty String"==o&&(r=""),r}function D(o,a){return new Promise(function(t,e){if(o<R||!a)t();else{var n,r=[];b.queryMobileTable("recsToSync","Mobile_Table_Name","Connection_Session__mc").then(function(e){return 0<(n=e).length?b.querySoupRecsPromise("Connection_Session__mc"):Promise.resolve([])}).then(function(o){n.forEach(function(e){for(var t,n=0;n<o.length;++n)if(o[n].Id===e.Id&&o[n].Id.length<20){t=o[n];break}t&&r.push({Id:e.Id,t:function(e){switch(e){case"Sync - Refresh":return 1;case"Sync - Update":return 2;case"Status Check":return 3;default:return g.error("Unkown Session_Type__c",e),0}}(t.mobilecaddy1__Session_Type__c),s:function(e){switch(e){case"P2M RE Records Processed":return 1;case"P2M Conn_Sess Records Processed":return 2;case"P2M RE Abandoned":return 3;case"P2M RE Exception/Timeout":return 4;case"P2M RE Heartbeat Exception/Timeout":return 5;case"P2M RE Failure":return 6;case"P2M RE Hearbeat Failure":return 7;case"M2P Conn_Sess Records Processed":return 8;case"M2P Records Processed":return 9;case"M2P UP Failed - RTS Cleared":return 10;case"M2P SC - Status Check Processed":return 11;case"M2P SC Failure":return 12;case"M2P SC Exception/Timeout":return 13;case"M2P SC Heartbeat Exception/Timeout":return 14;case"M2P SC Heartbeat Failure":return 15;case"M2P UP Received - Records Processed":return 16;case"P2M InitialSync Faliure":return 17;default:return g.error("Unknown CS status",e),0}}(t.mobilecaddy1__Mobile_Process_Status__c)})}),t(r)}).catch(function(e){g.error(e),t(null)})}})}function P(i,s,c,e,u,d,t,l,f,n,o){var p={MobileTable:i,connSessProxyId:n,records:[]};t.forEach(function(e){for(var t,n=0;n<l.length;++n)if(l[n].Id===e.Id){t=l[n];break}if(t){var o={RTSRowNum:e._soupEntryId,RecordCRUD:function(e){switch(e){case"Insert":return"I";case"InsertDelete":return"T";case"Update":return"U";case"UpdatetDelete":return"Q";case"Delete":return"D";default:return null}}(e.CRUD_Operation),fields:[]};switch(o.RecordCRUD){case"I":case"T":o=function(e,t,n,o,r,a,i,s){for(var c in s){var u={name:c};if("mobilecaddy1__Error_Text__c"==c)u.value=JSON.stringify(s[c]),e.fields.push(u);else if("_soupEntryId"!=c&&"_soupLastModifiedDate"!=c){var d,l={};l[o]=c;var f=_.findWhere(n,l);if(null===s[c])fieldNullHandler=f[a],d=N(t,c,s,fieldNullHandler);else if(d=s[c],f){var p=f[i];"M2P UP Unquoted"!=p||"true"!=d&&"false"!=d||(d="true"==d)}u.value=d,e.fields.push(u)}}return e}(o,i,s,c,0,u,d,t),p.records.push(o);break;case"D":case"U":case"Q":for(var r,a=0;a<f.length;++a)if(f[a].Id===e.Id){r=f[a];break}r?(o=function(e,t,n,o,r,a,i,s,c){var u=!1;for(var d in s)if("_soupEntryId"!=d&&"_soupLastModifiedDate"!=d){var l={name:d};if(s[d]!=c[d]||"SystemModstamp"==d){var f,p;u=!0;var m=null,S=null,h={};h[o]=d;var y=_.findWhere(n,h);null===s[d]?(m=y[a],f=N(t,d,s,m)):(f=s[d],y&&("M2P UP Unquoted"!=(S=y[i])||"true"!=f&&"false"!=f||(f="true"==f))),null===c[d]&&y?(m||(m=y[a]),p=N(t,d,c,m)):(p=c[d],y&&(S||(S=y[i]),"M2P UP Unquoted"!=S||"true"!=p&&"false"!=p||(p="true"==p))),l.previousValue=p,l.value=f,e.fields.push(l)}}return u?(e.fields.push({name:"Id",previousValue:c.Id,value:c.Id}),e):[]}(o,i,s,c,0,u,d,t,r),p.records.push(o)):g.errorAndDispatch("createUpdateJson Missing snapShot",i,t.Id);break;default:g.errorAndDispatch("createUpdateJson unknown CRUD",i,e.Id,e.CRUD_Operation)}}else g.errorAndDispatch("createUpdateJson Missing primary",i,e.Id)}),o(JSON.stringify(p))}function U(t,e,n,o,r){var a=[];$j.each(e,function(e,o){var r={};$j.each(n,function(e,t){if(o.Id==t.Id&&"Insert"==o.CRUD_Operation)for(var n in t)"_soupEntryId"!=n&&"_soupLastModifiedDate"!=n&&(r[n]=t[n])}),_.isEmpty(r)||a.push(r)}),0===a.length?o():b.getProxyFieldName(t).then(function(e){C.upsertSoupEntriesWithExternalId("SnapShot_"+t,a,e,o,r)})}function w(e,f,p,m,_,S){return new Promise(function(d,o){var e=r("mobileCaddy/geolocation"),l={};e.getLocation(function(r){var a,e,i,s,c,t,n={mobilecaddy1__Session_Type__c:f,mobilecaddy1__Mobile_Process_Status__c:p,SystemModstamp:(new Date).getTime()},u=r.ErrorNumber;0!==u?n.mobilecaddy1__Session_Created_Location_Error__c=r.Error:(n.Session_Created_Location__Longitude__s=r.Latitude,n.Session_Created_Location__Latitude__s=r.Longitude),a="Connection_Session__mc",e=n,i=function(e){var t=new Date,n={"Sync Session Proxy ID":null,"Total Sessions":_,"Session Number":m,"Device Call Date/Time":t.getTime(),"Connection Session Proxy ID":e.proxyId};S&&(n.CsPId=S),0!==u?n.ErrorNumber=u:(n["Location Long"]=r.Longitude,n["Location Lat"]=r.Latitude),l.status=0,l.connSessionRec=e.insertedRecord,l.connSessProxyId=e.proxyId;var o={version:"NULL"};window.device&&(o=window.device),y.getCurrentValueFromAppSoup("containerVersion").then(function(e){n.containerVsn=e,n.OSVsn=o.version,l.connSessJson=JSON.stringify(n),d(l)}).catch(function(e){g.error("buildConnectionSession - Could not get containerVsn",e),n.OSVsn=o.version,l.connSessJson=JSON.stringify(n),d(l)})},s=function(e){o(e)},c={},t=new Date,b.getProxyFieldName(a).then(function(o){C.upsertSoupEntries(a,[e],function(e){var n=e[0];I(a,n._soupEntryId,t.getTime()).then(function(t){n.Id=t,n[o]=t,C.upsertSoupEntries(a,[n],function(e){c.status=0,c.proxyId=t,c.insertedRecord=e[0],i(c)},s)}).catch(function(e){s(e)})},s)}).catch(function(e){s(e)})},function(e){o(e)})})}function n(f){return new Promise(function(t,n){var u={},d=function(e){t(e)},l=function(e){n(e)},e=C.buildExactQuerySpec("Mobile_Table_Name",f,mobileCaddy.QUERY_BUFFER_SIZE);b.querySoupRecordsWithQuerySpec("recsToSync",e,function(e){if(0!==e.length){var t=!1;"Connection_Session__mc"!=f&&3e4<e.length&&(t=!0);var c=[];c=t?(c=_.sortBy(e,"_soupLastModifiedDate")).slice(0,3e4):e,b.querySoupRecords(f,function(s){b.querySoupRecords("SnapShot_"+f,function(i){b.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(e){var t=e[0],o=e[1],r=(e[2],e[3]),a=e[4];b.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",t,f,function(e){var n=[];_.each(c,function(e){var t;t=e.Id,_.find(s,function(e){return e.Id==t})&&n.push(e)}),_.isEmpty(n)?b.setTableDefnColumnValue(f,"Last Sync Date/Time",(new Date).getTime()).then(function(){u.status=O,u.mc_add_status=M,d(u)}).catch(function(e){g.error(e)}):P(f,e,o,0,r,a,n,s,i,"",function(t){var o;y.getCachedCurrentValueFromAppSoup("audId").then(function(e){return o=e,y.getCachedCurrentValueFromAppSoup("syncRefreshVersion")}).then(function(e){U(f,c,s,function(){var n=function(e,t){u.result=e,u.event=t,d(u)};t=t.replace(/: undefined/g,': "undefined"'),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:o,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:e,mobileTableName:f,jsonRecords:t,connSessJson:"{}"}},function(e,t){void 0===t&&((t={}).status="200"),n(e,t)},l):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",o,e,f,t,JSON.stringify({"Session Number":1,"Location Long":10,"Location Lat":10,"Total Sessions":1,"Device Call Date/Time":(new Date).getTime(),"Connection Session Proxy ID":"1",ErrorNumber:2}),n,{buffer:!1,escape:!1,timeout:3e4})},l)}).catch(function(e){l(e)})})},l)},l)},l)},l)}else b.setTableDefnColumnValue(f,"Last Sync Date/Time",(new Date).getTime()).then(function(){u.status=O,u.mc_add_status=M,d(u)}).catch(function(e){g.log("No recs to sync")})},l)})}var O=100300,M=100310;function a(d,l,f,p){var m,S,h={};try{y.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){S=e;var t=localStorage.getItem("mcM2pMoreToSync")?2:1;return w(0,"Sync - Update","M2P Process Called",t,t,null)}).then(function(e){return m=e,D(S,!0)}).then(function(e){e&&(m.connSessJson=JSON.parse(m.connSessJson),m.connSessJson.csM2P=e,m.connSessJson=JSON.stringify(m.connSessJson));var t=C.buildExactQuerySpec("Mobile_Table_Name",d,mobileCaddy.QUERY_BUFFER_SIZE);b.querySoupRecordsWithQuerySpec("recsToSync",t,function(e){var t,n,o,r,a,i,s=(t=e,(n=JSON.parse(localStorage.getItem("tmpFailedRecordsAccum")))?t.filter(function(e){return!n[e.Id]}):t);if(0!==s.length){var c=!1;"Connection_Session__mc"!=d&&s.length>l?(c=!0,localStorage.setItem("mcM2pMoreToSync","true")):localStorage.removeItem("mcM2pMoreToSync");var u=[];u=c?(u=_.sortBy(s,"_soupLastModifiedDate")).slice(0,l):s,o=u,r=m.connSessProxyId,a=function(s){b.querySoupRecords(d,function(i){b.querySoupRecords("SnapShot_"+d,function(a){b.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(e){var t=e[0],n=e[1],o=(e[2],e[3]),r=e[4];b.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",t,d,function(e){P(d,e,n,0,o,r,s,i,a,m.connSessProxyId,function(o){var t;y.getCachedCurrentValueFromAppSoup("audId").then(function(e){t=e,U(d,s,i,function(){var n=function(e,t){var n;t.status?(e=e.replace(/,}/g,"}"),n=JSON.parse(e),v.processM2PUpdateResponse(n,o,function(e){m.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="Connection_Session__mc"==d?"M2P Conn_Sess Records Processed":"M2P Records Processed",m.connSessionRec.Id=e.csId,v.postProcessConnectionSession(m.connSessionRec).then(function(){return v.handleUpdatedCS(n.csM2P)}).then(function(){c?(h.status=O,h.mc_add_status="more-to-sync",f(h)):S<R?v.maybeSyncConnSess(m.connSessionRec,function(){h.status=O,f(h)},p):(h.status=O,f(h))}).catch(function(e){p(e)})},p)):("exception"===t.type?(h.status=O,h.mc_add_status=A):(h.status=O,h.mc_add_status=L),f(h),g.error("m2pUpdate",d,t.message,t.where))};o=o.replace(/: undefined/g,': "undefined"'),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:t,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:S,mobileTableName:d,jsonRecords:o,connSessJson:m.connSessJson}},function(e,t){void 0===t&&((t={}).status="200"),n(e,t)},p):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",t,S,d,o,m.connSessJson,n,{buffer:!1,escape:!1,timeout:3e4})},p)}).catch(function(e){p(e)})})},p)},p)},p)},p)},i=p,$j.each(o,function(e,t){t.Current_Connection_Session=r}),C.upsertSoupEntriesWithExternalId("recsToSync",o,"Id",a,i)}else b.setTableDefnColumnValue(d,"Last Sync Date/Time",(new Date).getTime()).then(function(){h.status=O,h.mc_add_status=M,f(h)}).catch(function(e){p(e)})},p)},p)}catch(e){g.errorAndDispatch(e)}}var i=100100,A=100101,L=100102,o=100103,s=100104,c=100105;function u(n,e){var o={};Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".heartBeat",function(e,t){t.status?(o.status=i,n(o)):"exception"===t.type?d(function(e){o.status=c,n(o)},function(e){o.status=A,n(o)}):(o.status=L,n(o))},{escape:!1,timeout:3e4})}function d(n,o){b.querySoupRecords("appSoup",function(e){var t={};e.forEach(function(e){t[e.Name]=e.CurrentValue}),function(e,t,n){r("mobileCaddy/mobileLogger"),cordova.require("com.salesforce.plugin.smartstore");var o="grant_type=refresh_token&identity_url="+e.identityUrl+"&client_id="+e.clientId+"&refresh_token="+e.refreshToken+"&orgId="+e.orgId+"&audId="+e.audId+"&userId="+e.userId;$j.ajax({type:"POST",url:"https://mobilecaddy.secure.force.com/apex/ProxyToken",cache:!1,processData:!1,data:o,success:function(e){Visualforce.remoting.oauthAccessToken=e.access_token,Visualforce.remoting.last.refresh(function(){y.updateCurrentValueInAppSoup("accessToken",e.access_token).then(function(){t(e.access_token)}).catch(function(e){n(e)})},function(e){g.error("in VF last refresh error"),n(e)})},error:function(e){g.error("failed to refresh access token "+JSON.stringify(e)),n(e)},dataType:"json",beforeSend:function(e){}})}(t,n,o)},function(e){o(e)})}t.exports={CSINHEAD_SYNC_VSN:R,refreshToken:function(e,t){d(e,t)},genProxyId:function(e,t,n){return I(e,t,n)},addProxyIds:function(e,t,n,o,r){var a,i,s,c,u,d;a=e,i=t,s=n,c=o,u=r,b.getProxyFieldName(a).then(function(e){return d=e,y.getCachedCurrentValueFromAppSoup("audId")}).then(function(o){$j.each(i,function(e,t){var n="PROXY%"+a+"%"+s+"%"+t._soupEntryId+"%"+o;t.Id=n,t[d]=n}),C.upsertSoupEntries(a,i,function(e){c(e)},u)}).catch(function(e){u(e)})},P2M_REFRESH_OK:T,p2mRefreshTable:function(e,t,n,o,r,a,i,s){!function a(i,s,c,n,t,o,u,d){var r,l,f,p,m=function(e,t){if(t.status){var n,o,r=new RegExp("\n","g");e=e.replace(r,"\\n"),r=new RegExp("\r","g"),e=e.replace(r,""),h(o=JSON.parse(e)).then(function(e){return n=e,b.setTableDefnColumnValue(i,"Last Refresh Date/Time",n.lastRefreshDatetime)}).then(function(){var e="P2M RE Records Processed";return"Connection_Session__mc"==i&&(e="P2M Conn_Sess Records Processed"),1==n.mc_add_status&&(e="P2M RE Abandoned"),p.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=e,p.connSessionRec.Id=n.cs,v.postProcessConnectionSession(p.connSessionRec)}).then(function(){return v.handleUpdatedCS(o.csM2P)}).then(function(){c&&l<R?v.maybeSyncConnSess(p.connSessionRec,function(){o["Session Number"]&&o["Session Number"]<o["Total Sessions"]?a(i,s,c,o["Session Number"]+1,o["Total Sessions"],o.CsPId,u,d):o.moreBatches?a(i,s,c,"newBatch",1,null,u,d):(_.status=T,u(_))},d):o["Session Number"]&&o["Session Number"]<o["Total Sessions"]?a(i,s,c,o["Session Number"]+1,o["Total Sessions"],o.CsPId,u,d):o.moreBatches?a(i,s,c,"newBatch",1,null,u,d):(_.status=T,u(_))}).catch(function(e){d(e)})}else"exception"===t.type&&g.error("p2mRefresh",i,t.message,t.where),v.cleanConnectionSessionVFEvent(t,p,function(e){_.status=E,_.mc_add_status=e.mc_add_status,u(_)},d)},_={},S="newBatch"==n;S&&(n=1);try{b.getTableDefnColumnValue(i,"Last Refresh Date/Time").then(function(e){(f=e)&&"null"!=f||(f=0);var t=new Date;return f<t-s||1<n||S||!c?y.getCachedCurrentValueFromAppSoup("audId"):(_.status=100402,_.status=100497,Promise.reject(_))}).then(function(e){return r=e,y.getCachedCurrentValueFromAppSoup("syncRefreshVersion")}).then(function(e){return w(l=e,"Sync - Refresh","P2M RE Process Called",n,t,o)}).then(function(e){if(p=e,!c){var t=JSON.parse(p.connSessJson);t.initialSync=!0,p.connSessJson=JSON.stringify(t)}if(S){var n=JSON.parse(p.connSessJson);n.firstBatch=!1,p.connSessJson=JSON.stringify(n)}return D(l,c)}).then(function(e){e&&(p.connSessJson=JSON.parse(p.connSessJson),p.connSessJson.csM2P=e,p.connSessJson=JSON.stringify(p.connSessJson)),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshTable001",contentType:"application/json",data:{audId:r,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:l,mobileTableName:i,deviceRefreshIds:[],lastRefreshDateTime:f,thirdPartyJson:"",connSessJson:p.connSessJson}},function(e,t){void 0===t&&((t={}).status="200"),m(e,t)},d):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".p2mRefreshTable",r,l,i,[],f,"",p.connSessJson,m,{buffer:!1,escape:!1,timeout:12e4})}).catch(function(e){100497==e.status?u(e):(g.error(e),d(e))})}catch(e){g.errorAndDispatch(e)}}(e,t,n,o,r,a,i,s)},buildConnectionSession:function(e,t,n,o,r,a){return w(0,t,n,o,r,a)},M2P_UPDATE_OK:O,M2P_NO_RECS_TO_SYNC:M,m2pUpdateMobileTable:function(e,t,n,o){a(e,t,n,o)},m2pRecoveryUpdateMobileTable:function(e){return n(e)},HEARTBEAT_OK:i,HEARTBEAT_EXCEPTION:A,HEARTBEAT_FAILURE:L,HEARTBEAT_NO_CONNECTION:o,HEARTBEAT_NOT_DEVICE:s,HEARTBEAT_REFRESHED_OK:c,heartBeat:function(e,t){!function(r,e){var a={},t=navigator.appVersion.includes("Electron");if(t||navigator&&navigator.connection&&"undefined"!=typeof Connection)if(t||navigator.connection.type!=Connection.NONE)if("undefined"==typeof Visualforce){g.log("Visualforce not currently defined");var i=window.location.pathname;$j.get(i).done(function(e){g.log("Startpage re-fetched",i);var o=new RegExp('"(\\S+VFRemote.js)"').exec(e);if(o[0]){var t=o[1];$j.getScript(t).done(function(){g.log("remote script fetched",t),new Function($j("script")[2].innerHTML)(),g.log("set up Visualforce ref"),u(r)}).fail(function(e,t,n){g.errorAndDispatch("vfRemote Load Error",o[0],n),a.status=L,r(a)})}else g.errorAndDispatch("heartBeat Could not find VFRemote src",i),a.status=L,r(a)}).fail(function(e,t,n){g.errorAndDispatch("Startpage Load Error",i,n),a.status=L,r(a)})}else u(r);else a.status=o,r(a);else localStorage.connection?a.status=localStorage.connection:a.status=s,r(a)}(e)},handleRefreshResponse:function(e){return h(e)},createUpdateJson:P}}),r("mobileCaddy/connSessUtils",function(V,t,n){var i="mc_failure_tab_";var b=100200,l=100201;function o(c,h,y){var n=V("mobileCaddy/syncRefresh"),o=V("mobileCaddy/appDataUtils"),r=V("mobileCaddy/connSessUtils"),u=V("mobileCaddy/smartStoreUtils"),d=V("mobileCaddy/logger");try{var i;o.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){return i=e,n.buildConnectionSession(i,"Status Check","M2P SC Status Check Requested",1,1,null)}).then(function(S){n.heartBeat(function(t){var a;t.status==n.HEARTBEAT_OK||t.status==n.HEARTBEAT_NOT_DEVICE||t.status==n.HEARTBEAT_REFRESHED_OK?o.getCachedCurrentValueFromAppSoup("audId").then(function(t){a=t;var n=function(t,n){var _,o,r,a,i,s;n.status?((_=JSON.parse(t)).cs_fc_jr&&(_.cs_fc_jr=JSON.parse(_.cs_fc_jr)),"Received Processed"==_.cs_fc_sc?function(n,o,t,r){var a=V("mobileCaddy/connSessUtils"),i=V("mobileCaddy/logger"),s=V("mobileCaddy/smartStoreUtils");try{f(o.cs_fc_jr,function(e){n.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",n.connSessionRec.SystemModstamp=(new Date).getTime(),n.connSessionRec.mobilecaddy1__Status__c="Closed",n.connSessionRec.Id=o.cs_sc_sf,s.queryMobileTable("Connection_Session__mc","Id",o.cs_fc_jr.cp).then(function(e){if(e[0]){var t=e[0];return t.Id=o.cs_fc_jr.csId,t.SystemModstamp=(new Date).getTime(),t.mobilecaddy1__Mobile_Process_Status__c="M2P Records Processed",a.postProcessConnectionSession([n.connSessionRec,t])}return Promise.resolve()}).then(function(){t({status:b})}).catch(function(e){r(e)})},r)}catch(e){i.errorAndDispatch("processM2PUpdateResponse",e),r("processM2PUpdateResponse-error")}}(S,_,h,y):(o=c,r=function(){u.queryMobileTable("Connection_Session__mc","mobilecaddy1__MC_Proxy_ID__c",c,function(t){if(0<t.length){var n=t[0];"Received Not Processed"==_.cs_fc_sc?(u=n,d=S,l=_,f=h,p=y,m=V("mobileCaddy/connSessUtils"),u.mobilecaddy1__Mobile_Process_Status__c="M2P UP Failed - RTS Cleared",u.mobilecaddy1__Session_Type__c="Sync Update",u.mobilecaddy1__Status__c="Closed",u.SystemModstamp=(new Date).getTime(),u.Id=l.cs_fc_sf,m.postProcessConnectionSession(u).then(function(){d.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",d.connSessionRec.SystemModstamp=(new Date).getTime(),d.connSessionRec.mobilecaddy1__Status__c="Closed",d.connSessionRec.Id=l.cs_sc_sf,m.postProcessConnectionSession(d.connSessionRec,function(){f({status:b})},p)}).catch(function(e){p(e)})):(o=n,r=S,a=_,i=h,s=y,c=V("mobileCaddy/connSessUtils"),V("mobileCaddy/smartStoreUtils").deleteRecordsFromSoup([o],"Connection_Session__mc",function(t){r.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",r.connSessionRec.SystemModstamp=(new Date).getTime(),r.connSessionRec.mobilecaddy1__Status__c="Closed",r.connSessionRec.Id=a.cs_sc_sf,r.connSessionRec.mobilecaddy1__Session_Type__c="Status Check",c.postProcessConnectionSession(r.connSessionRec).then(function(){i({status:b})}).catch(function(){s(e)})},s))}else h({status:b});var o,r,a,i,s,c,u,d,l,f,p,m},y)},a=y,i=V("mobileCaddy/smartStoreUtils"),s=cordova.require("com.salesforce.plugin.smartstore"),i.queryMobileTable("recsToSync","Current_Connection_Session",o,function(e){if(0!==e.length){for(var t=0;t<e.length;t++)e[t].Current_Connection_Session=null,"InsertUpdate"==e[t].CRUD_Operation?e[t].CRUD_Operation="Insert":"UpdateUpdate"==e[t].CRUD_Operation&&(e[t].CRUD_Operation="Update");s.upsertSoupEntries("recsToSync",e,r,a)}else r()},a))):(d.error("csStatusCheck",n.message),h({status:l}))},o=S.connSessJson,r=localStorage.getItem("lastErrorLog");r&&(localStorage.removeItem("lastErrorLog"),(o=JSON.parse(o)).lastErrorLog=r,o=JSON.stringify(o)),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pCSStatusCheck001",contentType:"application/json",data:{audId:a,syncRefreshDataVersion:i,statusCheckCSProxyId:c,connSessJson:o,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(e,t){void 0===t&&((t={}).status="200"),n(e,t)},function(e){d.error("err -> "+JSON.stringify(e)),y(e)}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pCSStatusCheck",a,i,c,o,n,{buffer:!1,escape:!1,timeout:3e4})}).catch(function(e){y(e)}):r.cleanConnectionSessionHeartBeat(t,S,function(e){h({status:b,mc_add_status:e.mc_add_status})},y)},y)}).catch(function(e){y(e)})}catch(e){d.errorAndDispatch(e)}}function f(f,e,p,m){m||(m=p,p=e,e="{}");var i,s,c,u,S=V("mobileCaddy/smartStoreUtils"),h=(cordova.require("com.salesforce.plugin.smartstore"),V("mobileCaddy/logger")),y=V("mobileCaddy/vsnUtils"),b=1,g=f.mt,C=void 0!==f.is?f.is:[],t=void 0!==f.id?f.id:[],v=void 0!==f.us?f.us:[],R=void 0!==f.ifmf?f.ifmf:[],T=void 0!==f.ufmf?f.ufmf:[],E=[],I=[],N=[],D=[],P=[],U=[],w=[],O=[],M=[],A=[],L=[];if(C=C.concat(t),j(g,f.af,C,v),void 0===f.if)A=[];else if(void 0===f.if.if)A=f.if;else{b=2;var n=f.if.if.map(function(e){return{pd:e,fbe:void 0!==f.ifbe?f.ifbe:"K"}}),o=f.if.ifv.map(function(e){return{pd:e,fbe:void 0!==f.ifvbe?f.ifvbe:"K"}}),r=f.if.icv.map(function(e){return{pd:e,fbe:void 0!==f.icvbe?f.icvbe:"K"}});A=n.concat(o.concat(r))}(i=e,s=C,c=A,u=R,new Promise(function(e,t){var n=V("mobileCaddy/smartStoreUtils");i=JSON.parse(i);var o=c.concat(u),r=c;if(i.records&&i.records.length>s.length+o.length){var a=[];n.getProxyFieldName(i.MobileTable).then(function(n){i.records.forEach(function(e){if("I"==e.RecordCRUD){var t=e.fields.find(function(e){return e.name==n}).value;_.findWhere(s,{pd:t})||_.findWhere(o,{pd:t})||a.push({pd:t,fbe:"K"})}}),0<a.length&&(r=c.concat(a)),e(r)})}else e(r)})).then(function(e){if(A=e,void 0===f.uf)L=[];else if(void 0===f.uf.uf)L=f.uf;else{b=2;var t=f.uf.uf.map(function(e){return{Id:e,fbe:void 0!==f.ufbe?f.ufbe:"K"}}),n=f.uf.usv.map(function(e){return{Id:e,fbe:void 0!==f.usvbe?f.usvbe:"K"}}),o=f.uf.sdf.map(function(e){return{Id:e,fbe:void 0!==f.sdfbe?f.sdfbe:"K"}}),r=f.uf.hdf.map(function(e){return{Id:e,fbe:void 0!==f.hdfbe?f.hdfbe:"K"}}),a=f.uf.ufv.map(function(e){return{Id:e,fbe:void 0!==f.ufvbe?f.ufvbe:"K"}}),i=f.uf.ucv.map(function(e){return{Id:e,fbe:void 0!==f.ucvbe?f.ucvbe:"K"}});L=t.concat(n.concat(o.concat(r.concat(a.concat(i)))))}return d("SnapShot_"+g)}).then(function(e){return M=e,d(g)}).then(function(l){S.queryMobileTable("recsToSync","Mobile_Table_Name",g,function(e){for(var t in e)if(e[t].Current_Connection_Session==f.cp){var n=!1,o={},r={};switch(e[t].CRUD_Operation){case"Insert":case"InsertUpdate":for(var a in C)if(e[t].Id==C[a].pd){if(C[a].crud=e[t].CRUD_Operation,r=F(C[a],l),"Insert"==e[t].CRUD_Operation){switch(f.stbe){case"D":w.push(r),O.push(C[a]);break;default:if("U"==C[a].pc){if(r.Id=C[a].Id,void 0!==C[a].an&&(void 0!==C[a].nf?r[C[a].nf]=C[a].an:r.Name=C[a].an),void 0!==C[a].lu)for(var i in C[a].lu)C[a].lu.hasOwnProperty(i),r[i]=C[a].lu[i];D.push(r),U.push(r)}}I.push(e[t]._soupEntryId)}else{if(r.Id=C[a].Id,void 0!==C[a].an&&(void 0!==C[a].nf?r[C[a].nf]=C[a].an:r.Name=C[a].an),void 0!==C[a].lu)for(var s in C[a].lu)C[a].lu.hasOwnProperty(s),r[s]=C[a].lu[s];D.push(r);var c=F(C[a],M);c.Id=C[a].Id,U.push(c),(o=e[t]).Current_Connection_Session=null,o.CRUD_Operation="Update",o.Id=C[a].Id,E.push(o)}n=!0;break}if(!n)for(a in A)if(e[t].Id==A[a].pd){if(A[a].crud=e[t].CRUD_Operation,"Insert"==e[t].CRUD_Operation)switch("K",1==b?x(0,A[a].fl,f):A[a].fbe){case"K":(o=e[t]).Current_Connection_Session=null,E.push(o);break;case"R":break;default:r=F(A[a],l),w.push(r),I.push(e[t]._soupEntryId),O.push(A[a])}else"InsertUpdate"==e[t].CRUD_Operation&&((o=e[t]).Current_Connection_Session=null,o.CRUD_Operation="Insert",E.push(o));n=!0;break}if(!n)for(a in R)if(e[t].Id==R[a].pd){if(R[a].crud=e[t].CRUD_Operation,"Insert"==e[t].CRUD_Operation)switch(R[a].fbe){case"K":(o=e[t]).Current_Connection_Session=null,E.push(o);break;case"R":break;default:r=F(R[a],l),w.push(r),I.push(e[t]._soupEntryId),O.push(R[a])}else"InsertUpdate"==e[t].CRUD_Operation&&((o=e[t]).Current_Connection_Session=null,o.CRUD_Operation="Insert",E.push(o));n=!0;break}break;case"Update":case"UpdateUpdate":for(a in v)if(e[t].Id==v[a].Id){if(v[a].crud=e[t].CRUD_Operation,"Update"==e[t].CRUD_Operation){switch(r=F(v[a],l),f.stbe){case"D":w.push(r),O.push(v[a]);break;default:if("M"==v[a].pc&&(r.SystemModstamp=new Date(v[a].sm)),void 0!==v[a].lu)for(var u in v[a].lu)v[a].lu.hasOwnProperty(u)&&(r[u]=v[a].lu[u]);N.push(r),P.push(r)}I.push(e[t]._soupEntryId)}else"UpdateUpdate"==e[t].CRUD_Operation&&((o=e[t]).Current_Connection_Session=null,o.CRUD_Operation="Update",E.push(o));n=!0;break}if(!n)for(a in L)if(e[t].Id==L[a].Id){if("Update"==e[t].CRUD_Operation)switch("K",1==b?x(1,L[a].fl,f):L[a].fbe){case"K":(o=e[t]).Current_Connection_Session=null,E.push(o);break;case"R":break;default:r=F(L[a],l),w.push(r),I.push(e[t]._soupEntryId),O.push(L[a])}else"UpdateUpdate"==e[t].CRUD_Operation&&((o=e[t]).Current_Connection_Session=null,o.CRUD_Operation="Update",E.push(o));n=!0;break}if(!n)for(a in T)if(e[t].Id==T[a].Id){if(T[a].crud=e[t].CRUD_Operation,"Update"==e[t].CRUD_Operation)switch(T[a].fbe){case"K":(o=e[t]).Current_Connection_Session=null,E.push(o);break;case"R":break;default:r=F(T[a],l),w.push(r),I.push(e[t]._soupEntryId),O.push(T[a])}else"UpdateUpdate"==e[t].CRUD_Operation&&((o=e[t]).Current_Connection_Session=null,o.CRUD_Operation="Update",E.push(o));n=!0;break}}}var d;S.getProxyFieldName(g).then(function(e){return d=e,k(g,"Id",N)}).then(function(e){return k(g,d,D)}).then(function(e){return k("SnapShot_"+g,"Id",P)}).then(function(e){return k("SnapShot_"+g,d,U)}).then(function(e){return q(g,w)}).then(function(e){return q("SnapShot_"+g,O)}).then(function(e){return o=E,r=cordova.require("com.salesforce.plugin.smartstore"),new Promise(function(t,n){0<o.length?r.upsertSoupEntries("recsToSync",o,function(e){t(e)},function(e){n(e)}):t("OK")});var o,r}).then(function(e){return o=I,r=cordova.require("com.salesforce.plugin.smartstore"),new Promise(function(t,n){0<o.length?r.removeFromSoup("recsToSync",o,function(e){t(e)},function(e){n(e)}):t("OK")});var o,r}).then(function(e){return y.checkForMigrateToInfo(f)}).then(function(){var e={status:0};e.csId=f.csId,p(e)}).catch(function(e){h.errorAndDispatch("m2pResp error for "+g,e),m(e)})},m)}).catch(function(e){h.errorAndDispatch("Err reading table",g),m(e)})}function F(e,t){var n={};return"Insert"==e.crud||"InsertUpdate"==e.crud?n.Id=e.pd:n.Id=e.Id,_.findWhere(t,n)}function x(e,t,n){switch(e){case 0:switch(t){case"DF":return n.ifbe;case"CV":return n.icvbe;case"FV":return n.ifvbe}break;case 1:switch(t){case"DF":return n.ufbe;case"SV":return n.usvbe;case"CV":return n.ucvbe;case"FV":return n.ufvbe;case"SD":return n.sdfbe;case"HD":return n.hdfbe}}}function d(e){var o=V("mobileCaddy/smartStoreUtils");return new Promise(function(t,n){o.querySoupRecords(e,function(e){t(e)},function(e){n(e)})})}function k(e,o,r){var a=cordova.require("com.salesforce.plugin.smartstore");return new Promise(function(t,n){0<r.length?a.upsertSoupEntriesWithExternalId(e,r,o,function(e){t(e)},function(e){n(e)}):t("OK")})}function q(e,r){var a=V("mobileCaddy/smartStoreUtils"),i=V("mobileCaddy/logger");return new Promise(function(t,n){if(0<r.length)if(-1==e.indexOf("SnapShot"))a.deleteRecordsFromSoup(r,e,function(e){t(e)},function(e){n(e)});else{var o=[];r.forEach(function(e){null!=e&&("Insert"==e.crud&&(e.Id=e.pd),o.push(e))}),a.deleteRecordsForExternalId(e,o,"Id",function(e){t(e)},function(e){i.errorAndDispatch(e),n(e)})}else t("OK")})}var u=100600;function p(e,t,n,o){V("mobileCaddy/smartStoreUtils");var r=V("mobileCaddy/syncRefresh"),a=cordova.require("com.salesforce.plugin.smartstore"),i=V("mobileCaddy/logger"),s={},c=null;e.status==r.HEARTBEAT_NO_CONNECTION?"Sync - Refresh"==t.connSessionRec.mobilecaddy1__Session_Type__c?c="P2M RE Heartbeat No Connection":"Status Check"==t.connSessionRec.mobilecaddy1__Session_Type__c&&(c="M2P SC Heartbeat No Connection"):e.status==r.HEARTBEAT_EXCEPTION?"Sync - Refresh"==t.connSessionRec.mobilecaddy1__Session_Type__c?c=e.bogus?"P2M RE Exception/Timeout":"P2M RE Heartbeat Exception/Timeout":"Status Check"==t.connSessionRec.mobilecaddy1__Session_Type__c&&(c=e.bogus?"M2P SC Exception/Timeout":"M2P SC Heartbeat Exception/Timeout"):e.status==r.HEARTBEAT_FAILURE&&("Sync - Refresh"==t.connSessionRec.mobilecaddy1__Session_Type__c?c=e.bogus?"P2M RE Failure":"P2M RE Hearbeat Failure":"Status Check"==t.connSessionRec.mobilecaddy1__Session_Type__c&&(c=e.bogus?"M2P SC Failure":"M2P SC Heartbeat Failure")),null!==c?(t.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=c,t.connSessionRec.SystemModstamp=(new Date).getTime(),t.connSessionRec.mobilecaddy1__Status__c="Closed",a.upsertSoupEntries("Connection_Session__mc",[t.connSessionRec],function(){s.status=u,s.mc_add_status=e.status,n(s)},o)):(i.error("Unknown heartBeatObject.status. ",e.status),o())}function r(e){return e?localStorage.getItem(i+e)?JSON.parse(localStorage.getItem(i+e)):{}:(t=a(),n=[],t.forEach(function(e){var t=r(e.replace(i,""));_.isEmpty(t)||n.push({table:e.replace(i,""),failures:t})}),n);var t,n}function a(){for(var e=[],t=0,n=localStorage.length;t<n;++t)localStorage.key(t).startsWith(i)&&e.push(localStorage.key(t));return e}function j(e,t,n,o){var r={};if(localStorage.getItem("mcM2pMoreToSync")){if(localStorage.getItem(i+e)){localStorage.getItem(i+e);r=JSON.parse(localStorage.getItem(i+e)),n.forEach(function(e){delete r[e.pd]}),o.forEach(function(e){delete r[e.Id]})}}else localStorage.removeItem(i+e),r={};if(t){var a={};t.forEach(function(e){a[e.Id]=e,r[e.Id]=e}),localStorage.setItem("tmpFailedRecordsAccum",JSON.stringify(a))}0<Object.keys(r).length?localStorage.setItem(i+e,JSON.stringify(r)):localStorage.removeItem(i+e)}n.exports={getRTSPendingconnSess:function(e,t){var s,c;s=e,c=t,V("mobileCaddy/smartStoreUtils").querySoupRecords("recsToSync",function(e){for(var t=null,n=null,o=0;o<e.length;o++)if(null!==e[o].Current_Connection_Session&&void 0!==e[o].Current_Connection_Session){t=e[o].Current_Connection_Session,n=e[o];break}if(null!=t){var r=(new Date).getTime(),a=n._soupLastModifiedDate+3e4;if(a<r)s(t);else{var i={status:100498};c(i)}}else s(t)},c)},CLEAN_CS_OK:u,cleanConnectionSessionHeartBeat:function(e,t,n,o){p(e,t,n,o)},cleanConnectionSessionVFEvent:function(e,t,n,o){var r,a,i,s,c,u;r=e,a=t,i=n,s=o,c=V("mobileCaddy/syncRefresh"),u={bogus:!0},"exception"===r.type?u.status=c.HEARTBEAT_EXCEPTION:u.status=c.HEARTBEAT_FAILURE,p(u,a,i,s)},CONN_SESS_OK:b,csStatusCheck:function(e,t,n){o(e,t,n)},maybeSyncConnSess:function(e,t,n){var o,r,a,i,s,c,u;o=e,r=t,a=n,i=mobileCaddy.require("mobileCaddy/devUtils"),s=V("mobileCaddy/smartStoreUtils"),c=V("mobileCaddy/logger"),u={},s.querySoupRecsPromise("recsToSync").then(function(e){var t=_.filter(e,function(e){return void 0!==e.currentConnectionSession});1<t.length||"M2P Conn_Sess Records Processed"!=o.mobilecaddy1__Mobile_Process_Status__c?i.syncMobileTable("Connection_Session__mc").then(function(e){u.status=0,r(u)}).catch(function(e){c.warn("syncMobileTable ERROR -> ",e),a(e)}):(u.status=0,r(u))}).catch(function(e){c.error("querySoupRecsPromise ERROR -> ",e),a(e)})},processM2PUpdateResponse:function(e,t,n,o){f(e,t,n,o)},postProcessConnectionSession:function(e){return c=e,new Promise(function(n,t){var o=cordova.require("com.salesforce.plugin.smartstore"),r=V("mobileCaddy/logger"),a=function(e){r.error("postProcessConnectionSession error",e),t(e)},i=Array.isArray(c)?c:[c],s={};o.upsertSoupEntries("Connection_Session__mc",i,function(e){var t=Array.isArray(c);t=i.map(function(e){return{Id:e.Id,SystemModstamp:e.SystemModstamp-1,mobilecaddy1__Session_Type__c:null,mobilecaddy1__Mobile_Process_Status__c:null,mobilecaddy1__Session_Created_Location_Error__c:null,mobilecaddy1__MC_Proxy_ID__c:null}}),o.upsertSoupEntries("SnapShot_Connection_Session__mc",t,function(e){var t=e.map(function(e){return{Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Update",SOUP_Record_Id:e._soupEntryId,Id:e.Id,LastModifiedDateTime:e.SystemModstamp}});o.upsertSoupEntries("recsToSync",t,function(){s.status=0,n(s)},a)},a)},a)});var c},handleUpdatedCS:function(e){return r=e,new Promise(function(t,e){var n=mobileCaddy.require("mobileCaddy/smartStoreUtils"),o=V("mobileCaddy/logger");r&&r.us&&0!==r.us.length?n.deleteRecordsForExternalId("Connection_Session__mc",r.us,"Id").then(function(e){return n.deleteRecordsForExternalId("SnapShot_Connection_Session__mc",r.us,"Id")}).then(function(e){return n.deleteRecordsForExternalId("recsToSync",r.us,"Id")}).then(function(e){t()}).catch(function(e){o.error("handleUpdatedCS",e),t()}):t(),r&&r.uf&&0!==r.uf.length&&o.error("handleUpdatedCS -> we have uf",r.uf)});var r},getSyncRecFailures:function(e){return r(e)},_getSyncFailureTableKeys:function(){return a()},_storeSyncFailures:function(e,t,n,o){return j(e,t,n,o)}}}),r("mobileCaddy/vsnUtils",function(t,e,n){var a=mobileCaddy.require("mobileCaddy/devUtils"),S=(cordova.require("com.salesforce.plugin.smartstore"),mobileCaddy.require("mobileCaddy/smartStoreUtils")),i=t("mobileCaddy/connSessUtils"),h=t("mobileCaddy/appDataUtils"),y=t("mobileCaddy/logger"),o=["recsToSync"];function r(e,t){return new Promise(function(n,t){null===e?S.listMobileTables(S.ALPHA,function(e){var t=o;_.each(e,function(e){t.push(e),t.push("SnapShot_"+e),localStorage.removeItem("meta-tableDEF-"+e),localStorage.removeItem("meta-tableCRUD-"+e)}),n(t)},function(e){t(e)}):n([])})}function s(n,e){return new Promise(function(e,t){r(n).then(function(e){return Promise.all(e.map(S.deleteSoup))}).then(function(){e()}).catch(function(e){y.error(e),t(e)})})}function c(m){return new Promise(function(u,d){var l={},f=m?"Version Upgrade":"HardReset",p="";t("mobileCaddy/syncRefresh");a.readRecords("appSoup").then(function(e){return e.records.forEach(function(e){l[e.Name]=e.CurrentValue}),s(null)}).then(function(){p=b(l);var e,t,n="",o="localhost:3030"==window.location.host?"codeflow":"undefined"!=typeof mockStore?navigator.appVersion.includes("Electron")?"desktop":"platform":"device";"codeflow"==o&&(e=localStorage.getItem("forceOAuth"),t=localStorage.getItem("appSoup"));var r="lsItemsToPersist";if(m&&localStorage.getItem(r)){var a=JSON.parse(localStorage.getItem(r)).map(function(e){return{key:e,value:localStorage.getItem(e)}});a.push({key:r,value:localStorage.getItem(r)}),localStorage.clear(),a.forEach(function(e){localStorage.setItem(e.key,e.value)})}else localStorage.clear();if("codeflow"==o)localStorage.setItem("forceOAuth",e),localStorage.setItem("appSoup",t),n=window.location.protocol+"//"+window.location.host+"/www",u("ok");else if("platform"==o)n=window.location.href.substr(0,window.location.href.indexOf("#"));else{var i,s="";if(navigator&&navigator.connection&&(s=navigator.connection.type),window.device&&(i=window.device),navigator.appVersion.includes("Electron")){i=ipcRenderer.sendSync("request-device-info",""),s="wifi";var c="landscape"}n=p+"?deviceUuid="+i.uuid+"&deviceName="+i.name+"&deviceCordova="+i.cordova+"&deviceVersion="+i.version+"&deviceModel="+i.model+"&buildName="+l.buildName+"&buildVersion="+l.buildVersion+"&buildOS="+l.buildOS+"&knownAud="+l.audId+"&currentDv="+l.dynVersionNumber+"&orientation="+c+"&viewportWidth="+$j(window).width()+"&viewportHeight="+$j(window).height()+"&sessionType="+f+"&connType="+s+"&loginUrl="+l.loginUrl+"&millsFromEpoch="+(new Date).getTime()}h.updateNewValueInAppSoup("buildStatus","Resetting").then(function(){S.deleteSoup("syncLib_system_data").then(function(e){try{window.location.href=n}catch(e){y.errorAndDispatch("error on redirect",e),d(e)}u()}).catch(function(e){y.errorAndDispatch(e)}),u()}).catch(function(e){y.errorAndDispatch(e),d(e)})}).catch(function(e){y.errorAndDispatch(e),d(e)})})}function b(e){var t="/apex/mobilecaddy1__MobileCaddyBootstrap001_mc";switch(e.platAuthUrl){case"i":case"I":resetURL=e.instanceUrl+t;break;case"l":case"L":resetURL=e.loginUrl+t;break;case"":resetURL=void 0;break;default:resetURL=e.platAuthUrl}return resetURL||(e.authURLType||(e.authURLType="login"),resetURL="login"==e.authURLType?e.loginUrl+t:e.instanceUrl+t),resetURL}function u(){return new Promise(function(t,n){mobileCaddy.require("mobileCaddy/smartStoreUtils").queryMobileTable("appSoup","Name","dynVersionNumber").then(function(e){void 0!==e[0].NewValue&&e[0].NewValue!=e[0].CurrentValue?t(!0):t(!1)}).catch(function(e){y.error(e),n(e)})})}n.exports={checkForMigrateToInfo:function(e){return n=e,o=t("mobileCaddy/appDataUtils"),new Promise(function(e,t){null!==n.migrateTo&&void 0!==n.migrateTo?o.updateNewValueInAppSoup("dynVersionNumber",n.migrateTo).then(function(){e()}).catch(function(e){y.error(e),t(e)}):e()});var n,o},clearSoups:function(e,t){return s(e)},getSoupsToClear:function(e,t){return r(e)},hardReset:function(){return c()},upgradeAvailable:function(){return u()},upgradeIfAvailable:function(e){return r=e,new Promise(function(n,o){u().then(function(e){if(e&&"force"==r)return c(!0);if(e){var t="skip-failures"==r?i.getSyncRecFailures():null;a.dirtyTables(t).then(function(e){0<e.length?n(!1):i.getRTSPendingconnSess(function(e){if(null==e)return c(!0);n(!1)},function(e){n(!1)})}).catch(function(e){y.error(e),o(e)})}else n(!1)}).catch(function(e){y.error(e),o(e)})});var r},_getBootstrapUrl:function(e){return b(e)}}}),r("mobileCaddy/logger",function(e,t,n){cordova.require("com.salesforce.plugin.smartstore");var a=e("mobileCaddy/smartStoreUtils"),i=e("mobileCaddy/appDataUtils"),c=0,u=1,d=2;function s(){return new Promise(function(t,n){localStorage.hasLogType?t(localStorage.hasLogType):a.listMobileTableColumns("Mobile_Log__mc",a.FULL,function(e){void 0===_.find(e,{path:"mobilecaddy1__Log_Type__c"})?(localStorage.setItem("hasLogType","false"),t("false")):(localStorage.setItem("hasLogType","true"),t("true"))},function(e){n(e)})})}function l(r,e){return new Promise(function(t,n){if(1==e.length&&(e=e[0]),"object"==typeof e&&(e=JSON.stringify(e)),"number"!=typeof e&&"boolean"!=typeof e||(e=e.toString()),"string"==typeof e){r==c&&localStorage.setItem("lastErrorLog",e.substring(0,1024));var o={mobilecaddy1__Error_Text__c:e.substring(0,1024),SystemModstamp:(new Date).getTime()};i.getCachedCurrentValueFromAppSoup("audId").then(function(e){return o.mobilecaddy1__Application_User_Device__c=e,s()}).then(function(e){"true"==e&&(o.mobilecaddy1__Log_Type__c="D"+r.toString()),a.insertRecords("Mobile_Log__mc",[o],function(e){t()},function(e){n(e)})}).catch(function(e){n(e)})}else logger.error("Trying to log unsupported type",typeof e),n("Trying to log unsupported type"+typeof e)})}function o(e,t,n,o){var r=localStorage.getItem("logLevel");if(t<=(r=void 0===r?0:r)){if(0<t){var a=o.stack.split("\n")[4];if(void 0!==a){var i=a.indexOf("at ");a.slice(i+2,a.length)}}var s=n[0];switch(t){case c:n[0]&&n[0].stack?s=n[0].message+", STACK:"+n[0].stack:n[1]&&n[1].stack?s+="\n"+n[1].message+", STACK:"+n[1].stack:s=n,l(t,s);break;case u:u<=r&&l(t,n);break;default:d<=r&&l(t,n)}e&&"undefined"!=typeof LOCAL_DEV&&LOCAL_DEV&&alert(s+"\n\nSee dev console for more information")}}function r(){try{throw Error("")}catch(e){return e}}n.exports={debug:function(e){return o(!1,4,arguments,r())},error:function(e){return o(!1,c,arguments)},errorAndDispatch:function(e){return o(!0,c,arguments)},info:function(e){return o(!1,3,arguments,r())},log:function(e){return o(!1,d,arguments,r())},warn:function(e){return o(!1,u,arguments,r())},hasLogType:function(){return s()}}}),r("mobileCaddy/devUtils",function(S,e,t){var f=S("mobileCaddy/smartStoreUtils"),h=(S("mobileCaddy/mobileLogger"),S("mobileCaddy/logger")),c=cordova.require("com.salesforce.plugin.smartstore"),i=1,l=2,p=3,m=4,y=5,b=6,g=8,s=99,C=100400,v=C,R=100402,T=100700,E=101e3,u=101100,d=101200,r=101300,I=["syncLib_system_data","appSoup","cacheSoup","recsToSync","SnapShot_Connection_Session__mc"],N=["autonumber","CreatedById","CreatedDate","IsDeleted","IsClosed","IsWon","LastModifiedById","LastModifiedDate","LastReferencedDate","mobilecaddy1__MC_Proxy_ID","MC_Proxy_ID","OwnerId","SystemModstamp","Id","dirtyFlag"];function n(i){var s="Analytics";return new Promise(function(r,t){var e=new Date,a=new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0,0).valueOf();new Promise(function(t,n){c.soupExists("Analytics",function(e){e?t():c.registerSoup("Analytics",[{path:"Name",type:"integer"},{path:"Data",type:"string"}],function(e){t()},function(e){n(e)})},function(e){h.error(e),n(e)})}).then(function(){return s=a,new Promise(function(t,a){var e=S("mobileCaddy/appDataUtils"),i="";e.getCurrentValueFromAppSoup("audId").then(function(e){return i=e,f.querySoupRecsPromise("Analytics")}).then(function(e){var n=[],o=[],r=[];e.forEach(function(e){if(e.Name==s)n.push(e);else{var t={Name:e.Name.toString(),SystemModstamp:e.Name,mobilecaddy1__Error_Text__c:JSON.parse(e.Data),mobilecaddy1__Application_User_Device__c:i};h.hasLogType()&&(t.mobilecaddy1__Log_Type__c="analytic"),o.push(t),r.push(e._soupEntryId)}}),0!==o.length&&f.insertRecords("Mobile_Log__mc",o,function(e){c.removeFromSoup("Analytics",r,function(e){t(n)},function(e){h.error("Unable to insert analytic recs",e),a(e)})},function(e){h.error("Unable to insert analytic recs",e),a(e)}),t(n)}).catch(function(e){h.error("Error housekeeping Analytics",e),a(e)})});var s}).then(function(e){var t={};if(0===e.length){t[i]=1;var n={Name:a,Data:JSON.stringify(t)};r(t[i]),c.upsertSoupEntries(s,[n],function(e){},function(e){h.error("Unable to insert analytic recs",e)})}else{var o=e[0];(t=JSON.parse(o.Data))[i]=void 0===t[i]?1:t[i]+1,r(t[i]),o.Data=JSON.stringify(t),c.upsertSoupEntriesWithExternalId(s,[o],"Name",function(e){},function(e){h.error(e)})}}).catch(function(e){h.error("Error in analInc",e),t(e)})})}function D(i,n,s){return new Promise(function(r,a){var t=function(e,t){var n=0;switch(e){case T:n=1;break;case E:n=4;break;case u:n=7;break;case d:n=10;break;default:n=0}if("Y"==t.charAt(n))r(s);else{var o={};o.status=e+p,o.mc_add_status=i,a(o)}};-1==I.indexOf(i)?localStorage["meta-tableCRUD-"+i]?t(n,localStorage["meta-tableCRUD-"+i]):f.getTableDefnColumnValue(i,"Application Record CRUD").then(function(e){localStorage["meta-tableCRUD-"+i]=e,t(n,e)}).catch(function(e){a(e)}):r(s)})}function o(){return new Promise(function(t,n){if(!0===USE_FORCETK){var e=force.getUserId();t(e)}else a("userId").then(function(e){t(e)}).catch(function(e){h.error("getCurrentUserId",e),n(e)})})}function a(e){return new Promise(function(t,n){S("mobileCaddy/appDataUtils").getCachedCurrentValueFromAppSoup(e).then(function(e){t(e)}).catch(function(e){h.error("getCachedAppSoupValue",e),n(e)})})}function P(t,n,e,o){if("_soupLastModifiedDate"==t)return o;var r=_.findWhere(e,{path:t}),a={};if(void 0===r)return a.status=n+l,a.mc_add_status=t,a;var i=0;switch(n){case T:i=1;break;case E:i=4;break;case u:i=7;break;default:i=0}if("Y"!=r.crud.charAt(i))return a.status=n+p,a;try{return a.value=O(o,r.appColType,r.platColType),a}catch(e){return a.status=n+y,a.mc_add_status=e+"->"+t,a}}function U(o){return new Promise(function(t,n){localStorage["meta-tableDEF-"+o]?t(JSON.parse(localStorage["meta-tableDEF-"+o])):f.listMobileTableColumns(o,f.FULL,function(e){localStorage["meta-tableDEF-"+o]=JSON.stringify(e),t(e)},function(e){n(e)})})}function w(e,t,n){switch(n){case"checkbox":case"Deleted":return"true"===String(e);case"CreatedDate":case"date":case"datetime":case"LastActivtyDate":case"LastModifiedDate":case"LastReferencedDate":case"LastViewedDate":case"SystemModstamp":return null!==e?new Date(e):e;default:return e}}function O(e,t,n){var o=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/;switch(n){case"autonumber":throw"invalid_autonumber";case"checkbox":case"Deleted":if("boolean"==typeof e||"true"===e||"false"===e)return String(e);throw"invalid_boolean";case"date":if("string"==typeof e){if(!o.test(e))throw"invalid_date";e=new Date(e)}if(e instanceof Date)return e.setUTCHours(0),e.setUTCMinutes(0),e.setUTCSeconds(0),e.setUTCMilliseconds(0),e.valueOf();if(null===e)return null;throw"invalid_date";case"datetime":if("string"==typeof e){if(!o.test(e))throw"invalid_datetime";e=new Date(e)}if(e instanceof Date)return e.valueOf();if(null===e)return null;throw"invalid_datetime";case"email":if(function(e){if(0===e.length)return!0;var t=e.indexOf("@"),n=e.lastIndexOf(".");return!(t<1||n<t+2||n+2>=e.length)}(e))return e;throw"invalid_email";default:switch(t){case"jsString":if("string"==typeof e)return e;if("number"==typeof e)return e.toString();throw"invalid_string";case"jsNumber":if("number"==typeof e||null===e)return e;throw"invalid_number";default:return e}}}function M(r,a){return new Promise(function(t,n){var o={};localStorage["meta-tableCRUD-"+r]?t():f.listMobileTables(f.ALPHA,function(e){0<=e.concat(I).indexOf(r)?t():(o.status=a+i,o.mc_add_status=r,n(o))},function(e){o.status=a+s,o.mc_add_status="Unkonwn error "+e,n(o)})})}function A(t,c,u,n,d){return new Promise(function(a,e){var i={},s={};i.status=u,L().then(function(e){return e[t]&&(s=e[t]),o()}).then(function(r){$j.each(n,function(e,o){if(delete o._soupEntryId,delete o.$$HashKey,o.RecordTypeName){if(o.RecordTypeId=s[o.RecordTypeName],_.isEmpty(s))return i.status=u+l,i.mc_add_status=o.RecordTypeName,a(i);if(!o.RecordTypeId)return i.status=u+g,i.mc_add_status=o.RecordTypeName,a(i);delete o.RecordTypeName}for(var t in o)if(o.hasOwnProperty(t)&&t!=c){if(isValidFieldRes=P(t,u,d,o[t]),isValidFieldRes.status==u+l){i.status=isValidFieldRes.status,i.mc_add_status=t;break}if(isValidFieldRes.status==u+y){i.status=isValidFieldRes.status,i.mc_add_status=t;break}if(isValidFieldRes.status==u+p){i.status=isValidFieldRes.status,i.mc_add_status=t;break}if(u==T&&0<=N.indexOf(t)){i.status=u+b,i.mc_add_status=t;break}o[t]=isValidFieldRes.value}if(i.status!=u+l&&i.status!=u+y&&i.status!=u+b){var n=(new Date).getTime();u==T&&(o.CreatedById=r,o.CreatedDate=n),o.SystemModstamp=n,o.LastModifiedDate=n,o.LastModifiedById=r,o.IsDeleted="false",$j.each(d,function(e,t){if(u==T){var n=t.crud.charAt(1);N.indexOf(t.path)<0&&"false"==t.nillable&&"Y"==n?_.has(o,t.path)||(i.status=u+m,i.mc_add_status=t.path):("IsClosed"==t.path&&(o.IsClosed="false"),"IsWon"==t.path&&(o.IsWon="false"))}""!==t.proxyRefField&&void 0!==o[t.path]&&18<o[t.path].length&&(o[t.proxyRefField]=o[t.path])})}}),i.records=n,a(i)},function(e){h.error("validateRecords",e)})})}function L(){return new Promise(function(t,n){localStorage.getItem("lsDotsRecordTypes")?t(JSON.parse(localStorage.getItem("lsDotsRecordTypes"))):f.querySoupRecords("dotsRecordTypes",function(e){var n={};e.forEach(function(e){var t={};JSON.parse(e.Data).forEach(function(e){e.recTypeDevName?(t[e.recTypeId]={recTypeName:e.recTypeName,recTypeDevName:e.recTypeDevName},t[e.recTypeName]=e.recTypeId,t[e.recTypeDevName]=e.recTypeId):(t[e.recTypeId]=e.recTypeName,t[e.recTypeName]=e.recTypeId)}),n[e.Table]=t}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(n)),t(n)},function(e){h.error("Error returned from upsert, message =  "+e),n(e)})})}function V(a){return new Promise(function(r,t){k("recsToSync").then(function(e){var t=[],n=[],o={};a&&a.forEach(function(e){o[e.table]=e.failures}),e.records.forEach(function(e){"Connection_Session__mc"==e.Mobile_Table_Name||void 0!==t[e.Mobile_Table_Name]||a&&o[e.Mobile_Table_Name]&&(!o[e.Mobile_Table_Name]||o[e.Mobile_Table_Name][e.Id])||(t[e.Mobile_Table_Name]=!0,n.push(e.Mobile_Table_Name))}),r(n)}).catch(function(e){h.error(e),t(e)})})}function F(r,a){return new Promise(function(o,t){0<r.length&&-1==I.indexOf(a)?L().then(function(e){if(e[a]){var t=e[a],n=r.map(function(e){return"object"==typeof t[e.RecordTypeId]?(e.RecordTypeName=t[e.RecordTypeId].recTypeName,e.RecordTypeDevName=t[e.RecordTypeId].recTypeDevName):e.RecordTypeName=t[e.RecordTypeId],e.RecordTypeName||h.warn("enrichWithRecordTypeNames",e.RecordTypeId),e});o(n)}else o(r)}).catch(function(e){t(e)}):o(r)})}function x(o,e){var r=JSON.parse(JSON.stringify(e)),a={};return new Promise(function(t,n){M(o,T).then(function(){return U(o)}).then(function(e){return D(o,T,e)}).then(function(e){return new Promise(function(t,n){A(o,null,T,r,e).then(function(e){e.status==T?t(e.records):n(e)})})}).then(function(e){f.insertRecords(o,e,function(e){a.status=T,a.records=e,mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable().then(function(e){a.upgradeAvailable=e,t(a)}).catch(function(e){t(a),h.error(e)})},function(e){n(e),h.error(e)})}).catch(function(e){n(e),h.error(e)})})}function k(a,e){var i={};return new Promise(function(o,r){M(a,E).then(function(){return D(a,E)}).then(function(){return U(a)}).then(function(n){f.querySoupRecords(a,function(t){(i.status=E,0<t.length)?-1==I.indexOf(a)?f.getTableDefnColumnValue(a,"Last Refresh Date/Time").then(function(e){return q(a,t,n,e,i)}).then(function(e){o(e)}).catch(function(e){r(e),h.error(e)}):q(a,t,n,null,i).then(function(e){o(e)}):(i.records=[],mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable().then(function(e){i.upgradeAvailable=e,o(i)}).catch(function(e){o(i),h.error(e)}))},function(e){r(e),h.error(e)})},function(e){r(e),h.error(e)})})}function q(n,o,r,a,i){return new Promise(function(t,e){$j.each(o,function(e,t){for(var n in t){var o=_.findWhere(r,{path:n});void 0!==o&&(t[n]=w(t[n],o.appColType,o.platColType),"LastModifiedDate"==n&&(t.dirtyFlag=B(t[n],a)))}}),i.records=o.filter(function(e){return"object"==typeof e}),F(i.records,n).then(function(e){return i.records=e,mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable()}).then(function(e){i.upgradeAvailable=e,t(i)}).catch(function(e){t(i),h.error(e)})})}function j(c,l){return new Promise(function(o,t){var r,a,u,d,n=cordova.require("com.salesforce.plugin.smartstore"),i={},e=/FROM\s+\{(\S*)\}/gi.exec(c),s=l||1e3;tableName=e[1],(u=tableName,d=c,new Promise(function(t,e){var n=!0,o=d.match(/SELECT\s+(.*)\s+FROM/i);"*"!==o[1]&&(n=!1);var r=d.match(/\s+FROM\s+{(.*)}\s+WHERE (.* = .*)/i);if(null!==r&&null!==r[1]){var a=d,i=r[2].split("AND"),s={},c="";i.forEach(function(e){mWhere=e.match(/{(.*):(.*)}\s+=\s+(.*)/i),whereField=mWhere[2],c=mWhere[3].split("'")[1],s[whereField]=c}),void 0!==s.Id&&18<s.Id.length?f.getProxyFieldName(u).then(function(e){a=a.replace("Id} =",e+"} ="),t([a,n])}):t([a,n])}else t([d,n])})).then(function(e){var t=e[0];return a=e[1],r=n.buildSmartQuerySpec(t,s),"MC-TIMING smartRead "+tableName,M(tableName,E)}).then(function(){return D(tableName,E)}).then(function(){return U(tableName)}).then(function(n){f.smartQuerySoupRecordsWithQuerySpec(r,function(t){(i.status=E,0<t.length)?-1==I.indexOf(tableName)&&a?f.getTableDefnColumnValue(tableName,"Last Refresh Date/Time").then(function(e){return J(tableName,t,n,e,i)}).then(function(e){o(e)}):J(tableName,t,n,null,i).then(function(e){o(e)}):(i.records=[],mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable().then(function(e){i.upgradeAvailable=e,o(i)}).catch(function(e){o(i),h.error(e)}))},function(){t()})},function(e){t(e),h.error(e)})})}function J(o,r,s,c,u){return new Promise(function(t,e){var a=[],i=!0;$j.each(r,function(e,t){var n;if(t[1]&&"object"==typeof t[1])for(var o in n=t[1]){var r=_.findWhere(s,{path:o});void 0!==r&&(n[o]=w(n[o],r.appColType,r.platColType),"LastModifiedDate"==o&&(t[1].dirtyFlag=B(t[1][o],c)))}else n=t,i=!1;a.push(n)}),u.records=a.filter(function(e){return"object"==typeof e});var n=mobileCaddy.require("mobileCaddy/vsnUtils");i?F(u.records,o).then(function(e){return u.records=e,n.upgradeAvailable()}).then(function(e){u.upgradeAvailable=e,t(u)}).catch(function(e){t(u),h.error(e)}):n.upgradeAvailable().then(function(e){u.upgradeAvailable=e,t(u)}).catch(function(e){t(u),h.error(e)})})}function B(e,t){return t&&"null"!=t||(t=0),e.valueOf()>t}function K(o){return new Promise(function(a,i){if(0===o.length)a({status:C+m});else{var t={},n=S("mobileCaddy/syncRefresh");n.heartBeat(function(e){if(e.status==n.HEARTBEAT_OK||e.status==n.HEARTBEAT_NOT_DEVICE||e.status==n.HEARTBEAT_REFRESHED_OK){var r=[];V().then(function(e){return e.forEach(function(e){dirtyIndex=o.indexOf(e),-1<dirtyIndex&&(r.push({table:e,status:R,mc_add_status:"Dirty records"}),o.splice(dirtyIndex,1))}),function a(i,s,c){return new Promise(function(n,o){s||(s=[]),c||(c=1);var r;(function(e){Promise.resolve();var n=[];return e.reduce(function(e,t){return e.then(function(e){return e&&e[e.length-1].status!=v?Promise.resolve():(i=t,new Promise(function(t,n){var o=S("mobileCaddy/syncRefresh"),r=function(e){t(e)},a={table:i};o.p2mRefreshTable(i,0,!1,1,1,null,function(e){e.status==o.P2M_REFRESH_OK?a.status=v:(a.status=e.status,a.mc_add_status=e.mc_add_status),r(a)},function(e){h.error("innerProcessRefreshTablePromise error",e),n(e)})}));var i}).then(function(e){return e&&n.push(e),n}).catch(function(e){h.errorAndDispatch(e)})},Promise.resolve())})(i).then(function(e){if(e.forEach(function(e,t){e&&(s.push(e),e.status!=v&&void 0===r&&(r=t))}),void 0!==r)if(c<3){var t=i.splice(r,i.length-r);a(t,s,c+1).then(function(e){n(e)}).catch(function(e){o(e)})}else o(s);else n(s)})})}(o)}).then(function(e){var t=r.concat(e).filter(function(e){return e});a(t);var n=S("mobileCaddy/connSessUtils"),o={mobilecaddy1__Mobile_Process_Status__c:""};H().then(function(e){n.maybeSyncConnSess(o,function(){},function(e){i(e),h.error(e)})})}).catch(function(e){if(Array.isArray(e)){var o=r.concat(e).filter(function(e){return e});h.error("InitialSync Failed"),W("Mobile_Log__mc").then(function(e){var t=S("mobileCaddy/connSessUtils"),n={mobilecaddy1__Mobile_Process_Status__c:""};H().then(function(e){t.maybeSyncConnSess(n,function(){W("Mobile_Log__mc"),i(o)},function(e){i(e),h.error(e)})})}).catch(function(e){h.error("Failed sending Mobile Logs"),i(e)}),i(o)}else i(e),h.error(e)})}else t.status=R,t.mc_add_status=e.status,a(t),100101==t.mc_add_status||100102==t.mc_add_status?h.error(t):h.log(t)},function(e){h.error(e),t.status=R,a(t)})}})}function H(){return new Promise(function(n,t){var e="SELECT * FROM {Connection_Session__mc} WHERE {Connection_Session__mc:mobilecaddy1__Mobile_Process_Status__c} = 'P2M RE Exception/Timeout'";querySpec=c.buildSmartQuerySpec(e,100),f.smartQuerySoupRecordsWithQuerySpec(querySpec,function(e){var t=e.map(function(e){return e[1].mobilecaddy1__Mobile_Process_Status__c="P2M InitialSync Faliure",e[1]});c.upsertSoupEntries("Connection_Session__mc",t,function(e){var t=e.map(function(e){return{Id:e.Id,SystemModstamp:e.SystemModstamp-1,mobilecaddy1__Session_Type__c:null,mobilecaddy1__Mobile_Process_Status__c:null,mobilecaddy1__Session_Created_Location_Error__c:null,mobilecaddy1__MC_Proxy_ID__c:null}});c.upsertSoupEntries("SnapShot_Connection_Session__mc",t,function(e){var t=e.map(function(e){return{Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Insert",SOUP_Record_Id:e._soupEntryId,Id:e.Id,LastModifiedDateTime:e.SystemModstamp}});c.upsertSoupEntries("recsToSync",t,function(){n()},function(e){h.error(e)})},function(e){h.error(e)})},function(e){h.error(e)}),n()},function(e){h.error(e),t(e)})})}function W(u,d,a,i,s){d=void 0===d||d;var l=S("mobileCaddy/connSessUtils"),f=S("mobileCaddy/syncRefresh"),p=S("mobileCaddy/smartStoreUtils");S("mobileCaddy/mobileLogger");a||(a=0),i||(i=50),s||(s=!1);var m=function(e,t,n){var o={};f.p2mRefreshTable(e,a,!0,1,1,null,function(e){e.status==f.P2M_REFRESH_OK?o.status=v:(o.status=e.status,o.mc_add_status=e.mc_add_status),t(o)},n)},c=function(t,n,o){var r={};p.queryMobileTable("recsToSync","Mobile_Table_Name",t,function(e){if(0<e.length)try{f.m2pUpdateMobileTable(t,i,function(e){e.status==f.M2P_UPDATE_OK&&void 0===e.mc_add_status?(a=0,r.status=0,n(r)):e.status==f.M2P_UPDATE_OK&&"more-to-sync"===e.mc_add_status?c(t,n,o):(r.status=e.status,r.mc_add_status=e.mc_add_status,n(r))},o)}catch(e){}else r.status=2,r.mc_add_status="no-sync-no-updates",n(r)},o)},_=function(t,e,n,o,r){var a={};localStorage.removeItem("mcM2pMoreToSync"),"Dynamic (Submit First/Retain)"==e||"Dynamic (Submit First/Clear)"==e?c(t,function(e){!s&&(0===e.status||n&&2==e.status)?m(t,o,r):(s&&0===e.status||2==e.status?a.status=v:a.status=R,a.mc_add_status=e.mc_add_status,o(a))},r):"Submit Only"==e||"Submit & Clear"==e||"Submit & Destroy"==e?c(t,function(e){0===e.status?a.status=v:(a.status=R,a.mc_add_status=e.mc_add_status),o(a)},r):h.errorAndDispatch("Unknown sync type",e,s)};return new Promise(function(o,r){var a={},i=function(e){localStorage.removeItem("syncInProgressTime"),o(e)},s=function(e){localStorage.removeItem("syncInProgressTime"),r(e)},e="syncTime"+u,t=localStorage.getItem(e),n=(new Date).valueOf(),c=t?parseInt(t)+5e3:0;"Connection_Session__mc"!=u&&n<c?(a.status=v,a.mc_add_status="sync-too-soon",o(a)):(localStorage.setItem(e,n),localStorage.removeItem("tmpFailedRecordsAccum"),M(u,C).then(function(){f.heartBeat(function(e){if(e.status==f.HEARTBEAT_OK||e.status==f.HEARTBEAT_NOT_DEVICE||e.status==f.HEARTBEAT_REFRESHED_OK){var t=localStorage.getItem("syncInProgressTime"),n=(new Date).valueOf();"Connection_Session__mc"!=u&&t&&n-12e4<t?(a.status=100498,s(a)):(localStorage.setItem("syncInProgressTime",n),p.getTableDefnColumnValue(u,"Sync Type").then(function(t){l.getRTSPendingconnSess(function(e){"Mobile_Log__mc"!=u?null!=e?l.csStatusCheck(e,function(e){e.status==l.CONN_SESS_OK?"Refresh Only"==t||"Refresh & Clear"==t?m(u,i,s):_(u,t,d,i,s):(a.status=v,a.mc_add_status=e.status,o(a))},function(e){h.errorAndDispatch(e),r(e)}):"Refresh Only"==t||"Refresh & Clear"==t?m(u,i,s):_(u,t,d,i,s):_(u,t,!1,i,s)},s)}).catch(function(e){s(e)}))}else a.status=R,a.mc_add_status=e.status,o(a),100101==a.mc_add_status||100102==a.mc_add_status?h.error(a):h.log(a)},s)}).catch(s))})}function Q(r,e,a){var i=JSON.parse(JSON.stringify(e)),o={};return new Promise(function(t,n){0<i.length?M(r,u).then(function(){return U(r)}).then(function(e){return D(r,u,e)}).then(function(o){return new Promise(function(t,n){var e=P(a,u,o);e.status!=u+l?A(r,a,u,i,o).then(function(e){e.status==u?t(e.records):n(e)}):n(e)})}).then(function(e){f.updateRecordsWithExternalId(r,e,a,function(e){o.status=u,o.records=e,mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable().then(function(e){o.upgradeAvailable=e,t(o)}).catch(function(e){t(o)})},function(e){n(e),h.error(e)})},function(e){n(e),h.error(e)}):(o.status=u,o.mc_add_status="No records supplied",o.records=[],t(o),h.warn(o))})}t.exports={SYNC_OK:v,SYNC_NOK:R,SYNC_ALREADY_IN_PROGRESS:C+98,SYNC_UNKONWN_TABLE:C+i,SYNC_MANDATORY_MISSING:C+m,DELETE_RECS_OK:d,DELETE_RECS_UNKONWN_TABLE:d+i,DELETE_RECS_UNKONWN_FIELD:d+l,DELETE_RECS_ACCESS_DENIED:d+p,DELETE_RECS_MANDATORY_MISSING:d+m,INSERT_RECS_OK:T,INSERT_RECS_UNKONWN_TABLE:T+i,INSERT_RECS_UNKONWN_FIELD:T+l,INSERT_RECS_ACCESS_DENIED:T+p,INSERT_RECS_MANDATORY_MISSING:T+m,INSERT_RECS_DATATYPE_MISMATCH:T+y,INSERT_RECS_PROTECTED_FIELD:T+b,INSERT_RECS_UNKNOWN_RECORD_TYPE:T+g,READ_RECS_OK:E,READ_RECS_UNKONWN_TABLE:E+i,READ_RECS_ACCESS_DENIED:E+p,UPDATE_RECS_OK:u,UPDATE_RECS_UNKONWN_TABLE:u+i,UPDATE_RECS_UNKONWN_FIELD:u+l,UPDATE_RECS_ACCESS_DENIED:u+p,UPDATE_RECS_DATATYPE_MISMATCH:u+y,UPDATE_RECS_UNKNOWN_ID:u+7,UPDATE_RECS_UNKNOWN_RECORD_TYPE:u+g,GET_REC_TYPES_UNKONWN_TABLE:r+i,analInc:function(e){return n(e)},deleteRecord:function(e,t,n){return r=e,a=[t],i=n,c={},new Promise(function(n,o){0<a.length?M(r,d).then(function(){return U(r)}).then(function(e){return D(r,d,e)}).then(function(o){return new Promise(function(t,n){var e=P(i,d,o);e.status!=d+l?A(r,i,d,a,o).then(function(e){e.status==d?t(e.records):(n(e),h.error(e))}):(n(e),h.error(e))})}).then(function(e){return f.queryMobileTable(r,i,a[0][i])}).then(function(e){if(0===e.length)c.status=d+m,h.warn("deleteRecord no record found",r),c.mc_add_status="no record found",o(c);else{if(!(e[0].Id.length<19))return s=e,f.querySoupRecsPromise("recsToSync");c.status=d+p,h.warn("deleteRecord Cannot delete synced records"),c.mc_add_status="Cannot delete synced records",o(c)}}).then(function(e){var t=e.reduce(function(e,t){return t.Mobile_Table_Name==r&&_.findWhere(s,{_soupEntryId:t.SOUP_Record_Id})&&e.push({_soupEntryId:t._soupEntryId}),e},[]);f.deleteRecordsFromSoup(s,r,function(){f.deleteRecordsFromSoup(t,"recsToSync",function(){c.status=d,c.records=s,n(c)},function(e){o(e)})},function(e){o(e)})}).catch(function(e){o(e)}):(c.status=d,h.warn("deleteRecord No records supplied"),c.mc_add_status="No records supplied",c.records=[],n(c))});var r,a,i,s,c},dirtyTables:function(e){return V(e)},syncMobileTable:function(e,t,n,o,r){return W(e,t,n,o,r)},initialSync:function(e){return K(e)},getCurrentUserId:function(){return o()},getCurrentUserName:function(){return o="",new Promise(function(t,n){a("userFirstName").then(function(e){return o=e,a("userLastName")}).then(function(e){t(o+" "+e)}).catch(function(e){h.error("getCurrentUserName",e),n(e)})});var o},getUserLocale:function(){return a("userLocale")},getCachedAppSoupValue:function(e){return a(e)},getRecordTypes:function(e){return o=e,new Promise(function(t,n){M(o,r).then(function(){return L()}).then(function(e){t(e[o])}).catch(function(e){n(e)})});var o},insertRecord:function(e,t){return x(e,[t])},insertRecords:function(e,t){return x(e,t)},logout:function(){return localStorage.clear(),void(navigator.appVersion.includes("Electron")?ipcRenderer.sendSync("logout",""):cordova.require("com.salesforce.plugin.sfaccountmanager").logout())},readRecords:function(e,t){return k(e)},smartSql:function(e,t){return j(e,t)},updateRecord:function(e,t,n){return Q(e,[t],n)},updateRecords:function(e,t,n){return Q(e,t,n)},maybeReadTransformType:function(e,t,n){return w(e,0,n)},maybeWriteTransformType:function(e,t,n){return O(e,t,n)}}}),window.mobileCaddy=o("mobileCaddy")}();