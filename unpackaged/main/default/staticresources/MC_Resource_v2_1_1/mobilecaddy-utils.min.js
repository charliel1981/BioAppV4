/* mobilecaddy-utils - v2.1.1 - Bundle Time: 2019-12-03 14:08:15 */
/* git info: "2019-11-28 14:17:31 +0000": ca6d66734f6e1487122b7b760d91962b15eeffcc (v2) */
/* Copyright 2019 MobileCaddy Ltd */

String.prototype.includes||(String.prototype.includes=function(e,n){"use strict";return"number"!=typeof n&&(n=0),!(n+e.length>this.length)&&-1!==this.indexOf(e,n)}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var n=Object(this),t=n.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var o=arguments[1],r=0;r<t;){var i=n[r];if(e.call(o,i,r,n))return i;r++}},configurable:!0,writable:!0});var $j=jQuery.noConflict(),MC_TABLES=["Connection_Session__mc","Mobile_Log__mc","MC_Project__ap","MC_Time_Expense__ap","MC_Project_Location__ap"],_typeof=function(e){return typeof e};!function(){var e,n;!function(){var t={},o=[],r={};e=function(n){if(t[n]){if(n in r)o.slice(r[n]).join("->")}else;if(t[n].factory)try{return r[n]=o.length,o.push(n),i=t[n],a=i.factory,i.exports={},delete i.factory,a(e,i.exports,i),i.exports}finally{delete r[n],o.pop()}var i,a;return t[n].exports},(n=function(e,n){t[e],t[e]={id:e,factory:n}}).remove=function(e){delete t[e]}}(),"object"==typeof module&&"function"==typeof e&&(module.exports.require=e,module.exports.define=n),n("mobileCaddy",function(e,t,o){var r={define:n,require:e,START_PAGE_CONTROLLER:"",QUERY_BUFFER_SIZE:1e3,QUERY_BUFFER_SIZE_SL:1e3,INITIAL_APPCACHE_INFO:[]};o.exports=r}),n("mobileCaddy/mobileLogger",function(e,n,t){function o(){try{throw Error("")}catch(e){return e}}function r(e,n){var t=n.stack.split("\n")[4];if(void 0!==t){var o=t.indexOf("at ");t.slice(o+2,t.length)}}t.exports={logMessageAndThrow:function(e){!function(e,n){throw r(0,n),e}(e,o())},logMessage:function(e){r(0,o())},logObjectDetails:function(e){!function(e,n){for(var t in e)r(e[t],n)}(e,o())}}}),n("mobileCaddy/geoLocation",function(e,n,t){t.exports={getLocation:function(e,n){!function(e,n){var t=[];t.Error="Location information is unavailable.",t.ErrorNumber=2,e(t)}(e)}}}),n("mobileCaddy/startup",function(e,n,t){e("mobileCaddy/mobileLogger");var o=e("mobileCaddy/logger"),r=cordova.require("com.salesforce.plugin.smartstore"),i=e("mobileCaddy/systemData"),a=e("mobileCaddy/smartStoreUtils"),c=e("mobileCaddy/appDataUtils"),s=(e("mobileCaddy/geoLocation"),e("mobileCaddy/syncRefresh")),u=!!window.LOCAL_DEV,l=!!window.USE_FORCETK,d=[],f=["Initialising"];window.addEventListener("error",function(e){var n=e.error?e.error.stack:null;e.error&&e.error.toString()});var p=100900,m=100901;function S(e){f.unshift("Checking Cache"),d=[];var n=localStorage.getItem("tmpCacheItems");if(n){var t=JSON.parse(n);if(t.length>0&&("preBootstrap-noupdate"==t[t.length-1].Description||"preBootstrap-checking"==t[t.length-1].Description))return d=[],void e({status:p});if(d=t,t.length>0&&"preBootstrap-cached"==t[t.length-1].Description)return void e({status:p})}else d.push({Name:"AppCache: Initial Status",Description:window.applicationCache.status});window.applicationCache.addEventListener("checking",function(e){h(e)},!1),window.applicationCache.addEventListener("downloading",function(e){h(e)},!1),window.applicationCache.addEventListener("progress",function(e){h(e)},!1);var o={};switch(o.status=p,window.applicationCache.status){case window.applicationCache.CHECKING:case window.applicationCache.DOWNLOADING:return window.applicationCache.addEventListener("updateready",function(n){h(n,e)},!1),window.applicationCache.addEventListener("cached",function(n){h(n,e)},!1),window.applicationCache.addEventListener("error",function(n){h(n,e)},!1),void window.applicationCache.addEventListener("noupdate",function(n){h(n,e)},!1);case window.applicationCache.UPDATEREADY:default:e(o)}}function h(e,n){"progress"==e.type?d.push({Name:"Event ",Description:e.loaded+" of "+e.total}):d.push({Name:"Event ",Description:e.type});var t={};"udpateready"==e.type||"cached"==e.type?t.status=p:t.status=m,n&&"function"==typeof n&&n(t)}function y(e,n){f.unshift("Preparing platform");var t=C("appSoupJson");if(""!==t){var i=JSON.parse(t);r.registerSoup("appSoup",[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}],function(){r.upsertSoupEntries("appSoup",i,function(t){r.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){b(e,n)},function(e){})},function(e){})},function(e){})}else void 0!==u&&u?new Promise(function(e,n){new Promise(function(e,n){if(l){var t=window.SF_LOGIN_URL?window.SF_LOGIN_URL:"https://login.salesforce.com";force.isLoggedIn()?e():(force.init({appId:"3MVG9Rd3qC6oMalWEuQby1hkUef0N2L7kTPExDjRAs1GH35ueKyc3q_D5NY0LLoLHnfwIr_Y8PyeRotaClrtZ",apiVersion:"v30.0",loginUrl:t,tokenStore:localStorage,oauthRedirectURL:"http://localhost:3030/oauthcallback.html",proxyURL:"http://localhost:3000"}),force.isLoggedIn()?e():force.login(function(){e()},function(e){alert("Salesforce login failed"),n(e)}))}else e()}).then(function(e){return new Promise(function(e,n){var t=!localStorage.getItem("initialSyncState");if(l&&t){var o=window.DEVICE_APP_NAME?window.DEVICE_APP_NAME:"BIZ001";force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/codeflowUtils001",contentType:"application/json",data:{buildVersion:"001",buildName:o,buildOS:"Android",deviceUuid:"c86d3e94574debug",overrideUserId:"",startPageControllerVersion:"001"}},function(n){e()},function(e){alert("Salesforce codeflowUtils001 failed"),n(e)})}else e()})}).then(function(t){f.unshift("Creating CodeFlow records"),r.soupExists("appSoup",function(t){t?r.soupExists("cacheSoup",function(t){t?e():r.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){e()},function(e){n(e)})},function(e){n(e)}):r.registerSoup("appSoup",[{path:"Name",type:"string"},{path:"teststring",type:"string"},{path:"testinteger",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"},{path:"testno",type:"integer"}],function(){var t=window.DEVICE_APP_NAME?window.DEVICE_APP_NAME:"BIZ001",o=[{Name:"applicationName",CurrentValue:"MAP-0012001",NewValue:"MAP-0012001",_soupEntryId:1},{Name:"userId",CurrentValue:"",NewValue:"",_soupEntryId:2},{Name:"buildStatus",CurrentValue:"Initial",NewValue:"Initial",_soupEntryId:3},{Name:"buildVersion",CurrentValue:"001",NewValue:"001",_soupEntryId:4},{Name:"buildName",CurrentValue:t,NewValue:t,_soupEntryId:5},{Name:"buildOS",CurrentValue:"Android",NewValue:"Android",_soupEntryId:6},{Name:"deviceUuid",CurrentValue:"c86d3e94574debug",NewValue:"c86d3e94574debug",_soupEntryId:7}];localStorage.setItem("appSoup",JSON.stringify(o)),r.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){e()},function(e){n(e)})},function(e){n(e)})})}).catch(function(e){o.error(e),n(e)})}).then(function(t){b(e,n)}).catch(function(e){throw o.error(e),e}):navigator.appVersion.includes("Electron")?r.soupExists("appSoup",function(t){if(t)b(e,n);else{var o=[],i=ipcRenderer.sendSync("request-creds","");C("access_token","?"+i);if(o.push({Name:"accessToken",CurrentValue:C("access_token","?"+i),NewValue:null}),o.push({Name:"refreshToken",CurrentValue:C("refresh_token","?"+i),NewValue:null}),o.push({Name:"clientId",CurrentValue:C("client_id","?"+i),NewValue:null}),o.push({Name:"orgId",CurrentValue:C("org_id","?"+i),NewValue:null}),o.push({Name:"applicationName",CurrentValue:C("buildName","?"+i),NewValue:null}),o.push({Name:"buildName",CurrentValue:C("buildName","?"+i),NewValue:null}),window.location.pathname.startsWith("/apex/"))o.push({Name:"loginUrl",CurrentValue:window.location.protocol+"//"+window.location.host,NewValue:null});else{var a=window.location.pathname.split("/")[1];o.push({Name:"loginUrl",CurrentValue:window.location.protocol+"//"+window.location.host+"/"+a,NewValue:null})}var c=ipcRenderer.sendSync("request-device-info","");o.push({Name:"buildStatus",CurrentValue:"Initial"}),o.push({Name:"buildVersion",CurrentValue:c.buildVersion}),o.push({Name:"buildOS",CurrentValue:c.platform}),o.push({Name:"deviceUuid",CurrentValue:c.uuid});r.registerSoup("appSoup",[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}],function(){r.upsertSoupEntries("appSoup",o,function(t){r.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){b(e,n)},function(e){})},function(e){})},function(e){})}}):b(e,n)}var g=100800,v=100801;function b(e,n){r.upsertSoupEntries("cacheSoup",d,function(){a.querySoupRecsPromise("appSoup").then(function(t){var o={},u=[];if(t.forEach(function(e){if(void 0!==o[e.Name])throw"Should only be 1 "+e.Name+" entry in the app soup.  Found more";o[e.Name]=e}),o.userOverrideId||(o.userOverrideId=""),"Complete"==o.buildStatus.CurrentValue&&"Complete"==o.buildStatus.NewValue)if(null!==e){var d={};if(d.status=v,d.mc_add_status=n.status,d.curVsn=o.dynVersionNumber.CurrentValue,void 0!==o.dynVersionNumber.NewValue&&(d.newVsn=o.dynVersionNumber.NewValue),navigator.appVersion.includes("Electron")){var p=window.location.protocol+"//"+window.location.host+window.location.pathname;ipcRenderer.send("startPageUrl",p)}"undefined"!=typeof plugin&&plugin.mcsdk&&ionic.version.startsWith("1")&&plugin.mcsdk.getSplashScreenTimeout(function(e){setTimeout(function(){plugin.mcsdk.hideSplashScreen()},e.result)}),e(d)}else"undefined"!=typeof plugin&&plugin.mcsdk&&plugin.mcsdk.hideSplashScreen();else{f.unshift("Preparing database");var m=function(t,s){if(s.status){u=JSON.parse(t);var l=_.find(u,{Name:"audId"}).CurrentValue,d=_.find(u,{Name:"sysDataPlatSupVersion"}).CurrentValue;if(navigator.appVersion.includes("Electron")){var p=window.location.protocol+"//"+window.location.host+window.location.pathname;ipcRenderer.send("startPageUrl",p)}var m=_.find(u,{Name:"dynVersionNumber"}).CurrentValue;o.dynVersionNumber?o.dynVersionNumber.CurrentValue=m:o.dynVersionNumber={CurrentValue:m},c.getPlatformAppConfig(o).then(function(){return new Promise(function(e,n){r.registerSoup("recsToSync",[{path:"Mobile_Table_Name",type:"string"},{path:"SOUP_Record_Id",type:"string"},{path:"Id",type:"string"},{path:"LastModifiedDateTime",type:"integer"},{path:"CRUD_Operation",type:"string"},{path:"Current_Connection_Session",type:"string"}],function(){e()},function(e){n(e)})})}).then(function(){return new Promise(function(e,n){r.registerSoup("File_Library__ap",[{path:"Id",type:"string"},{path:"SF_Content_Version_Id__c",type:"string"},{path:"File_Type__c",type:"string"},{path:"Synchronised__c",type:"integer"}],function(){e()},function(e){n(e)})})}).then(function(){i.createSystemDataSoup(function(){f.unshift("Building tables"),a.buildMobileTables(function(){var t=o.buildStatus;t.CurrentValue="Complete",t.NewValue="Complete",u.map(function(e){return o[e.Name]&&(e._soupEntryId=o[e.Name]._soupEntryId),e}),u.push(t),f.unshift("Finalising build"),r.upsertSoupEntries("appSoup",u,function(){i.getRecordTypeDots(l,d).then(function(){if(null!==e){var t={};t.status=g,t.mc_add_status=n.status,"undefined"!=typeof plugin&&plugin.mcsdk&&ionic.version.startsWith("1")&&plugin.mcsdk.getSplashScreenTimeout(function(e){setTimeout(function(){plugin.mcsdk.hideSplashScreen()},e.result)}),e(t)}else"undefined"!=typeof plugin&&plugin.mcsdk&&plugin.mcsdk.hideSplashScreen()}).catch(function(e){})},function(e){})},function(e){})},function(e){},l,d)}).catch(function(e){})}else"exception"===s.type&&alert(s.message)};s.heartBeat(function(e){!0===l?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getAUDInfo001",contentType:"application/json",data:{buildVersion:o.buildVersion.CurrentValue,buildName:o.buildName.CurrentValue,buildOS:o.buildOS.CurrentValue,deviceUuid:o.deviceUuid.CurrentValue,overrideUserId:force.getUserId(),startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(e){var n={status:"200"};m(e,n)},function(e){}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".getAudInfo",o.buildVersion.CurrentValue,o.buildName.CurrentValue,o.buildOS.CurrentValue,o.deviceUuid.CurrentValue,o.userOverrideId,m,{escape:!1,timeout:3e4})},function(e){alert("Failed to refresh authentication. Please uninstall/re-install the application")})}}).catch(function(e){})},function(e){})}function C(e,n){n||(n=window.location.search),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(n);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))}t.exports={startup:function(e){!function(e){if("undefined"!=typeof plugin&&plugin.mcsdk&&!ionic.version.startsWith("1")&&plugin.mcsdk.hideSplashScreen(),!e)return new Promise(function(e,n){S(function(n){y(function(n){e(n)},n)})});S(function(n){y(e,n)})}(e)}}}),n("mobileCaddy/systemData",function(e,n,t){var o=e("mobileCaddy"),r=e("mobileCaddy/logger"),i=cordova.require("com.salesforce.plugin.smartstore"),a=e("mobileCaddy/appDataUtils"),c=!!window.USE_FORCETK;function s(e,n,t,a){!function(e,n,t,a){var s=function(s,u){if(u.status){var l=JSON.parse(s);l.forEach(function(e){}),i.registerSoup("syncLib_system_data",l,function(){!function(e,n,t,a){var s=function(e,n){if(n.status){var o=JSON.parse(e);i.upsertSoupEntries("syncLib_system_data",o,t,a)}else"exception"===n.type?(alert(n.message),r.error("Exception return from getSystemDataRowValues = "+n.message)):r.error("Unknown return from getSystemDataRowValues = "+n.message)};!0===c?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getSysDataSoupVariables001",contentType:"application/json",data:{audId:e,startPageControllerVersion:o.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:n}},function(e){var n={status:"200"};s(e,n)},a):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+o.START_PAGE_CONTROLLER+".getSysDataSoupVariables",e,n,s,{escape:!1})}(e,n,function(){!function(e,n,t,a){var s=function(e,n){if(n.status){var o=JSON.parse(e);i.upsertSoupEntries("syncLib_system_data",o,function(e){t(e)},function(e){r.error("Error returned from upsert, message =  "+e),a(e)})}else"exception"===n.type?(alert(n.message),r.error("Exception return from getDefsForSObjectMobileTables = "+n.message)):r.error("Unknown return from getDefsForSObjectMobileTables = "+n.message)};!0===c?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getDefsForSObjectMobileTables001",contentType:"application/json",data:{audId:e,startPageControllerVersion:o.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:n}},function(e){var n={status:"200"};s(e,n)},a):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+o.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables",e,n,s,{escape:!1,timeout:12e4})}(e,n,t,a)},a)},a)}else"exception"===u.type?(alert(u.message),r.error("Exception return from getSystemDataSoupDefinition = "+u.message)):r.error("Unknown return from getSystemDataSoupDefinition = "+u.message)};!0===c?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getSystemDataSoupDefinition001",contentType:"application/json",data:{audId:e,startPageControllerVersion:o.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:n}},function(e){var n={status:"200"};s(e,n)},a):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+o.START_PAGE_CONTROLLER+".getSystemDataSoupDefinition",e,n,s,{escape:!1})}(t,a,e,n)}t.exports={createSystemDataSoup:function(e,n,t,o){s(e,n,t,o)},getRecordTypeDots:function(e){return new Promise(function(n,t){var s,u=function(e,o){o.status?i.registerSoup("dotsRecordTypes",[{path:"Table",type:"string"},{path:"Data",type:"string"}],function(o){var a=JSON.parse(e).map(function(e){return{Table:e.mobileTableName,Data:JSON.stringify(e.recTypeInfoList)}});i.upsertSoupEntries("dotsRecordTypes",a,function(t){var o={};JSON.parse(e).forEach(function(e){var n={};e.recTypeInfoList.forEach(function(e){e.recTypeDevName?(n[e.recTypeId]={recTypeName:e.recTypeName,recTypeDevName:e.recTypeDevName},n[e.recTypeName]=e.recTypeId,n[e.recTypeDevName]=e.recTypeId):(n[e.recTypeId]=e.recTypeName,n[e.recTypeName]=e.recTypeId)}),o[e.mobileTableName]=n}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(o)),n()},function(e){r.error("Error returned from upsert, message =  "+e),t(e)})},function(e){t(e)}):"exception"===o.type?(r.error("Exception return from p2mRefreshRecTypeDOTs = "+o.message),t(o.message)):(r.error("Unknown return from p2mRefreshRecTypeDOTs = "+o.message),t(o.message))};a.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(n){s=n,!0===c?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshRecTypeDOTs001",contentType:"application/json",data:{audId:e,startPageControllerVersion:o.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:s,connSessJson:"{}"}},function(e){var n={status:"200"};u(e,n)},function(e){u("[]",{status:"OK"})}):Visualforce.remoting.Manager.getAction("mobilecaddy1."+o.START_PAGE_CONTROLLER+".p2mRefreshRecTypeDOTs")?Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+o.START_PAGE_CONTROLLER+".p2mRefreshRecTypeDOTs",e,s,"{}",u,{escape:!1,timeout:12e4}):u("[]",{status:"OK"})})})}}}),n("mobileCaddy/smartStoreUtils",function(e,n,t){var o=e("mobileCaddy/logUtils"),r=cordova.require("com.salesforce.plugin.smartstore");function i(e,n,t){var o=[];function r(e){n(o)}function i(e){if(!t)throw e;t(e)}!function e(n){n.currentPageOrderedEntries.forEach(function(e){o.push(e)}),n.currentPageIndex<n.totalPages-1?cordova.require("com.salesforce.plugin.smartstore").moveCursorToNextPage(n,e):cordova.require("com.salesforce.plugin.smartstore").closeCursor(n,r,i)}(e)}function a(e,n,t){var o=r.buildAllQuerySpec("_soupEntryId",null,mobileCaddy.QUERY_BUFFER_SIZE);r.querySoup(e,o,function(e){i(e,function(e){n(e)},t)})}function c(e,n,t,o){r.querySoup(e,n,function(e){i(e,function(e){t(e)},o)},o)}function s(e,n,t){if(void 0===n&&void 0===t)return new Promise(function(n,t){r.runSmartQuery(e,function(e){i(e,function(e){n(e)},function(e){t(e)})},function(e){t(e)})});r.runSmartQuery(e,function(e){i(e,function(e){n(e)},t)},t)}function u(e,n,t,o,i){if(void 0===o&&void 0===i)return new Promise(function(o,i){var a=r.buildExactQuerySpec(n,t,mobileCaddy.QUERY_BUFFER_SIZE_SL);c(e,a,function(e){o(e)},function(e){i(e)})});var a=r.buildExactQuerySpec(n,t,mobileCaddy.QUERY_BUFFER_SIZE_SL);c(e,a,function(e){o(e)},i)}function l(e,n,t,o,i,a,s){c(e,r.buildExactQuerySpec(n,t,mobileCaddy.QUERY_BUFFER_SIZE_SL),function(e){var n=[];e.forEach(function(e){e[o]==i&&n.push(e)}),a(n)},s)}function d(e,n,t){_("Row Mapping PT","Mobile Table Name",function(o){l("syncLib_system_data","MC_Var_String_001","Platform Table Definition",o,e,function(e){e.length,n(e[0])},t)},t)}function f(e,n){return new Promise(function(t,o){d(e,function(e){_("Row Mapping PT",n,function(n){t(e[n])},function(e){o(e)})},function(e){o(e)})})}function p(e,n,t){return new Promise(function(o,i){d(e,function(e){_("Row Mapping PT",n,function(n){e[n]=t,r.upsertSoupEntries("syncLib_system_data",[e],function(){o()},function(e){i(e)})},function(e){i(e)})},function(e){i(e)})})}function _(e,n,t,o){var r=e+"_"+n,i=localStorage.getItem(r);i?t(i):l("syncLib_system_data","MC_Var_String_001",e,"MC_Var_String_003",n,function(e){e.length,localStorage.setItem(r,e[0].MC_Var_String_004),t(e[0].MC_Var_String_004)},o)}function m(e,n,t,o){c("syncLib_system_data",r.buildExactQuerySpec("MC_Var_String_001",e,mobileCaddy.QUERY_BUFFER_SIZE_SL),function(o){var r=[];n.forEach(function(n){var t=!1;if(o.forEach(function(e){if(e.MC_Var_String_003==n)return r.push(e.MC_Var_String_004),void(t=!0)}),!t)throw"No mapping found for type = "+e+" and value = "+n}),t(r)},o)}var S=1,h=2;function y(e){return new Promise(function(n,t){r.soupExists("Analytics",function(e){n(e)},function(n){o.error("soupExists",e,n).then(function(e){T("Mobile_Log__mc",[e],function(e){t(n)},function(e){t(e)})}).catch(function(e){t(n)})})})}function g(e,n,t){m("Row Mapping PT",["Mobile Table Name","Build Order"],function(o){var r=o[0],i=o[1];u("syncLib_system_data","MC_Var_String_001","Platform Table Definition",function(t){var o=[];e==h?(t.sort(function(e,n){var t=0,o=parseInt(e[i]),r=parseInt(n[i]);return isNaN(o)||isNaN(r)||(t=o-r),t}),t.forEach(function(e){o.push(e[r])}),null!==n&&n(o)):(t.forEach(function(e){o.push(e[r])}),e==S&&o.sort(),null!==n&&n(o))},t)},t)}var v=0,b=1,C=2;function E(e,n,t,o){m("Row Mapping TC",["Parent SOUP Name","Table Column Name","Mobile Column Type","Application Field CRUD","META isNillable","Platform Column Type","Device Value Type","Proxy Ref Field Name"],function(o){var r=o[0],i=o[1],a=o[2],c=o[3],s=o[4],u=o[5],d=o[6],f=o[7];l("syncLib_system_data","MC_Var_String_001","Platform Table Column",r,e,function(e){var o=[];e.forEach(function(e){n==v?o.push(e[i]):n==C?o.push({path:e[i],type:e[a],crud:e[c],nillable:e[s],platColType:e[u],appColType:e[d],proxyRefField:e[f]}):o.push({path:e[i],type:e[a]})}),t(o)},function(e){})},o)}function R(e,n,t,o){if(0!==e.length){var i=[];e.forEach(function(e){e&&e._soupEntryId&&i.push(e._soupEntryId)}),0!==i.length?r.removeFromSoup(n,i,function(e){t(e)},o):t()}else t()}function T(e,n,t,o){r.upsertSoupEntries(e,n,function(n){var i=(new Date).getTime();!function(e,n,t,o,i){var a;I(e).then(function(e){return a=e,n="audId",t=localStorage.getItem("appSoup-"+n),new Promise(function(e,o){t?e(t):function(e){return new Promise(function(n,t){var o=r.buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE);c("appSoup",o,function(e){e[0]?n(e[0].CurrentValue):n(e[0])},function(e){t(e)})})}(n).then(function(t){localStorage.setItem("appSoup-"+n,t),e(t)})});var n,t}).then(function(o){return n.forEach(function(n){var r="PROXY%"+e+"%"+t+"%"+n._soupEntryId+"%"+o;n.Id=r,n[a]=r}),function(e,n){return new Promise(function(t,o){r.upsertSoupEntries(e,n,function(e){t(e)},function(e){o(e)})})}(e,n)}).then(function(e){o(e)}).catch(function(e){i(e)})}(e,n,i,function(n){var a=[];n.forEach(function(n){var t={Mobile_Table_Name:e,CRUD_Operation:"Insert",SOUP_Record_Id:n._soupEntryId,Id:n.Id,LastModifiedDateTime:i};a.push(t)}),r.upsertSoupEntriesWithExternalId("recsToSync",a,"Id",t,o)},o)},o)}function I(e){return new Promise(function(n,t){var o=localStorage.getItem("proxyField-"+e);o?n(o):E(e,v,function(t){var o=null;t.forEach(function(n){n.includes("MC_Proxy_ID")&&(o=n,localStorage.setItem("proxyField-"+e,n))}),n(o)},function(e){n(null)})})}t.exports={ALPHA:S,BUILD:h,listSoups:function(){return new Promise(function(e,n){Promise.resolve();var t=["Connection_Session__mc","Mobile_Log__mc"],r=["SnapShot_Connection_Session__mc","SnapShot_Mobile_Log__mc"],i=["appSoup","cacheSoup","dotsRecordTypes","recsToSync","syncLib_system_data"];y("Analytics").then(function(a){a&&i.unshift("Analytics"),g(S,function(n){n.splice(n.indexOf("Connection_Session__mc"),1),n.splice(n.indexOf("Mobile_Log__mc"),1);var o=t.concat(n).concat(r);n.reduce(function(e,n){return e.then(function(){return f(n,"Snapshot Data Required")}).then(function(e){return"Yes"==e&&-1==t.indexOf(n)&&o.push("SnapShot_"+n),o}).catch(function(e){})},Promise.resolve()).then(function(n){e(n.concat(i))})},function(e){o.error("Failed to listSoups",e).then(function(t){T("Mobile_Log__mc",[t],function(t){n(e)},function(t){n(e)})}).catch(function(t){n(e)})})})})},listMobileTables:g,FULL:C,listMobileTableColumns:E,queryMobileTable:u,buildMobileTables:function(e,n){g(h,function(t){var o=t.length;t.forEach(function(t){E(t,b,function(i){r.registerSoup(t,i,function(){p(t,"SOUP Built Date/Time",(new Date).getTime()).then(function(){return function(e,n){n.forEach(function(n){n.path.includes("MC_Proxy_ID")&&localStorage.setItem("proxyField-"+e,n.path)})}(t,i),f(t,"Snapshot Data Required")}).then(function(a){"Yes"==a?r.registerSoup("SnapShot_"+t,i,function(){p(t,"Snapshot SOUP Built Date/Time",(new Date).getTime()),0==--o&&e()},function(e){n(e)}):0==--o&&e()}).catch(function(e){n(e)})},n)},function(e){n(e)})})},n)},getProxyFieldName:I,getSysDataRowMapColHeading:_,getSysDataRowMapColHeadings:m,getTableDefnColumnValue:function(e,n){return f(e,n)},setTableDefnColumnValue:p,queryMobileTableWithAnd:l,smartQuerySoupRecordsWithQuerySpec:s,insertRecords:T,updateRecordsWithExternalId:function(e,n,t,o,i){(function(e,n,t){var o=n.length,r=0;return new Promise(function(i,a){I(e).then(function(c){n.forEach(function(s,l){u(e,t,s[t]).then(function(d){if(d.length>0){var f=d[0];for(var p in s)f[p]=s[p];n[l]=f,++r>=o&&i(n)}else"Id"==t&&s.Id.length>18?u(e,c,s.Id).then(function(e){if(e.length>0){var t=e[0];for(var c in s)"Id"!=c&&(t[c]=s[c]);n[l]=t,++r>=o&&i(n)}else a({status:101107})}):a({status:101107})}).catch(function(e){a(e)})})}).catch(function(e){a(e)})})})(e,n,t).then(function(n){r.upsertSoupEntriesWithExternalId(e,n,t,function(n){u("recsToSync","Mobile_Table_Name",e,function(t){var a=[];n.forEach(function(n){var o,r;if(t.forEach(function(e){e.Id!=n.Id||(o=e)}),void 0!==o)if(o.Current_Connection_Session&&void 0!==o.Current_Connection_Session)switch(o.CRUD_Operation){case"Insert":case"InsertUpdate":r="InsertUpdate";break;default:r="UpdateUpdate"}else r=o.CRUD_Operation;else r="Update";var i={Mobile_Table_Name:e,SOUP_Record_Id:n._soupEntryId,Id:n.Id,CRUD_Operation:r,LastModifiedDateTime:n.SystemModstamp};"InsertUpdate"!=r&&"UpdateUpdate"!=r||(i.Current_Connection_Session=o.Current_Connection_Session),a.push(i)}),r.upsertSoupEntriesWithExternalId("recsToSync",a,"Id",o,i)},i)},i)}).catch(function(e){i(e)})},deleteSoup:function(e){return new Promise(function(n,t){r.removeSoup(e,function(){o.log("deleteSoup",e).then(function(e){y("Mobile_Log__mc").then(function(t){t?T("Mobile_Log__mc",[e],function(e){n()},function(e){n()}):n()})}).catch(function(e){t(e)})},function(e){o.errorAndDispatch("deleteSoup",e).then(function(n){T("Mobile_Log__mc",[n],function(n){t(e)},function(n){t(e)})}).catch(function(n){t(e)})})})},querySoupRecords:a,querySoupRecsPromise:function(e){return new Promise(function(n,t){a(e,function(e){n(e.filter(function(e){return"object"==_typeof(e)}))},function(e){t(e)})})},querySoupRecordsWithQuerySpec:c,deleteRecordsForExternalId:function(e,n,t,o,i){if(!o&&!i)return new Promise(function(o,i){if(0===n.length)o();else{var a="";"object"==_typeof(n[0])?n.forEach(function(e,n){a+=0===n?"'"+e[t]+"'":",'"+e[t]+"'"}):n.forEach(function(e,n){a+=0===n?"'"+e+"'":", '"+e+"'"});var c="SELECT {"+e+":_soupEntryId} FROM {"+e+"} WHERE {"+e+":"+t+"} IN ("+a+")";s(r.buildSmartQuerySpec(c,1e4)).then(function(n){var t=n.map(function(e){return e[0]});r.removeFromSoup(e,t,function(e){o(e)},function(e){i(e)})}).catch(function(e){i(e)})}});if(0===n.length)o();else{var a=[];n.forEach(function(e){a.push(e[t])});var c="";n.forEach(function(e,n){c+=0===n?"'"+e[t]+"'":",'"+e[t]+"'"});var u="SELECT {"+e+":_soupEntryId} FROM {"+e+"} WHERE {"+e+":"+t+"} IN ("+c+")";s(r.buildSmartQuerySpec(u,1e4),function(n){var t=n.map(function(e){return e[0]});r.removeFromSoup(e,t,function(e){o()},function(e){i(e)})},function(e){i(e)})}},deleteRecordsFromSoup:R}}),n("mobileCaddy/appDataUtils",function(e,n,t){var o=cordova.require("com.salesforce.plugin.smartstore"),r=e("mobileCaddy/smartStoreUtils");window.LOCAL_DEV,window.USE_FORCETK;function i(e){return new Promise(function(n,t){var i=o.buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE);r.querySoupRecordsWithQuerySpec("appSoup",i,function(e){e[0]?n(e[0].CurrentValue):n(e[0])},function(e){t(e)})})}function a(e,n,t,i){return new Promise(function(a,c){var s=o.buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE);r.querySoupRecordsWithQuerySpec("appSoup",s,function(r){if(r.length>0)r[0][t]=n,o.upsertSoupEntries("appSoup",r,function(e){a(e)},function(e){c(e)});else if(i){var s={Name:e};s[t]=n,o.upsertSoupEntries("appSoup",[s],function(e){a(e)},function(e){c(e)})}else a()},function(e){c(e)})})}function c(e,n){return a(e,n,"CurrentValue",!0)}function s(e){return new Promise(function(e,n){e()})}t.exports={getPlatformAppConfig:function(e){return s()},getCurrentValueFromAppSoup:function(e){return i(e)},getCachedCurrentValueFromAppSoup:function(e){return function(e){var n=localStorage.getItem("appSoup-"+e);return new Promise(function(t,o){n?t(n):i(e).then(function(n){localStorage.setItem("appSoup-"+e,n),t(n)})})}(e)},updateNewValueInAppSoup:function(e,n){return function(e,n){return a(e,n,"NewValue",!1)}(e,n)},upsertNewValueInAppSoup:function(e,n){return function(e,n){return a(e,n,"NewValue",!0)}(e,n)},updateCurrentValueInAppSoup:function(e,n){return function(e,n){return a(e,n,"CurrentValue",!1)}(e,n)},upsertCurrentValueInAppSoup:function(e,n){return c(e,n)}}}),n("mobileCaddy/syncRefresh",function(e,n,t){var o=e("mobileCaddy/appDataUtils"),r=e("mobileCaddy/smartStoreUtils"),i=e("mobileCaddy/logger"),a=cordova.require("com.salesforce.plugin.smartstore"),c=e("mobileCaddy/geoLocation"),s=(window.LOCAL_DEV,!!window.USE_FORCETK),u=98;n.SYNC_ALREADY_IN_PROGRESS_INC=u;var l=100400;n.SYNC=l;var d=l,f=100402;n.SYNC_NOK_STATUS=f;var p="006";n.CSINHEAD_SYNC_VSN=p;var m="mc_failure_tab_";function S(e,n,t,o,a,c){c&&c({status:0,table:e}),n=void 0===n||n;t||(t=0),o||(o=50),a||(a=!1);var s=function(e,n,o){var r={};b(e,t,!0,1,1,null,function(e){e.status==g?(r.status=l,n(r)):(r.status=e.status,r.mc_add_status=e.mc_add_status,n(r))},o)},p=function e(n,i,a){var c={};r.queryMobileTable("recsToSync","Mobile_Table_Name",n,function(r){if(r.length>0)try{O(n,o,function(o){o.status==P&&void 0===o.mc_add_status?(t=0,c.status=0,i(c)):o.status==P&&"more-to-sync"===o.mc_add_status?e(n,i,a):(c.status=o.status,c.mc_add_status=o.mc_add_status,i(c))},a)}catch(e){}else c.status=2,c.mc_add_status="no-sync-no-updates",i(c)},a)},_=function(e,n,t,o,r){var c={};localStorage.removeItem("mcM2pMoreToSync"),"Dynamic (Submit First/Retain)"==n||"Dynamic (Submit First/Clear)"==n?p(e,function(n){!a&&(0===n.status||t&&2==n.status)?s(e,o,r):a&&0===n.status||2==n.status?(c.status=l,c.mc_add_status=n.mc_add_status,o(c)):(c.status=f,c.mc_add_status=n.mc_add_status,o(c))},r):"Submit Only"==n||"Submit & Clear"==n||"Submit & Destroy"==n?p(e,function(e){0===e.status?(c.status=l,o(c)):(c.status=f,c.mc_add_status=e.mc_add_status,o(c))},r):i.errorAndDispatch("Unknown sync type",n,a)};return new Promise(function(t,o){var a={},p=function(n){localStorage.removeItem("syncInProgressTime"),c&&(n.table=e,c(n)),t(n)},m=function(n){localStorage.removeItem("syncInProgressTime"),c&&c({table:e,status:-1}),o(n)},S="syncTime"+e,h=localStorage.getItem(S),y=(new Date).valueOf(),g=h?parseInt(h)+5e3:0;"Connection_Session__mc"!=e&&y<g?(a.status=l,a.mc_add_status="sync-too-soon",t(a)):(localStorage.setItem(S,y),localStorage.removeItem("tmpFailedRecordsAccum"),x(function(c){if(c.status==U||c.status==V||c.status==F){var S=localStorage.getItem("syncInProgressTime"),h=(new Date).valueOf();"Connection_Session__mc"!=e&&S&&S>h-12e4?(a.status=l+u,m(a)):(localStorage.setItem("syncInProgressTime",h),r.getTableDefnColumnValue(e,"Sync Type").then(function(r){q(function(c){"Mobile_Log__mc"!=e?null!==c&&void 0!==c?W(c,function(o){o.status==B?"Refresh Only"==r||"Refresh & Clear"==r?s(e,p,m):_(e,r,n,p,m):(a.status=d,a.mc_add_status=o.status,t(a))},function(e){i.errorAndDispatch(e),o(e)}):"Refresh Only"==r||"Refresh & Clear"==r?s(e,p,m):_(e,r,n,p,m):_(e,r,!1,p,m)},m)}).catch(function(e){m(e)}))}else a.status=f,a.mc_add_status=c.status,t(a),100101==a.mc_add_status||100102==a.mc_add_status?i.error(a):i.log(a)},m))})}function h(e){return new Promise(function(n,t){var o=function(e){t(e)},c={},s={},u={},l=e.mt,d=a.buildExactQuerySpec("Mobile_Table_Name",l,mobileCaddy.QUERY_BUFFER_SIZE);r.querySoupRecordsWithQuerySpec("recsToSync",d,function(t){t.forEach(function(e){if("Insert"==e.CRUD_Operation||"InsertUpdate"==e.CRUD_Operation)s[e.Id]=1;else{if("Update"!=e.CRUD_Operation&&"UpdateUpdate"!=e.CRUD_Operation)return void i.error("RTS contains record with non support CRUD Operation"+e);u[e.Id]=1}}),r.getProxyFieldName(l).then(function(i){var d=[],f=[];(e.records.forEach(function(e){var n=!0;null!==e.recordData.MC_Proxy_ID__c&&s.hasOwnProperty(e.recordData[i])&&(n=!1),n&&u.hasOwnProperty(e.recordData.Id)&&(n=!1),n&&d.push(e.recordData)}),e.ds)&&e.ds.oq.concat(e.ds.sd.concat(e.ds.hd.concat(e.ds.sh))).forEach(function(e){u.hasOwnProperty(e)||f.push({Id:e})});var p=a.buildExactQuerySpec("Mobile_Table_Name",l,mobileCaddy.QUERY_BUFFER_SIZE);r.querySoupRecordsWithQuerySpec("recsToSync",p,function(i){i.length==t.length?r.deleteRecordsForExternalId(l,f,"Id",function(){a.upsertSoupEntriesWithExternalId(l,d,"Id",function(){a.soupExists("SnapShot_"+l,function(t){t?r.deleteRecordsForExternalId("SnapShot_"+l,f,"Id",function(){a.upsertSoupEntriesWithExternalId("SnapShot_"+l,d,"Id",function(){ae(e),y(e.platAuthUrl),c.status=0,c.cs=e.cs,c.cp=e.cp,c.lastRefreshDatetime=e.lastRefreshDatetime,n(c)},o)},o):(ae(e),y(e.platAuthUrl),c.status=0,c.lastRefreshDatetime=e.lastRefreshDatetime,c.cs=e.cs,c.cp=e.cp,n(c))},o)},o)},o):(c.status=0,c.mc_add_status=1,c.cs=e.cs,c.cp=e.cp,c.lastRefreshDatetime=e.lastRefreshDatetime,n(c))},o)})},o)})}function y(e){e||(e=""),o.updateCurrentValueInAppSoup("platAuthUrl",e).catch(function(n){i.error("setPlatAuthUrl",e,n)})}var g=100500;n.P2M_REFRESH_OK=g;var v=100402;function b(e,n,t,a,c,u,l,d){var f,_,m,S,y=function(o,a){if(a.status){var c,s,u=new RegExp("\n","g");o=o.replace(u,"\\n"),u=new RegExp("\r","g"),o=o.replace(u,""),h(s=JSON.parse(o)).then(function(n){return c=n,r.setTableDefnColumnValue(e,"Last Refresh Date/Time",c.lastRefreshDatetime)}).then(function(){var n="P2M RE Records Processed";return"Connection_Session__mc"==e&&(n="P2M Conn_Sess Records Processed"),1==c.mc_add_status&&(n="P2M RE Abandoned"),S.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=n,S.connSessionRec.Id=c.cs,ne(S.connSessionRec)}).then(function(){return te(s.csM2P)}).then(function(){t&&_<p?ee(S.connSessionRec,function(){s["Session Number"]&&s["Session Number"]<s["Total Sessions"]?b(e,n,t,s["Session Number"]+1,s["Total Sessions"],s.CsPId,l,d):s.moreBatches?b(e,n,t,"newBatch",1,null,l,d):(C.status=g,l(C))},d):s["Session Number"]&&s["Session Number"]<s["Total Sessions"]?b(e,n,t,s["Session Number"]+1,s["Total Sessions"],s.CsPId,l,d):s.moreBatches?b(e,n,t,"newBatch",1,null,l,d):(C.status=g,l(C))}).catch(function(e){d(e)})}else"exception"===a.type&&i.error("p2mRefresh",e,a.message,a.where),z(a,S,function(e){C.status=v,C.mc_add_status=e.mc_add_status,l(C)},d)},C={},E="newBatch"==a;E&&(a=1);try{r.getTableDefnColumnValue(e,"Last Refresh Date/Time").then(function(e){(m=e)&&"null"!=m||(m=0);var r=new Date;return m<r-n||a>1||E||!t?o.getCachedCurrentValueFromAppSoup("audId"):(C.status=100402,C.status=100497,l(C),Promise.reject(C))}).then(function(e){return f=e,o.getCachedCurrentValueFromAppSoup("syncRefreshVersion")}).then(function(e){return N(_=e,"Sync - Refresh","P2M RE Process Called",a,c,u)}).then(function(e){if(S=e,!t){var n=JSON.parse(S.connSessJson);n.initialSync=!0,S.connSessJson=JSON.stringify(n)}if(E){var o=JSON.parse(S.connSessJson);o.firstBatch=!1,S.connSessJson=JSON.stringify(o)}return R(_,t)}).then(function(n){n&&(S.connSessJson=JSON.parse(S.connSessJson),S.connSessJson.csM2P=n,S.connSessJson=JSON.stringify(S.connSessJson)),!0===s?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshTable001",contentType:"application/json",data:{audId:f,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:_,mobileTableName:e,deviceRefreshIds:[],lastRefreshDateTime:m,thirdPartyJson:"",connSessJson:S.connSessJson}},function(e,n){void 0===n&&((n={}).status="200"),y(e,n)},d):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".p2mRefreshTable",f,_,e,[],m,"",S.connSessJson,y,{buffer:!1,escape:!1,timeout:12e4})}).catch(function(e){100497==e.status?l(e):(i.error(e),d(e))})}catch(e){i.errorAndDispatch(e)}}function C(e,n,t){return new Promise(function(r,i){o.getCachedCurrentValueFromAppSoup("audId").then(function(o){r("PROXY%"+e+"%"+t+"%"+n+"%"+o)}).catch(function(e){i(e)})})}function E(e,n,t,o){var r;if("Throw Exception"==o)throw i.errorAndDispatch("nullHandler - NULL value found",e,n,t.Id),"NULL value found for field "+n+" in Mobile Table "+e+" with Id = "+t.Id;return"Return NULL"==o?r=null:"Return Empty String"==o&&(r=""),r}function R(e,n){return new Promise(function(t,o){if(e<p||!n)t();else{var a,c=[];r.queryMobileTable("recsToSync","Mobile_Table_Name","Connection_Session__mc").then(function(e){return(a=e).length>0?r.querySoupRecsPromise("Connection_Session__mc"):Promise.resolve([])}).then(function(e){a.forEach(function(n){for(var t,o=0;o<e.length;++o)if(e[o].Id===n.Id&&e[o].Id.length<20){t=e[o];break}t&&c.push({Id:n.Id,t:function(e){switch(e){case"Sync - Refresh":return 1;case"Sync - Update":return 2;case"Status Check":return 3;default:return i.error("Unkown Session_Type__c",e),0}}(t.mobilecaddy1__Session_Type__c),s:function(e){switch(e){case"P2M RE Records Processed":return 1;case"P2M Conn_Sess Records Processed":return 2;case"P2M RE Abandoned":return 3;case"P2M RE Exception/Timeout":return 4;case"P2M RE Heartbeat Exception/Timeout":return 5;case"P2M RE Failure":return 6;case"P2M RE Hearbeat Failure":return 7;case"M2P Conn_Sess Records Processed":return 8;case"M2P Records Processed":return 9;case"M2P UP Failed - RTS Cleared":return 10;case"M2P SC - Status Check Processed":return 11;case"M2P SC Failure":return 12;case"M2P SC Exception/Timeout":return 13;case"M2P SC Heartbeat Exception/Timeout":return 14;case"M2P SC Heartbeat Failure":return 15;case"M2P UP Received - Records Processed":return 16;case"P2M InitialSync Faliure":return 17;default:return i.error("Unknown CS status",e),0}}(t.mobilecaddy1__Mobile_Process_Status__c)})}),t(c)}).catch(function(e){i.error(e),t(null)})}})}function T(e,n,t,o,r,a,c,s,u,l,d){var f={MobileTable:e,connSessProxyId:l,records:[]};c.forEach(function(o){for(var c,l=0;l<s.length;++l)if(s[l].Id===o.Id){c=s[l];break}if(c){var d={RTSRowNum:o._soupEntryId,RecordCRUD:function(e){switch(e){case"Insert":return"I";case"InsertDelete":return"T";case"Update":return"U";case"UpdatetDelete":return"Q";case"Delete":return"D";default:return null}}(o.CRUD_Operation),fields:[]};switch(d.RecordCRUD){case"I":case"T":d=function(e,n,t,o,r,i,a,c){for(var s in c){var u={name:s};if("mobilecaddy1__Error_Text__c"==s)u.value=JSON.stringify(c[s]),e.fields.push(u);else if("_soupEntryId"!=s&&"_soupLastModifiedDate"!=s){var l,d={};d[o]=s;var f=_.findWhere(t,d);if(null===c[s]){var p=f[i];l=E(n,s,c,p)}else if(l=c[s],f){var m=f[a];"M2P UP Unquoted"!=m||"true"!=l&&"false"!=l||(l="true"==l)}u.value=l,e.fields.push(u)}}return e}(d,e,n,t,0,r,a,c),f.records.push(d);break;case"D":case"U":case"Q":for(var p,m=0;m<u.length;++m)if(u[m].Id===o.Id){p=u[m];break}p?(d=function(e,n,t,o,r,i,a,c,s){var u=!1;for(var l in c)if("_soupEntryId"!=l&&"_soupLastModifiedDate"!=l){var d={name:l};if(c[l]!=s[l]||"SystemModstamp"==l){var f,p;u=!0;var m=null,S=null,h={};h[o]=l;var y=_.findWhere(t,h);null===c[l]?(m=y[i],f=E(n,l,c,m)):(f=c[l],y&&("M2P UP Unquoted"!=(S=y[a])||"true"!=f&&"false"!=f||(f="true"==f))),null===s[l]&&y?(m||(m=y[i]),p=E(n,l,s,m)):(p=s[l],y&&(S||(S=y[a]),"M2P UP Unquoted"!=S||"true"!=p&&"false"!=p||(p="true"==p))),d.previousValue=p,d.value=f,e.fields.push(d)}}return u?(e.fields.push({name:"Id",previousValue:s.Id,value:s.Id}),e):[]}(d,e,n,t,0,r,a,c,p),f.records.push(d)):i.errorAndDispatch("createUpdateJson Missing snapShot",e,c.Id);break;default:i.errorAndDispatch("createUpdateJson unknown CRUD",e,o.Id,o.CRUD_Operation)}}else i.errorAndDispatch("createUpdateJson Missing primary",e,o.Id)}),d(JSON.stringify(f))}function I(e,n,t,o,i){var c=[];n.forEach(function(e){var n={};t.forEach(function(t){if(e.Id==t.Id&&"Insert"==e.CRUD_Operation)for(var o in t)"_soupEntryId"!=o&&"_soupLastModifiedDate"!=o&&(n[o]=t[o])}),_.isEmpty(n)||c.push(n)}),0===c.length?o():r.getProxyFieldName(e).then(function(n){a.upsertSoupEntriesWithExternalId("SnapShot_"+e,c,n,o,i)})}function N(e,n,t,s,u,l){return new Promise(function(e,d){var f={};c.getLocation(function(c){var p={mobilecaddy1__Session_Type__c:n,mobilecaddy1__Mobile_Process_Status__c:t,SystemModstamp:(new Date).getTime()},_=c.ErrorNumber;0!==_?p.mobilecaddy1__Session_Created_Location_Error__c=c.Error:(p.Session_Created_Location__Longitude__s=c.Latitude,p.Session_Created_Location__Latitude__s=c.Longitude),function(e,n,t,o){var i={},c=new Date;r.getProxyFieldName(e).then(function(r){a.upsertSoupEntries(e,[n],function(n){var s=n[0];C(e,s._soupEntryId,c.getTime()).then(function(n){s.Id=n,s[r]=n,a.upsertSoupEntries(e,[s],function(e){i.status=0,i.proxyId=n,i.insertedRecord=e[0],t(i)},o)}).catch(function(e){o(e)})},o)}).catch(function(e){o(e)})}("Connection_Session__mc",p,function(n){var t=new Date,r={"Sync Session Proxy ID":null,"Total Sessions":u,"Session Number":s,"Device Call Date/Time":t.getTime(),"Connection Session Proxy ID":n.proxyId};l&&(r.CsPId=l),0!==_?r.ErrorNumber=_:(r["Location Long"]=c.Longitude,r["Location Lat"]=c.Latitude),f.status=0,f.connSessionRec=n.insertedRecord,f.connSessProxyId=n.proxyId;var a={version:"NULL"};window.device&&(a=window.device),o.getCurrentValueFromAppSoup("containerVersion").then(function(n){r.containerVsn=n,r.OSVsn=a.version,f.connSessJson=JSON.stringify(r),e(f)}).catch(function(n){i.error("buildConnectionSession - Could not get containerVsn",n),r.OSVsn=a.version,f.connSessJson=JSON.stringify(r),e(f)})},function(e){d(e)})},function(e){d(e)})})}function w(e){return new Promise(function(n,t){var c={},u=function(e){n(e)},l=function(e){t(e)},d=a.buildExactQuerySpec("Mobile_Table_Name",e,mobileCaddy.QUERY_BUFFER_SIZE);r.querySoupRecordsWithQuerySpec("recsToSync",d,function(n){if(0!==n.length){var t=!1;"Connection_Session__mc"!=e&&n.length>3e4&&(t=!0);var a=[];a=t?(a=_.sortBy(n,"_soupLastModifiedDate")).slice(0,3e4):n,r.querySoupRecords(e,function(n){r.querySoupRecords("SnapShot_"+e,function(t){r.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(d){var f=d[0],p=d[1],m=(d[2],d[3]),S=d[4];r.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",f,e,function(d){var f=[];_.each(a,function(e){var t;t=e.Id,_.find(n,function(e){return e.Id==t})&&f.push(e)}),_.isEmpty(f)?r.setTableDefnColumnValue(e,"Last Sync Date/Time",(new Date).getTime()).then(function(){c.status=P,c.mc_add_status=D,u(c)}).catch(function(e){i.error(e)}):T(e,d,p,0,m,S,f,n,t,"",function(t){var r;o.getCachedCurrentValueFromAppSoup("audId").then(function(e){return r=e,o.getCachedCurrentValueFromAppSoup("syncRefreshVersion")}).then(function(o){I(e,a,n,function(){var n=function(e,n){c.result=e,c.event=n,u(c)};t=t.replace(/: undefined/g,': "undefined"'),!0===s?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:r,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:o,mobileTableName:e,jsonRecords:t,connSessJson:"{}"}},function(e,t){void 0===t&&((t={}).status="200"),n(e,t)},l):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",r,o,e,t,JSON.stringify({"Session Number":1,"Location Long":10,"Location Lat":10,"Total Sessions":1,"Device Call Date/Time":(new Date).getTime(),"Connection Session Proxy ID":"1",ErrorNumber:2}),n,{buffer:!1,escape:!1,timeout:3e4})},l)}).catch(function(e){l(e)})})},l)},l)},l)},l)}else r.setTableDefnColumnValue(e,"Last Sync Date/Time",(new Date).getTime()).then(function(){c.status=P,c.mc_add_status=D,u(c)}).catch(function(e){i.log("No recs to sync")})},l)})}var P=100300;n.M2P_UPDATE_OK=P;var D=100310;function O(e,n,t,c){var u,l,d={};try{o.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){l=e;var n=localStorage.getItem("mcM2pMoreToSync")?2:1;return N(0,"Sync - Update","M2P Process Called",n,n,null)}).then(function(e){return u=e,R(l,!0)}).then(function(f){f&&(u.connSessJson=JSON.parse(u.connSessJson),u.connSessJson.csM2P=f,u.connSessJson=JSON.stringify(u.connSessJson));var m=a.buildExactQuerySpec("Mobile_Table_Name",e,mobileCaddy.QUERY_BUFFER_SIZE);r.querySoupRecordsWithQuerySpec("recsToSync",m,function(f){var m,S,h=(m=f,(S=JSON.parse(localStorage.getItem("tmpFailedRecordsAccum")))?m.filter(function(e){return!S[e.Id]}):m);if(0!==h.length){var y=!1;"Connection_Session__mc"!=e&&h.length>n?(y=!0,localStorage.setItem("mcM2pMoreToSync","true")):localStorage.removeItem("mcM2pMoreToSync");(function(e,n,t,o){e.forEach(function(e){e.Current_Connection_Session=n}),a.upsertSoupEntriesWithExternalId("recsToSync",e,"Id",t,o)})(y?_.sortBy(h,"_soupLastModifiedDate").slice(0,n):h,u.connSessProxyId,function(n){r.querySoupRecords(e,function(a){r.querySoupRecords("SnapShot_"+e,function(f){r.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(_){var m=_[0],S=_[1],h=(_[2],_[3]),g=_[4];r.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",m,e,function(r){T(e,r,S,0,h,g,n,a,f,u.connSessProxyId,function(r){var f;o.getCachedCurrentValueFromAppSoup("audId").then(function(o){f=o,I(e,n,a,function(){var n=function(n,o){var a;o.status?(n=n.replace(/,}/g,"}"),K(a=JSON.parse(n),r,function(n){u.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="Connection_Session__mc"==e?"M2P Conn_Sess Records Processed":"M2P Records Processed",u.connSessionRec.Id=n.csId,ne(u.connSessionRec).then(function(){return te(a.csM2P)}).then(function(){y?(d.status=P,d.mc_add_status="more-to-sync",t(d)):l<p?ee(u.connSessionRec,function(){d.status=P,t(d)},c):(d.status=P,t(d))}).catch(function(e){c(e)})},c)):"exception"===o.type?(d.status=P,d.mc_add_status=M,t(d),i.error("m2pUpdate",e,o.message,o.where)):(d.status=P,d.mc_add_status=A,t(d),i.error("m2pUpdate",e,o.message,o.where))};r=r.replace(/: undefined/g,': "undefined"'),!0===s?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:f,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:l,mobileTableName:e,jsonRecords:r,connSessJson:u.connSessJson}},function(e,t){void 0===t&&((t={}).status="200"),n(e,t)},c):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",f,l,e,r,u.connSessJson,n,{buffer:!1,escape:!1,timeout:3e4})},c)}).catch(function(e){c(e)})})},c)},c)},c)},c)},c)}else r.setTableDefnColumnValue(e,"Last Sync Date/Time",(new Date).getTime()).then(function(){d.status=P,d.mc_add_status=D,t(d)}).catch(function(e){c(e)})},c)},c)}catch(e){i.errorAndDispatch(e)}}n.M2P_NO_RECS_TO_SYNC=D;var U=100100;n.HEARTBEAT_OK=U;var M=100101;n.HEARTBEAT_EXCEPTION=M;var A=100102;n.HEARTBEAT_FAILURE=A;var L=100103;n.HEARTBEAT_NO_CONNECTION=L;var V=100104;n.HEARTBEAT_NOT_DEVICE=V;var F=100105;function x(e,n){var t={},o=navigator.appVersion.includes("Electron");o||navigator&&navigator.connection&&"undefined"!=typeof Connection?o||navigator.connection.type!=Connection.NONE?"undefined"==typeof Visualforce?(i.log("Visualforce not currently defined"),new Promise(function(e,n){var t=window.location.pathname,o=new XMLHttpRequest;o.open("GET",t,!0),o.send(),o.onreadystatechange=function(){if(o.readyState==XMLHttpRequest.DONE&&200==o.status){i.log("Startpage re-fetched",t);var e=new RegExp('"(\\S+VFRemote.js)"'),r=e.exec(o.response);if(r&&r[0]){var a=r[1];c=a,s=function(){i.log("remote script fetched",a),i.log("set up Visualforce ref")},u=document.createElement("script"),l=document.getElementsByTagName("script")[0],u.async=1,u.onload=u.onreadystatechange=function(e,n){(n||!u.readyState||/loaded|complete/.test(u.readyState))&&(u.onload=u.onreadystatechange=null,u=void 0,n||s&&s())},u.src=c,l.parentNode.insertBefore(u,l)}else n("Could not find VFRemote.js mention in "+t)}else o.readyState==XMLHttpRequest.DONE&&n(o.status);var c,s,u,l}}).then(function(t){k(e,n)}).catch(function(n){i.errorAndDispatch("Startpage Load Error: "+window.location.pathname,n),t.status=A,e(t)})):k(e,n):(t.status=L,e(t)):(localStorage.connection?t.status=localStorage.connection:t.status=V,e(t))}function k(e,n){var t={};Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".heartBeat",function(n,o){o.status?(t.status=U,e(t)):"exception"===o.type?J(function(n){t.status=F,e(t)},function(n){t.status=M,e(t)}):(t.status=A,e(t))},{escape:!1,timeout:3e4})}function J(e,n){r.querySoupRecords("appSoup",function(t){var r={};t.forEach(function(e){r[e.Name]=e.CurrentValue}),function(e,n,t){var r="grant_type=refresh_token&identity_url="+e.identityUrl+"&client_id="+e.clientId+"&refresh_token="+e.refreshToken+"&orgId="+e.orgId+"&audId="+e.audId+"&userId="+e.userId;var a=new XMLHttpRequest;a.open("POST","https://mobilecaddy.secure.force.com/apex/ProxyToken",!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.send(r),a.onreadystatechange=function(){if(a.readyState==XMLHttpRequest.DONE&&200==a.status){var e=JSON.parse(a.response);Visualforce.remoting.oauthAccessToken=e.access_token,Visualforce.remoting.last.refresh(function(){o.updateCurrentValueInAppSoup("accessToken",e.access_token).then(function(){n(e.access_token)}).catch(function(e){t(e)})},function(e){i.error("in VF last refresh error"),t(e)})}else a.readyState==XMLHttpRequest.DONE&&i.error("refreshTokenRequest error.",a.status)}}(r,e,n)},function(e){n(e)})}function q(e,n){r.querySoupRecords("recsToSync",function(t){for(var o=null,r=null,i=0;i<t.length;i++)if(null!==t[i].Current_Connection_Session&&void 0!==t[i].Current_Connection_Session){o=t[i].Current_Connection_Session,r=t[i];break}if(null!==o&&void 0!==o){var a=(new Date).getTime(),c=r._soupLastModifiedDate+3e4;if(a>c)e(o);else{var s={status:100498};n(s)}}else e(o)},n)}n.HEARTBEAT_REFRESHED_OK=F;var B=100200;n.CONN_SESS_OK=B;var H=100201;function W(e,n,t){try{var c;o.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){return c=e,N(0,"Status Check","M2P SC Status Check Requested",1,1,null)}).then(function(u){x(function(l){var d;l.status==U||l.status==V||l.status==F?o.getCachedCurrentValueFromAppSoup("audId").then(function(o){d=o;var l=function(o,c){var s;c.status?((s=JSON.parse(o)).cs_fc_jr&&(s.cs_fc_jr=JSON.parse(s.cs_fc_jr)),"Received Processed"==s.cs_fc_sc?function(e,n,t,o){try{K(n.cs_fc_jr,function(i){e.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",e.connSessionRec.SystemModstamp=(new Date).getTime(),e.connSessionRec.mobilecaddy1__Status__c="Closed",e.connSessionRec.Id=n.cs_sc_sf,r.queryMobileTable("Connection_Session__mc","Id",n.cs_fc_jr.cp).then(function(t){if(t[0]){var o=t[0];return o.Id=n.cs_fc_jr.csId,o.SystemModstamp=(new Date).getTime(),o.mobilecaddy1__Mobile_Process_Status__c="M2P Records Processed",ne([e.connSessionRec,o])}return Promise.resolve()}).then(function(){t({status:B})}).catch(function(e){o(e)})},o)}catch(e){i.errorAndDispatch("processM2PUpdateResponse",e),o("processM2PUpdateResponse-error")}}(u,s,n,t):function(e,n,t){r.queryMobileTable("recsToSync","Current_Connection_Session",e,function(e){if(0!==e.length){for(var o=0;o<e.length;o++)e[o].Current_Connection_Session=null,"InsertUpdate"==e[o].CRUD_Operation?e[o].CRUD_Operation="Insert":"UpdateUpdate"==e[o].CRUD_Operation&&(e[o].CRUD_Operation="Update");a.upsertSoupEntries("recsToSync",e,n,t)}else n()},t)}(e,function(){r.queryMobileTable("Connection_Session__mc","mobilecaddy1__MC_Proxy_ID__c",e,function(e){if(e.length>0){var o=e[0];"Received Not Processed"==s.cs_fc_sc?function(e,n,t,o,r){e.mobilecaddy1__Mobile_Process_Status__c="M2P UP Failed - RTS Cleared",e.mobilecaddy1__Session_Type__c="Sync Update",e.mobilecaddy1__Status__c="Closed",e.SystemModstamp=(new Date).getTime(),e.Id=t.cs_fc_sf,ne(e).then(function(){n.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",n.connSessionRec.SystemModstamp=(new Date).getTime(),n.connSessionRec.mobilecaddy1__Status__c="Closed",n.connSessionRec.Id=t.cs_sc_sf,ne(n.connSessionRec)}).catch(function(e){r(e)})}(o,u,s,0,t):function(e,n,t,o,i){r.deleteRecordsFromSoup([e],"Connection_Session__mc",function(e){n.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",n.connSessionRec.SystemModstamp=(new Date).getTime(),n.connSessionRec.mobilecaddy1__Status__c="Closed",n.connSessionRec.Id=t.cs_sc_sf,n.connSessionRec.mobilecaddy1__Session_Type__c="Status Check",ne(n.connSessionRec).then(function(){o({status:B})}).catch(function(e){i(e)})},i)}(o,u,s,n,t)}else n({status:B})},t)},t)):(i.error("csStatusCheck",c.message),n({status:H}))},f=u.connSessJson,p=localStorage.getItem("lastErrorLog");p&&(localStorage.removeItem("lastErrorLog"),(f=JSON.parse(f)).lastErrorLog=p,f=JSON.stringify(f)),!0===s?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pCSStatusCheck001",contentType:"application/json",data:{audId:d,syncRefreshDataVersion:c,statusCheckCSProxyId:e,connSessJson:f,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(e,n){void 0===n&&((n={}).status="200"),l(e,n)},function(e){i.error("err -> "+JSON.stringify(e)),t(e)}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pCSStatusCheck",d,c,e,f,l,{buffer:!1,escape:!1,timeout:3e4})}).catch(function(e){t(e)}):$(l,u,function(e){n({status:B,mc_add_status:e.mc_add_status})},t)},t)}).catch(function(e){t(e)})}catch(e){i.errorAndDispatch(e)}}function K(e,n,t,o){o||(o=t,t=n,n="{}");var c=1,s=e.mt,u=void 0!==e.is?e.is:[],l=void 0!==e.id?e.id:[],d=void 0!==e.us?e.us:[],f=void 0!==e.ifmf?e.ifmf:[],p=void 0!==e.ufmf?e.ufmf:[],m=[],S=[],h=[],y=[],g=[],v=[],b=[],C=[],E=[],R=[],T=[];if(u=u.concat(l),ie(s,e.af,u,d),void 0===e.if)R=[];else if(void 0===e.if.if)R=e.if;else{c=2;var I=e.if.if.map(function(n){return{pd:n,fbe:void 0!==e.ifbe?e.ifbe:"K"}}),N=e.if.ifv.map(function(n){return{pd:n,fbe:void 0!==e.ifvbe?e.ifvbe:"K"}}),w=e.if.icv.map(function(n){return{pd:n,fbe:void 0!==e.icvbe?e.icvbe:"K"}});R=I.concat(N.concat(w))}(function(e,n,t,o){return new Promise(function(i,a){e=JSON.parse(e);var c=t.concat(o),s=t;if(e.records&&e.records.length>n.length+c.length){var u=[];r.getProxyFieldName(e.MobileTable).then(function(o){e.records.forEach(function(e){if("I"==e.RecordCRUD){var t=e.fields.find(function(e){return e.name==o}).value;_.findWhere(n,{pd:t})||_.findWhere(c,{pd:t})||u.push({pd:t,fbe:"K"})}}),u.length>0&&(s=t.concat(u)),i(s)})}else i(s)})})(n,u,R,f).then(function(n){if(R=n,void 0===e.uf)T=[];else if(void 0===e.uf.uf)T=e.uf;else{c=2;var t=e.uf.uf.map(function(n){return{Id:n,fbe:void 0!==e.ufbe?e.ufbe:"K"}}),o=e.uf.usv.map(function(n){return{Id:n,fbe:void 0!==e.usvbe?e.usvbe:"K"}}),r=e.uf.sdf.map(function(n){return{Id:n,fbe:void 0!==e.sdfbe?e.sdfbe:"K"}}),i=e.uf.hdf.map(function(n){return{Id:n,fbe:void 0!==e.hdfbe?e.hdfbe:"K"}}),a=e.uf.ufv.map(function(n){return{Id:n,fbe:void 0!==e.ufvbe?e.ufvbe:"K"}}),u=e.uf.ucv.map(function(n){return{Id:n,fbe:void 0!==e.ucvbe?e.ucvbe:"K"}});T=t.concat(o.concat(r.concat(i.concat(a.concat(u)))))}return Y("SnapShot_"+s)}).then(function(e){return E=e,Y(s)}).then(function(n){r.queryMobileTable("recsToSync","Mobile_Table_Name",s,function(l){for(var _ in l)if(l[_].Current_Connection_Session==e.cp){var I=!1,N={},w={};switch(l[_].CRUD_Operation){case"Insert":case"InsertUpdate":for(var P in u)if(l[_].Id==u[P].pd){if(u[P].crud=l[_].CRUD_Operation,w=Q(u[P],n),"Insert"==l[_].CRUD_Operation){switch(e.stbe){case"D":b.push(w),C.push(u[P]);break;default:if("U"==u[P].pc){if(w.Id=u[P].Id,void 0!==u[P].an&&(void 0!==u[P].nf?w[u[P].nf]=u[P].an:w.Name=u[P].an),void 0!==u[P].lu)for(var D in u[P].lu)u[P].lu.hasOwnProperty(D),w[D]=u[P].lu[D];y.push(w),v.push(w)}}S.push(l[_]._soupEntryId)}else{if(w.Id=u[P].Id,void 0!==u[P].an&&(void 0!==u[P].nf?w[u[P].nf]=u[P].an:w.Name=u[P].an),void 0!==u[P].lu)for(var O in u[P].lu)u[P].lu.hasOwnProperty(O),w[O]=u[P].lu[O];y.push(w);var U=Q(u[P],E);U.Id=u[P].Id,v.push(U),(N=l[_]).Current_Connection_Session=null,N.CRUD_Operation="Update",N.Id=u[P].Id,m.push(N)}I=!0;break}if(!I)for(P in R)if(l[_].Id==R[P].pd){if(R[P].crud=l[_].CRUD_Operation,"Insert"==l[_].CRUD_Operation)switch("K",1==c?j(0,R[P].fl,e):R[P].fbe){case"K":(N=l[_]).Current_Connection_Session=null,m.push(N);break;case"R":break;default:w=Q(R[P],n),b.push(w),S.push(l[_]._soupEntryId),C.push(R[P])}else"InsertUpdate"==l[_].CRUD_Operation&&((N=l[_]).Current_Connection_Session=null,N.CRUD_Operation="Insert",m.push(N));I=!0;break}if(!I)for(P in f)if(l[_].Id==f[P].pd){if(f[P].crud=l[_].CRUD_Operation,"Insert"==l[_].CRUD_Operation)switch(f[P].fbe){case"K":(N=l[_]).Current_Connection_Session=null,m.push(N);break;case"R":break;default:w=Q(f[P],n),b.push(w),S.push(l[_]._soupEntryId),C.push(f[P])}else"InsertUpdate"==l[_].CRUD_Operation&&((N=l[_]).Current_Connection_Session=null,N.CRUD_Operation="Insert",m.push(N));I=!0;break}break;case"Update":case"UpdateUpdate":for(P in d)if(l[_].Id==d[P].Id){if(d[P].crud=l[_].CRUD_Operation,"Update"==l[_].CRUD_Operation){switch(w=Q(d[P],n),e.stbe){case"D":b.push(w),C.push(d[P]);break;default:if("M"==d[P].pc&&(w.SystemModstamp=new Date(d[P].sm)),void 0!==d[P].lu)for(var M in d[P].lu)d[P].lu.hasOwnProperty(M)&&(w[M]=d[P].lu[M]);h.push(w),g.push(w)}S.push(l[_]._soupEntryId)}else"UpdateUpdate"==l[_].CRUD_Operation&&((N=l[_]).Current_Connection_Session=null,N.CRUD_Operation="Update",m.push(N));I=!0;break}if(!I)for(P in T)if(l[_].Id==T[P].Id){if("Update"==l[_].CRUD_Operation)switch("K",1==c?j(1,T[P].fl,e):T[P].fbe){case"K":(N=l[_]).Current_Connection_Session=null,m.push(N);break;case"R":break;default:w=Q(T[P],n),b.push(w),S.push(l[_]._soupEntryId),C.push(T[P])}else"UpdateUpdate"==l[_].CRUD_Operation&&((N=l[_]).Current_Connection_Session=null,N.CRUD_Operation="Update",m.push(N));I=!0;break}if(!I)for(P in p)if(l[_].Id==p[P].Id){if(p[P].crud=l[_].CRUD_Operation,"Update"==l[_].CRUD_Operation)switch(p[P].fbe){case"K":(N=l[_]).Current_Connection_Session=null,m.push(N);break;case"R":break;default:w=Q(p[P],n),b.push(w),S.push(l[_]._soupEntryId),C.push(p[P])}else"UpdateUpdate"==l[_].CRUD_Operation&&((N=l[_]).Current_Connection_Session=null,N.CRUD_Operation="Update",m.push(N));I=!0;break}}}var A;r.getProxyFieldName(s).then(function(e){return A=e,G(s,"Id",h)}).then(function(e){return G(s,A,y)}).then(function(e){return G("SnapShot_"+s,"Id",g)}).then(function(e){return G("SnapShot_"+s,A,v)}).then(function(e){return Z(s,b)}).then(function(e){return Z("SnapShot_"+s,C)}).then(function(e){return n=m,new Promise(function(e,t){n.length>0?a.upsertSoupEntries("recsToSync",n,function(n){e(n)},function(e){t(e)}):e("OK")});var n}).then(function(e){return n=S,new Promise(function(e,t){n.length>0?a.removeFromSoup("recsToSync",n,function(n){e(n)},function(e){t(e)}):e("OK")});var n}).then(function(n){return ae(e)}).then(function(){var n={status:0};n.csId=e.csId,t(n)}).catch(function(e){i.errorAndDispatch("m2pResp error for "+s,e),o(e)})},o)}).catch(function(e){i.errorAndDispatch("Err reading table",s),o(e)})}function Q(e,n){var t={};return"Insert"==e.crud||"InsertUpdate"==e.crud?t.Id=e.pd:t.Id=e.Id,_.findWhere(n,t)}function j(e,n,t){switch(e){case 0:switch(n){case"DF":return t.ifbe;case"CV":return t.icvbe;case"FV":return t.ifvbe}break;case 1:switch(n){case"DF":return t.ufbe;case"SV":return t.usvbe;case"CV":return t.ucvbe;case"FV":return t.ufvbe;case"SD":return t.sdfbe;case"HD":return t.hdfbe}}}function Y(e){return new Promise(function(n,t){r.querySoupRecords(e,function(e){n(e)},function(e){t(e)})})}function G(e,n,t){return new Promise(function(o,r){t.length>0?a.upsertSoupEntriesWithExternalId(e,t,n,function(e){o(e)},function(e){r(e)}):o("OK")})}function Z(e,n){return new Promise(function(t,o){if(n.length>0)if(-1==e.indexOf("SnapShot"))r.deleteRecordsFromSoup(n,e,function(e){t(e)},function(e){o(e)});else{var a=n.filter(function(e){return e&&"Insert"==e.crud&&(e.Id=e.pd),null!==e&&void 0!==e});r.deleteRecordsForExternalId(e,a,"Id",function(e){t(e)},function(e){i.errorAndDispatch(e),o(e)})}else t("OK")})}var X=100600;function z(e,n,t,o){var r={bogus:!0};"exception"===e.type?r.status=M:r.status=A,$(r,n,t,o)}function $(e,n,t,o){var r={},c=null;e.status==L?"Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?c="P2M RE Heartbeat No Connection":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(c="M2P SC Heartbeat No Connection"):e.status==M?"Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?c=e.bogus?"P2M RE Exception/Timeout":"P2M RE Heartbeat Exception/Timeout":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(c=e.bogus?"M2P SC Exception/Timeout":"M2P SC Heartbeat Exception/Timeout"):e.status==A&&("Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?c=e.bogus?"P2M RE Failure":"P2M RE Hearbeat Failure":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(c=e.bogus?"M2P SC Failure":"M2P SC Heartbeat Failure")),null!==c?(n.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=c,n.connSessionRec.SystemModstamp=(new Date).getTime(),n.connSessionRec.mobilecaddy1__Status__c="Closed",a.upsertSoupEntries("Connection_Session__mc",[n.connSessionRec],function(){r.status=X,r.mc_add_status=e.status,t(r)},o)):(i.error("Unknown heartBeatObject.status. ",e.status),o())}function ee(e,n,t){var o={};r.querySoupRecsPromise("recsToSync").then(function(r){var a=_.filter(r,function(e){return void 0!==e.currentConnectionSession});a.length>1||"M2P Conn_Sess Records Processed"!=e.mobilecaddy1__Mobile_Process_Status__c?S("Connection_Session__mc").then(function(e){o.status=0,n(o)}).catch(function(e){i.warn("syncMobileTable ERROR -> ",e),t(e)}):(o.status=0,n(o))}).catch(function(e){i.error("querySoupRecsPromise ERROR -> ",e),t(e)})}function ne(e){return new Promise(function(n,t){var o=function(e){i.error("postProcessConnectionSession error",e),t(e)},r=Array.isArray(e)?e:[e],c={};a.upsertSoupEntries("Connection_Session__mc",r,function(t){var i=Array.isArray(e);i=r.map(function(e){return{Id:e.Id,SystemModstamp:e.SystemModstamp-1,mobilecaddy1__Session_Type__c:null,mobilecaddy1__Mobile_Process_Status__c:null,mobilecaddy1__Session_Created_Location_Error__c:null,mobilecaddy1__MC_Proxy_ID__c:null}}),a.upsertSoupEntries("SnapShot_Connection_Session__mc",i,function(e){var t=e.map(function(e){return{Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Update",SOUP_Record_Id:e._soupEntryId,Id:e.Id,LastModifiedDateTime:e.SystemModstamp}});a.upsertSoupEntries("recsToSync",t,function(){c.status=0,n(c)},o)},o)},o)})}function te(e){return new Promise(function(n,t){e&&e.us&&0!==e.us.length?r.deleteRecordsForExternalId("Connection_Session__mc",e.us,"Id").then(function(n){return r.deleteRecordsForExternalId("SnapShot_Connection_Session__mc",e.us,"Id")}).then(function(n){return r.deleteRecordsForExternalId("recsToSync",e.us,"Id")}).then(function(e){n()}).catch(function(e){i.error("handleUpdatedCS",e),n()}):n(),e&&e.uf&&0!==e.uf.length&&i.error("handleUpdatedCS -> we have uf",e.uf)})}function oe(e){return e?localStorage.getItem(m+e)?JSON.parse(localStorage.getItem(m+e)):{}:(n=[],re().forEach(function(e){var t=oe(e.replace(m,""));_.isEmpty(t)||n.push({table:e.replace(m,""),failures:t})}),n);var n}function re(){for(var e=[],n=0,t=localStorage.length;n<t;++n)localStorage.key(n).startsWith(m)&&e.push(localStorage.key(n));return e}function ie(e,n,t,o){var r={};if(localStorage.getItem("mcM2pMoreToSync")){if(localStorage.getItem(m+e)){localStorage.getItem(m+e);r=JSON.parse(localStorage.getItem(m+e)),t.forEach(function(e){delete r[e.pd]}),o.forEach(function(e){delete r[e.Id]})}}else localStorage.removeItem(m+e),r={};if(n){var i={};n.forEach(function(e){i[e.Id]=e,r[e.Id]=e}),localStorage.setItem("tmpFailedRecordsAccum",JSON.stringify(i))}Object.keys(r).length>0?localStorage.setItem(m+e,JSON.stringify(r)):localStorage.removeItem(m+e)}function ae(e){return new Promise(function(n,t){null!==e.migrateTo&&void 0!==e.migrateTo?o.updateNewValueInAppSoup("dynVersionNumber",e.migrateTo).then(function(){n()}).catch(function(e){i.error(e),t(e)}):n()})}n.CLEAN_CS_OK=X,t.exports={CSINHEAD_SYNC_VSN:p,refreshToken:function(e,n){J(e,n)},genProxyId:function(e,n,t){return C(e,n,t)},addProxyIds:function(e,n,t,i,c){!function(e,n,t,i,c){var s;r.getProxyFieldName(e).then(function(e){return s=e,o.getCachedCurrentValueFromAppSoup("audId")}).then(function(o){n.forEach(function(n){var r="PROXY%"+e+"%"+t+"%"+n._soupEntryId+"%"+o;n.Id=r,n[s]=r}),a.upsertSoupEntries(e,n,function(e){i(e)},c)}).catch(function(e){c(e)})}(e,n,t,i,c)},getSyncRecFailures:oe,P2M_REFRESH_OK:g,p2mRefreshTable:function(e,n,t,o,r,i,a,c){b(e,n,t,o,r,i,a,c)},buildConnectionSession:function(e,n,t,o,r,i){return N(0,n,t,o,r,i)},M2P_UPDATE_OK:P,M2P_NO_RECS_TO_SYNC:D,m2pUpdateMobileTable:function(e,n,t,o){O(e,n,t,o)},m2pRecoveryUpdateMobileTable:function(e){return w(e)},HEARTBEAT_OK:U,HEARTBEAT_EXCEPTION:M,HEARTBEAT_FAILURE:A,HEARTBEAT_NO_CONNECTION:L,HEARTBEAT_NOT_DEVICE:V,HEARTBEAT_REFRESHED_OK:F,heartBeat:function(e,n){x(e,n)},handleRefreshResponse:h,_getSyncFailureTableKeys:re,_storeSyncFailures:ie,createUpdateJson:T,syncMobileTable:S,getRTSPendingconnSess:q,CLEAN_CS_OK:X,cleanConnectionSessionHeartBeat:$,cleanConnectionSessionVFEvent:z,CONN_SESS_OK:B,csStatusCheck:W,maybeSyncConnSess:ee,processM2PUpdateResponse:K,postProcessConnectionSession:ne,handleUpdatedCS:te}}),n("mobileCaddy/fileUtils",function(e,n,t){var o,r,i=e("mobileCaddy/appDataUtils"),a=e("mobileCaddy/smartStoreUtils"),c=e("mobileCaddy/logger"),s=e("mobileCaddy/syncRefresh"),u=cordova.require("com.salesforce.plugin.smartstore"),l="fileUtils.js",d="File_Library__ap",f=1e4,p="SF_Content_Version_Id__c",_="Synchronised__c",m="File_Type__c",S="Local_Path",h=!!window.USE_FORCETK,y=!!window.LOCAL_DEV;function g(){return(o=localStorage.getItem("mcFileStorageDirectory"))||(o=cordova.file?cordova.file.documentsDirectory?cordova.file.documentsDirectory:cordova.file.dataDirectory:"CodeFlow",localStorage.setItem("mcFileStorageDirectory",o),o)}function v(e){var n="SELECT * FROM {"+d+"} WHERE {"+d+":Id} = '"+e[0]+"'";c.log("soql",n);var t=u.buildSmartQuerySpec(n,1);a.smartQuerySoupRecordsWithQuerySpec(t).then(function(n){var t=n[0][1];c.log("myRec",t),t[_]=1,t[S]=o+e[1]+"."+e[2],u.upsertSoupEntriesWithExternalId(d,[t],"Id",function(e){c.log("File DB entry updated",e)})}).catch(function(e){c.error("Error updating "+d+" following file save",e)})}t.exports={downloadFiles:function(){return new Promise(function(e,n){var t,r,S;o||g(),new Promise(function(e,n){u.soupExists(d,function(t){if(t){var o="SELECT {"+d+":Id},{"+d+":"+p+"},{"+d+":"+m+"} FROM {"+d+"} WHERE {"+d+":"+_+"} = 0",r=u.buildSmartQuerySpec(o,f);a.smartQuerySoupRecordsWithQuerySpec(r).then(function(n){c.log("Query res",n),n&&n[0]?e(n):e([])}).catch(function(e){n(e)})}else e([])},function(e){c.error("Failed to check soupExists for "+d),n(e)})}).then(function(n){n.length>0?(S=n,i.getCurrentValueFromAppSoup("accessToken").then(function(e){return t=e||JSON.parse(localStorage.getItem("forceOAuth")).access_token,i.getCurrentValueFromAppSoup("instanceUrl")}).then(function(e){return r=e||JSON.parse(localStorage.getItem("forceOAuth")).instance_url+"/",Promise.all(S.map(function(e){return function e(n,t,r){return c.log(l,"doDownloadFile",n),new Promise(function(i,a){y&&!h?i():function(e,n,t){var o=t+"/services/data/v39.0/sobjects/ContentVersion/"+e;return new Promise(function(t,r){if(e&&e.length>0){c.log(l,"urlToDownload",o);var i=new Headers;i.append("Authorization","Bearer "+n),i.append("Content-Type","application/json");var a={method:"GET",headers:i,mode:"cors"},s=new Request(o);fetch(s,a).then(function(e){return c.log(l,e),200==e.status?e.json():(c.error("resp.status",e.status),c.error("resp.statusText",e.statusText),c.error("resp.type",e.type),Promise.reject("Failed to read ContentVersionId object"))}).then(function(e){t(e.ContentDocumentId)}).catch(function(e){c.error("Something went wrong!",e),r(e)})}else t(null)})}(n[1],t,r).then(function(u){var d=r+"/services/data/v39.0/connect/files/"+u+"/content";if(c.log(l,"urlToDownload",d),u&&u.length>0){var f=new Headers;f.append("Authorization","Bearer "+t),f.append("Content-Type","image/jpeg");var p={method:"GET",headers:f,mode:"cors"},_=new Request(d);fetch(_,p).then(function(t){switch(c.log(l,t),t.status){case 200:u=n,d=t,"CodeFlow"!=o?window.resolveLocalFileSystemURL(o,function(e){c.log("file system open: "+e.name),e.getFile(u[1]+"."+u[2],{create:!0,exclusive:!1},function(e){(function(e,n){return new Promise(function(t,o){e.createWriter(function(e){e.onwriteend=function(){c.log("Successful file write..."),t()},e.onerror=function(e){c.error("Failed file write: "+e.toString()),o()},n.arrayBuffer().then(function(n){e.write(n)})})})})(e,d).then(function(e){v(u)})})}):d.arrayBuffer().then(function(e){var n=btoa(new Uint8Array(e).reduce(function(e,n){return e+String.fromCharCode(n)},""));h&&function(e,n){var t={filename:e,base64:n};fetch("http://localhost:3000/codeflow/storefile",{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(t)}).then(function(e){}).catch(function(e){})}(u[1]+"."+u[2],n),v(u)}),i(t);break;case 401:s.refreshToken(function(t){return e(n,t,r)},function(e){c.error(l,"Failed to refresh token",e),a(e)});break;default:c.error("resp.status",t.status),c.error("resp.statusText",t.statusText),c.error("resp.type",t.type),i(t)}var u,d}).catch(function(e){c.error("Something went wrong!",e),a(e)})}else i()}).catch(function(e){c.error(e),a(e)})})}(e,t,r).then(function(e){return c.log("resp",e),e})})).then(function(e){return c.log("accum",e),e})}).then(function(n){c.log("res1",n),e(n)})):(c.log("No files to download"),e())}).catch(function(e){n(e)})})},storeFilesInfo:function(e){return new Promise(function(n,t){o||g();var r=e,i="",c=(r.map(function(e,n){return i+=0===n?"'"+e.Id+"'":",'"+e.Id+"'",e.Id}),"SELECT {"+d+":Id} FROM {"+d+"} WHERE {"+d+":Id} IN ("+i+")"),s=u.buildSmartQuerySpec(c,f);a.smartQuerySoupRecordsWithQuerySpec(s).then(function(e){var n;return n=0!==e.length?r.filter(function(n){return!e[0].includes(n.Id)}):r,a.upsertSoupEntries(d,n)}).then(function(e){n(e)}).catch(function(e){t(e)})})},getStorageDirectory:g,readAsDataURL:function(e){return new Promise(function(n,t){if(cordova.platformId)if("ios"==cordova.platformId)if(r)n(r+e);else{var o=localStorage.getItem("cdvFileURI");o?n((r=o)+e):window.resolveLocalFileSystemURL(g(),function(t){r=t.toInternalURL(),localStorage.setItem("cdvFileURI",r),n(r+e)})}else window.resolveLocalFileSystemURL(g(),function(o){o.getFile(e,{},function(e){var o=new FileReader;o.onloadend=function(){void 0!==o.result||null!==o.result?n(o.result):void 0!==o.error||null!==o.error?t(o.error):t({code:null,message:"READER_ONLOADEND_ERR"})},e.file(function(e){o.readAsDataURL(e)},function(e){t(e)})})});else n("/mock/files/"+e)})}}}),n("mobileCaddy/vsnUtils",function(e,n,t){var o=e("mobileCaddy/devUtils"),r=e("mobileCaddy/appDataUtils"),i=mobileCaddy.require("mobileCaddy/smartStoreUtils"),a=e("mobileCaddy/syncRefresh"),c=e("mobileCaddy/logger"),s=["recsToSync"];function u(e,n){return new Promise(function(n,t){null===e?i.listMobileTables(i.ALPHA,function(e){var t=s;_.each(e,function(e){t.push(e),t.push("SnapShot_"+e),localStorage.removeItem("meta-tableDEF-"+e),localStorage.removeItem("meta-tableCRUD-"+e)}),n(t)},function(e){t(e)}):n([])})}function l(e,n){return new Promise(function(n,t){u(e).then(function(e){return Promise.all(e.map(i.deleteSoup))}).then(function(){n()}).catch(function(e){c.error(e),t(e)})})}function d(e){return new Promise(function(n,t){var o={},s=e?"Version Upgrade":"HardReset",u="";new Promise(function(e,n){a.refreshToken(function(n){e("ok")},function(e){n(e)})}).then(function(){i.querySoupRecsPromise("appSoup").then(function(e){return e.forEach(function(e){o[e.Name]=e.CurrentValue}),l(null)}).then(function(){u=f(o);var t,r,i="localhost:3030"==window.location.host?"codeflow":"undefined"!=typeof mockStore?navigator.appVersion.includes("Electron")?"desktop":"platform":"device";"codeflow"==i&&(t=localStorage.getItem("forceOAuth"),r=localStorage.getItem("appSoup"));if(e&&localStorage.getItem("lsItemsToPersist")){var a=JSON.parse(localStorage.getItem("lsItemsToPersist")).map(function(e){return{key:e,value:localStorage.getItem(e)}});a.push({key:"lsItemsToPersist",value:localStorage.getItem("lsItemsToPersist")}),localStorage.clear(),a.forEach(function(e){localStorage.setItem(e.key,e.value)})}else localStorage.clear();if("codeflow"==i)localStorage.setItem("forceOAuth",t),localStorage.setItem("appSoup",r),window.location.protocol+"//"+window.location.host+"/www",n("ok");else{if("platform"!=i)return function(e,n,t){return new Promise(function(o,r){var i,a="";navigator&&navigator.connection&&(a=navigator.connection.type),window.device&&(i=window.device);var c="";navigator.appVersion.includes("Electron")&&(i=ipcRenderer.sendSync("request-device-info",""),a="wifi",c="landscape");var s=s||c,u=e+"?deviceUuid="+i.uuid+"&deviceName="+i.name+"&deviceCordova="+i.cordova+"&deviceVersion="+i.version+"&deviceModel="+i.model+"&buildName="+n.buildName+"&buildVersion="+n.buildVersion+"&buildOS="+n.buildOS+"&knownAud="+n.audId+"&currentDv="+n.dynVersionNumber+"&orientation="+s+"&viewportWidth="+window.innerWidth+"&viewportHeight="+window.innerHeight+"&sessionType="+t+"&connType="+a+"&loginUrl="+n.loginUrl+"&millsFromEpoch="+(new Date).getTime();plugin&&plugin.mcsdk?plugin.mcsdk.getRESTBootstrapSetting(function(r){r.result?plugin.mcsdk.getConfig(function(r){var c={deviceUuid:i.uuid,deviceCordova:i.cordova,deviceName:i.name,deviceVersion:i.version,deviceModel:i.model,buildName:n.buildName,buildVersion:n.buildVersion,buildOS:n.buildOS,orientation:s,viewportWidthString:window.innerWidth,viewportHeightString:window.innerHeight,sessionType:t,userLanguage:"",connType:a,millsFromEpochString:(new Date).getTime(),loginUrl:n.loginUrl,containerVersion:r.containerVersion,containerAppName:r.containerAppName,containerBundleID:r.containerBundleID},u=new URL(e),l=u.origin;return fetch(l+"/services/apexrest/mobilecaddy1/mcBootstrap001/",{method:"POST",mode:"cors",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Bearer "+n.accessToken},body:JSON.stringify(c)}).then(function(e){return e.json()}).then(function(e){var n=new URL(e.path);o(n.protocol+"//"+n.hostname+n.pathname)})}):o(u)}):o(u)})}(u,o,s);window.location.href.substr(0,window.location.href.indexOf("#"))}}).then(function(e){r.updateNewValueInAppSoup("buildStatus","Resetting").then(function(){i.deleteSoup("syncLib_system_data").then(function(o){try{window.location.href=e}catch(e){c.errorAndDispatch("error on redirect",e),t(e)}n()}).catch(function(e){c.errorAndDispatch(e)}),n()}).catch(function(e){c.errorAndDispatch(e),t(e)})}).catch(function(e){c.errorAndDispatch(e),t(e)})}).catch(function(e){c.error("Tokens are bad, testRefreshAccessToken rejected with: "+JSON.stringify(e)),window.history.go(-(history.length-1)),navigator.appVersion.includes("Electron")||cordova.require("com.salesforce.plugin.sfaccountmanager").logout(),t(e)})})}function f(e){var n,t="/apex/mobilecaddy1__MobileCaddyBootstrap001_mc";switch(e.platAuthUrl){case"i":case"I":n=e.instanceUrl+t;break;case"l":case"L":n=e.loginUrl+t;break;case"":n=void 0;break;default:n=e.platAuthUrl}return n||(e.authURLType||(e.authURLType="login"),n="login"==e.authURLType?e.loginUrl+t:e.instanceUrl+t),n}function p(){return o.upgradeAvailable()}t.exports={clearSoups:function(e,n){return l(e)},getSoupsToClear:function(e,n){return u(e)},hardReset:function(){return d()},upgradeAvailable:function(){return p()},upgradeIfAvailable:function(){return new Promise(function(n,t){p().then(function(r){if(r&&"force"==e)return d(!0);if(r){var i="skip-failures"==e?a.getSyncRecFailures():null;o.dirtyTables(i).then(function(e){e.length>0?n(!1):a.getRTSPendingconnSess(function(e){if(null===e||void 0===e)return d(!0);n(!1)},function(e){n(!1)})}).catch(function(e){c.error(e),t(e)})}else n(!1)}).catch(function(e){c.error(e),t(e)})});var e},_getBootstrapUrl:function(e){return f(e)}}}),n("mobileCaddy/logUtils",function(e,n,t){var o=0,r=1,i=2,a=3,c=4;function s(e,n){return new Promise(function(t,r){if(1==n.length&&(n=n[0]),"object"==_typeof(n)&&(n=JSON.stringify(n)),"number"!=typeof n&&"boolean"!=typeof n||(n=n.toString()),"string"==typeof n){e==o&&localStorage.setItem("lastErrorLog",n.substring(0,1024));var i={mobilecaddy1__Error_Text__c:n.substring(0,1024),SystemModstamp:(new Date).getTime()},a=localStorage.getItem("appSoup-audId");i.mobilecaddy1__Application_User_Device__c=a,i.mobilecaddy1__Log_Type__c="D"+e.toString(),t(i)}else r("Trying to log unsupported type"+_typeof(n))})}function u(e,n,t,a){return new Promise(function(c,u){var l=localStorage.getItem("logLevel");l=null===l||void 0==_typeof(l)?0:l;if(n>0){var d=a.stack.split("\n")[4];if(void 0!==d){var f=d.indexOf("at ");d.slice(f+2,d.length)}}var p=t[0];switch(n){case o:t[0]&&t[0].stack?p=t[0].message+", STACK:"+t[0].stack:t[1]&&t[1].stack?p+="\n"+t[1].message+", STACK:"+t[1].stack:p=t,s(n,p).then(function(e){c(e)});break;case r:case i:s(n,t).then(function(e){c(e)});break;default:s(n,t).then(function(e){c(e)})}e&&"undefined"!=typeof LOCAL_DEV&&LOCAL_DEV&&alert(p+"\n\nSee dev console for more information")})}function l(){try{throw Error("")}catch(e){return e}}t.exports={debug:function(e){return u(!1,c,arguments,l())},error:function(e){return u(!1,o,arguments)},errorAndDispatch:function(e){return u(!0,o,arguments)},info:function(e){return u(!1,a,arguments,l())},log:function(e){return u(!1,i,arguments,l())},warn:function(e){return u(!1,r,arguments,l())},doLog:u}}),n("mobileCaddy/logger",function(e,n,t){var o=e("mobileCaddy/smartStoreUtils"),r=e("mobileCaddy/logUtils"),i=0,a=1,c=2,s=3,u=4;function l(e,n,t,i){r.doLog(e,n,t,i).then(function(e){var r=localStorage.getItem("logLevel");(r=null===r||void 0==_typeof(r)?0:r)>=n&&o.insertRecords("Mobile_Log__mc",[e],function(e){},function(e){f(e,_typeof(t))})}).catch(function(e){f(e,_typeof(t))})}function d(){try{throw Error("")}catch(e){return e}}function f(e){return l(!1,i,arguments)}t.exports={debug:function(e){return l(!1,u,arguments,d())},error:f,errorAndDispatch:function(e){return l(!0,i,arguments)},info:function(e){return l(!1,s,arguments,d())},log:function(e){return l(!1,c,arguments,d())},warn:function(e){return l(!1,a,arguments,d())}}}),n("mobileCaddy/devUtils",function(e,n,t){var o=e("mobileCaddy/smartStoreUtils"),r=e("mobileCaddy/appDataUtils"),i=e("mobileCaddy/fileUtils"),a=e("mobileCaddy/syncRefresh"),c=e("mobileCaddy/logger"),s=cordova.require("com.salesforce.plugin.smartstore"),u=!!window.USE_FORCETK,l=1,d=2,f=3,p=4,m=5,S=6,h=8,y=99,g=100400,v=100402,b=100700,C=101e3,E=101100,R=101200,T=101300,I=["syncLib_system_data","appSoup","cacheSoup","recsToSync","SnapShot_Connection_Session__mc"],N=["autonumber","CreatedById","CreatedDate","IsDeleted","IsClosed","IsWon","LastModifiedById","LastModifiedDate","LastReferencedDate","mobilecaddy1__MC_Proxy_ID","MC_Proxy_ID","OwnerId","SystemModstamp","Id","dirtyFlag"];function w(e){return new Promise(function(n,t){var i=new Date,a=new Date(i.getFullYear(),i.getMonth(),i.getDate(),0,0,0,0).valueOf();new Promise(function(e,n){s.soupExists("Analytics",function(t){t?e():s.registerSoup("Analytics",[{path:"Name",type:"integer"},{path:"Data",type:"string"}],function(n){e()},function(e){n(e)})},function(e){c.error(e),n(e)})}).then(function(){return function(e){return new Promise(function(n,t){var i="";r.getCurrentValueFromAppSoup("audId").then(function(e){return i=e,o.querySoupRecsPromise("Analytics")}).then(function(r){var a=[],u=[],l=[];r.forEach(function(n){if(n.Name==e)a.push(n);else{var t={Name:n.Name.toString(),SystemModstamp:n.Name,mobilecaddy1__Error_Text__c:JSON.parse(n.Data),mobilecaddy1__Application_User_Device__c:i,mobilecaddy1__Log_Type__c:"analytic"};u.push(t),l.push(n._soupEntryId)}}),0!==u.length&&o.insertRecords("Mobile_Log__mc",u,function(e){s.removeFromSoup("Analytics",l,function(e){n(a)},function(e){c.error("Unable to insert analytic recs",e),t(e)})},function(e){c.error("Unable to insert analytic recs",e),t(e)}),n(a)}).catch(function(e){c.error("Error housekeeping Analytics",e),t(e)})})}(a)}).then(function(t){var o={};if(0===t.length){o[e]=1;var r={Name:a,Data:JSON.stringify(o)};n(o[e]),s.upsertSoupEntries("Analytics",[r],function(e){},function(e){c.error("Unable to insert analytic recs",e)})}else{var i=t[0];(o=JSON.parse(i.Data))[e]=void 0===o[e]?1:o[e]+1,n(o[e]),i.Data=JSON.stringify(o),s.upsertSoupEntriesWithExternalId("Analytics",[i],"Name",function(e){},function(e){c.error(e)})}}).catch(function(e){c.error("Error in analInc",e),t(e)})})}function P(e,n,t){return new Promise(function(r,i){var a=function(n,o){var a=0;switch(n){case b:a=1;break;case C:a=4;break;case E:a=7;break;case R:a=10;break;default:a=0}if("Y"==o.charAt(a))r(t);else{var c={};c.status=n+f,c.mc_add_status=e,i(c)}};-1==I.indexOf(e)?localStorage["meta-tableCRUD-"+e]?a(n,localStorage["meta-tableCRUD-"+e]):o.getTableDefnColumnValue(e,"Application Record CRUD").then(function(t){localStorage["meta-tableCRUD-"+e]=t,a(n,t)}).catch(function(e){i(e)}):r(t)})}function D(){return new Promise(function(e,n){if(!0===u){var t=force.getUserId();e(t)}else O("userId").then(function(n){e(n)}).catch(function(e){c.error("getCurrentUserId",e),n(e)})})}function O(e){return new Promise(function(n,t){r.getCachedCurrentValueFromAppSoup(e).then(function(e){n(e)}).catch(function(e){c.error("getCachedAppSoupValue",e),t(e)})})}function U(e,n,t,o){if("_soupLastModifiedDate"==e)return o;var r=_.findWhere(t,{path:e}),i={};if(void 0===r)return i.status=n+d,i.mc_add_status=e,i;var a=0;switch(n){case b:a=1;break;case C:a=4;break;case E:a=7;break;default:a=0}if("Y"!=r.crud.charAt(a))return i.status=n+f,i;try{return i.value=L(o,r.appColType,r.platColType),i}catch(t){return i.status=n+m,i.mc_add_status=t+"->"+e,i}}function M(e){return new Promise(function(n,t){localStorage["meta-tableDEF-"+e]?n(JSON.parse(localStorage["meta-tableDEF-"+e])):o.listMobileTableColumns(e,o.FULL,function(t){localStorage["meta-tableDEF-"+e]=JSON.stringify(t),n(t)},function(e){t(e)})})}function A(e,n,t){switch(t){case"checkbox":case"Deleted":return"true"===String(e);case"CreatedDate":case"date":case"datetime":case"LastActivtyDate":case"LastModifiedDate":case"LastReferencedDate":case"LastViewedDate":case"SystemModstamp":return null!==e?new Date(e):e;default:return e}}function L(e,n,t){var o=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/;switch(t){case"autonumber":throw"invalid_autonumber";case"checkbox":case"Deleted":if("boolean"==typeof e||"true"===e||"false"===e)return String(e);throw"invalid_boolean";case"date":if("string"==typeof e){if(!o.test(e))throw"invalid_date";e=new Date(e)}if(e instanceof Date)return e.setUTCHours(0),e.setUTCMinutes(0),e.setUTCSeconds(0),e.setUTCMilliseconds(0),e.valueOf();if(null===e)return null;throw"invalid_date";case"datetime":if("string"==typeof e){if(!o.test(e))throw"invalid_datetime";e=new Date(e)}if(e instanceof Date)return e.valueOf();if(null===e)return null;throw"invalid_datetime";case"email":if(function(e){if(0===e.length)return!0;var n=e.indexOf("@"),t=e.lastIndexOf(".");return!(n<1||t<n+2||t+2>=e.length)}(e))return e;throw"invalid_email";default:switch(n){case"jsString":if("string"==typeof e)return e;if("number"==typeof e)return e.toString();throw"invalid_string";case"jsNumber":if("number"==typeof e||null===e)return e;throw"invalid_number";default:return e}}}function V(e,n){return new Promise(function(t,r){var i={};localStorage["meta-tableCRUD-"+e]?t():o.listMobileTables(o.ALPHA,function(o){o.concat(I).indexOf(e)>=0?t():(i.status=n+l,i.mc_add_status=e,r(i))},function(e){i.status=n+y,i.mc_add_status="Unkonwn error "+e,r(i)})})}function F(e,n,t,o,r){return new Promise(function(i,a){var s={},u={};s.status=t,x().then(function(n){return n[e]&&(u=n[e]),D()}).then(function(e){o.forEach(function(o){if(delete o._soupEntryId,delete o.$HashKey,o.RecordTypeName){if(o.RecordTypeId=u[o.RecordTypeName],_.isEmpty(u))return s.status=t+d,s.mc_add_status=o.RecordTypeName,i(s);if(!o.RecordTypeId)return s.status=t+h,s.mc_add_status=o.RecordTypeName,i(s);delete o.RecordTypeName}for(var a in o)if(o.hasOwnProperty(a)&&a!=n){var c=U(a,t,r,o[a]);if(c.status==t+d){s.status=c.status,s.mc_add_status=a;break}if(c.status==t+m){s.status=c.status,s.mc_add_status=a;break}if(c.status==t+f){s.status=c.status,s.mc_add_status=a;break}if(t==b&&N.indexOf(a)>=0){s.status=t+S,s.mc_add_status=a;break}o[a]=c.value}if(s.status!=t+d&&s.status!=t+m&&s.status!=t+S){var l=(new Date).getTime();t==b&&(o.CreatedById=e,o.CreatedDate=l),o.SystemModstamp=l,o.LastModifiedDate=l,o.LastModifiedById=e,o.IsDeleted="false",r.forEach(function(e){if(t==b){var n=e.crud.charAt(1);N.indexOf(e.path)<0&&"false"==e.nillable&&"Y"==n?_.has(o,e.path)||(s.status=t+p,s.mc_add_status=e.path):("IsClosed"==e.path&&(o.IsClosed="false"),"IsWon"==e.path&&(o.IsWon="false"))}""!==e.proxyRefField&&void 0!==o[e.path]&&o[e.path].length>18&&(o[e.proxyRefField]=o[e.path])})}}),s.records=o,i(s)},function(e){c.error("validateRecords",e)})})}function x(){return new Promise(function(e,n){localStorage.getItem("lsDotsRecordTypes")?e(JSON.parse(localStorage.getItem("lsDotsRecordTypes"))):o.querySoupRecords("dotsRecordTypes",function(n){var t={};n.forEach(function(e){var n={};JSON.parse(e.Data).forEach(function(e){e.recTypeDevName?(n[e.recTypeId]={recTypeName:e.recTypeName,recTypeDevName:e.recTypeDevName},n[e.recTypeName]=e.recTypeId,n[e.recTypeDevName]=e.recTypeId):(n[e.recTypeId]=e.recTypeName,n[e.recTypeName]=e.recTypeId)}),t[e.Table]=n}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(t)),e(t)},function(e){c.error("Error returned from upsert, message =  "+e),n(e)})})}function k(e,n,t){var r,i={};return new Promise(function(a,s){n.length>0?V(e,R).then(function(){return M(e)}).then(function(n){return P(e,R,n)}).then(function(o){return new Promise(function(r,i){var a=U(t,R,o);a.status!=R+d?F(e,t,R,n,o).then(function(e){e.status==R?r(e.records):(i(e),c.error(e))}):(i(a),c.error(a))})}).then(function(r){return o.queryMobileTable(e,t,n[0][t])}).then(function(n){if(0===n.length)i.status=R+p,c.warn("deleteRecord no record found",e),i.mc_add_status="no record found",s(i);else{if(!(n[0].Id.length<19))return r=n,o.querySoupRecsPromise("recsToSync");i.status=R+f,c.warn("deleteRecord Cannot delete synced records"),i.mc_add_status="Cannot delete synced records",s(i)}}).then(function(n){var t=n.reduce(function(n,t){return t.Mobile_Table_Name==e&&_.findWhere(r,{_soupEntryId:t.SOUP_Record_Id})&&n.push({_soupEntryId:t._soupEntryId}),n},[]);o.deleteRecordsFromSoup(r,e,function(){o.deleteRecordsFromSoup(t,"recsToSync",function(){i.status=R,i.records=r,a(i)},function(e){s(e)})},function(e){s(e)})}).catch(function(e){s(e)}):(i.status=R,c.warn("deleteRecord No records supplied"),i.mc_add_status="No records supplied",i.records=[],a(i))})}function J(e){return new Promise(function(n,t){H("recsToSync").then(function(t){var o=[],r=[],i={};e&&e.forEach(function(e){i[e.table]=e.failures}),t.records.forEach(function(n){"Connection_Session__mc"==n.Mobile_Table_Name||void 0!==o[n.Mobile_Table_Name]||e&&i[n.Mobile_Table_Name]&&(!i[n.Mobile_Table_Name]||i[n.Mobile_Table_Name][n.Id])||(o[n.Mobile_Table_Name]=!0,r.push(n.Mobile_Table_Name))}),n(r)}).catch(function(e){c.error(e),t(e)})})}function q(e,n){return new Promise(function(t,o){e.length>0&&-1==I.indexOf(n)?x().then(function(o){if(o[n]){var r=o[n],i=e.map(function(e){return"object"==_typeof(r[e.RecordTypeId])?(e.RecordTypeName=r[e.RecordTypeId].recTypeName,e.RecordTypeDevName=r[e.RecordTypeId].recTypeDevName):e.RecordTypeName=r[e.RecordTypeId],e.RecordTypeName||c.warn("enrichWithRecordTypeNames",e.RecordTypeId),e});t(i)}else t(e)}).catch(function(e){o(e)}):t(e)})}function B(e,n){var t=JSON.parse(JSON.stringify(n)),r={};return new Promise(function(n,i){V(e,b).then(function(){return M(e)}).then(function(n){return P(e,b,n)}).then(function(n){return new Promise(function(o,r){F(e,null,b,t,n).then(function(e){e.status==b?o(e.records):r(e)})})}).then(function(t){o.insertRecords(e,t,function(e){r.status=b,r.records=e,z().then(function(e){r.upgradeAvailable=e,n(r)}).catch(function(e){n(r),c.error(e)})},function(e){i(e),c.error(e)})}).catch(function(e){i(e),c.error(e)})})}function H(e,n){var t={};return new Promise(function(n,r){V(e,C).then(function(){return P(e,C)}).then(function(){return M(e)}).then(function(i){o.querySoupRecords(e,function(a){t.status=C,a.length>0?-1==I.indexOf(e)?o.getTableDefnColumnValue(e,"Last Refresh Date/Time").then(function(n){return W(e,a,i,n,t)}).then(function(e){n(e)}).catch(function(e){r(e),c.error(e)}):W(e,a,i,null,t).then(function(e){n(e)}):(t.records=[],z().then(function(e){t.upgradeAvailable=e,n(t)}).catch(function(e){n(t),c.error(e)}))},function(e){r(e),c.error(e)})},function(e){r(e),c.error(e)})})}function W(e,n,t,o,r){return new Promise(function(i,a){n.forEach(function(e){for(var n in e){var r=_.findWhere(t,{path:n});void 0!==r&&(e[n]=A(e[n],r.appColType,r.platColType),"LastModifiedDate"==n&&(e.dirtyFlag=j(e[n],o)))}}),r.records=n.filter(function(e){return"object"==_typeof(e)}),q(r.records,e).then(function(e){return r.records=e,z()}).then(function(e){r.upgradeAvailable=e,i(r)}).catch(function(e){i(r),c.error(e)})})}function K(e,n){return new Promise(function(t,r){var i,a,u={},l=/FROM\s+\{(\S*)\}/gi.exec(e),d=n||1e3,f=l[1];(function(e,n){return new Promise(function(t,r){var i=!0,a=n.match(/SELECT\s+(.*)\s+FROM/i);"*"!==a[1]&&(i=!1);var c=n.match(/\s+FROM\s+{(.*)}\s+WHERE\s+(.*)/i);if(null!==c&&null!==c[1]){var s,u,l=n,d=c[2].split(" AND "),f={},p="";d.forEach(function(e){var n=e.match(/{(.*):(.*)}\s+=\s+(.*)/i);if(n){var t=n[2];p=n[3].split("'")[1],f[t]=p}}),d.forEach(function(e){var n=e.match(/{(.*):(.*)}\s+IN\s+\((.*)\)/i);if(n&&"Id"==n[2]){var t=n[3].split(",");(u=t.some(function(e){return e.length>20}))&&(s=n[3])}}),void 0!==f.Id&&f.Id.length>18||u?o.getProxyFieldName(e).then(function(e){if(u){var n=":Id} IN ("+s+") OR {"+c[1]+":"+e+"} IN";l=l.replace(":Id} IN",n)}else l=l.replace("Id} =",e+"} =");t([l,i])}):t([l,i])}else t([n,i])})})(f,e).then(function(e){var n=e[0];return a=e[1],i=s.buildSmartQuerySpec(n,d),"MC-TIMING smartRead "+f,V(f,C)}).then(function(){return P(f,C)}).then(function(){return M(f)}).then(function(e){o.smartQuerySoupRecordsWithQuerySpec(i,function(n){u.status=C,n.length>0?-1==I.indexOf(f)&&a?o.getTableDefnColumnValue(f,"Last Refresh Date/Time").then(function(t){return Q(f,n,e,t,u)}).then(function(e){t(e)}):Q(f,n,e,null,u).then(function(e){t(e)}):(u.records=[],z().then(function(e){u.upgradeAvailable=e,t(u)}).catch(function(e){t(u),c.error(e)}))},function(){r()})},function(e){r(e),c.error(e)})})}function Q(e,n,t,o,r){return new Promise(function(i,a){var s=[],u=!0;n.forEach(function(e){var n;if("object"==_typeof(e[1]))for(var r in n=e[1]){var i=_.findWhere(t,{path:r});void 0!==i&&(n[r]=A(n[r],i.appColType,i.platColType),"LastModifiedDate"==r&&(e[1].dirtyFlag=j(e[1][r],o)))}else n=e,u=!1;s.push(n)}),r.records=s.filter(function(e){return"object"==_typeof(e)}),u?q(r.records,e).then(function(e){return r.records=e,z()}).then(function(e){r.upgradeAvailable=e,i(r)}).catch(function(e){i(r),c.error(e)}):z().then(function(e){r.upgradeAvailable=e,i(r)}).catch(function(e){i(r),c.error(e)})})}function j(e,n){return n&&"null"!=n||(n=0),e.valueOf()>n}function Y(e,n){return new Promise(function(t,o){if(0===e.length)t({status:g+p});else{var r={};a.heartBeat(function(s){if(s.status==a.HEARTBEAT_OK||s.status==a.HEARTBEAT_NOT_DEVICE||s.status==a.HEARTBEAT_REFRESHED_OK){var u=[];J().then(function(t){return t.forEach(function(n){var t=e.indexOf(n);t>-1&&(u.push({table:n,status:v,mc_add_status:"Dirty records"}),e.splice(t,1))}),function e(n,t,o,r){return new Promise(function(i,s){o||(o=[]),r||(r=1);var u;(function(e,n){Promise.resolve();var t=[];return e.reduce(function(e,o){return e.then(function(e){return e&&e[e.length-1].status!=g?Promise.resolve():(n&&n({status:0,table:o}),t=o,new Promise(function(e,n){var o=function(n){e(n)},r={table:t};a.p2mRefreshTable(t,0,!1,1,1,null,function(e){e.status==a.P2M_REFRESH_OK?(r.status=g,o(r)):(r.status=e.status,r.mc_add_status=e.mc_add_status,o(r))},function(e){c.error("innerProcessRefreshTablePromise error",e),n(e)})}));var t}).then(function(e){return n&&n(e),e&&t.push(e),t}).catch(function(e){c.errorAndDispatch(e)})},Promise.resolve())})(n,t).then(function(a){if(a.forEach(function(e,n){e&&(o.push(e),e.status!=g&&void 0===u&&(u=n))}),void 0!==u)if(r<3){var c=n.splice(u,n.length-u);e(c,t,o,r+1).then(function(e){i(e)}).catch(function(e){s(e)})}else s(o);else i(o)})})}(e,n)}).then(function(e){var n=u.concat(e).filter(function(e){return e});t(n),i.downloadFiles();var r={mobilecaddy1__Mobile_Process_Status__c:""};G().then(function(e){a.maybeSyncConnSess(r,function(){},function(e){o(e),c.error(e)})})}).catch(function(e){if(Array.isArray(e)){var n=u.concat(e).filter(function(e){return e});c.error("InitialSync Failed"),Z("Mobile_Log__mc").then(function(e){var t={mobilecaddy1__Mobile_Process_Status__c:""};G().then(function(e){a.maybeSyncConnSess(t,function(){Z("Mobile_Log__mc"),o(n)},function(e){o(e),c.error(e)})})}).catch(function(e){c.error("Failed sending Mobile Logs"),o(e)}),o(n)}else o(e),c.error(e)})}else r.status=v,r.mc_add_status=s.status,t(r),100101==r.mc_add_status||100102==r.mc_add_status?c.error(r):c.log(r)},function(e){c.error(e),r.status=v,t(r)})}})}function G(){return new Promise(function(e,n){var t="SELECT * FROM {Connection_Session__mc} WHERE {Connection_Session__mc:mobilecaddy1__Mobile_Process_Status__c} = 'P2M RE Exception/Timeout'",r=s.buildSmartQuerySpec(t,100);o.smartQuerySoupRecordsWithQuerySpec(r,function(n){var t=n.map(function(e){return e[1].mobilecaddy1__Mobile_Process_Status__c="P2M InitialSync Faliure",e[1]});s.upsertSoupEntries("Connection_Session__mc",t,function(n){var t=n.map(function(e){return{Id:e.Id,SystemModstamp:e.SystemModstamp-1,mobilecaddy1__Session_Type__c:null,mobilecaddy1__Mobile_Process_Status__c:null,mobilecaddy1__Session_Created_Location_Error__c:null,mobilecaddy1__MC_Proxy_ID__c:null}});s.upsertSoupEntries("SnapShot_Connection_Session__mc",t,function(n){var t=n.map(function(e){return{Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Insert",SOUP_Record_Id:e._soupEntryId,Id:e.Id,LastModifiedDateTime:e.SystemModstamp}});s.upsertSoupEntries("recsToSync",t,function(){e()},function(e){c.error(e)})},function(e){c.error(e)})},function(e){c.error(e)}),e()},function(e){c.error(e),n(e)})})}function Z(e,n,t,o,r,i){return new Promise(function(c,s){V(e,g).then(function(){return a.syncMobileTable(e,n,t,o,r,i)}).then(function(e){c(e)}).catch(function(e){s(e)})})}function X(e,n,t){var r=JSON.parse(JSON.stringify(n)),i={};return new Promise(function(n,a){r.length>0?V(e,E).then(function(){return M(e)}).then(function(n){return P(e,E,n)}).then(function(n){return new Promise(function(o,i){var a=U(t,E,n);a.status!=E+d?F(e,t,E,r,n).then(function(e){e.status==E?o(e.records):i(e)}):i(a)})}).then(function(r){o.updateRecordsWithExternalId(e,r,t,function(e){i.status=E,i.records=e,z().then(function(e){i.upgradeAvailable=e,n(i)}).catch(function(e){n(i)})},function(e){a(e),c.error(e)})},function(e){a(e),c.error(e)}):(i.status=E,i.mc_add_status="No records supplied",i.records=[],n(i),c.warn(i))})}function z(){return new Promise(function(e,n){o.queryMobileTable("appSoup","Name","dynVersionNumber").then(function(n){void 0!==n[0].NewValue&&n[0].NewValue!=n[0].CurrentValue?e(!0):e(!1)}).catch(function(e){c.error(e),n(e)})})}t.exports={SYNC_OK:g,SYNC_NOK:v,SYNC_ALREADY_IN_PROGRESS:g+98,SYNC_UNKONWN_TABLE:g+l,SYNC_MANDATORY_MISSING:g+p,DELETE_RECS_OK:R,DELETE_RECS_UNKONWN_TABLE:R+l,DELETE_RECS_UNKONWN_FIELD:R+d,DELETE_RECS_ACCESS_DENIED:R+f,DELETE_RECS_MANDATORY_MISSING:R+p,INSERT_RECS_OK:b,INSERT_RECS_UNKONWN_TABLE:b+l,INSERT_RECS_UNKONWN_FIELD:b+d,INSERT_RECS_ACCESS_DENIED:b+f,INSERT_RECS_MANDATORY_MISSING:b+p,INSERT_RECS_DATATYPE_MISMATCH:b+m,INSERT_RECS_PROTECTED_FIELD:b+S,INSERT_RECS_UNKNOWN_RECORD_TYPE:b+h,READ_RECS_OK:C,READ_RECS_UNKONWN_TABLE:C+l,READ_RECS_ACCESS_DENIED:C+f,UPDATE_RECS_OK:E,UPDATE_RECS_UNKONWN_TABLE:E+l,UPDATE_RECS_UNKONWN_FIELD:E+d,UPDATE_RECS_ACCESS_DENIED:E+f,UPDATE_RECS_DATATYPE_MISMATCH:E+m,UPDATE_RECS_UNKNOWN_ID:E+7,UPDATE_RECS_UNKNOWN_RECORD_TYPE:E+h,GET_REC_TYPES_UNKONWN_TABLE:T+l,analInc:function(e){return w(e)},deleteRecord:function(e,n,t){return k(e,[n],t)},dirtyTables:function(e){return J(e)},syncMobileTable:function(e,n,t,o,r){return Z(e,n,t,o,r)},initialSync:function(e){return Y(e)},getCurrentUserId:function(){return D()},getCurrentUserName:function(){return e="",new Promise(function(n,t){O("userFirstName").then(function(n){return e=n,O("userLastName")}).then(function(t){n(e+" "+t)}).catch(function(e){c.error("getCurrentUserName",e),t(e)})});var e},getUserLocale:function(){return O("userLocale")},getCachedAppSoupValue:function(e){return O(e)},getRecordTypes:function(e){return function(e){return new Promise(function(n,t){V(e,T).then(function(){return x()}).then(function(t){n(t[e])}).catch(function(e){t(e)})})}(e)},insertRecord:function(e,n){return B(e,[n])},insertRecords:function(e,n){return B(e,n)},logout:function(){return localStorage.clear(),void(navigator.appVersion.includes("Electron")?ipcRenderer.sendSync("logout",""):cordova.require("com.salesforce.plugin.sfaccountmanager").logout())},readRecords:function(e,n){return H(e)},smartSql:function(e){return K(e)},updateRecord:function(e,n,t){return X(e,[n],t)},updateRecords:function(e,n,t){return X(e,n,t)},maybeReadTransformType:function(e,n,t){return A(e,0,t)},maybeWriteTransformType:function(e,n,t){return L(e,n,t)},upgradeAvailable:function(){return z()}}}),window.mobileCaddy=e("mobileCaddy")}();