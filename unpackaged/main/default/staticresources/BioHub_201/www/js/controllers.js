/*! BioHub - v2.0.1 - 2016-06-07 10:09:16*/
/* Copyright 2016 MobileCaddy Ltd */
!function(){"use strict";angular.module("starter.controllers",["ionic","ngCordova"]).filter("dateYYYYMMDD",["$filter",function($filter){return function(x){if("undefined"!=typeof x&&null!==typeof x){if(null===x)return"";var myDate=new Date(x);return $filter("date")(myDate,"yyyy - MM - dd")}return""}}]).filter("dateDDMMMYYYY",["$filter",function($filter){return function(x){if("undefined"!=typeof x&&null!==typeof x){if(null===x)return"";var myDate=new Date(x);return $filter("date")(myDate,"dd MMM yyyy")}return""}}]).filter("dateDDMMMYYYYHHMM",["$filter",function($filter){return function(x){if("undefined"!=typeof x&&null!==typeof x){if(null===x)return"";var myDate=new Date(x);return $filter("date")(myDate,"dd MMM yyyy HH:mm")}return""}}]).filter("trusted",["$sce",function($sce){return function(val){return val?$sce.trustAsHtml(val.replace(/\n/g,"<br/>").replace("<ul>",'<ul class="bio-custom-bullet bio-green-tick">')):void 0}}])}(),function(){"use strict";function ContentItemCtrl($rootScope,$scope,$stateParams,$ionicLoading,$window,$timeout,$ionicModal,$location,$ionicScrollDelegate,$ionicPopup,$ionicHistory,$state,logger,ContentItemService,NetworkService){function activate(refreshAfterSync){vm.title=decodeURIComponent($stateParams.menuName),refreshAfterSync||$ionicLoading.show({duration:1e4,template:"Loading...",animation:"fade-in",showBackdrop:!0}),ContentItemService.getContentItems($stateParams.menuItem).then(function(records){records.length>0&&($ionicLoading.hide(),vm.contentItemTemplate=getTemplateName(records[0].Record_Type_Name__c),"Portrait_Image.html"==vm.contentItemTemplate||"Portrait_Image_Fixed_Heading.html"==vm.contentItemTemplate?populatePortraitImageSlider(records,refreshAfterSync):"Menu_List.html"==vm.contentItemTemplate?populateMenuList(records,refreshAfterSync):"Twin_Images.html"==vm.contentItemTemplate?populateTwinImagesSlider(records,refreshAfterSync):"Landscape_Image.html"==vm.contentItemTemplate?populateLandscapeImageSlider(records,refreshAfterSync):"Image_and_Copy.html"==vm.contentItemTemplate?populateImageAndCopySlider(records,refreshAfterSync):"Image_or_Copy.html"==vm.contentItemTemplate&&populateImageOrCopySlider(records,refreshAfterSync))})}function getTemplateName(recordTypeName){return"Portrait_Image"==recordTypeName?"apps"==vm.menuItem?"Portrait_Image.html":"Portrait_Image_Fixed_Heading.html":"Menu_List"==recordTypeName?"Menu_List.html":"Twin_Images"==recordTypeName?"Twin_Images.html":"Landscape_Image"==recordTypeName?"Landscape_Image.html":"Image_and_Copy"==recordTypeName?"Image_and_Copy.html":"Copy"==recordTypeName?"Image_or_Copy.html":void 0}function populatePortraitImageSlider(records,refreshAfterSync){if(vm.slider&&!refreshAfterSync)refreshSliderAndImageText();else{vm.slides=[],vm.slideHeadings=[],vm.slideFooters=[];for(var i=0;i<records.length;i++)vm.slideHeadings.push(records[i].Text2__c),vm.slideFooters.push(records[i].Text3__c),"Copy"==records[i].Display_Type__c?vm.slides.push({text:records[i].Image1__c}):vm.slides.push({image:records[i].Image1__c,caption:records[i].Text1__c});vm.slides.length<=1?hideSwiperPagination(vm.slidesId):showSwiperPagination(vm.slidesId),refreshAfterSync&&refreshSliderAndImageText()}}function populateMenuList(records,refreshAfterSync){vm.menuItems&&!refreshAfterSync||(vm.menuItems=records)}function populateTwinImagesSlider(records,refreshAfterSync){if(vm.slider&&!refreshAfterSync)refreshSliderAndImageText();else{vm.slides=[],vm.slideHeadings=[],vm.slideFooters=[];for(var slideFooter=null,i=0;i<records.length;i++)"Left Side Image"==records[i].Display_Type__c&&(slideFooter=records[i].Text3__c),"Right Side Image"==records[i].Display_Type__c&&(slideFooter=records[i].Text3__c),records[i].Image1__c&&(vm.slides.push({image:records[i].Image1__c,caption:records[i].Text1__c,heading:""}),vm.slideHeadings.push(records[i].Text2__c),vm.slideFooters.push(slideFooter));refreshAfterSync&&refreshSliderAndImageText()}}function populateLandscapeImageSlider(records,refreshAfterSync){if(vm.slider&&!refreshAfterSync)refreshSliderAndImageText();else{vm.slides=[],vm.slideHeadings=[],vm.slideFooters=[];for(var i=0;i<records.length;i++)records[i].Image1__c&&(vm.slides.push({image:records[i].Image1__c,caption:records[i].Text1__c}),vm.slideHeadings.push(records[i].Text2__c),vm.slideFooters.push(records[i].Text3__c));vm.slides.length<=1&&hideSwiperPagination(vm.slidesId),refreshAfterSync&&refreshSliderAndImageText()}}function populateImageAndCopySlider(records,refreshAfterSync){if(vm.slider&&!refreshAfterSync)refreshSliderAndImageText();else{vm.slides=[],vm.slideHeadings=[],vm.slideFooters=[],vm.modalSlides=[];for(var copyText=null,image=null,image2=null,slideHeading=null,slideFooter=null,i=0;i<records.length;i++)"Left Side Copy"==records[i].Display_Type__c&&(slideHeading=records[i].Text2__c,slideFooter=records[i].Text3__c,records[i].Image1__c&&(copyText=records[i].Image1__c)),"Left Side Image"==records[i].Display_Type__c&&(slideHeading=records[i].Text2__c,slideFooter=records[i].Text3__c,records[i].Image1__c&&(image=records[i].Image1__c,vm.modalSlides.push({image:records[i].Image1__c}))),"Right Side Image"==records[i].Display_Type__c&&records[i].Image1__c&&(image?image2=records[i].Image1__c:image=records[i].Image1__c,vm.modalSlides.push({image:records[i].Image1__c}),vm.slides.push({image:image,image2:image2,text:copyText}),vm.slideHeadings.push(slideHeading),vm.slideFooters.push(slideFooter),copyText=null,image=null,image2=null,slideHeading=null,slideFooter=null);vm.slides.length<=1&&hideSwiperPagination(vm.slidesId),refreshAfterSync&&refreshSliderAndImageText()}}function populateImageOrCopySlider(records,refreshAfterSync){if(vm.slider&&!refreshAfterSync)refreshSliderAndImageText();else{vm.slides=[];for(var i=0;i<records.length;i++){var image=null,copy=null,footerText=null,headerText=null,externalURL=null;"Copy"==records[i].Display_Type__c&&(headerText=records[i].Text1__c,copy=records[i].Image1__c,footerText=records[i].Text2__c,externalURL=records[i].Text3__c),"Image"==records[i].Display_Type__c&&(records[i].Image1__c&&(image=records[i].Image1__c),headerText=records[i].Text1__c,footerText=records[i].Text2__c,externalURL=records[i].Text3__c),vm.slides.push({image:image,text:copy,headerText:headerText,footerText:footerText,externalURL:externalURL})}vm.slides.length<=1&&hideSwiperPagination(vm.slidesId),refreshAfterSync&&refreshSliderAndImageText()}}function refreshSliderAndImageText(){resetSliderTimeout=$timeout(function(){vm.slider&&vm.slider.update(),adjustImageCaptionPosition(vm.imageCSSClass,vm.imageCaptionCSSClass,vm.slidesId),showingModal&&(vm.modalSlider.update(),adjustImageCaptionPosition(vm.imageCSSClassModal,vm.imageCaptionCSSClassModal,vm.modalSlidesId))},0)}function windowResizeHandler(){showingModal?adjustImageCaptionPosition(vm.imageCSSClassModal,vm.imageCaptionCSSClassModal,vm.modalSlidesId):(adjustImageCaptionPosition(vm.imageCSSClass,vm.imageCaptionCSSClass,vm.slidesId),$ionicScrollDelegate.scrollTop())}function showImageModal(index,templateName){$ionicModal.fromTemplateUrl($window.RESOURCE_ROOT+"templates/"+templateName+".html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){showingModal=!0,vm.imageModal=modal,vm.slides.length<=1?hideSwiperPagination(vm.modalSlidesId):showSwiperPagination(vm.modalSlidesId),vm.imageModal.show(),resetModalSliderTimeout=$timeout(function(){vm.modalSlider.slideTo(index,0)},0)})}function closeImageModal(){showingModal=!1,vm.slider.update(),vm.slider.slideTo(vm.modalSlider.activeIndex,0),adjustImageCaptionPosition(vm.imageCSSClass,vm.imageCaptionCSSClass,vm.slidesId),vm.imageModal&&(vm.imageModal.hide(),vm.imageModal.remove(),delete vm.imageModal)}function adjustImageCaptionPosition(imageClass,imageCaptionClass,slidesId){adjustImageTextTimeout=$timeout(function(){var slidesEl=$window.document.getElementById(slidesId),wrappedSlidesEl=angular.element(slidesEl),slidesHeight=null;wrappedSlidesEl&&wrappedSlidesEl.length>0&&(slidesHeight=wrappedSlidesEl[0].offsetHeight);var images=$window.document.getElementsByClassName(imageClass);if(images.length>0&&images[0].offsetWidth>0){for(var imageCaptions=$window.document.getElementsByClassName(imageCaptionClass),j=imageCaptions.length-1;j>=0;--j){var bottomAttr="";if(slidesHeight){var bottom=wrappedSlidesEl[0].offsetHeight-images[j].offsetHeight-images[j].offsetTop;bottomAttr=0>bottom?"bottom:0;":"bottom:"+bottom+"px;"}imageCaptions[j].setAttribute("style","width:"+images[j].offsetWidth+"px;left:"+images[j].offsetLeft+"px;display:block;"+bottomAttr)}imageCaptions=null}images=slidesEl=wrappedSlidesEl=null},0)}function hideSwiperPagination(slidesId){hideSwiperPaginationTimeout=$timeout(function(){var slidesEl=$window.document.getElementById(slidesId);if(slidesEl){var swiperPagination=slidesEl.querySelector("#"+slidesId+" > .swiper-container > .swiper-pagination"),wrappedSwiperPagination=angular.element(swiperPagination);wrappedSwiperPagination.css("display","none"),slidesEl=swiperPagination=wrappedSwiperPagination=null}},50)}function showSwiperPagination(slidesId){showSwiperPaginationTimeout=$timeout(function(){var slidesEl=$window.document.getElementById(slidesId);if(slidesEl){var swiperPagination=slidesEl.querySelector("#"+slidesId+" > .swiper-container > .swiper-pagination"),wrappedSwiperPagination=angular.element(swiperPagination);wrappedSwiperPagination.removeClass("ng-hide"),slidesEl=swiperPagination=wrappedSwiperPagination=null}},500)}function gotoPage(menuItem,menuName){$location.path("/app/contentitem/"+menuItem+"/"+encodeURIComponent(menuName))}function openWindow(url){"online"===NetworkService.getNetworkStatus()?openWindowTimeout=$timeout(function(){cordova.InAppBrowser?cordova.InAppBrowser.open(url,"_system","location=yes"):$window.open(url,"_system","location=yes")},0):alertOffline()}function alertOffline(){var alertPopup=$ionicPopup.alert({title:"No connection",template:"You need to be online to view",cssClass:"bio-popup"});alertPopup.then(function(res){})}function goBack(){$ionicHistory.backView()?$ionicHistory.goBack():"toi"===vm.menuItem||"e-learn"===vm.menuItem||"bio"===vm.menuItem?$rootScope.$emit("showSideMenu"):"terms"===vm.menuItem?$rootScope.$emit("showSettingsMenu"):$rootScope.$emit("showStimulanMenu")}function goHome(){$state.go("app.home")}function destroyReferences(){logger.log("ContentItemCtrl destroyReferences"),deregisterIonicViewEnter(),deregisterIonicViewLeave(),deregisterHandleSyncTables(),$timeout.cancel(resetSliderTimeout),$timeout.cancel(resetModalSliderTimeout),$timeout.cancel(adjustImageTextTimeout),$timeout.cancel(openWindowTimeout),$timeout.cancel(hideSwiperPaginationTimeout),$timeout.cancel(showSwiperPaginationTimeout),$timeout.cancel(slideNextStartTimeout),$timeout.cancel(slidePrevStartTimeout),$timeout.cancel(updateTimeout),vm.slider&&(vm.slider.off("slideNextStart"),vm.slider.off("slidePrevStart"))}logger.log("in ContentItemCtrl"),console.log("bio in ContentItemCtrl<<<<<<<<<<<");var resetSliderTimeout,resetModalSliderTimeout,adjustImageTextTimeout,openWindowTimeout,hideSwiperPaginationTimeout,showSwiperPaginationTimeout,slideNextStartTimeout,slidePrevStartTimeout,updateTimeout,showingModal,vm=this;vm.menuItem=$stateParams.menuItem,vm.imageCSSClass="slide-image-"+$stateParams.menuItem,vm.imageCaptionCSSClass="slide-caption-text-"+$stateParams.menuItem,vm.imageCSSClassModal="modal-slide-image-"+$stateParams.menuItem,vm.imageCaptionCSSClassModal="modal-slide-caption-text-"+$stateParams.menuItem,vm.slidesId="slides-"+$stateParams.menuItem,vm.modalSlidesId="modal-slides-"+$stateParams.menuItem,vm.twinImagesSliderOptions={slidesPerView:2,breakpoints:{768:{slidesPerView:1}}},vm.showImageModal=showImageModal,vm.closeImageModal=closeImageModal,vm.gotoPage=gotoPage,vm.openWindow=openWindow,vm.goBack=goBack,vm.goHome=goHome,activate(!1);var deregisterIonicViewEnter=$scope.$on("$ionicView.enter",function(scopes,states){refreshSliderAndImageText(),angular.element($window).on("resize",windowResizeHandler)}),deregisterIonicViewLeave=($scope.$on("$ionicView.afterEnter",function(scopes,states){updateTimeout=$timeout(function(){vm.title=decodeURIComponent($stateParams.menuName)},0)}),$scope.$on("$ionicView.leave",function(scopes,states){angular.element($window).off("resize",windowResizeHandler),vm.slider&&vm.slider.slideTo(0,0),"Menu_List.html"==vm.contentItemTemplate&&$ionicScrollDelegate.scrollTop()}));$scope.$watch("vm.slider",function(slider){slider&&(adjustImageCaptionPosition(vm.imageCSSClass,vm.imageCaptionCSSClass,vm.slidesId),vm.slider.on("slideNextStart",function(){slideNextStartTimeout=$timeout(function(){$scope.$apply()},0)}),vm.slider.on("slidePrevStart",function(){slidePrevStartTimeout=$timeout(function(){$scope.$apply()},0)}))}),$scope.$watch("vm.modalSlider",function(slider){slider&&adjustImageCaptionPosition(vm.imageCSSClassModal,vm.imageCaptionCSSClassModal,vm.modalSlidesId)});var deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){if(logger.log("ContentItemCtrl syncTables: "+JSON.stringify(args)),console.log("bio ContentItemCtrl syncTables: "+JSON.stringify(args)),args.result.toString().indexOf("TableComplete")>=0){var syncedTable=args.result.replace("TableComplete ","");"Content_Item__ap"==syncedTable&&activate(!0)}});$scope.$on("$destroy",function(){logger.log("ContentItemCtrl $destroy"),console.log("bio ContentItemCtrl $destroy<<<<<<<<<<<"),destroyReferences()})}angular.module("starter.controllers").controller("ContentItemCtrl",ContentItemCtrl),ContentItemCtrl.$inject=["$rootScope","$scope","$stateParams","$ionicLoading","$window","$timeout","$ionicModal","$location","$ionicScrollDelegate","$ionicPopup","$ionicHistory","$state","logger","ContentItemService","NetworkService"]}(),function(){"use strict";function DeployCtrl($scope,DeployService){function iconForErr(errType){switch(errType){case"info":return"ion-information-circled";default:return"ion-close-round"}}var messages=[{message:"Uploading bundle...",type:""}],appConfig={};$scope.messages=messages,DeployService.getDetails().then(function(data){return console.log("data",data),appConfig=data,DeployService.deployBunlde(appConfig)}).then(function(res){console.dir(res);var msg={message:res,type:"ok",icon:"ion-checkmark-round"};return $scope.$apply(function(){$scope.messages.push(msg),msg={message:"Uploading cache manifest...",type:""},$scope.messages.push(msg)}),DeployService.uploadCachePage(appConfig)}).then(function(res){console.dir(res);var msg={message:res,type:"ok",icon:"ion-checkmark-round"};return $scope.$apply(function(){$scope.messages.push(msg),msg={message:"Uploading start page...",type:""},$scope.messages.push(msg)}),DeployService.uploadStartPage(appConfig)}).then(function(res){console.dir(res);var msg={message:res,type:"ok",icon:"ion-checkmark-round"};$scope.$apply(function(){$scope.messages.push(msg),msg={message:"Deploy Completed successfully.",type:"final"},$scope.messages.push(msg)})})["catch"](function(err){var msg={message:err.message,type:err.type,icon:iconForErr(err.type)};$scope.$apply(function(){$scope.messages.push(msg),"error"!=err.type&&(msg={message:"Deploy Completed successfully.",type:"final"},$scope.messages.push(msg))}),console.debug(err)})}angular.module("starter.controllers").controller("DeployCtrl",DeployCtrl),DeployCtrl.$inject=["$scope","DeployService"]}(),function(){"use strict";function SettingsHBCtrl($scope,NetworkService){localStorage.connection?$scope.heartbeatStatus=localStorage.connection:$scope.heartbeatStatus=100100,$scope.hbUpdate=function(){localStorage.connection=$scope.heartbeatStatus,100100==$scope.heartbeatStatus&&NetworkService.networkEvent("online"),100103==$scope.heartbeatStatus&&NetworkService.networkEvent("offline")}}angular.module("starter.controllers").controller("SettingsHBCtrl",SettingsHBCtrl),SettingsHBCtrl.$inject=["$scope","NetworkService"]}(),function(){"use strict";function HomeCtrl($rootScope,$scope,$ionicLoading,$window,$timeout,logger,UserService){function activate(){UserService.getUserFirstName().then(function(result){vm.userFirstName="Hello "+result}),UserService.hasDoneProcess("initialDataLoaded").then(function(result){result||$ionicLoading.show({template:'<p id="app-progress-msg" class="item-icon-left"><h3>Loading Data...</h3><ion-spinner></ion-spinner></p>',animation:"fade-in",showBackdrop:!0,maxWidth:600,duration:0})})}function showStimulanSideMenu(){$rootScope.$emit("showStimulanMenu")}logger.log("in HomeCtrl"),console.log("bio in HomeCtrl");var slideInTimeout,vm=this;vm.titleImage=$window.RESOURCE_ROOT+"images/Biocomposites-header-logo.SVG",vm.homeImage=$window.RESOURCE_ROOT+"images/home.jpg",vm.orderFormSVG=$window.RESOURCE_ROOT+"images/order-form-home-icon.SVG",vm.unsolicitedSVG=$window.RESOURCE_ROOT+"images/unsolicited-request-home-icon.SVG",vm.stimulanSVG=$window.RESOURCE_ROOT+"images/stimulan-home-icon.SVG",vm.topicSVG=$window.RESOURCE_ROOT+"images/topics-of-interest-home-icon.SVG",vm.slideInHomePage=!0,vm.showStimulanSideMenu=showStimulanSideMenu,activate(),slideInTimeout=$timeout(function(){vm.slideInHomePage=!1},1e3),$scope.$on("$destroy",function(){logger.log("HomeCtrl destroy"),console.log("bio HomeCtrl destroy"),$timeout.cancel(slideInTimeout)})}angular.module("starter.controllers").controller("HomeCtrl",HomeCtrl),HomeCtrl.$inject=["$rootScope","$scope","$ionicLoading","$window","$timeout","logger","UserService"]}(),function(){"use strict";function LeadCaptureCtrl($rootScope,$scope,$ionicPopup,$state,$ionicLoading,$timeout,$ionicScrollDelegate,logger,SyncService,NetworkService,RecordTypeService,MobileDynamicService,LocalNotificationService){function activate(){angular.copy(initialLead,vm.lead),vm.showBackButton=!0,RecordTypeService.getRecordTypeId("Mobile_Lead","Mobile_Dynamic__c").then(function(id){recordTypeId=id})}function gotoStep(step){"eventinfo"==step&&(vm.showCancel=!0,$rootScope.$emit("disableSideMenu",{showSideMenu:!1}),SyncService.setSyncLock("true"),vm.newLeadTitle="- new lead"),"eventinfo"==step&&""!==vm.lead.eventName.trim()&&(vm.showBackButton=!1),"default"==step&&(vm.newLeadTitle="",vm.showCancel=!1,activate(),$rootScope.$emit("disableSideMenu",{showSideMenu:!0}),SyncService.setSyncLock("false")),vm.step=step,scrollTimeout=$timeout(function(){$ionicScrollDelegate.scrollTop()},50)}function inputValidation(nextStepIfValid){if("leadinfo"===nextStepIfValid&&""===vm.lead.eventName.trim())return void showAlert("Error","Please enter an event name.");if("leadinfo2"===nextStepIfValid){if(""===vm.lead.firstName.trim())return void showAlert("Error","Please enter a first name.");if(""===vm.lead.lastName.trim())return void showAlert("Error","Please enter a last name.")}if("contactinfo"===nextStepIfValid){if(""===vm.lead.jobTitle.trim())return void showAlert("Error","Please enter a job title.");if(""===vm.lead.hospital.trim())return void showAlert("Error","Please enter a hospital/institution.")}if("topic"===nextStepIfValid){if(console.log("bio vm.lead",vm.lead),!vm.lead.email&&""===vm.lead.telephone.trim())return void showAlert("Error","Please enter either a valid e-mail address or a telephone number.");if(null!==vm.lead.email&&""!==vm.lead.email&&("undefined"==vm.lead.email||!validateEmail(vm.lead.email)))return void showAlert("Error","Please enter a valid e-mail address.")}return"submit"===nextStepIfValid?"Select product"===vm.lead.product?void showAlert("Error","Please select a product."):""===vm.lead.notes.trim()?void showAlert("Error","Please enter your notes."):void submitLeadCapture():void gotoStep(nextStepIfValid)}function submitLeadCapture(){$ionicLoading.show({duration:5e3,template:"Saving lead...",animation:"fade-in",showBackdrop:!0}),MobileDynamicService.insertRecord(buildLeadRecord()).then(function(resObject){$ionicLoading.hide(),"online"===NetworkService.getNetworkStatus()?(SyncService.setSyncLock("false"),SyncService.syncTables(["Mobile_Dynamic__ap"]),submitSuccessful=!0,exitLeadCapture()):($rootScope.$emit("updateOutboxCount"),LocalNotificationService.setLocalNotification(),alertOffline())})["catch"](function(e){logger.error("submitLeadCapture "+JSON.stringify(e)+" "+JSON.stringify(orderForm)),$ionicLoading.hide()})}function buildLeadRecord(){var lead={};return lead.Name="TMP-"+(new Date).valueOf(),lead.Event_Name__c=vm.lead.eventName,lead.Title_Designation__c=vm.lead.title,lead.First_Name__c=vm.lead.firstName,lead.Last_Name__c=vm.lead.lastName,lead.Job_Title__c=vm.lead.jobTitle,lead.Hospital_Institution__c=vm.lead.hospital,vm.lead.email?lead.Email__c=vm.lead.email:lead.Email__c="",vm.lead.telephone&&(lead.Telephone__c=vm.lead.telephone),vm.lead.country&&(lead.Country__c=vm.lead.country),vm.lead.address&&(lead.Address__c=vm.lead.address),vm.lead.state&&(lead.State__c=vm.lead.state),vm.lead.zip&&(lead.ZIP__c=vm.lead.zip),lead.Product__c=vm.lead.product,lead.Notes__c=vm.lead.notes,""!==recordTypeId&&(lead.RecordTypeId=recordTypeId),lead.Date_Entered__c=new Date,lead}function cancelLeadCapture(){var confirmPopup=$ionicPopup.confirm({title:"Cancel",template:"Are you sure?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res&&exitLeadCapture()})}function exitLeadCapture(){$rootScope.$emit("disableSideMenu",{showSideMenu:!0}),SyncService.setSyncLock("false"),submitSuccessful?alertSuccess():$state.go("app.home")}function alertSuccess(){var alertPopup=$ionicPopup.alert({title:"New lead",template:"Submission successful",cssClass:"bio-popup"});alertPopup.then(function(res){res&&$state.go("app.home")})}function alertOffline(){var alertPopup=$ionicPopup.alert({title:"You are currently offline",template:"Synchronisation will take place when you are next online",cssClass:"bio-popup"});alertPopup.then(function(res){res&&exitLeadCapture()})}function showAlert(title,template){var alertPopup=$ionicPopup.alert({title:title,template:template,cssClass:"bio-popup"});alertPopup.then(function(res){})}function validateEmail(email){var re=/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(email)}logger.log("in LeadCaptureCtrl"),console.log("bio in LeadCaptureCtrl");var recordTypeId,scrollTimeout,vm=this,initialLead={eventName:"",title:"",firstName:"",lastName:"",jobTitle:"",hospital:"",email:null,telephone:"",country:"",address:"",state:"",zip:"",product:"Select product",notes:""},submitSuccessful=!1;vm.showCancel=!1,vm.today=new Date,vm.newLeadTitle="",vm.lead={},vm.gotoStep=gotoStep,vm.inputValidation=inputValidation,vm.submitLeadCapture=submitLeadCapture,vm.cancelLeadCapture=cancelLeadCapture,activate(),$scope.$on("$destroy",function(){logger.log("LeadCaptureCtrl destroy"),console.log("bio LeadCaptureCtrl destroy"),$timeout.cancel(scrollTimeout)})}angular.module("starter.controllers").controller("LeadCaptureCtrl",LeadCaptureCtrl),LeadCaptureCtrl.$inject=["$rootScope","$scope","$ionicPopup","$state","$ionicLoading","$timeout","$ionicScrollDelegate","logger","SyncService","NetworkService","RecordTypeService","MobileDynamicService","LocalNotificationService"]}(),function(){"use strict";function LeadHistoryCtrl($rootScope,$scope,$window,$ionicLoading,$ionicModal,$state,logger,RecordTypeService,MobileDynamicService){function activate(){$ionicLoading.show({duration:5e3,template:"Loading...",animation:"fade-in",showBackdrop:!0}),vm.leads=[],RecordTypeService.getRecordTypeId("Mobile_Lead","Mobile_Dynamic__c").then(function(recordTypeId){return MobileDynamicService.getRecords(recordTypeId)}).then(function(records){for(var i=0;i<records.length;i++)-1==records[i].Id.indexOf("PROXY")&&vm.leads.push(records[i]);console.log("bio vm.leads",vm.leads),$ionicLoading.hide()})}function showModal(record){$ionicModal.fromTemplateUrl($window.RESOURCE_ROOT+"templates/leadDetail.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){vm.modal=modal,vm.modal.lead=record,console.log("bio showModal vm.modal.lead",vm.modal.lead),vm.modal.show()})}function closeModal(){console.log("bio closeModal"),vm.modal&&(vm.modal.hide(),vm.modal.remove(),delete vm.modal)}function goHome(){$state.go("app.home")}logger.log("in LeadHistoryCtrl"),console.log("bio in LeadHistoryCtrl");var vm=this;vm.showModal=showModal,vm.closeModal=closeModal,vm.goHome=goHome,activate();var deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){if(logger.log("LeadHistoryCtrl syncTables: "+JSON.stringify(args)),console.log("bio LeadHistoryCtrl syncTables: "+JSON.stringify(args)),args.result.toString().indexOf("TableComplete")>=0){var syncedTable=args.result.replace("TableComplete ","");"Mobile_Dynamic__ap"==syncedTable&&activate()}});$scope.$on("$destroy",function(){logger.log("LeadHistoryCtrl destroy"),console.log("bio LeadHistoryCtrl destroy"),deregisterHandleSyncTables(),vm.modal&&(vm.modal.remove(),delete vm.modal)})}angular.module("starter.controllers").controller("LeadHistoryCtrl",LeadHistoryCtrl),LeadHistoryCtrl.$inject=["$rootScope","$scope","$window","$ionicLoading","$ionicModal","$state","logger","RecordTypeService","MobileDynamicService"]}(),function(){"use strict";function MenuCtrl($rootScope,$scope,$timeout,$ionicLoading,$ionicSideMenuDelegate,$location,$state,$ionicScrollDelegate,logger,MenuService,SyncService,UserService,RecordTypeService,OutboxService,LocalNotificationService){function activate(){MenuService.getSideMenuJson().then(function(sidemenu){sidemenu&&sidemenu[0].length>0?(vm.allSideMenuOptions=sidemenu[0],vm.stimulanMenuOption=sidemenu[1],vm.settingsMenuOption=sidemenu[2],vm.menuOptions=vm.allSideMenuOptions,setRecordTypes(),updateOutboxCount(),menuRefreshTimeout=$timeout(function(){$scope.$apply(),$ionicLoading.hide()},0)):MenuService.buildAndSetSideMenuJson().then(function(result){vm.allSideMenuOptions=result[0],vm.stimulanMenuOption=result[1],vm.settingsMenuOption=result[2],vm.menuOptions=vm.allSideMenuOptions,vm.allSideMenuOptions.length>0&&(setRecordTypes(),updateOutboxCount(),menuRefreshTimeout=$timeout(function(){$scope.$apply(),$ionicLoading.hide()},5e3))})})}function showSubmenu(item){vm.menuOptions=item.submenu,vm.selectedItem=item,$ionicScrollDelegate.scrollTop()}function goBack(){if(vm.selectedItem)if(0===vm.selectedItem.parentid)vm.menuOptions=vm.allSideMenuOptions,vm.selectedItem=null;else{var parentItem=findItemById(vm.allSideMenuOptions,vm.selectedItem.parentid);showSubmenu(parentItem)}}function findItemById(obj,id){if(obj.id==id)return obj;for(var i in obj)if(null!==obj[i]&&"object"==typeof obj[i]){var result=findItemById(obj[i],id);if(result)return result}return null}function doRefreshAndSync(){SyncService.syncTables(["Mobile_Refresh__ap","Content_Item__ap","DOF__ap","DOF_Item__ap","Mobile_Dynamic__ap","Surgeon_in_Hospital__ap"])}function gotoPage(path){gotoPageTimeout=$timeout(function(){goBack(),$location.path(path)},0)}function setRecordTypes(){RecordTypeService.readAndSetRecordTypes()}function checkForMenuChanges(){MenuService.buildAndSetSideMenuJson().then(function(result){var reloadMenu=!1,newAllSideMenuOptions=result[0],newStimulanMenuOption=result[1],currentMainMenuOptionNames=_.pluck(vm.allSideMenuOptions,"name"),newMainMenuOptionNames=_.pluck(newAllSideMenuOptions,"name");newMainMenuOptionNames.join()!==currentMainMenuOptionNames.join()&&(reloadMenu=!0);var currentStimulanMenuOptionNames=_.pluck(vm.stimulanMenuOption.submenu,"name"),newStimulanMenuOptionNames=_.pluck(newStimulanMenuOption.submenu,"name");newStimulanMenuOptionNames.join()!==currentStimulanMenuOptionNames.join()&&(reloadMenu=!0),reloadMenu&&(vm.allSideMenuOptions=newAllSideMenuOptions,vm.stimulanMenuOption=newStimulanMenuOption,vm.menuOptions=vm.allSideMenuOptions,vm.selectedItem&&goBack())})}function displayFeedbackMsg(msg){vm.feedbackMsgText=msg,vm.showFeedbackMsg=!0}function delayHidingOfFeedbackMsg(delay){feedbackTimeout=$timeout(function(){vm.showFeedbackMsg=!1},delay)}function displaySyncingMessageAgain(){feedbackTimeout=$timeout(function(){displayFeedbackMsg("Syncing...")},3e3)}function updateOutboxCount(){OutboxService.getDirtyRecordsCount().then(function(result){result>0?vm.outboxCount=" ("+result+")":vm.outboxCount=""})}var feedbackTimeout,gotoPageTimeout,menuRefreshTimeout,vm=this;vm.allSideMenuOptions=[],vm.stimulanMenuOption={},vm.settingsMenuOption={},vm.menuOptions=[],vm.selectedItem=null,vm.feedbackMsgText="",vm.showFeedbackMsg=!1,vm.showSideMenu=!0,vm.showSubmenu=showSubmenu,vm.goBack=goBack,vm.doRefreshAndSync=doRefreshAndSync,vm.gotoPage=gotoPage,activate();var deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){switch(logger.log("MenuCtrl syncTables: "+JSON.stringify(args)),console.log("bio MenuCtrl syncTables: "+JSON.stringify(args)),args.result.toString()){case"StartSync":displayFeedbackMsg("Syncing...");break;case"Complete":LocalNotificationService.cancelNotification(),delayHidingOfFeedbackMsg(0);break;case"InitialLoadComplete":activate(),UserService.setProcessDone("initialDataLoaded");break;case"100497":displayFeedbackMsg("Sync too soon, please try again in a minute"),delayHidingOfFeedbackMsg(3e3);break;case"100498":displayFeedbackMsg("Sync already in progress"),displaySyncingMessageAgain();break;case"100402":displayFeedbackMsg("Please connect before syncing"),LocalNotificationService.setLocalNotification(),delayHidingOfFeedbackMsg(3e3);break;default:if(args.result.toString().indexOf("Error")>=0)displayFeedbackMsg(args.result.toString()),delayHidingOfFeedbackMsg(3e3);else if(args.result.toString().indexOf("TableComplete")>=0){var syncedTable=args.result.replace("TableComplete ","");("DOF__ap"==syncedTable||"Mobile_Dynamic__ap"==syncedTable)&&updateOutboxCount(),"Mobile_Refresh__ap"==syncedTable&&(checkForMenuChanges(),setRecordTypes())}}}),deregisterHandleSetSideMenuVisibility=$rootScope.$on("disableSideMenu",function(event,args){vm.showSideMenu=args.showSideMenu,$ionicSideMenuDelegate.canDragContent(args.showSideMenu)}),deregisterHandleShowStimulan=$rootScope.$on("showStimulanMenu",function(event,args){showSubmenu(vm.stimulanMenuOption),$ionicSideMenuDelegate.toggleLeft()}),deregisterHandleShowSettings=$rootScope.$on("showSettingsMenu",function(event,args){showSubmenu(vm.settingsMenuOption),$ionicSideMenuDelegate.toggleLeft()}),deregisterHandleShowSideMenu=$rootScope.$on("showSideMenu",function(event,args){$ionicSideMenuDelegate.toggleLeft()}),deregisterHandleUpdateOutboxCount=$rootScope.$on("updateOutboxCount",function(event,args){updateOutboxCount()});$scope.$on("$destroy",function(){logger.log("MenuCtrl destroy"),console.log("bio MenuCtrl destroy"),deregisterHandleSyncTables(),deregisterHandleSetSideMenuVisibility(),deregisterHandleShowStimulan(),deregisterHandleShowSettings(),deregisterHandleUpdateOutboxCount(),deregisterHandleShowSideMenu(),$timeout.cancel(feedbackTimeout),$timeout.cancel(gotoPageTimeout),$timeout.cancel(menuRefreshTimeout)})}angular.module("starter.controllers").controller("MenuCtrl",MenuCtrl),MenuCtrl.$inject=["$rootScope","$scope","$timeout","$ionicLoading","$ionicSideMenuDelegate","$location","$state","$ionicScrollDelegate","logger","MenuService","SyncService","UserService","RecordTypeService","OutboxService","LocalNotificationService"]}(),function(){"use strict";function MTICtrl($scope,$rootScope,$location,$ionicPopup,$ionicLoading,DevService,devUtils,logger){var adminTimeout=3e5;if($rootScope.adminLoggedIn>Date.now()-adminTimeout);else{$location.url("app/settings");var alertPopup=$ionicPopup.alert({title:"Access Denied"});alertPopup.then(function(res){$scope.$apply()})}DevService.allTables().then(function(tables){$scope.tables=tables},function(reason){console.error("Angular: promise returned reason -> "+reason)}),$scope.showTable=function(tableName){$location.path(decodeURIComponent("/app/settings/mti/"+tableName))},$scope.syncTable=function(tableName){var confirmPopup=$ionicPopup.confirm({title:"Sync Table",template:"<div style='text-align:center;'>Are you sure you want to sync "+tableName+"?</div>",
cancelText:"No",okText:"Yes"});confirmPopup.then(function(res){res&&($ionicLoading.show({duration:1e4,template:"Syncing "+tableName+" ..."}),devUtils.syncMobileTable(tableName).then(function(resObject){$ionicLoading.hide()})["catch"](function(e){logger.error("syncTable from settings "+tableName+" "+JSON.stringify(e)),$ionicLoading.hide();$ionicPopup.alert({title:"Operation failed!",template:'<p>Sorry, something went wrong.</p><p class="error_details">Error: '+e.status+" - "+e.mc_add_status+"</p>"})}))})},$scope.saveTableToML=function(tableName){var confirmPopup=$ionicPopup.confirm({title:"Save Table To Mobile Log",template:"<div style='text-align:center;'>Are you sure you want to save "+tableName+"?</div>",cancelText:"No",okText:"Yes"});confirmPopup.then(function(res){res&&($ionicLoading.show({duration:1e4,template:"Saving "+tableName+" ..."}),DevService.allRecords(tableName,!1).then(function(tableRecs){return DevService.insertMobileLog(tableRecs)}).then(function(resObject){$ionicLoading.hide()})["catch"](function(e){logger.error("saveTableToML "+tableName+" "+JSON.stringify(e)),$ionicLoading.hide();$ionicPopup.alert({title:"Operation failed!",template:'<p>Sorry, something went wrong.</p><p class="error_details">Error: '+e.status+" - "+e.mc_add_status+"</p>"})}))})}}angular.module("starter.controllers").controller("MTICtrl",MTICtrl),MTICtrl.$inject=["$scope","$rootScope","$location","$ionicPopup","$ionicLoading","DevService","devUtils","logger"]}(),function(){"use strict";function MTIDetailCtrl($scope,$stateParams,$ionicLoading,$ionicModal,DevService){$ionicLoading.show({duration:3e4,noBackdrop:!0,template:'<p id="app-progress-msg" class="item-icon-left"><i class="icon ion-loading-c"></i>Fetching records...</p>'}),$scope.table={Name:$stateParams.tableName},DevService.allRecords($stateParams.tableName,!1).then(function(tableRecs){$scope.tableRecs=tableRecs,$ionicLoading.hide()},function(reason){console.error("Angular: promise returned error -> "+reason)}),$scope.getItemHeight=function(item,index){return"undefined"!=typeof item?100+55*item.length:0},$scope.search={},$scope.clearSearch=function(){$scope.search.query=""},$scope.showRecord=function(tableRec,soupRecordId){$ionicLoading.show({duration:1e4,template:"Loading..."});for(var tableName,i=0,len=tableRec.length;len>i;i++)"Mobile_Table_Name"==tableRec[i].Name&&(tableName=tableRec[i].Value);console.log("tableName",tableName,soupRecordId),DevService.getRecordForSoupEntryId(tableName,soupRecordId).then(function(record){console.log("record",record),$scope.showTableRecord(tableName,record,soupRecordId),$ionicLoading.hide()},function(reason){$ionicLoading.hide(),console.error("getRecordForSoupEntryId "+reason)})},$scope.showTableRecord=function(tableName,record,soupRecordId){$ionicModal.fromTemplateUrl("settingDevMTITableRecord.html",function(modal){$scope.tableRecordModal=modal,$scope.tableRecordModal.tableName=tableName,$scope.tableRecordModal.record=record,$scope.tableRecordModal.soupRecordId=soupRecordId,$scope.tableRecordModal.show()},{scope:$scope,animation:"slide-in-up",backdropClickToClose:!1})},$scope.closeShowTableRecord=function(){$scope.tableRecordModal.hide(),$scope.tableRecordModal.remove(),delete $scope.tableRecordModal},$scope.reorder=function(){$scope.tableRecs=$scope.tableRecs.reverse()}}angular.module("starter.controllers").controller("MTIDetailCtrl",MTIDetailCtrl),MTIDetailCtrl.$inject=["$scope","$stateParams","$ionicLoading","$ionicModal","DevService"]}(),function(){"use strict";function OrderHistoryCtrl($rootScope,$scope,$ionicLoading,$window,$ionicModal,$state,logger,OrderFormService,UserService){function activate(){$ionicLoading.show({duration:5e3,template:"Loading...",animation:"fade-in",showBackdrop:!0}),UserService.getUserCurrencySymbol().then(function(result){vm.currencySymbol=result}),vm.orders=[],vm.orderItems=[],OrderFormService.getOrders().then(function(records){for(var i=0;i<records.length;i++)if(-1==records[i].Id.indexOf("PROXY")){var hospitalNotification;hospitalNotification="Do not send"==records[i].Send_Confirmation__c?records[i].Send_Confirmation__c:"Send to alternative address"==records[i].Send_Confirmation__c?"alternative e-mail address - "+records[i].Alternative_Email__c:"e-mail address on file - "+records[i].Hospital_Email__c,vm.orders.push({record:records[i],items:[],hospitalNotification:hospitalNotification})}return OrderFormService.getOrderItems()}).then(function(records){for(var j=0;j<records.length;j++)for(var k=0;k<vm.orders.length;k++)vm.orders[k].record.Id==records[j].DOF__c&&(records[j].Product_Name__c?vm.orders[k].items.push({productName:records[j].Product_Name__c,lotNumber:records[j].Lot_Number__c,price:records[j].Entered_Price__c,expiryDate:records[j].Expiry_Date__c}):vm.orders[k].items.push({lotNumber:records[j].Lot_Number__c,price:records[j].Entered_Price__c}));$ionicLoading.hide()})}function showModal(order){$ionicModal.fromTemplateUrl($window.RESOURCE_ROOT+"templates/orderDetail.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){vm.modal=modal,vm.modal.order=order,vm.modal.show()})}function closeModal(){vm.modal&&(vm.modal.hide(),vm.modal.remove(),delete vm.modal)}function goHome(){$state.go("app.home")}logger.log("in OrderHistoryCtrl"),console.log("bio in OrderHistoryCtrl");var vm=this;vm.showModal=showModal,vm.closeModal=closeModal,vm.goHome=goHome,activate();var deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){if(logger.log("OrderHistoryCtrl syncTables: "+JSON.stringify(args)),args.result.toString().indexOf("TableComplete")>=0){var syncedTable=args.result.replace("TableComplete ","");"DOF_Item__ap"==syncedTable&&activate()}});$scope.$on("$destroy",function(){logger.log("OrderHistoryCtrl destroy"),console.log("bio OrderHistoryCtrl destroy"),deregisterHandleSyncTables(),vm.modal&&(vm.modal.remove(),delete vm.modal)})}angular.module("starter.controllers").controller("OrderHistoryCtrl",OrderHistoryCtrl),OrderHistoryCtrl.$inject=["$rootScope","$scope","$ionicLoading","$window","$ionicModal","$state","logger","OrderFormService","UserService"]}(),function(){"use strict";function OrderFormCtrl($rootScope,$scope,$window,$ionicPopup,$state,$ionicLoading,$timeout,$cordovaBarcodeScanner,$ionicScrollDelegate,logger,OrderFormService,SyncService,RecentItemsService,NetworkService,LocalNotificationService,UserService){function activate(){OrderFormService.getProducts().then(function(records){vm.allProducts=records}),vm.hospitals=[],OrderFormService.getHospitals().then(function(records){for(var h=0;h<records.length;h++)vm.hospitals.push({id:records[h].Hospital__c,name:records[h].Hospital_Name__c,email:records[h].Hospital_Email__c})}),vm.allSurgeons=[],OrderFormService.getSurgeons().then(function(records){for(var s=0;s<records.length;s++)vm.allSurgeons.push({id:records[s].Surgeon__c,name:records[s].Salutation__c+" "+records[s].First_Name__c+" "+records[s].Last_Name__c,hospitalId:records[s].Hospital__c})}),RecentItemsService.getRecentItems("recentHospitals").then(function(recentItems){vm.recentHospitals=recentItems,recentItems.length>7&&RecentItemsService.setRecentItems("recentHospitals",recentItems.slice(0,7))}),RecentItemsService.getRecentItems("recentSurgeons").then(function(recentItems){vm.allRecentSurgeons=recentItems,recentItems.length>40&&RecentItemsService.setRecentItems("recentSurgeons",recentItems.slice(0,40))}),vm.showManualInputBackButton=!0,UserService.getUserCurrencySymbol().then(function(result){vm.currencySymbol=result})}function gotoStep(step){("manual"==step||"scangood"==step||"scanbad"==step)&&(vm.showCancel=!0,$rootScope.$emit("disableSideMenu",{showSideMenu:!1}),SyncService.setSyncLock("true"),checkRecentHospitalsAreStillValid(),checkRecentSurgeonsAreStillValid()),"confirmation"==step&&(vm.isFirstTimeThru=!1,createSignaturePad()),"default"==step&&(vm.showCancel=!1,$rootScope.$emit("disableSideMenu",{showSideMenu:!0}),SyncService.setSyncLock("false")),"manualinputgood"==step&&(vm.showManualInputBackButton=!1),vm.step=step,scrollTimeout=$timeout(function(){$ionicScrollDelegate.scrollTop()},50)}function createSignaturePad(){signaturePadTimeout=$timeout(function(){var canvas=angular.element(document.getElementById("signatureCanvas"))[0];resizeCanvas(canvas),signaturePad=new SignaturePad(canvas,{backgroundColor:"#FFFFFF",minWidth:1,maxWidth:1.5,onBegin:onBeginSignature,onEnd:onEndSignature}),signatureDataURL&&signaturePad.fromDataURL(signatureDataURL),canvas=null},0)}function onBeginSignature(){onBeginSignatureTimeout=$timeout(function(){$ionicScrollDelegate.freezeAllScrolls(!0)},0)}function onEndSignature(){onEndSignatureTimeout=$timeout(function(){$ionicScrollDelegate.freezeAllScrolls(!1),signatureDataURL=signaturePad.toDataURL()},0)}function displayNewManualInput(step){vm.manualInput={},vm.manualInput.lotNumber={part1:null,part2:null,part3:"",part4:""},vm.manualInput.price=null,vm.manualInput.isCharge=!0,vm.manualInput.isNoCharge=!1,vm.product=null,vm.gotoStep(step)}function manualInputValidation(nextStepIfValid){null===vm.manualInput.lotNumber.part1||null===vm.manualInput.lotNumber.part2||""===vm.manualInput.lotNumber.part1||""===vm.manualInput.lotNumber.part2?showAlert("Error","Please enter all parts of the lot number."):vm.manualInput.lotNumber.part1<0||vm.manualInput.lotNumber.part1>99?showAlert("Error","The first part of the lot number can only be a maximum of two digits."):vm.manualInput.lotNumber.part2<0||vm.manualInput.lotNumber.part2>99?showAlert("Error","The second part of the lot number can only be a maximum of two digits."):""===vm.manualInput.lotNumber.part3.trim()?showAlert("Error","Please enter all parts of the lot number."):(vm.manualInput.lotNumberCombined=("00"+vm.manualInput.lotNumber.part1).slice(-2)+"/"+("00"+vm.manualInput.lotNumber.part2).slice(-2)+"-"+vm.manualInput.lotNumber.part3+(""!==vm.manualInput.lotNumber.part4.trim()?"/"+vm.manualInput.lotNumber.part4.trim():""),gotoStep(nextStepIfValid))}function manualInputPriceValidation(nextStepIfValid){!vm.manualInput.isCharge||null!==vm.manualInput.price&&0!==vm.manualInput.price?manualInputPriceValidationContinued(nextStepIfValid):confirmManualInputNoPrice(nextStepIfValid)}function confirmManualInputNoPrice(nextStepIfValid){var confirmPopup=$ionicPopup.confirm({title:"No Price Entered",template:"Would you like to enter a price?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res||(vm.manualInput.price=0,manualInputPriceValidationContinued(nextStepIfValid))})}function manualInputPriceValidationContinued(nextStepIfValid){return vm.manualInput.isNoCharge&&null!==vm.manualInput.price?void showAlert("Error","You have entered a price, but selected no charge."):void(vm.manualInput.isCharge&&!isValidPrice(vm.manualInput.price)?showAlert("Error","Please enter a valid price."):(vm.manualInput.isNoCharge&&(vm.manualInput.price=0),vm.selectedProducts.push({id:"MANUAL-"+(new Date).valueOf(),lotNumber:vm.manualInput.lotNumberCombined,price:vm.manualInput.price,isCharge:vm.manualInput.isCharge,isNoCharge:vm.manualInput.isNoCharge}),"selecthospital"==nextStepIfValid?displayHospitalSelection(nextStepIfValid):gotoStep(nextStepIfValid)))}function scannedProductDetailsValidation(nextStepIfValid){!vm.product.isCharge||null!==vm.product.price&&0!==vm.product.price?scannedProductDetailsValidationContinued(nextStepIfValid):confirmScannedInputNoPrice(nextStepIfValid)}function confirmScannedInputNoPrice(nextStepIfValid){var confirmPopup=$ionicPopup.confirm({title:"No Price Entered",template:"Would you like to enter a price?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res||(vm.product.price=0,scannedProductDetailsValidationContinued(nextStepIfValid))})}function scannedProductDetailsValidationContinued(nextStepIfValid){return vm.product.isNoCharge&&null!==vm.product.price?void showAlert("Error","You have entered a price, but selected no charge."):void(vm.product.isCharge&&!isValidPrice(vm.product.price)?showAlert("Error","Please enter a valid price."):(vm.product.isNoCharge&&(vm.product.price=0),vm.selectedProducts.push(vm.product),"selecthospital"==nextStepIfValid?displayHospitalSelection(nextStepIfValid):gotoStep(nextStepIfValid)))}function hospitalDetailsValidation(nextStepIfValid){vm.selectedHospital.replaceStockYes&&""===vm.selectedHospital.replaceStockComments.trim()?showAlert("Error","Please enter stock replacement details if you've selected 'Replace stock to'."):vm.selectedHospital.replaceStockNo&&""!==vm.selectedHospital.replaceStockComments.trim()?showAlert("Error","You have entered stock details but selected 'Don't replace stock'."):(vm.selectedHospital.stockInstruction=vm.selectedHospital.replaceStockYes?"Replace stock":"Don't replace stock",displaySurgeonSelection(nextStepIfValid))}function newHospitalValidation(nextStepIfValid){""===vm.newHospital.name.trim()&&""===vm.newHospital.address.trim()?showAlert("Error","Please enter a name and address of the hospital - or select one from the Recent/All tabs."):""===vm.newHospital.name.trim()&&""!==vm.newHospital.address.trim()||""!==vm.newHospital.name.trim()&&""===vm.newHospital.address.trim()?showAlert("Error","Please enter both the name and address of the hospital."):displayHospitalDetails(vm.newHospital,nextStepIfValid)}function newSurgeonValidation(nextStepIfValid){""===vm.newSurgeon.firstName.trim()&&""===vm.newSurgeon.lastName.trim()?showAlert("Error","Please enter a first and last name for the surgeon - or select one from the Recent/All tabs."):""===vm.newSurgeon.firstName.trim()&&""!==vm.newSurgeon.lastName.trim()||""!==vm.newSurgeon.firstName.trim()&&""===vm.newSurgeon.lastName.trim()?showAlert("Error","Please enter both the first and last names."):(vm.newSurgeon.name=vm.newSurgeon.firstName.trim()+" "+vm.newSurgeon.lastName.trim(),displaySurgeonDetails(vm.newSurgeon,nextStepIfValid))}function surgeonDetailsValidation(nextStepIfValid){if(vm.procedureType&&"Please select"!==vm.procedureType)if(vm.procedureDate){if(vm.selectedProducts&&vm.selectedProducts.length>0){for(var isNoChargeCount=0,zeroPriceCount=0,i=0,len=vm.selectedProducts.length;len>i;i++)vm.selectedProducts[i].isNoCharge&&(isNoChargeCount+=1),0===vm.selectedProducts[i].price&&(zeroPriceCount+=1);if(0!==isNoChargeCount&&""===vm.procedureComments.trim())return void showAlert("Error","You selected no charge. Please add your reason in the comment section.");if(0!==zeroPriceCount&&""===vm.procedureComments.trim())return void showAlert("Error","You entered "+vm.currencySymbol+"0.00. Please add your reason in the comment section.")}gotoStep(nextStepIfValid)}else showAlert("Error","Please enter a valid procedure date.");else showAlert("Error","Please select type of procedure.")}function hospitalRepValidation(nextStepIfValid){""===vm.hospitalRep.firstName.trim()&&""!==vm.hospitalRep.lastName.trim()||""!==vm.hospitalRep.firstName.trim()&&""===vm.hospitalRep.lastName.trim()?showAlert("Error","Please enter both the first and last names."):(vm.notification.email=vm.selectedHospital.email,vm.isFirstTimeThru&&(vm.notification.isEmail=!0,vm.notification.isAlternativeEmail=!1,vm.notification.dontSend=!1),gotoStep(nextStepIfValid))}function notificationValidation(nextStepIfValid){vm.notification.isAlternativeEmail&&!vm.notification.alternativeEmail?showAlert("Error","Please enter a valid alternative e-mail address."):!vm.notification.isAlternativeEmail&&vm.notification.alternativeEmail?showAlert("Error","You have entered an alternative e-mail address but not tapped the checkedbox."):vm.notification.isAlternativeEmail&&vm.notification.alternativeEmail&&!validateEmail(vm.notification.alternativeEmail)?showAlert("Error","Please enter a valid e-mail address."):vm.notification.isEmail&&""===vm.notification.email?showAlert("Error","e-mail address on file is blank. Please enter an altenative e-mail, or tap don't send."):(vm.notification.dontSend?vm.confirmationEmail="No email will be sent":vm.notification.isAlternativeEmail?vm.confirmationEmail=vm.notification.alternativeEmail:vm.confirmationEmail=vm.notification.email,gotoStep(nextStepIfValid))}function resizeCanvas(canvas){var ratio=Math.max($window.devicePixelRatio||1,1);canvas.width=canvas.offsetWidth*ratio,canvas.height=canvas.offsetHeight*ratio,canvas.getContext("2d").scale(ratio,ratio)}function clearCanvas(){signaturePad.clear()}function displayHospitalSelection(step){vm.hospitalTab="hospitalrecent",gotoStep(step)}function displayHospitalDetails(hospital,step){vm.selectedHospital?(vm.selectedHospital.id=hospital.id?hospital.id:null,vm.selectedHospital.name=hospital.name,vm.selectedHospital.email=hospital.id?hospital.email:null):(vm.selectedHospital={},vm.selectedHospital.id=hospital.id?hospital.id:null,vm.selectedHospital.name=hospital.name,vm.selectedHospital.email=hospital.id?hospital.email:null,vm.selectedHospital.replaceStockNo=!0,vm.selectedHospital.replaceStockYes=!1,vm.selectedHospital.replaceStockComments=""),hospital.id&&RecentItemsService.addRecentItem("recentHospitals",hospital).then(function(recentItems){vm.recentHospitals=recentItems}),gotoStep(step)}function displaySurgeonSelection(step){if(vm.surgeonTab="surgeonrecent",vm.selectedHospital.id){vm.surgeons=[],vm.recentSurgeons=[];for(var a=0;a<vm.allSurgeons.length;a++)vm.allSurgeons[a].hospitalId==vm.selectedHospital.id&&vm.surgeons.push(vm.allSurgeons[a]);for(var r=0;r<vm.allRecentSurgeons.length;r++)vm.allRecentSurgeons[r].hospitalId==vm.selectedHospital.id&&vm.recentSurgeons.push(vm.allRecentSurgeons[r])}else vm.surgeons=vm.allSurgeons,vm.recentSurgeons=vm.allRecentSurgeons;gotoStep(step)}function displaySurgeonDetails(surgeon,step){vm.selectedSurgeon={},vm.selectedSurgeon.id=surgeon.id?surgeon.id:null,vm.selectedSurgeon.name=surgeon.name,vm.selectedSurgeon.hospitalId=surgeon.hospitalId,vm.isFirstTimeThru&&(vm.procedureDate=vm.today,vm.procedureType="",vm.procedureComments=""),surgeon.id&&RecentItemsService.addRecentItem("recentSurgeons",surgeon).then(function(recentItems){vm.allRecentSurgeons=recentItems}),gotoStep(step)}function displayHospitalTab(tab){vm.hospitalTab=tab}function displaySurgeonTab(tab){vm.surgeonTab=tab}function clearHospitalSearch(){vm.hospitalSearch=""}function editProduct(startEditAtStep){gotoStep(startEditAtStep)}function removeProduct(index){console.log("bio removeProduct index",index,vm.selectedProducts);var confirmPopup=$ionicPopup.confirm({title:"Remove Product",template:"Are you sure you want to remove product?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res&&vm.selectedProducts.splice(index,1)})}function scanBarcode(){if(cordova&&cordova.plugins&&cordova.plugins.barcodeScanner)scannerTimeout=$timeout(function(){$cordovaBarcodeScanner.scan().then(function(imageData){imageData.cancelled||processScannedProduct(imageData)},function(err){console.error(err)})},0);else{var imageData={text:"0150601557110348171810311010/15-R123/456",format:"CODE_128"};processScannedProduct(imageData)}}function cancelOrder(){var confirmPopup=$ionicPopup.confirm({title:"Cancel",template:"Are you sure?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res&&exitOrderForm()})}function submitOrder(){return 0===vm.selectedProducts.length?void showAlert("Error","Please add a product before submitting."):void(signaturePad.isEmpty()?confirmNoSignature():saveOrder())}function confirmNoSignature(){var confirmPopup=$ionicPopup.confirm({title:"No signature",template:"Add signature?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res||saveOrder()})}function saveOrder(){$ionicLoading.show({duration:5e3,template:"Saving Order form...",animation:"fade-in",showBackdrop:!0}),OrderFormService.insertOrderForm(buildOrderFormRecord()).then(function(resObject){return OrderFormService.insertOrderFormItems(buidOrderFormItemRecords(resObject.records[0].Id))}).then(function(resObject){$ionicLoading.hide(),"online"===NetworkService.getNetworkStatus()?(SyncService.setSyncLock("false"),SyncService.syncTables(["DOF__ap","DOF_Item__ap"]),submitSuccessful=!0,exitOrderForm()):($rootScope.$emit("updateOutboxCount"),LocalNotificationService.setLocalNotification(),alertOffline())})["catch"](function(e){logger.error("saveOrder "+JSON.stringify(e)+" "+JSON.stringify(orderForm)),$ionicLoading.hide()})}function buildOrderFormRecord(){var orderForm={};return orderForm.Name="TMP-"+(new Date).valueOf(),orderForm.DOF_Item_Count__c=vm.selectedProducts.length,vm.selectedHospital.id?orderForm.Hospital__c=vm.selectedHospital.id:(orderForm.Hospital_Name__c=vm.newHospital.name,orderForm.Hospital_Street__c=vm.newHospital.address),vm.selectedHospital.poNumber&&(orderForm.PO_Number__c=vm.selectedHospital.poNumber),vm.selectedHospital.replaceStockNo?orderForm.Stock_Instructions__c="Don't replace stock":(orderForm.Stock_Instructions__c="Replace stock to",orderForm.Replace_Stock_Details__c=vm.selectedHospital.replaceStockComments),vm.selectedSurgeon.id?orderForm.Surgeon__c=vm.selectedSurgeon.id:(orderForm.Surgeon_First_Name__c=vm.newSurgeon.firstName,orderForm.Surgeon_Last_Name__c=vm.newSurgeon.lastName),orderForm.Procedure_Date__c=vm.procedureDate,orderForm.Type_of_Procedure__c=vm.procedureType,""!==vm.procedureComments&&(orderForm.Procedure_Comments__c=vm.procedureComments),""!==vm.hospitalRep.firstName&&(orderForm.First_Name__c=vm.hospitalRep.firstName,orderForm.Last_Name__c=vm.hospitalRep.lastName),vm.notification.isEmail?orderForm.Send_Confirmation__c="Send to address on file":vm.notification.dontSend?orderForm.Send_Confirmation__c="Do not send":(orderForm.Send_Confirmation__c="Send to alternative address",orderForm.Alternative_Email__c=vm.notification.alternativeEmail),signaturePad.isEmpty()||(orderForm.Signature_Capture__c=signaturePad.toDataURL()),orderForm.Date_Entered__c=new Date,orderForm}function buidOrderFormItemRecords(orderFormId){for(var orderFormItems=[],i=0,len=vm.selectedProducts.length;len>i;i++){var record={};record.Name="TMP-"+(new Date).valueOf(),record.DOF__c=orderFormId,vm.selectedProducts[i].name?(record.Product__c=vm.selectedProducts[i].id,record.Lot_Number__c=vm.selectedProducts[i].lotNumber,record.Entered_Price__c=parseFloat(vm.selectedProducts[i].price),vm.selectedProducts[i].isCharge?record.Price_Entered__c="Price Entered":record.Price_Entered__c="No Charge",record.Expiry_Date__c=vm.selectedProducts[i].expiryDate):(record.Lot_Number__c=vm.selectedProducts[i].lotNumber,record.Entered_Price__c=parseFloat(vm.selectedProducts[i].price),vm.selectedProducts[i].isCharge?record.Price_Entered__c="Price Entered":record.Price_Entered__c="No Charge"),orderFormItems.push(record)}return orderFormItems}function exitOrderForm(){$rootScope.$emit("disableSideMenu",{showSideMenu:!0}),SyncService.setSyncLock("false"),submitSuccessful?alertSuccess():$state.go("app.home")}function alertSuccess(){var alertPopup=$ionicPopup.alert({title:"Order form",template:"Submission successful",cssClass:"bio-popup"});alertPopup.then(function(res){res&&$state.go("app.home")})}function alertOffline(){var alertPopup=$ionicPopup.alert({title:"You are currently offline",template:"Synchronisation will take place when you are next online",cssClass:"bio-popup"});alertPopup.then(function(res){res&&exitOrderForm()})}function processScannedProduct(imageData){0===vm.allProducts.length?($ionicLoading.show({duration:5e3,template:"Loading products...",animation:"fade-in",showBackdrop:!0}),OrderFormService.getProducts().then(function(records){matchProduct(imageData),$ionicLoading.hide()})):matchProduct(imageData)}function matchProduct(imageData){if(logger.log("scanned code and format: >"+imageData.text+"< >"+imageData.format+"<"),"CODE_128"==imageData.format||"QR_CODE"==imageData.format||"DATA_MATRIX"==imageData.format){var data="QR_CODE"==imageData.format||"DATA_MATRIX"==imageData.format?imageData.text.substring(1):imageData.text,scannedProductGTIN=data.substring(2,16);logger.log("extracted GTIN: >"+scannedProductGTIN+"<");for(var matchedProduct=null,i=0;i<vm.allProducts.length;i++)vm.allProducts[i].GTIN__c==scannedProductGTIN&&(matchedProduct=vm.allProducts[i]);matchedProduct?(vm.product={},vm.product.id=matchedProduct.Id,vm.product.name=matchedProduct.Name__c+" "+matchedProduct.Size__c,vm.product.expiryDate=new Date("20"+data.substring(18,20)+"-"+data.substring(20,22)+"-"+data.substring(22,24)),vm.product.lotNumber=data.substring(26),vm.product.price=null,vm.product.isCharge=!0,vm.product.isNoCharge=!1,logger.log("product: "+JSON.stringify(vm.product)),gotoStep("scangood")):gotoStep("scanbad")}else gotoStep("scanbad")}function chargeCheckboxChange(inputType,checkbox){"manual"==inputType?vm.manualInput[checkbox]=!vm.manualInput[checkbox]:vm.product[checkbox]=!vm.product[checkbox]}function stockCheckboxChange(checkbox){"replaceStockYes"==checkbox?(vm.selectedHospital.replaceStockYes=!1,vm.selectedHospital.replaceStockNo=!0):(vm.selectedHospital.replaceStockYes=!0,vm.selectedHospital.replaceStockNo=!1)}function notificationEmailCheckboxChange(checkbox){vm.notification.isEmail=!1,vm.notification.isAlternativeEmail=!1,vm.notification.dontSend=!1,"isEmail"==checkbox?vm.notification.isEmail=!0:"isAlternativeEmail"==checkbox?vm.notification.isAlternativeEmail=!0:vm.notification.dontSend=!0}function checkRecentHospitalsAreStillValid(){for(var matchedRecentItems=[],i=0;i<vm.recentHospitals.length;i++)for(var j=0;j<vm.hospitals.length;j++)if(vm.hospitals[j].id==vm.recentHospitals[i].id){matchedRecentItems.push(vm.recentHospitals[i]);break}matchedRecentItems.length!==vm.recentHospitals.length&&(vm.recentHospitals=matchedRecentItems,RecentItemsService.setRecentItems("recentHospitals",matchedRecentItems))}function checkRecentSurgeonsAreStillValid(){for(var matchedRecentItems=[],i=0;i<vm.allRecentSurgeons.length;i++)for(var j=0;j<vm.allSurgeons.length;j++)if(vm.allSurgeons[j].id==vm.allRecentSurgeons[i].id){matchedRecentItems.push(vm.allRecentSurgeons[i]);break}matchedRecentItems.length!==vm.allRecentSurgeons.length&&(vm.allRecentSurgeons=matchedRecentItems,RecentItemsService.setRecentItems("recentSurgeons",matchedRecentItems))}function showAlert(title,template){var alertPopup=$ionicPopup.alert({title:title,template:template,cssClass:"bio-popup"});alertPopup.then(function(res){})}function windowResizeHandler(){var canvas=angular.element(document.getElementById("signatureCanvas"))[0];canvas&&signaturePad&&!signaturePad.isEmpty()&&(signatureDataURL=signaturePad.toDataURL(),$timeout(function(){resizeCanvas(canvas),signaturePad.isEmpty()||signaturePad.fromDataURL(signatureDataURL),canvas=null},500))}function isValidPrice(n){return/^\d*\.?\d{0,2}$/.test(n)}function validateEmail(email){var re=/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(email)}logger.log("in OrderFormCtrl");var signaturePad,signatureDataURL,signaturePadTimeout,scannerTimeout,scrollTimeout,onBeginSignatureTimeout,onEndSignatureTimeout,vm=this,submitSuccessful=!1;vm.allProducts=[],vm.selectedProducts=[],vm.showCancel=!1,vm.isFirstTimeThru=!0,vm.newHospital={name:"",address:""},vm.newSurgeon={firstName:"",lastName:""},vm.hospitalRep={firstName:"",lastName:""},vm.notification={email:"",alternativeEmail:"",dontSend:!1,isEmail:!1,isAlternativeEmail:!1},vm.today=new Date,vm.hospitalTab="hospitalrecent",vm.gotoStep=gotoStep,vm.displayNewManualInput=displayNewManualInput,vm.manualInputValidation=manualInputValidation,vm.manualInputPriceValidation=manualInputPriceValidation,vm.scannedProductDetailsValidation=scannedProductDetailsValidation,vm.newHospitalValidation=newHospitalValidation,vm.hospitalDetailsValidation=hospitalDetailsValidation,vm.newSurgeonValidation=newSurgeonValidation,vm.surgeonDetailsValidation=surgeonDetailsValidation,vm.hospitalRepValidation=hospitalRepValidation,vm.notificationValidation=notificationValidation,vm.chargeCheckboxChange=chargeCheckboxChange,vm.stockCheckboxChange=stockCheckboxChange,vm.notificationEmailCheckboxChange=notificationEmailCheckboxChange,vm.displayHospitalDetails=displayHospitalDetails,vm.displaySurgeonDetails=displaySurgeonDetails,vm.displayHospitalTab=displayHospitalTab,vm.displaySurgeonTab=displaySurgeonTab,vm.clearHospitalSearch=clearHospitalSearch,vm.editProduct=editProduct,vm.removeProduct=removeProduct,vm.scanBarcode=scanBarcode,vm.cancelOrder=cancelOrder,vm.submitOrder=submitOrder,vm.clearCanvas=clearCanvas,activate(),angular.element($window).on("resize",windowResizeHandler),$scope.$on("$destroy",function(){logger.log("OrderFormCtrl destroy"),$timeout.cancel(signaturePadTimeout),$timeout.cancel(scannerTimeout),$timeout.cancel(scrollTimeout),$timeout.cancel(onBeginSignatureTimeout),$timeout.cancel(onEndSignatureTimeout),angular.element($window).off("resize",windowResizeHandler)})}angular.module("starter.controllers").controller("OrderFormCtrl",OrderFormCtrl),OrderFormCtrl.$inject=["$rootScope","$scope","$window","$ionicPopup","$state","$ionicLoading","$timeout","$cordovaBarcodeScanner","$ionicScrollDelegate","logger","OrderFormService","SyncService","RecentItemsService","NetworkService","LocalNotificationService","UserService"]}(),function(){"use strict";function OutboxCtrl($rootScope,$scope,$ionicLoading,$timeout,logger,OutboxService,RecordTypeService,SyncService,NetworkService,UserService,OrderFormService){function activate(){$ionicLoading.show({duration:5e3,template:"Loading...",animation:"fade-in",showBackdrop:!0,delay:400}),UserService.getUserCurrencySymbol().then(function(result){vm.currencySymbol=result}),vm.orders=[],vm.leads=[],vm.requests=[],RecordTypeService.getRecordTypeId("Mobile_Lead","Mobile_Dynamic__c").then(function(recordTypeId){return leadRecordTypeId=recordTypeId,OutboxService.getDirtyRecords()}).then(function(records){if(dirtyRecordsCount=records.length,0===dirtyRecordsCount)vm.showMsg=!0,vm.showSyncButton=!1,$ionicLoading.hide();else for(var i=0;i<records.length;i++)pushRecordToArray(records[i].Mobile_Table_Name,records[i].SOUP_Record_Id,i);updateOutboxCountTimeout=$timeout(function(){$rootScope.$emit("updateOutboxCount")},0)})}function pushRecordToArray(tableName,soupRecordId,index){OutboxService.getRecordForSoupEntryId(tableName,soupRecordId).then(function(record){record&&("DOF__ap"==tableName?getAdditionalDetails(record,index):record.RecordTypeId==leadRecordTypeId?(vm.leads.push(record),$scope.$emit("checkIfAllRecordsProcessed")):(vm.requests.push(record),$scope.$emit("checkIfAllRecordsProcessed")))})}function getAdditionalDetails(record,index){var surgeonInHospitalRecord,items;OrderFormService.getSurgeonInHospital(record.Surgeon__c).then(function(surgeonInHospital){return surgeonInHospitalRecord=surgeonInHospital,OrderFormService.getOrderItemsWithOrderId(record.Id)}).then(function(orderItems){return items=orderItems,OrderFormService.getProductsForOrderItems(orderItems)}).then(function(products){for(var productName,displayProducts=[],j=0;j<items.length;j++){if(productName=null,items[j].Product__c)for(var k=0;k<products.length;k++)if(items[j].Product__c==products[k].Id){productName=products[k].Name__c+" "+products[k].Size__c;break}productName?displayProducts.push({productName:productName,lotNumber:items[j].Lot_Number__c,price:items[j].Entered_Price__c,expiryDate:items[j].Expiry_Date__c}):displayProducts.push({lotNumber:items[j].Lot_Number__c,
price:items[j].Entered_Price__c})}$scope.$apply(),vm.orders.push({record:record,surgeonInHospitalRecord:surgeonInHospitalRecord,products:displayProducts}),$scope.$emit("checkIfAllRecordsProcessed")})}function sync(){SyncService.syncTables(["DOF__ap","DOF_Item__ap","Mobile_Dynamic__ap"])}logger.log("in OutboxCtrl"),console.log("bio in OutboxCtrl");var leadRecordTypeId,updateOutboxCountTimeout,dirtyRecordsCount,vm=this,recordsProcessed=0;vm.showMsg=!1,vm.showSyncButton=!1,vm.syncing=!1,vm.sync=sync,activate();var deregisterHandleCheckRecordProcessed=$scope.$on("checkIfAllRecordsProcessed",function(event,args){recordsProcessed+=1,recordsProcessed===dirtyRecordsCount&&($ionicLoading.hide(),vm.showSyncButton=!0)}),deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){switch(logger.log("OutboxCtrl syncTables: "+JSON.stringify(args)),console.log("bio OutboxCtrl syncTables: "+JSON.stringify(args)),args.result.toString()){default:if(args.result.toString().indexOf("TableComplete")>=0){var syncedTable=args.result.replace("TableComplete ","");"Mobile_Dynamic__ap"==syncedTable&&activate()}}});$scope.$on("$destroy",function(){logger.log("OutboxCtrl destroy"),console.log("bio OutboxCtrl destroy"),deregisterHandleSyncTables(),deregisterHandleCheckRecordProcessed(),$timeout.cancel(updateOutboxCountTimeout)})}angular.module("starter.controllers").controller("OutboxCtrl",OutboxCtrl),OutboxCtrl.$inject=["$rootScope","$scope","$ionicLoading","$timeout","logger","OutboxService","RecordTypeService","SyncService","NetworkService","UserService","OrderFormService"]}(),function(){"use strict";function RequestCtrl($rootScope,$scope,$ionicPopup,$state,$ionicLoading,$timeout,$ionicScrollDelegate,logger,SyncService,NetworkService,RecordTypeService,MobileDynamicService,LocalNotificationService){function activate(){angular.copy(initialRequest,vm.request),vm.showBackButton=!0,RecordTypeService.getRecordTypeId("Unsolicited_Request","Mobile_Dynamic__c").then(function(id){recordTypeId=id})}function gotoStep(step){("standardstart"==step||"urgentstart"==step)&&(vm.showCancel=!0,$rootScope.$emit("disableSideMenu",{showSideMenu:!1}),SyncService.setSyncLock("true"),"standardstart"==step?vm.requestTypeTitle="- standard":vm.requestTypeTitle="- urgent"),("standardinfo"==step||"urgentinfo"==step)&&""!==vm.request.info.trim()&&(vm.showBackButton=!1),"default"==step&&(vm.requestTypeTitle="",vm.showCancel=!1,activate(),$rootScope.$emit("disableSideMenu",{showSideMenu:!0}),SyncService.setSyncLock("false")),vm.step=step,scrollTimeout=$timeout(function(){$ionicScrollDelegate.scrollTop()},50)}function inputValidation(nextStepIfValid){if(("standardproduct"===nextStepIfValid||"urgentproduct"===nextStepIfValid)&&""===vm.request.info.trim())return void showAlert("Error","Please enter information.");if("standarddeadline"===nextStepIfValid){if(""===vm.request.requestorName.trim()||""===vm.request.requestorInstitution.trim())return void showAlert("Error","Please enter the requestor's details.");if(!vm.request.requestorEmail||!validateEmail(vm.request.requestorEmail))return void showAlert("Error","Please enter a valid e-mail address.")}return"urgentdeadline"!==nextStepIfValid||""!==vm.request.requestorName.trim()&&""!==vm.request.requestorInstitution.trim()?"submitstandard"===nextStepIfValid||"submiturgent"===nextStepIfValid?vm.request.responseDate?void submitRequest(nextStepIfValid):void showAlert("Error","Please enter a date."):void gotoStep(nextStepIfValid):void showAlert("Error","Please enter the requestor's details.")}function submitRequest(requestType){$ionicLoading.show({duration:5e3,template:"Saving request...",animation:"fade-in",showBackdrop:!0}),MobileDynamicService.insertRecord(buildRequestRecord(requestType)).then(function(resObject){$ionicLoading.hide(),"online"===NetworkService.getNetworkStatus()?(SyncService.setSyncLock("false"),SyncService.syncTables(["Mobile_Dynamic__ap"]),submitSuccessful=!0,exitRequest()):($rootScope.$emit("updateOutboxCount"),LocalNotificationService.setLocalNotification(),alertOffline())})["catch"](function(e){logger.error("submitRequest "+JSON.stringify(e)+" "+JSON.stringify(orderForm)),$ionicLoading.hide()})}function buildRequestRecord(requestType){var request={};return request.Name="TMP-"+(new Date).valueOf(),"submitstandard"==requestType?request.Request_Type__c="Standard":request.Request_Type__c="Urgent",request.Requested_Information__c=vm.request.info,request.Product__c=vm.request.product,request.Requestors_Name__c=vm.request.requestorName,vm.request.requestorEmail?request.Email__c=vm.request.requestorEmail:request.Email__c="",request.Hospital_Institution__c=vm.request.requestorInstitution,request.Request_Target_Response_Date__c=vm.request.responseDate,""!==recordTypeId&&(request.RecordTypeId=recordTypeId),request.Date_Entered__c=new Date,request}function cancelRequest(){var confirmPopup=$ionicPopup.confirm({title:"Cancel",template:"Are you sure?",cssClass:"bio-popup",cancelText:"&nbsp;&nbsp;&nbsp;No",cancelType:"button-dark ion-close-round",okText:"&nbsp;&nbsp;&nbsp;Yes",okType:"button-positive ion-checkmark-round"});confirmPopup.then(function(res){res&&exitRequest()})}function exitRequest(){$rootScope.$emit("disableSideMenu",{showSideMenu:!0}),SyncService.setSyncLock("false"),submitSuccessful?alertSuccess():$state.go("app.home")}function alertSuccess(){var alertPopup=$ionicPopup.alert({title:"Unsolicited request",template:"Submission successful",cssClass:"bio-popup"});alertPopup.then(function(res){res&&$state.go("app.home")})}function alertOffline(){var alertPopup=$ionicPopup.alert({title:"You are currently offline",template:"Synchronisation will take place when you are next online",cssClass:"bio-popup"});alertPopup.then(function(res){res&&exitRequest()})}function showAlert(title,template){var alertPopup=$ionicPopup.alert({title:title,template:template,cssClass:"bio-popup"});alertPopup.then(function(res){})}function validateEmail(email){var re=/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(email)}logger.log("in RequestCtrl"),console.log("bio in RequestCtrl");var recordTypeId,scrollTimeout,vm=this,initialRequest={info:"",product:"STIMULAN",requestorName:"",requestorEmail:"",requestorInstitution:"",responseDate:new Date((new Date).getTime()+12096e5)},submitSuccessful=!1;vm.showCancel=!1,vm.today=new Date,vm.requestTypeTitle="",vm.request={},vm.gotoStep=gotoStep,vm.inputValidation=inputValidation,vm.submitRequest=submitRequest,vm.cancelRequest=cancelRequest,activate(),$scope.$on("$destroy",function(){logger.log("RequestCtrl destroy"),console.log("bio RequestCtrl destroy"),$timeout.cancel(scrollTimeout)})}angular.module("starter.controllers").controller("RequestCtrl",RequestCtrl),RequestCtrl.$inject=["$rootScope","$scope","$ionicPopup","$state","$ionicLoading","$timeout","$ionicScrollDelegate","logger","SyncService","NetworkService","RecordTypeService","MobileDynamicService","LocalNotificationService"]}(),function(){"use strict";function RequestHistoryCtrl($rootScope,$scope,$window,$ionicLoading,$ionicModal,$state,logger,RecordTypeService,MobileDynamicService){function activate(){$ionicLoading.show({duration:5e3,template:"Loading...",animation:"fade-in",showBackdrop:!0}),vm.requests=[],RecordTypeService.getRecordTypeId("Unsolicited_Request","Mobile_Dynamic__c").then(function(recordTypeId){return MobileDynamicService.getRecords(recordTypeId)}).then(function(records){for(var i=0;i<records.length;i++)-1==records[i].Id.indexOf("PROXY")&&vm.requests.push(records[i]);console.log("bio vm.requests",vm.requests),$ionicLoading.hide()})}function showModal(record){$ionicModal.fromTemplateUrl($window.RESOURCE_ROOT+"templates/requestDetail.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){vm.modal=modal,vm.modal.request=record,console.log("bio showModal vm.modal.request",vm.modal.request),vm.modal.show()})}function closeModal(){console.log("bio closeModal"),vm.modal&&(vm.modal.hide(),vm.modal.remove(),delete vm.modal)}function goHome(){$state.go("app.home")}logger.log("in RequestHistoryCtrl"),console.log("bio in RequestHistoryCtrl");var vm=this;vm.showModal=showModal,vm.closeModal=closeModal,vm.goHome=goHome,activate();var deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){if(logger.log("RequestHistoryCtrl syncTables: "+JSON.stringify(args)),console.log("bio RequestHistoryCtrl syncTables: "+JSON.stringify(args)),args.result.toString().indexOf("TableComplete")>=0){var syncedTable=args.result.replace("TableComplete ","");"Mobile_Dynamic__ap"==syncedTable&&activate()}});$scope.$on("$destroy",function(){logger.log("RequestHistoryCtrl destroy"),console.log("bio RequestHistoryCtrl destroy"),deregisterHandleSyncTables(),vm.modal&&(vm.modal.remove(),delete vm.modal)})}angular.module("starter.controllers").controller("RequestHistoryCtrl",RequestHistoryCtrl),RequestHistoryCtrl.$inject=["$rootScope","$scope","$window","$ionicLoading","$ionicModal","$state","logger","RecordTypeService","MobileDynamicService"]}(),function(){"use strict";function SettingsCtrl($scope,$rootScope,$ionicPopup,$ionicLoading,$location,$state,devUtils,vsnUtils,DevService,logger){function extractSettingsValues(appSoupRecs){var settingRecs={};return $j.each(appSoupRecs,function(i,records){var tableRec={};$j.each(records,function(i,record){switch(record.Name){case"Name":tableRec.Name=record.Value;break;case"CurrentValue":tableRec.Value=record.Value}}),settingRecs[tableRec.Name]=tableRec.Value}),settingRecs}function validateAdminPassword(pword){return"123"==pword?!0:!1}var e=document.getElementById("my-nav-bar");angular.element(e).removeClass("mc-hide"),$scope.logoutAllowedClass="disabled",$scope.recsToSyncCount=0,$scope.codeflow=LOCAL_DEV,$scope.upgradeAvailable=!1,vsnUtils.upgradeAvailable().then(function(res){return res?devUtils.dirtyTables():void 0}).then(function(tables){tables&&0===tables.length&&($scope.upgradeAvailable=!0,$scope.$apply())}),DevService.allRecords("recsToSync",!1).then(function(recsToSyncRecs){$scope.recsToSyncCount=recsToSyncRecs.length,0===$scope.recsToSyncCount?$scope.logoutAllowedClass="":$scope.recsToSyncCount=0},function(reason){console.error("Angular: promise returned reason -> "+reason)}),DevService.allRecords("appSoup",!1).then(function(appSoupRecs){$scope.settingsRecs=extractSettingsValues(appSoupRecs)},function(reason){console.error("Angular: promise returned reason -> "+reason)}),$scope.upgradeIfAvailable=function(){devUtils.dirtyTables().then(function(tables){if(logger.log("upgrade: dirtyTables check"),tables&&0===tables.length){logger.log("upgrade: no dirtyTables");var confirmPopup=$ionicPopup.confirm({title:"Upgrade",template:"Are you sure you want to upgrade now?"});confirmPopup.then(function(res){res&&($ionicLoading.show({duration:3e4,delay:400,maxWidth:600,noBackdrop:!0,template:'<h1>Upgrade app...</h1><p id="app-upgrade-msg" class="item-icon-left">Upgrading...<ion-spinner/></p>'}),logger.log("upgrade: calling upgradeIfAvailable"),vsnUtils.upgradeIfAvailable().then(function(res){logger.log("upgrade: upgradeIfAvailable? "+res),res||($ionicLoading.hide(),$scope.data={},$ionicPopup.show({title:"Upgrade",subTitle:"The upgrade could not take place due to sync in progress. Please try again later.",scope:$scope,buttons:[{text:"OK",type:"button-positive",onTap:function(e){return!0}}]}))})["catch"](function(e){logger.error("upgrade: "+JSON.stringify(e)),$ionicLoading.hide()}))})}else logger.log("upgrade: dirtyTables found"),$scope.data={},$ionicPopup.show({title:"Upgrade",subTitle:"Unable to upgrade. A sync is required - please try later.",scope:$scope,buttons:[{text:"OK",type:"button-positive",onTap:function(e){return!0}}]})})},$scope.showAdminPasswordPopup=function(){var adminTimeout=3e5;if($rootScope.adminLoggedIn>Date.now()-adminTimeout)$location.path("app/settings/devtools"),$rootScope.adminLoggedIn=Date.now();else{$scope.data={};$ionicPopup.show({template:'<input type="password" ng-model="data.admin">',title:"Enter Admin Password",scope:$scope,buttons:[{text:"Cancel"},{text:"<b>Continue</b>",type:"button-positive",onTap:function(e){validateAdminPassword($scope.data.admin)?($location.path("app/settings/devtools"),$rootScope.adminLoggedIn=Date.now()):console.log("Password incorrect")}}]})}},$scope.showConfirmLogout=function(){var confirmPopup=$ionicPopup.confirm({title:"Logout",template:"Are you sure you want to logout?"});confirmPopup.then(function(res){res&&($rootScope.adminLoggedIn=null,cordova.require("com.salesforce.plugin.sfaccountmanager").logout())})},$scope.showConfirmReset=function(){var confirmPopup=$ionicPopup.confirm({title:"Reset App Data",template:"Are you sure you want to reset ALL application data?"});confirmPopup.then(function(res){if(res){console.debug("Resetting app");$ionicLoading.show({duration:3e4,delay:400,maxWidth:600,noBackdrop:!0,template:'<h1>Resetting app...</h1><p id="app-progress-msg" class="item-icon-left">Clearing data...<ion-spinner/></p>'}),vsnUtils.hardReset().then(function(res){})["catch"](function(e){console.error(e),$ionicLoading.hide()})}})},$scope.setLogLevel=function(){"Off"==$scope.log.level?localStorage.removeItem("logLevel"):localStorage.setItem("logLevel",$scope.log.level),$scope.log.levelChange=!1},$scope.getLogLevel=function(){var logLevel=localStorage.getItem("logLevel");return null===logLevel&&(logLevel="Off"),logLevel},$scope.log={},$scope.log.level=$scope.getLogLevel(),$scope.log.levelChange=!1,$scope.logLevelChange=function(){$scope.log.levelChange=!0},$scope.goBack=function(){$rootScope.$emit("showSettingsMenu")},$scope.goHome=function(){$state.go("app.home")}}angular.module("starter.controllers").controller("SettingsCtrl",SettingsCtrl),SettingsCtrl.$inject=["$scope","$rootScope","$ionicPopup","$ionicLoading","$location","$state","devUtils","vsnUtils","DevService","logger"]}(),function(){"use strict";function TestingCtrl($scope,$cordovaLocalNotification,AppRunStatusService,logger,LocalNotificationService){$scope.resumeEvent=function(){console.debug("resumeEvent"),AppRunStatusService.statusEvent("resume")},$scope.localNotification=function(id){var alarmTime=new Date;alarmTime.setSeconds(alarmTime.getSeconds()+15);var args={id:100100,at:alarmTime,text:"Unsynced records",sound:null};"Android"==device.platform&&(args.ongoing=!0,args.smallIcon="res://icon"),$cordovaLocalNotification.schedule(args).then(function(result){console.log("localNotification result = "+result),logger.log("localNotification result = "+result)})},$scope.localNotificationTrigger=function(id){LocalNotificationService.handleLocalNotification(id,"foreground")},$scope.toggleNotificationState=function(){var notificationState=LocalNotificationService.getLocalNotificationState();"enabled"==notificationState?(LocalNotificationService.setLocalNotificationState("disabled"),$scope.notificationButtonText="Enable"):(LocalNotificationService.setLocalNotificationState("enabled"),$scope.notificationButtonText="Disable")};var notificationState=LocalNotificationService.getLocalNotificationState();"enabled"==notificationState?$scope.notificationButtonText="Disable":$scope.notificationButtonText="Enable"}angular.module("starter.controllers").controller("TestingCtrl",TestingCtrl),TestingCtrl.$inject=["$scope","$cordovaLocalNotification","AppRunStatusService","logger","LocalNotificationService"]}(),function(){"use strict";function TutorialCtrl($rootScope,$scope,$state,$window,$timeout,logger,UserService){function leftButtonClick(){0===vm.slider.activeIndex?startApp():previous()}function rightButtonClick(){vm.slider.activeIndex===vm.maxSlideIndex?startApp():next()}function startApp(){var tutorialDone=localStorage.getItem("tutorial");null===tutorialDone?(localStorage.setItem("tutorial","done"),$state.go("app.home")):($state.go("app.home"),showSettingsMenuTimeout=$timeout(function(){$rootScope.$emit("showSettingsMenu")},0))}function startAppFromImageTap(index){index==vm.maxSlideIndex&&startApp()}function next(){vm.slider.slideNext(!1),setButtonText()}function previous(){vm.slider.slidePrev(!1),setButtonText()}function setButtonText(){0===vm.slider.activeIndex?vm.leftButtonText="Skip welcome":vm.leftButtonText="<",vm.slider.activeIndex===vm.maxSlideIndex?vm.rightButtonText="Start App":vm.rightButtonText=">"}function setMaxSlideIndex(slidesPerView){vm.slides.length%slidesPerView===0?vm.maxSlideIndex=vm.slides.length/slidesPerView-1:vm.maxSlideIndex=Math.ceil(vm.slides.length/slidesPerView)-1}function windowResizeHandler(){updateButtonTextOnResizeTimeout=$timeout(function(){setMaxSlideIndex(vm.slider.params.slidesPerView),setButtonText()},0)}logger.log("in TutorialCtrl"),console.log("bio in TutorialCtrl");var showButtonsTimeout,showSettingsMenuTimeout,updateButtonTextOnResizeTimeout,vm=this;vm.startAppFromImageTap=startAppFromImageTap,vm.slides=[],vm.slides.push({image:$window.RESOURCE_ROOT+"images/tutorial1.jpg",heading:"Welcome to the Biocomposites' <span class='bio-line-break-on-small-device'>Distributor Hub.</span>"}),vm.slides.push({image:$window.RESOURCE_ROOT+"images/tutorial2.jpg",heading:"Providing easy, offline access to <span class='bio-line-break-on-small-device'>the tools you need.</span>"}),vm.slides.push({image:$window.RESOURCE_ROOT+"images/tutorial3.jpg",heading:"Applications and cases at your <span class='bio-line-break-on-small-device'>fingertips.</span>"}),vm.slides.push({image:$window.RESOURCE_ROOT+"images/tutorial4.jpg",heading:"On-label answers to your <span class='bio-line-break-on-small-device'>surgeons' questions.</span>"}),vm.slides.push({image:$window.RESOURCE_ROOT+"images/tutorial5.jpg",heading:"e-learning modules to grow your <span class='bio-line-break-on-small-device'>knowledge.</span>"}),vm.slides.push({image:$window.RESOURCE_ROOT+"images/tutorial6.jpg",heading:"…and regular news updates to <span class='bio-line-break-on-small-device'>keep you informed.</span>"}),vm.slides.push({image:$window.RESOURCE_ROOT+"images/tutorial7.jpg",heading:"Let's get started."}),vm.showButtons=!1,vm.leftButtonClick=leftButtonClick,vm.rightButtonClick=rightButtonClick;var deregisterIonicViewEnter=$scope.$on("$ionicView.afterEnter",function(scopes,states){showButtonsTimeout=$timeout(function(){setButtonText(),vm.showButtons=!0},0),angular.element($window).on("resize",windowResizeHandler)}),deregisterIonicViewLeave=$scope.$on("$ionicView.leave",function(scopes,states){angular.element($window).off("resize",windowResizeHandler)});$scope.$watch("vm.slider",function(slider){slider&&(setMaxSlideIndex(slider.params.slidesPerView),vm.slider.on("slideNextStart",function(){setButtonText(),$scope.$apply()}),vm.slider.on("slidePrevStart",function(){setButtonText(),$scope.$apply()}))});var deregisterHandleSyncTables=$rootScope.$on("syncTables",function(event,args){logger.log("TutorialCtrl syncTables: "+JSON.stringify(args)),console.log("bio TutorialCtrl syncTables: "+JSON.stringify(args)),"InitialLoadComplete"==args.result.toString()&&(UserService.setProcessDone("initialDataLoaded"),UserService.setUserFirstName())});$scope.$on("$destroy",function(){logger.log("TutorialCtrl destroy"),console.log("bio TutorialCtrl destroy"),deregisterHandleSyncTables(),deregisterIonicViewEnter(),deregisterIonicViewLeave(),$timeout.cancel(showButtonsTimeout),$timeout.cancel(updateButtonTextOnResizeTimeout),$timeout.cancel(showSettingsMenuTimeout),vm.slider.off("slideNextStart"),vm.slider.off("slidePrevStart")})}angular.module("starter.controllers").controller("TutorialCtrl",TutorialCtrl),TutorialCtrl.$inject=["$rootScope","$scope","$state","$window","$timeout","logger","UserService"]}();